(function(){"use strict";try{if(typeof document<"u"){var e=document.createElement("style");e.appendChild(document.createTextNode(".SurfaceJSX{flex:1 1 auto;display:flex;flex-direction:column;width:100%;height:100%;overflow:hidden}")),document.head.appendChild(e)}}catch(t){console.error("vite-plugin-css-injected-by-js",t)}})();
(function(d,q){var Pn=document.createElement("style");Pn.textContent=`.SurfaceJSX{flex:1 1 auto;display:flex;flex-direction:column;width:100%;height:100%;overflow:hidden}
`,document.head.appendChild(Pn),typeof exports=="object"&&typeof module<"u"?q(exports,require("react")):typeof define=="function"&&define.amd?define(["exports","react"],q):(d=typeof globalThis<"u"?globalThis:d||self,q(d.deltav={},d.React))})(this,function(d,q){"use strict";window.WebGL2RenderingContext=window.WebGL2RenderingContext||function(){};class Pn{get surface(){return this.userInputManager.surface}getProjection(e){const i=this.userInputManager.getView(e);return i?i.projection:null}getView(e){return this.userInputManager&&this.userInputManager.getView(e)||null}getViewScreenBounds(e){const i=this.userInputManager.getView(e);return i?i.screenBounds:null}setUserInputManager(e){this.userInputManager=e}willRender(){}didRender(){}}class ns extends Pn{constructor(e){super(),Object.assign(this,e)}handleMouseDown(e){}handleMouseUp(e){}handleMouseOver(e){}handleMouseOut(e){}handleMouseMove(e){}handleClick(e){}handleDrag(e){}handleWheel(e){}handleTouchCancelled(e){}handleTouchDown(e){}handleTouchUp(e){}handleTouchOut(e){}handleTouchDrag(e){}handleTap(e){}handleDoubleTap(e){}handleLongTouch(e){}handleLongTap(e){}handlePinch(e){}handleSpread(e){}handleTouchRotate(e){}handleSwipe(e){}}var ul=(t=>(t[t.NONE=-1]="NONE",t[t.LEFT=0]="LEFT",t[t.AUX=1]="AUX",t[t.RIGHT=2]="RIGHT",t[t.FOURTH=3]="FOURTH",t[t.FIFTH=4]="FIFTH",t))(ul||{});const{sqrt:Ra,max:Tt,min:yt,floor:bt,ceil:Et,abs:_t,acos:lp,sin:xa}=Math,$e=new Array(20).fill(0).map(t=>[0,0,0]),hl=new Array(20).fill(0).map(t=>[0,0,0,0]);function dl(t){return t&&Array.isArray(t)&&t.length===1}function Aa(t){return t&&Array.isArray(t)&&t.length===2}function fl(t){return t&&Array.isArray(t)&&t.length===3}function U(t){return t&&Array.isArray(t)&&t.length===4}function Fe(t,e){return t=t||[],t[0]=e,t}function rs(t,e,i){return Fe(i,t[0]+e[0])}function Sa(t,e){return Fe(e,Et(t[0]))}function Ma(t,e){return t[0]===e[0]}function pl(t,e,i){return _t(t[0]-e[0])<=i}function Ia(t,e){return Fe(e,t[0])}function La(){return[0]}function Ca(t,e,i){return Fe(i,0)}function Oa(t,e,i){return Fe(i,t[0]/e[0])}function Na(t){return Fe(t,0)}function Pa(t,e){e=e||[];for(let i=0,n=t.length;i<n;++i)e.push(t[i][0]);return e}function Da(t,e){return Fe(e,bt(t[0]))}function Fa(t,e){return Fe(e,1/t[0])}function ss(t,e,i){return Fe(i,t[0]*e)}function as(t,e,i){return Fe(i,t[0]-e[0])}function Ba(t,e,i){return Fe(i,Tt(t[0],e[0]))}function Ua(t,e,i){return Fe(i,yt(t[0],e[0]))}function Ga(t,e,i){return Fe(i,t[0]*e[0])}function ka(t,e){return Fe(e,1)}function za(t,e){return t[0]*e[0]}function gl(t,e){return t[0]*e[0]}function Va(t,e,i,n){return rs(ss(as(e,t),i),t,n)}function Wa(t){return t[0]}function ml(t){return t}function $a(t,...e){let i;if(e=e||[],Array.isArray(t)?i=t.slice(0,1):i=[t],i.length<1)for(let n=0,r=e.length;n<r&&i.length<1;++n){const s=e[n];Array.isArray(s)?i.push(...s.slice(0,1-i.length)):i.push(s)}for(;i.length<1;)i.push(0);return i}function de(t,e,i){return t=t||new Array(2),t[0]=e,t[1]=i,t}function fi(t,e,i){return de(i,t[0]+e[0],t[1]+e[1])}function ja(t,e){return de(e,Et(t[0]),Et(t[1]))}function os(t,e){return de(e,t[0],t[1])}function Ha(t){return de(t,1,0)}function Qa(t,e,i){return de(i,0,0)}function cs(t,e){return t[0]===e[0]&&t[1]===e[1]}function vl(t,e,i){return _t(t[0]-e[0])<=i&&_t(t[1]-e[1])<=i}function cr(t,e,i){return de(i,t[0]/e[0],t[1]/e[1])}function Xa(t){return de(t,0,0)}function Ya(t,e){e=e||new Array(t.length*2);for(let i=0,n=0,r=t.length;i<r;++i,n+=2){const s=t[i];e[n]=s[0],e[n+1]=s[1]}return e}function qa(t,e){return de(e,bt(t[0]),bt(t[1]))}function ls(t,e){return de(e,1/t[0],1/t[1])}function Ka(t,e,i){return de(i,Tt(t[0],e[0]),Tt(t[1],e[1]))}function Za(t,e,i){return de(i,yt(t[0],e[0]),yt(t[1],e[1]))}function Re(t,e,i){return de(i,t[0]*e,t[1]*e)}function ye(t,e,i){const n=i||new Array(2);return n[0]=t[0]-e[0],n[1]=t[1]-e[1],n}function Ja(t,e,i){return de(i,t[0]*e[0],t[1]*e[1])}function eo(t,e){const i=Gi(t);return de(e,t[0]/i,t[1]/i)}function Dn(t,e){return t[0]*e[0]+t[1]*e[1]}function wl(t,e){return t[0]*e[0]-t[1]*e[1]}function Tl(t,e){return t[0]*e[1]-t[1]*e[0]}function yl(t,e){return de(e,t[1],t[0])}function to(t,e,i,n){return fi(Re(ye(e,t),i),t,n)}function Gi(t){return io(t[0],t[1])}function io(t,e){return Ra(t*t+e*e)}function us(t,...e){let i;if(e=e||[],Array.isArray(t)?i=t.slice(0,2):i=[t],i.length<2)for(let n=0,r=e.length;n<r&&i.length<2;++n){const s=e[n];Array.isArray(s)?i.push(...s.slice(0,2-i.length)):i.push(s)}for(;i.length<2;)i.push(0);return i}function pe(t,e,i,n){return t=t||new Array(3),t[0]=e,t[1]=i,t[2]=n,t}function Rt(t,e,i){return pe(i,t[0]+e[0],t[1]+e[1],t[2]+e[2])}function no(t,e){return pe(e,Et(t[0]),Et(t[1]),Et(t[2]))}function it(t,e){return pe(e,t[0],t[1],t[2])}function lr(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function bl(t,e,i){return _t(t[0]-e[0])<=i&&_t(t[1]-e[1])<=i&&_t(t[2]-e[2])<=i}function hn(t){return pe(t,0,0,-1)}function Ye(t,e,i){return i=i||new Array(3),i[0]=t[1]*e[2]-t[2]*e[1],i[1]=t[2]*e[0]-t[0]*e[2],i[2]=t[0]*e[1]-t[1]*e[0],i}function ur(t,e,i){return pe(i,t[0]/e[0],t[1]/e[1],t[2]/e[2])}function ro(t){return pe(t,0,0,0)}function so(t,e){e=e||new Array(t.length*3);for(let i=0,n=0,r=t.length;i<r;++i,n+=3){const s=t[i];e[n]=s[0],e[n+1]=s[1],e[n+2]=s[2]}return e}function ao(t,e){return pe(e,bt(t[0]),bt(t[1]),bt(t[2]))}function Fn(t,e){return pe(e,1/t[0],1/t[1],1/t[2])}function nt(t,e,i){return pe(i,t[0]*e,t[1]*e,t[2]*e)}function xt(t,e,i){return pe(i,t[0]-e[0],t[1]-e[1],t[2]-e[2])}function oo(t,e,i){return pe(i,t[0]*e[0],t[1]*e[1],t[2]*e[2])}function co(t,e,i,n){return Rt(nt(xt(e,t),i),t,n)}function hs(t){return lo(t[0],t[1],t[2])}function lo(t,e,i){return Ra(t*t+e*e+i*i)}function ds(t,e,i){return pe(i,Tt(t[0],e[0]),Tt(t[1],e[1]),Tt(t[2],e[2]))}function fs(t,e,i){return pe(i,yt(t[0],e[0]),yt(t[1],e[1]),yt(t[2],e[2]))}function ct(t,e){e=e||new Array(3);const i=hs(t);return e[0]=t[0]/i,e[1]=t[1]/i,e[2]=t[2]/i,e}function hr(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function El(t,e){return t[0]*e[0]-t[1]*e[1]-t[2]*e[2]}function _l(t,e){return pe(e,t[2],t[1],t[0])}function ki(t,...e){let i;if(e=e||[],Array.isArray(t)?i=t.slice(0,3):i=[t],i.length<3)for(let n=0,r=e.length;n<r&&i.length<3;++n){const s=e[n];Array.isArray(s)?i.push(...s.slice(0,3-i.length)):i.push(s)}for(;i.length<3;)i.push(0);return i}function Rl(t,e,i){return i=i||[0,0,0],ct(Ye(Ye(t,e,i),t,i),i)}function xl(t,e,i){return i=i||[0,0,0],ct(Ye(t,e,i),i)}function Al(t,e,i){return i=i||[0,0,0],ct(Ye(e,t,i),i)}function Sl(t,e,i){return i=i||[0,0,0],ct(Ye(t,Ye(t,e,i),i),i)}function fe(t,e,i,n,r){return t=t||new Array(4),t[0]=e,t[1]=i,t[2]=n,t[3]=r,t}function ps(t,e,i){return fe(i,t[0]+e[0],t[1]+e[1],t[2]+e[2],t[3]+e[3])}function Ml(t,e,i){return fe(i,t[0]+e[0],t[1]+e[1],t[2]+e[2],t[3])}function uo(t,e){return fe(e,Et(t[0]),Et(t[1]),Et(t[2]),Et(t[3]))}function At(t,e){return fe(e,t[0],t[1],t[2],t[3])}function gs(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function Il(t,e,i){return _t(t[0]-e[0])<=i&&_t(t[1]-e[1])<=i&&_t(t[2]-e[2])<=i&&_t(t[3]-e[3])<=i}function ho(t){return fe(t,0,0,-1,0)}function fo(t,e,i){return fe(i,0,0,0,1)}function po(t,e,i){return fe(i,t[0]/e[0],t[1]/e[1],t[2]/e[2],t[3]/e[3])}function go(t){return fe(t,0,0,0,0)}function ms(t,e){e=e||new Array(4);for(let i=0,n=0,r=t.length;i<r;++i,n+=4){const s=t[i];e[n]=s[0],e[n+1]=s[1],e[n+2]=s[2],e[n+3]=s[3]}return e}function mo(t,e){return fe(e,bt(t[0]),bt(t[1]),bt(t[2]),bt(t[3]))}function vo(t,e){return fe(e,1/t[0],1/t[1],1/t[2],1/t[3])}function vs(t,e,i){return fe(i,t[0]*e,t[1]*e,t[2]*e,t[3]*e)}function ws(t,e,i){return fe(i,t[0]-e[0],t[1]-e[1],t[2]-e[2],t[3]-e[3])}function wo(t,e,i){return fe(i,t[0]*e[0],t[1]*e[1],t[2]*e[2],t[3]*e[3])}function Ts(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function Ll(t,e){return t[0]*e[0]-t[1]*e[1]-t[2]*e[2]-t[3]*e[3]}function Cl(t,e){return fe(e,t[3],t[2],t[1],t[0])}function To(t,e,i,n){return ps(vs(ws(e,t),i),t,n)}function ys(t){return pi(t[0],t[1],t[2],t[3])}function pi(t,e,i,n){return Ra(t*t+e*e+i*i+n*n)}function yo(t,e,i){return fe(i,Tt(t[0],e[0]),Tt(t[1],e[1]),Tt(t[2],e[2]),Tt(t[3],e[3]))}function bo(t,e,i){return fe(i,yt(t[0],e[0]),yt(t[1],e[1]),yt(t[2],e[2]),yt(t[3],e[3]))}function Eo(t,e){const i=ys(t);return fe(e,t[0]/i,t[1]/i,t[2]/i,t[3]/i)}function dr(t,...e){let i;if(e=e||[],Array.isArray(t)?i=t.slice(0,4):i=[t],i.length<4)for(let n=0,r=e.length;n<r&&i.length<4;++n){const s=e[n];Array.isArray(s)?i.push(...s.slice(0,4-i.length)):i.push(s)}for(;i.length<4;)i.push(0);return i}function Ol(t,e){return e=e||[0,0,0,0],fe(e,((t&16711680)>>16)/255,((t&65280)>>8)/255,(t&255)/255,1)}function Nl(t,e){return e=e||[0,0,0,0],fe(e,((t&4278190080)>>24)/255,((t&16711680)>>16)/255,((t&65280)>>8)/255,(t&255)/255)}function _o(t,e,i,n){n=n||[0,0,0,0];const r=[0,0,0,0];let s,a,o,c,l;return a=t[1]*e[1]+t[2]*e[2]+t[3]*e[3]+t[0]*e[0],a<0?(a=-a,r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r[3]=-e[3]):(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3]),1-a>1e-7?(s=lp(a),o=xa(s),c=xa((1-i)*s)/o,l=xa(i*s)/o):(c=1-i,l=i),n[1]=c*t[1]+l*r[1],n[2]=c*t[2]+l*r[2],n[3]=c*t[3]+l*r[3],n[0]=c*t[0]+l*r[0],n}const Ro={add:rs,ceil:Sa,copy:Ia,compare:Ma,cross:Ca,divide:Oa,dot:za,empty:Na,flatten:Pa,floor:Da,forward:La,inverse:Fa,length:Wa,linear:Va,max:Ba,min:Ua,multiply:Ga,normalize:ka,scale:ss,subtract:as,vec:$a},xo={add:fi,ceil:ja,copy:os,compare:cs,cross:Qa,divide:cr,dot:Dn,empty:Xa,flatten:Ya,floor:qa,forward:Ha,inverse:ls,length:Gi,linear:to,max:Ka,min:Za,multiply:Ja,normalize:eo,scale:Re,subtract:ye,vec:us},Ao={add:Rt,ceil:no,copy:it,compare:lr,cross:Ye,divide:ur,dot:hr,empty:ro,flatten:so,floor:ao,forward:hn,inverse:Fn,length:hs,linear:co,max:ds,min:fs,multiply:oo,normalize:ct,scale:nt,subtract:xt,vec:ki},So={add:ps,ceil:uo,copy:At,compare:gs,cross:fo,divide:po,dot:Ts,empty:go,flatten:ms,floor:mo,forward:ho,inverse:vo,length:ys,linear:To,max:yo,min:bo,multiply:wo,normalize:Eo,scale:vs,subtract:ws,vec:dr,slerpQuat:_o};function B(t){let e;return t.length===1?(e=Ro,e):t.length===2?(e=xo,e):t.length===3?(e=Ao,e):(e=So,e)}function Pl(t){return`[${t[0]}]`}function Dl(t){return`[${t[0]}, ${t[1]}]`}function Fl(t){return`[${t[0]}, ${t[1]}, ${t[2]}]`}function Bl(t){return`[${t[0]}, ${t[1]}, ${t[2]}, ${t[3]}]`}const up=Object.freeze(Object.defineProperty({__proto__:null,V3R:$e,V4R:hl,VecMath:B,add1:rs,add2:fi,add3:Rt,add4:ps,add4by3:Ml,apply1:Fe,apply2:de,apply3:pe,apply4:fe,ceil1:Sa,ceil2:ja,ceil3:no,ceil4:uo,color4FromHex3:Ol,color4FromHex4:Nl,compare1:Ma,compare2:cs,compare3:lr,compare4:gs,copy1:Ia,copy2:os,copy3:it,copy4:At,cross1:Ca,cross2:Qa,cross3:Ye,cross4:fo,divide1:Oa,divide2:cr,divide3:ur,divide4:po,dot1:za,dot2:Dn,dot3:hr,dot4:Ts,down3:Sl,empty1:Na,empty2:Xa,empty3:ro,empty4:go,flatten1:Pa,flatten2:Ya,flatten3:so,flatten4:ms,floor1:Da,floor2:qa,floor3:ao,floor4:mo,forward1:La,forward2:Ha,forward3:hn,forward4:ho,fuzzyCompare1:pl,fuzzyCompare2:vl,fuzzyCompare3:bl,fuzzyCompare4:Il,inverse1:Fa,inverse2:ls,inverse3:Fn,inverse4:vo,isVec1:dl,isVec2:Aa,isVec3:fl,isVec4:U,left3:Al,length1:Wa,length1Components:ml,length2:Gi,length2Components:io,length3:hs,length3Components:lo,length4:ys,length4Components:pi,linear1:Va,linear2:to,linear3:co,linear4:To,max1:Ba,max2:Ka,max3:ds,max4:yo,min1:Ua,min2:Za,min3:fs,min4:bo,multiply1:Ga,multiply2:Ja,multiply3:oo,multiply4:wo,normalize1:ka,normalize2:eo,normalize3:ct,normalize4:Eo,reverse2:yl,reverse3:_l,reverse4:Cl,right3:xl,scale1:ss,scale2:Re,scale3:nt,scale4:vs,slerpQuat:_o,subtract1:as,subtract2:ye,subtract3:xt,subtract4:ws,toString1:Pl,toString2:Dl,toString3:Fl,toString4:Bl,tod1:gl,tod2:wl,tod3:El,tod4:Ll,tod_flip2:Tl,up3:Rl,vec1:$a,vec1Methods:Ro,vec2:us,vec2Methods:xo,vec3:ki,vec3Methods:Ao,vec4:dr,vec4Methods:So},Symbol.toStringTag,{value:"Module"})),{min:bs,max:Es}=Math;class te{constructor(e){this.x=0,this.y=0,this.width=0,this.height=0,this.x=e.x||e.left||0,this.y=e.y||e.top||0,this.height=e.height||(e.bottom||0)-this.y||0,this.width=e.width||(e.right||0)-this.x||0}get area(){return this.width*this.height}get bottom(){return this.y+this.height}get left(){return this.x}get mid(){return[this.x+this.width/2,this.y+this.height/2]}get right(){return this.x+this.width}get top(){return this.y}static emptyBounds(){return new te({height:0,width:0,x:0,y:0})}containsPoint(e){return!(e[0]<this.x||e[1]<this.y||e[0]>this.right||e[1]>this.bottom)}encapsulate(e){return e instanceof te?(e.x<this.x&&(this.width+=Math.abs(e.x-this.x),this.x=e.x),e.y<this.y&&(this.height+=Math.abs(e.y-this.y),this.y=e.y),this.right<e.right&&(this.width+=e.right-this.right),this.bottom<e.bottom&&(this.height+=e.bottom-this.bottom),!0):(e[0]<this.x&&(this.width+=this.x-e[0],this.x=e[0]),e[0]>this.right&&(this.width+=e[0]-this.x),e[1]<this.y&&(this.height+=this.y-e[1],this.y=e[1]),e[1]>this.bottom&&(this.height+=e[1]-this.y),!0)}encapsulateAll(e){if(e.length<=0)return;let i=Number.MAX_SAFE_INTEGER,n=Number.MIN_SAFE_INTEGER,r=Number.MAX_SAFE_INTEGER,s=Number.MIN_SAFE_INTEGER;if(e[0]instanceof te){const a=e;for(let o=0,c=a.length;o<c;++o){const l=a[o];i=bs(i,l.left),n=Es(n,l.right),r=bs(r,l.top),s=Es(s,l.bottom)}}else{const a=e;for(let o=0,c=a.length;o<c;++o){const[l,u]=a[o];i=bs(i,l),n=Es(n,l),r=bs(r,u),s=Es(s,u)}}this.x=Math.min(this.x,i),this.y=Math.min(this.y,r),this.width=Math.max(this.width,n-i),this.height=Math.max(this.height,s-r)}fits(e){return this.width===e.width&&this.height===e.height?1:this.width>=e.width&&this.height>=e.height?2:0}hitBounds(e){return!(this.right<e.x||this.x>e.right||this.bottom<e.y||this.y>e.bottom)}isInside(e){return this.x>=e.x&&this.right<=e.right&&this.y>=e.y&&this.bottom<=e.bottom}get location(){return[this.x,this.y]}toString(){return`{x: ${this.x} y:${this.y} w:${this.width} h:${this.height}}`}}function St(t,e,i){const n=`${t}`,r=parseFloat(n);return isNaN(r)?0:n.indexOf("%")>-1?r/100*e:r*i}const Bn=new WeakSet;function Mo(t,e,i){(e.width===0||e.height===0)&&(Bn.has(t)||(console.warn("An AbsolutePosition evaluated to invalid dimensions.","Please ensure that the object provided and the reference has valid dimensions","to produce dimensions with width and height that are non-zero.","item:",t,"reference:",e.toString()),Bn.add(t)));const n=te.emptyBounds();let r,s;if(t.width)n.width=St(t.width,e.width,i),t.left!==void 0?n.x=St(t.left,e.width,i):t.right!==void 0&&(n.x=e.width-St(t.right,e.width,i)-n.width);else{const a=St(t.left||0,e.width,i);r=e.width-St(t.right||0,e.width,i)-a,r<0&&(Bn.has(t)||(console.warn("An AbsolutePosition evaluated to invalid dimensions.","Please ensure that the object provided and the reference has valid dimensions","to produce dimensions with width and height that are greater than zero.","item:",t,"reference:",e.toString()),Bn.add(t))),n.x=a,n.width=r}if(t.height)n.height=St(t.height,e.height,i),t.top!==void 0?n.y=St(t.top,e.height,i):t.bottom!==void 0&&(n.y=e.height-St(t.bottom,e.height,i)-n.height);else{const a=St(t.top||0,e.height,i);s=e.height-St(t.bottom||0,e.height,i)-a,(s===void 0||s<0)&&(Bn.has(t)||(console.warn("An AbsolutePosition evaluated to invalid dimensions.","Please ensure that the object provided and the reference has valid dimensions","to produce dimensions with width and height that are greater than zero.","item:",t,"reference:",e.toString()),Bn.add(t))),n.y=a,n.height=s}return(n.width===0||n.height===0||isNaN(n.x+n.y+n.width+n.height))&&(n.x=0,n.y=0,n.width=e.width,n.height=e.height),n}class gi{constructor(e,i,n=!1,r=!1){this._isInstanced=!1,this._fullUpdate=!1,this.normalize=!1,this._needsUpdate=!1,this._updateRange={count:-1,offset:-1},this.data=e,this.size=i,this._isDynamic=n,this._isInstanced=r}get isDynamic(){return this._isDynamic}get isInstanced(){return this._isInstanced}get fullUpdate(){return this._fullUpdate}get needsUpdate(){return this._needsUpdate}get updateRange(){return this._updateRange}set updateRange(e){this._updateRange=e,this._needsUpdate=!0}destroy(){this.gl&&this.gl.proxy.disposeAttribute(this)}resolve(){this._needsUpdate=!1,this._fullUpdate=!1}setDynamic(e){this._isDynamic=e,this._needsUpdate=!0,this._fullUpdate=!0}}class zi{constructor(){this._attributes={},this.maxInstancedCount=0,this.isInstanced=!1}get attributes(){return new Map(Object.entries(this._attributes))}addAttribute(e,i){this._attributes[e]=i,this.isInstanced=!1;let n;Object.values(this._attributes).forEach(r=>{const s=r.isInstanced?1:0;n===void 0&&(n=s),(n^s)===1&&(this.isInstanced=!0)})}removeAttribute(e){delete this._attributes[e]}destroy(){this.attributes.forEach(e=>e.destroy()),this.gl&&this.gl.proxy.disposeGeometry(this)}}d.GLSettings=void 0,(t=>{(e=>{(i=>{i[i.RGBA4=0]="RGBA4",i[i.RGB565=1]="RGB565",i[i.RGB5_A1=2]="RGB5_A1",i[i.R8=3]="R8",i[i.R8UI=4]="R8UI",i[i.R8I=5]="R8I",i[i.R16UI=6]="R16UI",i[i.R16I=7]="R16I",i[i.R32UI=8]="R32UI",i[i.R32I=9]="R32I",i[i.RG8=10]="RG8",i[i.RG8UI=11]="RG8UI",i[i.RG8I=12]="RG8I",i[i.RG16UI=13]="RG16UI",i[i.RG16I=14]="RG16I",i[i.RG32UI=15]="RG32UI",i[i.RG32I=16]="RG32I",i[i.RGB8=17]="RGB8",i[i.RGBA8=18]="RGBA8",i[i.SRGB8_ALPHA8=19]="SRGB8_ALPHA8",i[i.RGB10_A2=20]="RGB10_A2",i[i.RGBA8UI=21]="RGBA8UI",i[i.RGBA8I=22]="RGBA8I",i[i.RGB10_A2UI=23]="RGB10_A2UI",i[i.RGBA16UI=24]="RGBA16UI",i[i.RGBA16I=25]="RGBA16I",i[i.RGBA32I=26]="RGBA32I",i[i.RGBA32UI=27]="RGBA32UI"})(e.ColorBufferFormat||(e.ColorBufferFormat={})),(i=>{i[i.DEPTH_COMPONENT16=0]="DEPTH_COMPONENT16",i[i.DEPTH_STENCIL=1]="DEPTH_STENCIL",i[i.DEPTH_COMPONENT24=2]="DEPTH_COMPONENT24",i[i.DEPTH_COMPONENT32F=3]="DEPTH_COMPONENT32F",i[i.DEPTH24_STENCIL8=4]="DEPTH24_STENCIL8",i[i.DEPTH32F_STENCIL8=5]="DEPTH32F_STENCIL8"})(e.DepthBufferFormat||(e.DepthBufferFormat={})),(i=>{i[i.STENCIL_INDEX8=0]="STENCIL_INDEX8"})(e.StencilBufferFormat||(e.StencilBufferFormat={}))})(t.RenderTarget||(t.RenderTarget={})),(e=>{(i=>{i[i.NoBlending=-1]="NoBlending",i[i.NormalBlending=1]="NormalBlending",i[i.AdditiveBlending=2]="AdditiveBlending",i[i.SubtractiveBlending=3]="SubtractiveBlending",i[i.MultiplyBlending=4]="MultiplyBlending"})(e.Blending||(e.Blending={})),(i=>{i[i.Zero=-1]="Zero",i[i.One=1]="One",i[i.SrcColor=2]="SrcColor",i[i.OneMinusSrcColor=3]="OneMinusSrcColor",i[i.SrcAlpha=4]="SrcAlpha",i[i.OneMinusSrcAlpha=5]="OneMinusSrcAlpha",i[i.DstAlpha=6]="DstAlpha",i[i.OneMinusDstAlpha=7]="OneMinusDstAlpha",i[i.DstColor=8]="DstColor",i[i.OneMinusDstColor=9]="OneMinusDstColor"})(e.BlendingDstFactor||(e.BlendingDstFactor={})),(i=>{i[i.Zero=-1]="Zero",i[i.One=1]="One",i[i.SrcColor=2]="SrcColor",i[i.OneMinusSrcColor=3]="OneMinusSrcColor",i[i.SrcAlpha=4]="SrcAlpha",i[i.OneMinusSrcAlpha=5]="OneMinusSrcAlpha",i[i.DstAlpha=6]="DstAlpha",i[i.OneMinusDstAlpha=7]="OneMinusDstAlpha",i[i.DstColor=8]="DstColor",i[i.OneMinusDstColor=9]="OneMinusDstColor",i[i.SrcAlphaSaturate=10]="SrcAlphaSaturate"})(e.BlendingSrcFactor||(e.BlendingSrcFactor={})),(i=>{i[i.Add=-1]="Add",i[i.Subtract=1]="Subtract",i[i.ReverseSubtract=2]="ReverseSubtract"})(e.BlendingEquations||(e.BlendingEquations={})),(i=>{i[i.NEVER=-1]="NEVER",i[i.LESS=1]="LESS",i[i.EQUAL=2]="EQUAL",i[i.LESS_OR_EQUAL=3]="LESS_OR_EQUAL",i[i.GREATER=4]="GREATER",i[i.NOTEQUAL=5]="NOTEQUAL",i[i.GREATER_OR_EQUAL=6]="GREATER_OR_EQUAL",i[i.ALWAYS=7]="ALWAYS"})(e.DepthFunctions||(e.DepthFunctions={})),(i=>{i[i.NONE=-1]="NONE",i[i.CW=1]="CW",i[i.CCW=2]="CCW",i[i.BOTH=3]="BOTH"})(e.CullSide||(e.CullSide={}))})(t.Material||(t.Material={})),(e=>{(i=>{i[i.LINE_LOOP=0]="LINE_LOOP",i[i.LINE_STRIP=1]="LINE_STRIP",i[i.LINES=2]="LINES",i[i.POINTS=3]="POINTS",i[i.TRIANGLE_FAN=4]="TRIANGLE_FAN",i[i.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",i[i.TRIANGLES=6]="TRIANGLES"})(e.DrawMode||(e.DrawMode={}))})(t.Model||(t.Model={})),(e=>{(i=>{i[i.TEXTURE_2D=0]="TEXTURE_2D",i[i.CUBE_MAP=1]="CUBE_MAP"})(e.TextureBindingTarget||(e.TextureBindingTarget={})),(i=>{i[i.REPEAT=-1]="REPEAT",i[i.CLAMP_TO_EDGE=1]="CLAMP_TO_EDGE",i[i.MIRRORED_REPEAT=2]="MIRRORED_REPEAT"})(e.Wrapping||(e.Wrapping={})),(i=>{i[i.Nearest=-1]="Nearest",i[i.NearestMipMapNearest=1]="NearestMipMapNearest",i[i.NearestMipMapLinear=2]="NearestMipMapLinear",i[i.Linear=3]="Linear",i[i.LinearMipMapNearest=4]="LinearMipMapNearest",i[i.LinearMipMapLinear=5]="LinearMipMapLinear"})(e.TextureMinFilter||(e.TextureMinFilter={})),(i=>{i[i.Nearest=-1]="Nearest",i[i.Linear=1]="Linear"})(e.TextureMagFilter||(e.TextureMagFilter={})),(i=>{i[i.UnsignedByte=-1]="UnsignedByte",i[i.UnsignedShort_5_6_5=1]="UnsignedShort_5_6_5",i[i.UnsignedShort_4_4_4_4=2]="UnsignedShort_4_4_4_4",i[i.UnsignedShort_5_5_5_1=3]="UnsignedShort_5_5_5_1",i[i.UnsignedShort=4]="UnsignedShort",i[i.UnsignedInt=5]="UnsignedInt",i[i.UnsignedInt_24_8=6]="UnsignedInt_24_8",i[i.Byte=7]="Byte",i[i.Short=8]="Short",i[i.Int=9]="Int",i[i.Float=10]="Float",i[i.HalfFloat=11]="HalfFloat",i[i.UnsignedInt_2_10_10_10_REV=12]="UnsignedInt_2_10_10_10_REV",i[i.UnsignedInt_10F_11F_11F_REV=13]="UnsignedInt_10F_11F_11F_REV",i[i.UnsignedInt_5_9_9_9_REV=14]="UnsignedInt_5_9_9_9_REV",i[i.Float32UnsignedInt_24_8_REV=15]="Float32UnsignedInt_24_8_REV"})(e.SourcePixelFormat||(e.SourcePixelFormat={})),(i=>{i[i.Alpha=-1]="Alpha",i[i.DepthComponent=1]="DepthComponent",i[i.DepthStencil=2]="DepthStencil",i[i.Luminance=3]="Luminance",i[i.LuminanceAlpha=4]="LuminanceAlpha",i[i.RGB=5]="RGB",i[i.RGBA=6]="RGBA",i[i.RGBE=7]="RGBE",i[i.R8=8]="R8",i[i.R16F=9]="R16F",i[i.R32F=10]="R32F",i[i.R8UI=11]="R8UI",i[i.RG8=12]="RG8",i[i.RG16F=13]="RG16F",i[i.RG32F=14]="RG32F",i[i.RG8UI=15]="RG8UI",i[i.RG16UI=16]="RG16UI",i[i.RG32UI=17]="RG32UI",i[i.RGB8=18]="RGB8",i[i.SRGB8=19]="SRGB8",i[i.RGB565=20]="RGB565",i[i.R11F_G11F_B10F=21]="R11F_G11F_B10F",i[i.RGB9_E5=22]="RGB9_E5",i[i.RGB16F=23]="RGB16F",i[i.RGB32F=24]="RGB32F",i[i.RGB8UI=25]="RGB8UI",i[i.RGBA8=26]="RGBA8",i[i.SRGB8_ALPHA8=27]="SRGB8_ALPHA8",i[i.RGB5_A1=28]="RGB5_A1",i[i.RGB10_A2=29]="RGB10_A2",i[i.RGBA4=30]="RGBA4",i[i.RGBA16F=31]="RGBA16F",i[i.RGBA32F=32]="RGBA32F",i[i.RGBA8UI=33]="RGBA8UI",i[i.DEPTH_COMPONENT16=34]="DEPTH_COMPONENT16",i[i.DEPTH_COMPONENT24=35]="DEPTH_COMPONENT24",i[i.DEPTH_COMPONENT32F=36]="DEPTH_COMPONENT32F",i[i.RGBA32UI=37]="RGBA32UI",i[i.RGB32UI=38]="RGB32UI",i[i.RGBA16UI=39]="RGBA16UI",i[i.RGB16UI=40]="RGB16UI",i[i.RGBA32I=41]="RGBA32I",i[i.RGB32I=42]="RGB32I",i[i.RGBA16I=43]="RGBA16I",i[i.RGB16I=44]="RGB16I",i[i.RGBA8I=45]="RGBA8I",i[i.RGB8I=46]="RGB8I",i[i.RED_INTEGER=47]="RED_INTEGER",i[i.RG_INTEGER=48]="RG_INTEGER",i[i.RGB_INTEGER=49]="RGB_INTEGER",i[i.RGBA_INTEGER=50]="RGBA_INTEGER"})(e.TexelDataType||(e.TexelDataType={})),(i=>{i[i.ONE=1]="ONE",i[i.TWO=2]="TWO",i[i.FOUR=4]="FOUR",i[i.EIGHT=8]="EIGHT"})(e.PackAlignment||(e.PackAlignment={})),(i=>{i[i.ONE=1]="ONE",i[i.TWO=2]="TWO",i[i.FOUR=4]="FOUR",i[i.EIGHT=8]="EIGHT"})(e.UnpackAlignment||(e.UnpackAlignment={}))})(t.Texture||(t.Texture={})),(e=>{(i=>{i[i.ALPHA=0]="ALPHA",i[i.RGB=1]="RGB",i[i.RGBA=2]="RGBA"})(e.ReadFilter||(e.ReadFilter={})),(i=>{i[i.UNSIGNED_BYTE=0]="UNSIGNED_BYTE",i[i.UNSIGNED_SHORT_5_6_5=1]="UNSIGNED_SHORT_5_6_5",i[i.UNSIGNED_SHORT_4_4_4_4=2]="UNSIGNED_SHORT_4_4_4_4",i[i.UNSIGNED_SHORT_5_5_5_1=3]="UNSIGNED_SHORT_5_5_5_1",i[i.FLOAT=4]="FLOAT"})(e.ReadTargetArrayFormat||(e.ReadTargetArrayFormat={}))})(t.Renderer||(t.Renderer={}))})(d.GLSettings||(d.GLSettings={}));function hp(t,e){const i={attributeCount:0,attributes:[],uniformCount:0,uniforms:[]},n=t.getProgramParameter(e,t.ACTIVE_UNIFORMS),r=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),s={35664:"FLOAT_VEC2",35665:"FLOAT_VEC3",35666:"FLOAT_VEC4",35667:"INT_VEC2",35668:"INT_VEC3",35669:"INT_VEC4",35670:"BOOL",35671:"BOOL_VEC2",35672:"BOOL_VEC3",35673:"BOOL_VEC4",35674:"FLOAT_MAT2",35675:"FLOAT_MAT3",35676:"FLOAT_MAT4",35678:"SAMPLER_2D",35680:"SAMPLER_CUBE",5120:"BYTE",5121:"UNSIGNED_BYTE",5122:"SHORT",5123:"UNSIGNED_SHORT",5124:"INT",5125:"UNSIGNED_INT",5126:"FLOAT"},a={35664:1,35665:1,35666:1,35667:1,35668:1,35669:1,35670:1,35671:1,35672:1,35673:1,35674:1,35675:3,35676:4,35678:1,35680:1,5120:1,5121:1,5122:1,5123:1,5124:1,5125:1,5126:1};for(let o=0;o<n;++o){const c=t.getActiveUniform(e,o);c.typeName=s[c.type],i.uniforms.push(c),i.uniformCount+=c.size,c.size=c.size*a[c.type]}for(let o=0;o<r;o++){const c=t.getActiveAttrib(e,o);c.typeName=s[c.type],i.attributes.push(c),i.attributeCount+=c.size}return i}const Ul=class{static print(){return Object.assign({},Ul)}};let L=Ul;L.VAO=!1,L.DEPTH_TEXTURE=!1,L.MAX_VERTEX_UNIFORMS=0,L.MAX_FRAGMENT_UNIFORMS=0,L.MAX_VERTEX_ATTRIBUTES=0,L.WEBGL_SUPPORTED=!1,L.MAX_TEXTURE_SIZE=0,L.HARDWARE_INSTANCING=!1,L.MRT_EXTENSION=!1,L.MRT=!1,L.MAX_COLOR_ATTACHMENTS=0,L.SHADERS_3_0=!1,L.WEBGL_VERSION="none",L.FLOAT_TEXTURE_READ={half:!1,full:!1,halfLinearFilter:!1,fullLinearFilter:!1},L.FLOAT_TEXTURE_WRITE={half:!1,full:!1};function dp(){function t(){try{const n=document.createElement("canvas");let r;return r=n.getContext("webgl2"),r?(L.WEBGL_VERSION="webgl2",r):(r=n.getContext("webgl"),r?(L.WEBGL_VERSION="webgl",r):(r=n.getContext("experimental-webgl"),r?(L.WEBGL_VERSION="experimental-webgl",r):null))}catch{return null}}function e(n){L.FLOAT_TEXTURE_READ.fullLinearFilter=!!n.getExtension("OES_texture_float_linear"),L.FLOAT_TEXTURE_READ.halfLinearFilter=!!n.getExtension("OES_texture_half_float_linear");const r=n.createTexture();if(n.bindTexture(n.TEXTURE_2D,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.getError()!==n.NO_ERROR)throw new Error("WebGLStat could not create a texture");const s=n.getExtension("OES_texture_float")||n.getExtension("EXT_color_buffer_float");if(n.getExtension("WEBGL_color_buffer_float"),s){n.texImage2D(n.TEXTURE_2D,0,n instanceof WebGL2RenderingContext?n.RGBA32F:n.RGBA,2,2,0,n.RGBA,n.FLOAT,null),n.getError()===n.NO_ERROR&&(L.FLOAT_TEXTURE_READ.full=!0);const u=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,u),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,r,0),n.bindTexture(n.TEXTURE_2D,null),n.checkFramebufferStatus(n.FRAMEBUFFER)===n.FRAMEBUFFER_COMPLETE&&(L.FLOAT_TEXTURE_WRITE.full=!0),n.deleteFramebuffer(u),n.deleteTexture(r)}const a=n.createTexture();if(n.bindTexture(n.TEXTURE_2D,a),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.getError()!==n.NO_ERROR)throw new Error("WebGLStat could not create a texture");const o=n.getExtension("OES_texture_half_float")||n.getExtension("EXT_color_buffer_float");if(o){n.texImage2D(n.TEXTURE_2D,0,n instanceof WebGL2RenderingContext?n.RGBA16F:n.RGBA,2,2,0,n.RGBA,n instanceof WebGL2RenderingContext?n.HALF_FLOAT:o.HALF_FLOAT_OES,null),n.getError()===n.NO_ERROR&&(L.FLOAT_TEXTURE_READ.full=!0);const u=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,u),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,a,0),n.bindTexture(n.TEXTURE_2D,null),n.checkFramebufferStatus(n.FRAMEBUFFER)===n.FRAMEBUFFER_COMPLETE&&(L.FLOAT_TEXTURE_WRITE.full=!0),n.deleteFramebuffer(u),n.deleteTexture(a)}}const i=t();if(i)if(L.WEBGL_SUPPORTED=!0,L.MAX_VERTEX_UNIFORMS=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),L.MAX_FRAGMENT_UNIFORMS=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),L.MAX_VERTEX_ATTRIBUTES=i.getParameter(i.MAX_VERTEX_ATTRIBS),L.MAX_TEXTURE_SIZE=i.getParameter(i.MAX_TEXTURE_SIZE),e(i),i instanceof WebGL2RenderingContext)L.VAO=!0,L.MRT=!0,L.HARDWARE_INSTANCING=!0,L.SHADERS_3_0=!0,L.HARDWARE_INSTANCING=!0,L.DEPTH_TEXTURE=!0,L.MAX_COLOR_ATTACHMENTS=i.getParameter(i.MAX_COLOR_ATTACHMENTS);else{L.VAO=!!i.getExtension("OES_vertex_array_object"),L.HARDWARE_INSTANCING=!!i.getExtension("ANGLE_instanced_arrays");const n=i.getExtension("WEBGL_draw_buffers");L.MRT_EXTENSION=!!n,L.MRT=!!n,L.DEPTH_TEXTURE=!!i.getExtension("WEBGL_depth_texture"),n&&(L.MAX_COLOR_ATTACHMENTS=i.getParameter(n.MAX_COLOR_ATTACHMENTS_WEBGL))}window.WebGLStat=L}dp();function _s(t,e){switch(e){case d.GLSettings.Model.DrawMode.LINES:return t.LINES;case d.GLSettings.Model.DrawMode.LINE_LOOP:return t.LINE_LOOP;case d.GLSettings.Model.DrawMode.LINE_STRIP:return t.LINE_STRIP;case d.GLSettings.Model.DrawMode.POINTS:return t.POINTS;case d.GLSettings.Model.DrawMode.TRIANGLES:return t.TRIANGLES;case d.GLSettings.Model.DrawMode.TRIANGLE_FAN:return t.TRIANGLE_FAN;case d.GLSettings.Model.DrawMode.TRIANGLE_STRIP:return t.TRIANGLE_STRIP;default:return t.TRIANGLES}}function dn(t,e){switch(e){case d.GLSettings.Texture.TexelDataType.Alpha:return t.ALPHA;case d.GLSettings.Texture.TexelDataType.DepthComponent:return t.DEPTH_COMPONENT;case d.GLSettings.Texture.TexelDataType.DepthStencil:return t.DEPTH_STENCIL;case d.GLSettings.Texture.TexelDataType.Luminance:return t.LUMINANCE;case d.GLSettings.Texture.TexelDataType.LuminanceAlpha:return t.LUMINANCE_ALPHA;case d.GLSettings.Texture.TexelDataType.RGB:return t.RGB;case d.GLSettings.Texture.TexelDataType.RGBA:return t.RGBA;default:if(t instanceof WebGL2RenderingContext)switch(e){case d.GLSettings.Texture.TexelDataType.R8:return t.R8;case d.GLSettings.Texture.TexelDataType.R16F:return t.R16F;case d.GLSettings.Texture.TexelDataType.R32F:return t.R32F;case d.GLSettings.Texture.TexelDataType.R8UI:return t.R8UI;case d.GLSettings.Texture.TexelDataType.RG8:return t.RG8;case d.GLSettings.Texture.TexelDataType.RG16F:return t.RG16F;case d.GLSettings.Texture.TexelDataType.RG32F:return t.RG32F;case d.GLSettings.Texture.TexelDataType.RG8UI:return t.RG8UI;case d.GLSettings.Texture.TexelDataType.RG16UI:return t.RG16UI;case d.GLSettings.Texture.TexelDataType.RG32UI:return t.RG32UI;case d.GLSettings.Texture.TexelDataType.RGB8:return t.RGB8;case d.GLSettings.Texture.TexelDataType.SRGB8:return t.SRGB8;case d.GLSettings.Texture.TexelDataType.RGB565:return t.RGB565;case d.GLSettings.Texture.TexelDataType.R11F_G11F_B10F:return t.R11F_G11F_B10F;case d.GLSettings.Texture.TexelDataType.RGB9_E5:return t.RGB9_E5;case d.GLSettings.Texture.TexelDataType.RGB16F:return t.RGB16F;case d.GLSettings.Texture.TexelDataType.RGB32F:return t.RGB32F;case d.GLSettings.Texture.TexelDataType.RGB8UI:return t.RGB8UI;case d.GLSettings.Texture.TexelDataType.RGBA8:return t.RGBA8;case d.GLSettings.Texture.TexelDataType.SRGB8_ALPHA8:return t.SRGB8_ALPHA8;case d.GLSettings.Texture.TexelDataType.RGB5_A1:return t.RGB5_A1;case d.GLSettings.Texture.TexelDataType.RGB10_A2:return t.RGB10_A2;case d.GLSettings.Texture.TexelDataType.RGBA4:return t.RGBA4;case d.GLSettings.Texture.TexelDataType.RGBA16F:return t.RGBA16F;case d.GLSettings.Texture.TexelDataType.RGBA32F:return L.FLOAT_TEXTURE_READ.full&&L.FLOAT_TEXTURE_WRITE.full?t.RGBA32F:t.RGBA16F;case d.GLSettings.Texture.TexelDataType.RGBA8UI:return t.RGBA8UI;case d.GLSettings.Texture.TexelDataType.DEPTH_COMPONENT16:return t.DEPTH_COMPONENT16;case d.GLSettings.Texture.TexelDataType.DEPTH_COMPONENT24:return t.DEPTH_COMPONENT24;case d.GLSettings.Texture.TexelDataType.DEPTH_COMPONENT32F:return t.DEPTH_COMPONENT32F;case d.GLSettings.Texture.TexelDataType.RGBA32UI:return t.RGBA32UI;case d.GLSettings.Texture.TexelDataType.RGB32UI:return t.RGB32UI;case d.GLSettings.Texture.TexelDataType.RGBA16UI:return t.RGBA16UI;case d.GLSettings.Texture.TexelDataType.RGB16UI:return t.RGB16UI;case d.GLSettings.Texture.TexelDataType.RGBA32I:return t.RGBA32I;case d.GLSettings.Texture.TexelDataType.RGB32I:return t.RGB32I;case d.GLSettings.Texture.TexelDataType.RGBA16I:return t.RGBA16I;case d.GLSettings.Texture.TexelDataType.RGB16I:return t.RGB16I;case d.GLSettings.Texture.TexelDataType.RGBA8I:return t.RGBA8I;case d.GLSettings.Texture.TexelDataType.RGB8I:return t.RGB8I;default:return console.warn("An unsupported texel format was provided that is not supported in WebGL 1 or 2"),t.RGBA}return console.warn("An Unsupported texel format was provided. Some formats are only available in WebGL 2",e),t.RGBA}}function fr(t,e){switch(e){case d.GLSettings.Texture.SourcePixelFormat.Byte:return t.BYTE;case d.GLSettings.Texture.SourcePixelFormat.Float:return t.FLOAT;case d.GLSettings.Texture.SourcePixelFormat.HalfFloat:return console.warn("Unsupported HALF_FLOAT"),t.BYTE;case d.GLSettings.Texture.SourcePixelFormat.Int:return t.INT;case d.GLSettings.Texture.SourcePixelFormat.Short:return t.SHORT;case d.GLSettings.Texture.SourcePixelFormat.UnsignedByte:return t.UNSIGNED_BYTE;case d.GLSettings.Texture.SourcePixelFormat.UnsignedInt:return t.UNSIGNED_INT;case d.GLSettings.Texture.SourcePixelFormat.UnsignedShort:return t.UNSIGNED_SHORT;case d.GLSettings.Texture.SourcePixelFormat.UnsignedShort_4_4_4_4:return t.UNSIGNED_SHORT_4_4_4_4;case d.GLSettings.Texture.SourcePixelFormat.UnsignedShort_5_5_5_1:return t.UNSIGNED_SHORT_5_5_5_1;case d.GLSettings.Texture.SourcePixelFormat.UnsignedShort_5_6_5:return t.UNSIGNED_SHORT_5_6_5;default:return console.warn("An Unsupported input image format was provided",e),t.BYTE}}function fn(t,e){switch(e){case d.GLSettings.Texture.TextureMagFilter.Linear:return t.LINEAR;case d.GLSettings.Texture.TextureMagFilter.Nearest:return t.NEAREST}}function mi(t,e,i){switch(e){case d.GLSettings.Texture.TextureMinFilter.Linear:return t.LINEAR;case d.GLSettings.Texture.TextureMinFilter.Nearest:return t.NEAREST;case d.GLSettings.Texture.TextureMinFilter.LinearMipMapLinear:return i?t.LINEAR_MIPMAP_LINEAR:t.LINEAR;case d.GLSettings.Texture.TextureMinFilter.LinearMipMapNearest:return i?t.LINEAR_MIPMAP_NEAREST:t.LINEAR;case d.GLSettings.Texture.TextureMinFilter.NearestMipMapLinear:return i?t.NEAREST_MIPMAP_LINEAR:t.NEAREST;case d.GLSettings.Texture.TextureMinFilter.NearestMipMapNearest:return i?t.NEAREST_MIPMAP_NEAREST:t.NEAREST;default:return t.LINEAR}}function Gl(t,e){switch(e){case d.GLSettings.RenderTarget.ColorBufferFormat.RGB565:return t.RGB565;case d.GLSettings.RenderTarget.ColorBufferFormat.RGB5_A1:return t.RGB5_A1;case d.GLSettings.RenderTarget.ColorBufferFormat.RGBA4:return t.RGBA4;default:if(t instanceof WebGL2RenderingContext)switch(e){case d.GLSettings.RenderTarget.ColorBufferFormat.R8:return t.R8;case d.GLSettings.RenderTarget.ColorBufferFormat.R8UI:return t.R8UI;case d.GLSettings.RenderTarget.ColorBufferFormat.R8I:return t.R8I;case d.GLSettings.RenderTarget.ColorBufferFormat.R16UI:return t.R16UI;case d.GLSettings.RenderTarget.ColorBufferFormat.R16I:return t.R16I;case d.GLSettings.RenderTarget.ColorBufferFormat.R32UI:return t.R32UI;case d.GLSettings.RenderTarget.ColorBufferFormat.R32I:return t.R32I;case d.GLSettings.RenderTarget.ColorBufferFormat.RG8:return t.RG8;case d.GLSettings.RenderTarget.ColorBufferFormat.RG8UI:return t.RG8UI;case d.GLSettings.RenderTarget.ColorBufferFormat.RG8I:return t.RG8I;case d.GLSettings.RenderTarget.ColorBufferFormat.RG16UI:return t.RG16UI;case d.GLSettings.RenderTarget.ColorBufferFormat.RG16I:return t.RG16I;case d.GLSettings.RenderTarget.ColorBufferFormat.RG32UI:return t.RG32UI;case d.GLSettings.RenderTarget.ColorBufferFormat.RG32I:return t.RG32I;case d.GLSettings.RenderTarget.ColorBufferFormat.RGB8:return t.RGB8;case d.GLSettings.RenderTarget.ColorBufferFormat.RGBA8:return t.RGBA8;case d.GLSettings.RenderTarget.ColorBufferFormat.SRGB8_ALPHA8:return t.SRGB8_ALPHA8;case d.GLSettings.RenderTarget.ColorBufferFormat.RGB10_A2:return t.RGB10_A2;case d.GLSettings.RenderTarget.ColorBufferFormat.RGBA8UI:return t.RGBA8UI;case d.GLSettings.RenderTarget.ColorBufferFormat.RGBA8I:return t.RGBA8I;case d.GLSettings.RenderTarget.ColorBufferFormat.RGB10_A2UI:return t.RGB10_A2UI;case d.GLSettings.RenderTarget.ColorBufferFormat.RGBA16UI:return t.RGBA16UI;case d.GLSettings.RenderTarget.ColorBufferFormat.RGBA16I:return t.RGBA16I;case d.GLSettings.RenderTarget.ColorBufferFormat.RGBA32I:return t.RGBA32I;case d.GLSettings.RenderTarget.ColorBufferFormat.RGBA32UI:return t.RGBA32UI}return t.RGBA4}}function kl(t,e){switch(e){case d.GLSettings.RenderTarget.DepthBufferFormat.DEPTH_COMPONENT16:return t.DEPTH_COMPONENT16;case d.GLSettings.RenderTarget.DepthBufferFormat.DEPTH_STENCIL:return t.DEPTH_STENCIL;default:if(t instanceof WebGL2RenderingContext)switch(e){case d.GLSettings.RenderTarget.DepthBufferFormat.DEPTH_COMPONENT24:return t.DEPTH_COMPONENT24;case d.GLSettings.RenderTarget.DepthBufferFormat.DEPTH_COMPONENT32F:return t.DEPTH_COMPONENT32F;case d.GLSettings.RenderTarget.DepthBufferFormat.DEPTH24_STENCIL8:return t.DEPTH24_STENCIL8;case d.GLSettings.RenderTarget.DepthBufferFormat.DEPTH32F_STENCIL8:return t.DEPTH32F_STENCIL8}return t.DEPTH_COMPONENT16}}function zl(t,e){switch(e){case d.GLSettings.RenderTarget.StencilBufferFormat.STENCIL_INDEX8:return t.STENCIL_INDEX8;default:return t.STENCIL_INDEX8}}function Io(t,e){switch(e){case d.GLSettings.Texture.Wrapping.CLAMP_TO_EDGE:return t.CLAMP_TO_EDGE;case d.GLSettings.Texture.Wrapping.MIRRORED_REPEAT:return t.MIRRORED_REPEAT;case d.GLSettings.Texture.Wrapping.REPEAT:return t.REPEAT}}function pr(t,e,i,n,r){if(n)return t.COLOR_ATTACHMENT0;const s=e.drawBuffers;if(r){if(s instanceof WebGL2RenderingContext)switch(i){case-2:return t.BACK;case-1:return t.NONE;case 0:return s.DRAW_BUFFER0;case 1:return s.DRAW_BUFFER1;case 2:return s.DRAW_BUFFER2;case 3:return s.DRAW_BUFFER3;case 4:return s.DRAW_BUFFER4;case 5:return s.DRAW_BUFFER5;case 6:return s.DRAW_BUFFER6;case 7:return s.DRAW_BUFFER7;case 8:return s.DRAW_BUFFER8;case 9:return s.DRAW_BUFFER9;case 10:return s.DRAW_BUFFER10;case 11:return s.DRAW_BUFFER11;case 12:return s.DRAW_BUFFER12;case 13:return s.DRAW_BUFFER13;case 14:return s.DRAW_BUFFER14;case 15:return s.DRAW_BUFFER15;default:console.warn("Attachments are only available for -2 - 15")}else if(s)switch(i){case-2:return t.BACK;case-1:return t.NONE;case 0:return s.DRAW_BUFFER0_WEBGL;case 1:return s.DRAW_BUFFER1_WEBGL;case 2:return s.DRAW_BUFFER2_WEBGL;case 3:return s.DRAW_BUFFER3_WEBGL;case 4:return s.DRAW_BUFFER4_WEBGL;case 5:return s.DRAW_BUFFER5_WEBGL;case 6:return s.DRAW_BUFFER6_WEBGL;case 7:return s.DRAW_BUFFER7_WEBGL;case 8:return s.DRAW_BUFFER8_WEBGL;case 9:return s.DRAW_BUFFER9_WEBGL;case 10:return s.DRAW_BUFFER10_WEBGL;case 11:return s.DRAW_BUFFER11_WEBGL;case 12:return s.DRAW_BUFFER12_WEBGL;case 13:return s.DRAW_BUFFER13_WEBGL;case 14:return s.DRAW_BUFFER14_WEBGL;case 15:return s.DRAW_BUFFER15_WEBGL;default:console.warn("Attachments are only available for 0 - 15")}}else if(s instanceof WebGL2RenderingContext)switch(i){case-2:return t.BACK;case-1:return t.NONE;case 0:return s.COLOR_ATTACHMENT0;case 1:return s.COLOR_ATTACHMENT1;case 2:return s.COLOR_ATTACHMENT2;case 3:return s.COLOR_ATTACHMENT3;case 4:return s.COLOR_ATTACHMENT4;case 5:return s.COLOR_ATTACHMENT5;case 6:return s.COLOR_ATTACHMENT6;case 7:return s.COLOR_ATTACHMENT7;case 8:return s.COLOR_ATTACHMENT8;case 9:return s.COLOR_ATTACHMENT9;case 10:return s.COLOR_ATTACHMENT10;case 11:return s.COLOR_ATTACHMENT11;case 12:return s.COLOR_ATTACHMENT12;case 13:return s.COLOR_ATTACHMENT13;case 14:return s.COLOR_ATTACHMENT14;case 15:return s.COLOR_ATTACHMENT15;default:console.warn("Attachments are only available for -2 - 15")}else if(s)switch(i){case-2:return t.BACK;case-1:return t.NONE;case 0:return s.COLOR_ATTACHMENT0_WEBGL;case 1:return s.COLOR_ATTACHMENT1_WEBGL;case 2:return s.COLOR_ATTACHMENT2_WEBGL;case 3:return s.COLOR_ATTACHMENT3_WEBGL;case 4:return s.COLOR_ATTACHMENT4_WEBGL;case 5:return s.COLOR_ATTACHMENT5_WEBGL;case 6:return s.COLOR_ATTACHMENT6_WEBGL;case 7:return s.COLOR_ATTACHMENT7_WEBGL;case 8:return s.COLOR_ATTACHMENT8_WEBGL;case 9:return s.COLOR_ATTACHMENT9_WEBGL;case 10:return s.COLOR_ATTACHMENT10_WEBGL;case 11:return s.COLOR_ATTACHMENT11_WEBGL;case 12:return s.COLOR_ATTACHMENT12_WEBGL;case 13:return s.COLOR_ATTACHMENT13_WEBGL;case 14:return s.COLOR_ATTACHMENT14_WEBGL;case 15:return s.COLOR_ATTACHMENT15_WEBGL;default:console.warn("Attachments are only available for 0 - 15")}return t.COLOR_ATTACHMENT0}function Vl(t,e){return t.TEXTURE0+e}function Lo(t,e){return e-t.TEXTURE0}function fp(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Co={exports:{}},Oo={exports:{}},gr=1e3,mr=gr*60,vr=mr*60,wr=vr*24,pp=wr*365.25,gp=function(t,e){e=e||{};var i=typeof t;if(i==="string"&&t.length>0)return mp(t);if(i==="number"&&isNaN(t)===!1)return e.long?wp(t):vp(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))};function mp(t){if(t=String(t),!(t.length>100)){var e=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(t);if(e){var i=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return i*pp;case"days":case"day":case"d":return i*wr;case"hours":case"hour":case"hrs":case"hr":case"h":return i*vr;case"minutes":case"minute":case"mins":case"min":case"m":return i*mr;case"seconds":case"second":case"secs":case"sec":case"s":return i*gr;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return i;default:return}}}}function vp(t){return t>=wr?Math.round(t/wr)+"d":t>=vr?Math.round(t/vr)+"h":t>=mr?Math.round(t/mr)+"m":t>=gr?Math.round(t/gr)+"s":t+"ms"}function wp(t){return Rs(t,wr,"day")||Rs(t,vr,"hour")||Rs(t,mr,"minute")||Rs(t,gr,"second")||t+" ms"}function Rs(t,e,i){if(!(t<e))return t<e*1.5?Math.floor(t/e)+" "+i:Math.ceil(t/e)+" "+i+"s"}(function(t,e){e=t.exports=n.debug=n.default=n,e.coerce=c,e.disable=a,e.enable=s,e.enabled=o,e.humanize=gp,e.instances=[],e.names=[],e.skips=[],e.formatters={};function i(l){var u=0,h;for(h in l)u=(u<<5)-u+l.charCodeAt(h),u|=0;return e.colors[Math.abs(u)%e.colors.length]}function n(l){var u;function h(){if(h.enabled){var f=h,p=+new Date,g=p-(u||p);f.diff=g,f.prev=u,f.curr=p,u=p;for(var m=new Array(arguments.length),T=0;T<m.length;T++)m[T]=arguments[T];m[0]=e.coerce(m[0]),typeof m[0]!="string"&&m.unshift("%O");var w=0;m[0]=m[0].replace(/%([a-zA-Z%])/g,function(b,x){if(b==="%%")return b;w++;var R=e.formatters[x];if(typeof R=="function"){var N=m[w];b=R.call(f,N),m.splice(w,1),w--}return b}),e.formatArgs.call(f,m);var y=h.log||e.log||console.log.bind(console);y.apply(f,m)}}return h.namespace=l,h.enabled=e.enabled(l),h.useColors=e.useColors(),h.color=i(l),h.destroy=r,typeof e.init=="function"&&e.init(h),e.instances.push(h),h}function r(){var l=e.instances.indexOf(this);return l!==-1?(e.instances.splice(l,1),!0):!1}function s(l){e.save(l),e.names=[],e.skips=[];var u,h=(typeof l=="string"?l:"").split(/[\s,]+/),f=h.length;for(u=0;u<f;u++)h[u]&&(l=h[u].replace(/\*/g,".*?"),l[0]==="-"?e.skips.push(new RegExp("^"+l.substr(1)+"$")):e.names.push(new RegExp("^"+l+"$")));for(u=0;u<e.instances.length;u++){var p=e.instances[u];p.enabled=e.enabled(p.namespace)}}function a(){e.enable("")}function o(l){if(l[l.length-1]==="*")return!0;var u,h;for(u=0,h=e.skips.length;u<h;u++)if(e.skips[u].test(l))return!1;for(u=0,h=e.names.length;u<h;u++)if(e.names[u].test(l))return!0;return!1}function c(l){return l instanceof Error?l.stack||l.message:l}})(Oo,Oo.exports);var Tp=Oo.exports;(function(t,e){e=t.exports=Tp,e.log=r,e.formatArgs=n,e.save=s,e.load=a,e.useColors=i,e.storage=typeof chrome<"u"&&typeof chrome.storage<"u"?chrome.storage.local:o(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function i(){return typeof window<"u"&&window.process&&window.process.type==="renderer"?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}e.formatters.j=function(c){try{return JSON.stringify(c)}catch(l){return"[UnexpectedJSONParseError]: "+l.message}};function n(c){var l=this.useColors;if(c[0]=(l?"%c":"")+this.namespace+(l?" %c":" ")+c[0]+(l?"%c ":" ")+"+"+e.humanize(this.diff),!!l){var u="color: "+this.color;c.splice(1,0,u,"color: inherit");var h=0,f=0;c[0].replace(/%[a-zA-Z%]/g,function(p){p!=="%%"&&(h++,p==="%c"&&(f=h))}),c.splice(f,0,u)}}function r(){return typeof console=="object"&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}function s(c){try{c==null?e.storage.removeItem("debug"):e.storage.debug=c}catch{}}function a(){var c;try{c=e.storage.debug}catch{}return!c&&typeof process<"u"&&"env"in process&&(c=process.env.DEBUG),c}e.enable(a());function o(){try{return window.localStorage}catch{}}})(Co,Co.exports);var yp=Co.exports;const xe=fp(yp);class Wl{constructor(e){this._destroyed=!1,this._internalFormat=d.GLSettings.RenderTarget.ColorBufferFormat.RGBA4,this.needsSettingsUpdate=!1,this._size=[0,0],this.size=e.size||this.size,this.internalFormat=e.internalFormat??this.internalFormat}get destroyed(){return this._destroyed}get internalFormat(){return this._internalFormat}set internalFormat(e){this.needsSettingsUpdate=!0,this._internalFormat=e}get size(){return this._size}set size(e){this.needsSettingsUpdate=!0,this._size=e}destroy(){this.gl&&this.gl.proxy.disposeColorBuffer(this),this._destroyed=!0}}var No=(t=>(t[t.INVALID=0]="INVALID",t[t.ONE=1]="ONE",t[t.TWO=2]="TWO",t[t.THREE=3]="THREE",t[t.FOUR=4]="FOUR",t))(No||{}),C=(t=>(t[t.ONE=1]="ONE",t[t.TWO=2]="TWO",t[t.THREE=3]="THREE",t[t.FOUR=4]="FOUR",t[t.MAT4X4=16]="MAT4X4",t[t.ATLAS=99]="ATLAS",t))(C||{});const $l={[1]:1,[2]:2,[3]:3,[4]:4,[16]:16,[99]:4};var E=(t=>(t[t.ONE=1]="ONE",t[t.TWO=2]="TWO",t[t.THREE=3]="THREE",t[t.FOUR=4]="FOUR",t[t.MATRIX3=9]="MATRIX3",t[t.MATRIX4=16]="MATRIX4",t[t.FLOAT_ARRAY=97]="FLOAT_ARRAY",t[t.VEC4_ARRAY=98]="VEC4_ARRAY",t[t.TEXTURE=99]="TEXTURE",t))(E||{}),Be=(t=>(t[t.ONE=1]="ONE",t[t.TWO=2]="TWO",t[t.THREE=3]="THREE",t[t.FOUR=4]="FOUR",t))(Be||{}),lt=(t=>(t[t.SCREEN_256TH=-256]="SCREEN_256TH",t[t.SCREEN_128TH=-128]="SCREEN_128TH",t[t.SCREEN_64TH=-64]="SCREEN_64TH",t[t.SCREEN_32ND=-32]="SCREEN_32ND",t[t.SCREEN_16TH=-16]="SCREEN_16TH",t[t.SCREEN_8TH=-8]="SCREEN_8TH",t[t.SCREEN_QUARTER=-4]="SCREEN_QUARTER",t[t.SCREEN_HALF=-2]="SCREEN_HALF",t[t.SCREEN=-1]="SCREEN",t[t._2=2]="_2",t[t._4=4]="_4",t[t._8=8]="_8",t[t._16=16]="_16",t[t._32=32]="_32",t[t._64=64]="_64",t[t._128=128]="_128",t[t._256=256]="_256",t[t._512=512]="_512",t[t._1024=1024]="_1024",t[t._2048=2048]="_2048",t[t._4096=4096]="_4096",t))(lt||{}),le=(t=>(t[t.ATLAS=0]="ATLAS",t[t.FONT=1]="FONT",t[t.TEXTURE=2]="TEXTURE",t[t.COLOR_BUFFER=3]="COLOR_BUFFER",t))(le||{}),re=(t=>(t[t.zyx=0]="zyx",t[t.zyz=1]="zyz",t[t.zxy=2]="zxy",t[t.zxz=3]="zxz",t[t.yxz=4]="yxz",t[t.yxy=5]="yxy",t[t.yzx=6]="yzx",t[t.yzy=7]="yzy",t[t.xyz=8]="xyz",t[t.xyx=9]="xyx",t[t.xzy=10]="xzy",t[t.xzx=11]="xzx",t))(re||{});function bp(t){return t.size!==void 0&&t.size<=4}function Ep(t){return!!(t&&t.resource)}var A=(t=>(t[t.VERTEX=1]="VERTEX",t[t.FRAGMENT=2]="FRAGMENT",t[t.ALL=3]="ALL",t))(A||{});function xs(){}const _p=/\s/g,Po=/\s/,pn=Po.test.bind(Po),jl=/\n\r|\n|\r/g,Do=/\n\r|\n|\r/,Rp=Do.test.bind(Do);function xp(t){return t}var X=(t=>(t[t.NONE=0]="NONE",t[t.SINGLE=1]="SINGLE",t))(X||{}),Le=(t=>(t[t.CHANGE=0]="CHANGE",t[t.INSERT=1]="INSERT",t[t.REMOVE=2]="REMOVE",t))(Le||{}),Fo=(t=>(t[t.NO_WEBGL_CONTEXT=0]="NO_WEBGL_CONTEXT",t))(Fo||{}),Ae=(t=>(t[t.UNIFORM=1]="UNIFORM",t[t.INSTANCE_ATTRIBUTE=2]="INSTANCE_ATTRIBUTE",t[t.INSTANCE_ATTRIBUTE_PACKING=3]="INSTANCE_ATTRIBUTE_PACKING",t))(Ae||{}),As=(t=>(t[t.LINEAR=0]="LINEAR",t))(As||{});function vi(t){return t!==void 0&&t.charCodeAt!==void 0}function Hl(t){return t!==void 0&&t.toExponential!==void 0}function Ap(t){return t!==void 0&&t.call!==void 0&&t.apply!==void 0}function Vi(t){return t===!0||t===!1}var $=(t=>(t[t.NONE=0]="NONE",t[t.BLANK=1]="BLANK",t[t.COLOR=2]="COLOR",t[t.DEPTH=3]="DEPTH",t[t.NORMAL=4]="NORMAL",t[t.PICKING=5]="PICKING",t[t.POSITION=6]="POSITION",t[t.POSITION_X=7]="POSITION_X",t[t.POSITION_Y=8]="POSITION_Y",t[t.POSITION_Z=9]="POSITION_Z",t[t.LIGHTS=10]="LIGHTS",t[t.LIGHTS2=11]="LIGHTS2",t[t.LIGHTS3=12]="LIGHTS3",t[t.ALPHA=13]="ALPHA",t[t.BETA=14]="BETA",t[t.GAMMA=15]="GAMMA",t[t.DELTA=16]="DELTA",t[t.ACCUMULATION1=17]="ACCUMULATION1",t[t.ACCUMULATION2=18]="ACCUMULATION2",t[t.ACCUMULATION3=19]="ACCUMULATION3",t[t.ACCUMULATION4=20]="ACCUMULATION4",t[t.COEFFICIENT1=21]="COEFFICIENT1",t[t.COEFFICIENT2=22]="COEFFICIENT2",t[t.COEFFICIENT3=23]="COEFFICIENT3",t[t.COEFFICIENT4=24]="COEFFICIENT4",t[t.ANGLE1=25]="ANGLE1",t[t.ANGLE2=26]="ANGLE2",t[t.ANGLE3=27]="ANGLE3",t[t.ANGLE4=28]="ANGLE4",t[t.COLOR2=29]="COLOR2",t[t.COLOR3=30]="COLOR3",t[t.COLOR4=31]="COLOR4",t[t.GLOW=32]="GLOW",t[t.BLUR=33]="BLUR",t))($||{});let Sp=1;function G(){return++Sp}let Mp=0;function Ip(){return++Mp%16777215}class se{constructor(e){this._uid=G(),this._destroyed=!1,this._flipY=!1,this._format=d.GLSettings.Texture.TexelDataType.RGBA,this._generateMipmaps=!1,this._internalFormat=d.GLSettings.Texture.TexelDataType.RGBA,this._magFilter=d.GLSettings.Texture.TextureMagFilter.Linear,this._minFilter=d.GLSettings.Texture.TextureMinFilter.LinearMipMapLinear,this.needsDataUpload=!1,this.needsPartialDataUpload=!1,this.needsSettingsUpdate=!1,this._packAlignment=d.GLSettings.Texture.PackAlignment.FOUR,this._premultiplyAlpha=!1,this._type=d.GLSettings.Texture.SourcePixelFormat.UnsignedByte,this._unpackAlignment=d.GLSettings.Texture.UnpackAlignment.FOUR,this._updateRegions=[],this._wrapHorizontal=d.GLSettings.Texture.Wrapping.CLAMP_TO_EDGE,this._wrapVertical=d.GLSettings.Texture.Wrapping.CLAMP_TO_EDGE,this.anisotropy=e.anisotropy||this.anisotropy,this.data=e.data||this.data,this.flipY=e.flipY||this.flipY,this.format=e.format||this.format,this.internalFormat=e.internalFormat||this.format,this.generateMipMaps=e.generateMipMaps||this.generateMipMaps,this.magFilter=e.magFilter||this.magFilter,this.minFilter=e.minFilter||this.minFilter,this.packAlignment=e.packAlignment||this.packAlignment,this.premultiplyAlpha=e.premultiplyAlpha||this.premultiplyAlpha,this.type=e.type||this.type,this.unpackAlignment=e.unpackAlignment||this.unpackAlignment,this.wrapHorizontal=e.wrapHorizontal||this.wrapHorizontal,this.wrapVertical=e.wrapVertical||this.wrapVertical}static get emptyTexture(){return Lp}get uid(){return this._uid}get destroyed(){return this._destroyed}get anisotropy(){return this._anisotropy}set anisotropy(e){this.needsSettingsUpdate=!0,this._anisotropy=e}get data(){return this._data}set data(e){this.needsDataUpload=!0,this._data=e}get flipY(){return this._flipY}set flipY(e){this.needsDataUpload=!0,this._flipY=e}get format(){return this._format}set format(e){this.needsDataUpload=!0,this._format=e}get generateMipMaps(){return this._generateMipmaps}set generateMipMaps(e){this.needsSettingsUpdate=!0,this._generateMipmaps=e}get internalFormat(){return this._internalFormat}set internalFormat(e){this.needsDataUpload=!0,this._internalFormat=e}get magFilter(){return this._magFilter}set magFilter(e){this.needsSettingsUpdate=!0,this._magFilter=e}get minFilter(){return this._minFilter}set minFilter(e){this.needsSettingsUpdate=!0,this._minFilter=e}get packAlignment(){return this._packAlignment}set packAlignment(e){this.needsSettingsUpdate=!0,this._packAlignment=e}get premultiplyAlpha(){return this._premultiplyAlpha}set premultiplyAlpha(e){this.needsSettingsUpdate=!0,this._premultiplyAlpha=e}get type(){return this._type}set type(e){this.needsDataUpload=!0,this._type=e}get unpackAlignment(){return this._unpackAlignment}set unpackAlignment(e){this.needsSettingsUpdate=!0,this._unpackAlignment=e}get updateRegions(){return this._updateRegions}get wrapHorizontal(){return this._wrapHorizontal}set wrapHorizontal(e){this.needsSettingsUpdate=!0,this._wrapHorizontal=e}get wrapVertical(){return this._wrapVertical}set wrapVertical(e){this.needsSettingsUpdate=!0,this._wrapVertical=e}get isHalfFloatTexture(){switch(this._internalFormat){case d.GLSettings.Texture.TexelDataType.R16F:case d.GLSettings.Texture.TexelDataType.RG16F:case d.GLSettings.Texture.TexelDataType.RGB16F:return!0}switch(this._type){case d.GLSettings.Texture.SourcePixelFormat.HalfFloat:return!0}return!1}get isFloatTexture(){switch(this._internalFormat){case d.GLSettings.Texture.TexelDataType.R11F_G11F_B10F:case d.GLSettings.Texture.TexelDataType.R16F:case d.GLSettings.Texture.TexelDataType.RG16F:case d.GLSettings.Texture.TexelDataType.R32F:case d.GLSettings.Texture.TexelDataType.RG32F:case d.GLSettings.Texture.TexelDataType.RGB16F:case d.GLSettings.Texture.TexelDataType.RGB32F:return!0}switch(this._type){case d.GLSettings.Texture.SourcePixelFormat.Float:case d.GLSettings.Texture.SourcePixelFormat.HalfFloat:return!0}return!1}destroy(){this.gl&&this.gl.proxy.disposeTexture(this),this._destroyed=!0,delete this._data}resolve(){this.needsDataUpload=!1,this.needsPartialDataUpload=!1,this.needsSettingsUpdate=!1,this._updateRegions=[]}update(e,i){this.needsPartialDataUpload=!0,this._updateRegions.push([e,i])}}const Lp=new se({data:{width:2,height:2,buffer:new Uint8Array(16)}}),wi=xe("performance");function Ql(t){return t&&t.buffer&&t.buffer.byteOffset!==void 0&&t.buffer.byteLength||t.buffer===null}function Un(t){return(t&t-1)===0}function Ss(t){return!!(t.gl&&t.gl.textureId&&t.gl.textureUnit>-1)}class Tr{constructor(e,i,n){this.debugContext="",this.fragmentShaders=new Map,this.vertexShaders=new Map,this.programs=new Map,this.gl=e,this.state=i,this.extensions=n}static addExtensions(e){const i=e.getExtension("ANGLE_instanced_arrays"),n=e.getExtension("WEBGL_draw_buffers"),r=e.getExtension("OES_texture_float"),s=e.getExtension("OES_texture_float_linear"),a=e.getExtension("OES_texture_half_float"),o=e.getExtension("OES_texture_half_float_linear"),c=e.getExtension("EXT_texture_filter_anisotropic"),l=e.getExtension("EXT_color_buffer_float"),u=e.getExtension("OES_vertex_array_object"),h={maxAnistropicFilter:0};return!i&&!(e instanceof WebGL2RenderingContext)&&wi("This device does not have hardware instancing. All buffering strategies will be utilizing compatibility modes."),!n&&!(e instanceof WebGL2RenderingContext)&&wi("This device does not have hardware multi-render target capabilities. The system will have to fallback to multiple render passes to multiple FBOs to achieve the same result."),c?h.maxAnistropicFilter=e.getParameter(c.MAX_TEXTURE_MAX_ANISOTROPY_EXT):wi("This device does not have hardware anisotropic filtering for textures. This property will be ignored when setting texture settings."),!u&&!(e instanceof WebGL2RenderingContext)&&wi("This device does not support Vertex Array Objects. This could cause performance issues for high numbers of draw calls."),{instancing:(e instanceof WebGL2RenderingContext?e:i)||void 0,drawBuffers:(e instanceof WebGL2RenderingContext?e:n)||void 0,anisotropicFiltering:c?{ext:c,stat:h}:void 0,renderFloatTexture:l||void 0,floatTex:(e instanceof WebGL2RenderingContext?e:r)||void 0,floatTexFilterLinear:(e instanceof WebGL2RenderingContext?e:s)||void 0,halfFloatTex:(e instanceof WebGL2RenderingContext?e:a)||void 0,halfFloatTexFilterLinear:(e instanceof WebGL2RenderingContext?e:o)||void 0,vao:(e instanceof WebGL2RenderingContext?e:u)||void 0}}clear(e,i,n){let r=0;e&&(r=r|this.gl.COLOR_BUFFER_BIT),i&&(r=r|this.gl.DEPTH_BUFFER_BIT),n&&(r=r|this.gl.STENCIL_BUFFER_BIT),this.gl.clear(r)}compileAttribute(e){if(e.gl)return;const i=this.gl,n=i.createBuffer();if(!n){console.warn(this.debugContext,"Could bot create WebGLBuffer. Printing any existing gl errors:"),this.printError();return}return this.state.bindVBO(n),i.bufferData(i.ARRAY_BUFFER,e.data,e.isDynamic?i.DYNAMIC_DRAW:i.STATIC_DRAW),e.gl={bufferId:n,type:i.ARRAY_BUFFER,proxy:this},e.resolve(),!0}compileGeometry(e){if(e.gl)return;let i=!0;if(e.gl={proxy:this},this.extensions.vao){let n;this.extensions.vao instanceof WebGL2RenderingContext?n=this.extensions.vao.createVertexArray():n=this.extensions.vao.createVertexArrayOES(),n?(this.state.disableVertexAttributeArray(),this.state.bindVAO(n),e.attributes.forEach((r,s)=>{this.updateAttribute(r)&&this.useAttribute(s,r,e)}),e.gl.vao=n,this.state.bindVAO(null)):wi("WARNING: Could not make VAO for Geometry. This is fine, but this could cause a hit on performance.")}return e.attributes.forEach(n=>{i=!!(this.compileAttribute(n)&&i)}),i}compileMaterial(e){if(e.gl)return;let i=this.vertexShaders.get(e.vertexShader)||null;if(!i){if(i=this.gl.createShader(this.gl.VERTEX_SHADER),!i){console.warn(this.debugContext,"Could not create a Vertex WebGLShader. Printing GL Errors:"),this.printError();return}if(this.gl.shaderSource(i,e.vertexShader),this.gl.compileShader(i),this.gl.isContextLost()&&console.warn("Context was lost during compilation"),!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)){console.error(this.debugContext,"VERTEX SHADER COMPILER ERROR",e.name),console.warn("Could not compile provided shader. Printing logs and errors:"),console.warn(this.lineFormatShader(e.vertexShader)),console.warn("LOGS:"),console.warn(this.gl.getShaderInfoLog(i)),this.printError(),this.gl.deleteShader(i);return}}let n=this.programs.get(i);n||(n=new Map,this.programs.set(i,n));const r={vsId:i,fsId:[],programId:[],proxy:this,programByTarget:new WeakMap,outputsByProgram:new WeakMap},s=new Set;if(!e.fragmentShader)return console.warn("A material appears to not have it's fragment shader configuration set."),!1;e.fragmentShader.forEach(o=>{var f,p;if(!n||!i)return;let c=this.fragmentShaders.get(o.source)||null;if(!c){if(c=this.gl.createShader(this.gl.FRAGMENT_SHADER),!c){console.warn(this.debugContext,"Could not create a Fragment WebGLShader. Printing GL Errors:"),this.printError();return}if(this.gl.shaderSource(c,o.source),this.gl.compileShader(c),this.gl.isContextLost()&&console.warn("Context was lost during compilation"),!this.gl.getShaderParameter(c,this.gl.COMPILE_STATUS)){console.error(this.debugContext,"FRAGMENT SHADER COMPILER ERROR:",e.name),console.warn("Could not compile provided shader. Printing logs and errors:"),console.warn(this.lineFormatShader(o.source)),console.warn("LOGS:"),console.warn(this.gl.getShaderInfoLog(c)),this.printError(),this.gl.deleteShader(c);return}}let l=n.get(c)||null;if(l)l.useCount++;else{const g=this.gl.createProgram();if(!g){console.warn(this.debugContext,"Could not create a WebGLProgram. Printing GL Errors:"),this.printError();return}if(l={useCount:1,program:g},this.gl.attachShader(g,i),this.gl.attachShader(g,c),this.gl.linkProgram(g),this.gl.validateProgram(g),!this.gl.getProgramParameter(g,this.gl.LINK_STATUS)||!this.gl.getProgramParameter(g,this.gl.VALIDATE_STATUS)){const m=this.gl.getProgramInfoLog(g);console.warn(this.debugContext,`Could not compile WebGL program. 

`,m),this.printError(),this.gl.deleteProgram(g);return}n.set(c,l)}(f=r.fsId)==null||f.push({id:c,outputTypes:o.outputTypes}),(p=r.programId)==null||p.push({id:l.program,outputTypes:o.outputTypes}),r.outputsByProgram.set(l.program,o.outputTypes),this.state.useProgram(l.program);const u=this.state.currentProgram;if(!u)return!1;const h=this.gl.getProgramParameter(u,this.gl.ACTIVE_UNIFORMS);for(let g=0;g<h;g++){const m=this.gl.getActiveUniform(u,g);m&&s.add(m.name.replace("[0]",""))}}),e.gl=r;const a=new Set;return Object.keys(e.uniforms).forEach(o=>{s.has(o)||a.add(o)}),a.forEach(o=>{delete e.uniforms[o]}),Object.keys(e.uniforms).length!==s.size?(console.warn(this.debugContext,"A program is requesting a set of uniforms:",Array.from(s.values()),"but our material only provides",Object.keys(e.uniforms),"thus the expected rendering will be considered invalid."),!1):!0}compileRenderTarget(e){if(e.isInvalid)return!1;if(e.gl)return!0;const i=this.gl,n=i.createFramebuffer();if(!n)return console.warn(this.debugContext,"Could not generate a frame buffer object. Printing GL errors:"),this.printError(),!1;this.state.bindFBO(n);const r={fboId:n,proxy:this,fboByMaterial:new WeakMap};if(Array.isArray(e.buffers.color)){if(!this.extensions.drawBuffers)return console.warn("Attempted to manage a render target with MRT but the hardware does not support MRT. Use multiple render targets instead."),!1;const l=[];let u=!0;r.colorBufferId=l;const h=e.buffers.color.length<=1;if(e.buffers.color.forEach((f,p)=>{if(u)if(f.buffer instanceof se){const g=pr(i,this.extensions,p,h,!1);l.push({data:f.buffer,outputType:f.outputType,attachment:g}),Ss(f.buffer)?i.framebufferTexture2D(i.FRAMEBUFFER,g,i.TEXTURE_2D,f.buffer.gl.textureId,0):(console.warn(this.debugContext,"Attempted to compile render target whose target texture was not ready for use."),u=!1)}else{const g=this.compileColorBuffer(f.buffer,e.width,e.height);if(g){const m=pr(i,this.extensions,p,h,!1);l.push({data:g,outputType:f.outputType,attachment:m}),i.framebufferRenderbuffer(i.FRAMEBUFFER,m,i.RENDERBUFFER,g)}}}),!u)return!1}else if(e.buffers.color!==void 0){const l=e.buffers.color;if(l.buffer instanceof se){const u=pr(i,this.extensions,0,!0,!1);if(r.colorBufferId={data:l.buffer,outputType:l.outputType,attachment:u},Ss(l.buffer))i.framebufferTexture2D(i.FRAMEBUFFER,u,i.TEXTURE_2D,l.buffer.gl.textureId,0);else return console.warn(this.debugContext,"Attempted to compile render target whose target texture was not ready for use."),!1}else{const u=this.compileColorBuffer(l.buffer,e.width,e.height);if(u){const h=pr(i,this.extensions,0,!0,!1);r.colorBufferId={data:u,outputType:l.outputType,attachment:h},i.framebufferRenderbuffer(i.FRAMEBUFFER,h,i.RENDERBUFFER,u)}}}if(e.buffers.depth!==void 0){const l=e.buffers.depth;if(l instanceof se)r.depthBufferId=l,Ss(l)&&i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_2D,l.gl.textureId,0);else if(l instanceof Wl){const u=this.compileDepthBuffer(l.internalFormat,e.width,e.height);u&&(r.depthBufferId=u,i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,u))}else{const u=this.compileDepthBuffer(l,e.width,e.height);u&&(r.depthBufferId=u,i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,u))}}if(e.buffers.stencil!==void 0){const l=e.buffers.stencil;if(l instanceof se)r.stencilBufferId=l,Ss(l)&&i.framebufferTexture2D(i.FRAMEBUFFER,i.STENCIL_ATTACHMENT,i.TEXTURE_2D,l.gl.textureId,0);else{const u=this.compileStencilBuffer(l,e.width,e.height);u&&(r.stencilBufferId=u,i.framebufferRenderbuffer(i.FRAMEBUFFER,i.STENCIL_ATTACHMENT,i.RENDERBUFFER,u))}}e.gl=r;const s=i.checkFramebufferStatus(i.FRAMEBUFFER);let a=!1,o=!1,c="";switch(s){case i.FRAMEBUFFER_COMPLETE:e.setAsValid();break;case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:c="FRAMEBUFFER_INCOMPLETE_ATTACHMENT";break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:c="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:c="FRAMEBUFFER_INCOMPLETE_DIMENSIONS";break;case i.FRAMEBUFFER_UNSUPPORTED:c="FRAMEBUFFER_UNSUPPORTED";break;default:a=!0;break}if(i instanceof WebGL2RenderingContext)switch(s){case i.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE:c="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE";break;case i.RENDERBUFFER_SAMPLES:c="RENDERBUFFER_SAMPLES";break;default:o=!0;break}return a&&o&&(console.warn(this.debugContext,"A framebuffer check failed to return a known result. This FBO for render target will be assumed failed"),console.warn("Result:",s,"Render Target:",e),c="UNKNOWN"),c?(console.warn(this.debugContext,"When creating a new FrameBuffer Object, the check on the framebuffer failed. Printing Errors:"),console.warn(c),this.printError(),console.warn("FAILED RENDER TARGET:",e),delete e.gl,e.isInvalid=!0,!1):!0}compileDepthBuffer(e,i,n){const r=this.gl,s=r.createRenderbuffer();if(!s){console.warn(this.debugContext,"Could not generate a WebGLRenderBuffer. Printing GL Errors:"),this.printError();return}return this.state.bindRBO(s),r.renderbufferStorage(r.RENDERBUFFER,kl(r,e),i,n),s}compileStencilBuffer(e,i,n){const r=this.gl,s=r.createRenderbuffer();if(!s){console.warn(this.debugContext,"Could not generate a WebGLRenderBuffer. Printing GL Errors:"),this.printError();return}return this.state.bindRBO(s),r.renderbufferStorage(r.RENDERBUFFER,zl(r,e),i,n),s}compileColorBuffer(e,i,n){const r=this.gl,s=r.createRenderbuffer();if(!s){console.warn(this.debugContext,"Could not generate a WebGLRenderBuffer. Printing GL Errors:"),this.printError();return}return this.state.bindRBO(s),r.renderbufferStorage(r.RENDERBUFFER,Gl(r,e.internalFormat),i,n),e.gl={bufferId:s,proxy:this},s}compileTexture(e){if(!e.gl||e.gl.textureId)return;if(e.gl.textureUnit<0){console.warn(this.debugContext,"A Texture object attempted to be compiled without an established Texture Unit.",e);return}this.state.setActiveTextureUnit(e.gl.textureUnit);const n=this.gl.createTexture();if(!n){console.warn(this.debugContext,"Could not generate a texture object on the GPU. Printing any gl errors:"),this.printError();return}return e.gl.textureId=n,e.needsDataUpload=!0,e.needsSettingsUpdate=!0,this.updateTextureData(e),this.updateTextureSettings(e),!0}draw(e){let i,n=[0,0];e.vertexDrawRange&&e.vertexDrawRange[0]>=0&&e.vertexDrawRange[1]>=0?n=[e.vertexDrawRange[0],e.vertexDrawRange[1]-e.vertexDrawRange[0]]:n=[0,e.vertexCount],e.drawInstances>=0&&e.geometry.isInstanced&&(i=this.extensions.instancing),!((L.MRT||L.MRT_EXTENSION)&&this.state.renderTarget&&!this.state.drawBuffers.find(r=>r!==this.gl.NONE))&&(i&&i instanceof WebGL2RenderingContext?i.drawArraysInstanced(_s(this.gl,e.drawMode),n[0],n[1],e.drawInstances):i?i.drawArraysInstancedANGLE(_s(this.gl,e.drawMode),n[0],n[1],e.drawInstances):this.gl.drawArrays(_s(this.gl,e.drawMode),n[0],n[1]),this.state.setDrawBuffers([],!0))}disposeAttribute(e){e.gl&&(this.gl.deleteBuffer(e.gl.bufferId),delete e.gl)}disposeColorBuffer(e){e.gl&&(e.gl.bufferId&&this.disposeRenderBuffer(e.gl.bufferId),delete e.gl)}disposeGeometry(e){e.gl&&this.extensions.vao&&e.gl.vao&&(this.extensions.vao instanceof WebGL2RenderingContext?this.extensions.vao.deleteVertexArray(e.gl.vao):this.extensions.vao.deleteVertexArrayOES(e.gl.vao))}disposeMaterial(e){if(e.gl){const{vsId:i,fsId:n,programId:r}=e.gl;let s=this.programs.get(i);s||(s=new Map,this.gl.deleteShader(i));for(let a=0,o=n.length;a<o;++a){const c=n[a];let l=s.get(c);l||(l={useCount:0,program:r}),l.useCount--,l.useCount<1&&(this.gl.deleteProgram(l.program),s.delete(c),s.size<=0&&this.gl.deleteShader(i));let u=!1;this.programs.forEach(h=>{h.has(c)&&(u=!0)}),u||this.gl.deleteShader(c)}}delete e.gl}disposeRenderBuffer(e){this.gl.deleteRenderbuffer(e)}disposeRenderTarget(e){e.gl&&(Array.isArray(e.gl.colorBufferId)?e.gl.colorBufferId.forEach(i=>{i.data instanceof se&&!e.retainTextureTargets?this.disposeTexture(i.data):i.data instanceof WebGLRenderbuffer&&this.disposeRenderBuffer(i.data)}):e.gl.colorBufferId&&e.gl.colorBufferId.data instanceof se&&!e.retainTextureTargets?this.disposeTexture(e.gl.colorBufferId.data):e.gl.colorBufferId instanceof WebGLRenderbuffer&&this.disposeRenderBuffer(e.gl.colorBufferId.data),e.gl.depthBufferId instanceof se&&!e.retainTextureTargets?this.disposeTexture(e.gl.depthBufferId):e.gl.depthBufferId instanceof WebGLRenderbuffer&&this.disposeRenderBuffer(e.gl.depthBufferId),e.gl.stencilBufferId instanceof se&&!e.retainTextureTargets?this.disposeTexture(e.gl.stencilBufferId):e.gl.stencilBufferId instanceof WebGLRenderbuffer&&this.disposeRenderBuffer(e.gl.stencilBufferId),this.gl.deleteFramebuffer(e.gl.fboId),delete e.gl)}disposeTexture(e){e.gl&&!e.destroyed&&(this.gl.deleteTexture(e.gl.textureId),this.state.freeTextureUnit(e)),delete e.gl}static getContext(e,i){const n=[L.WEBGL_VERSION,"webgl","webgl2","experimental-webgl"];let r=null,s={};for(let a=0;a<n.length;++a){const o=n[a],c=e.getContext(o,i);if(c&&(c instanceof WebGLRenderingContext||c instanceof WebGL2RenderingContext)){wi("Generated GL Context of version with attributes:",o,i),r=c,s=Tr.addExtensions(r);break}}return{context:r,extensions:s}}printError(){const e=this.gl.getError();switch(e){case this.gl.NO_ERROR:console.warn("GL Error: No Error");break;case this.gl.INVALID_ENUM:console.warn("GL Error: INVALID ENUM");break;case this.gl.INVALID_VALUE:console.warn("GL Error: INVALID_VALUE");break;case this.gl.INVALID_OPERATION:console.warn("GL Error: INVALID OPERATION");break;case this.gl.INVALID_FRAMEBUFFER_OPERATION:console.warn("GL Error: INVALID FRAMEBUFFER OPERATION");break;case this.gl.OUT_OF_MEMORY:console.warn("GL Error: OUT OF MEMORY");break;case this.gl.CONTEXT_LOST_WEBGL:console.warn("GL Error: CONTEXT LOST WEBGL");break;default:console.warn("GL Error: GL Context output an unrecognized error value:",e);break}}lineFormat(e){const i=e.split(`
`),n=String(i.length).length+1;return`
${i.map((r,s)=>`${Array(n-String(s+1).length).join(" ")}${s+1}: ${r}`).join(`
`)}`}lineFormatShader(e){return e?vi(e)?this.lineFormat(e):e.forEach(i=>`
SHADER FOR OUTPUT TYPES: ${i.outputTypes} ${this.lineFormat(i.source)}`):"NO SHADER FOUND"}updateTexture(e){if(!e.gl||e.gl.textureUnit<0){console.warn(this.debugContext,"Can not update or compile a texture that does not have an established texture unit.",e);return}this.compileTexture(e),this.updateTextureData(e),this.updateTexturePartialData(e),this.updateTextureSettings(e),e.resolve()}updateTextureData(e){if(!e.needsDataUpload||!e.gl||!e.gl.textureId)return;if(e.gl.textureUnit<0){console.warn(this.debugContext,"A Texture object attempted to update it's data without an established Texture Unit.",e);return}const i=this.gl;if(this.state.setActiveTextureUnit(e.gl.textureUnit),this.state.bindTexture(e,d.GLSettings.Texture.TextureBindingTarget.TEXTURE_2D),e.needsSettingsUpdate=!0,this.updateTextureSettings(e),i instanceof WebGLRenderingContext||i instanceof WebGL2RenderingContext){if(Ql(e.data)){(!Un(e.data.width)||!Un(e.data.height))&&wi("Created a texture that is not using power of 2 dimensions.");const n=dn(i,e.internalFormat),r=dn(i,e.format);i instanceof WebGLRenderingContext&&n!==r&&console.warn("WebGL 1 requires format and data format to be identical"),i.texImage2D(i.TEXTURE_2D,0,n,e.data.width,e.data.height,0,r,fr(i,e.type),e.data.buffer)}else e.data&&((!Un(e.data.width)||!Un(e.data.height))&&wi("Created a texture that is not using power of 2 dimensions. %o",e),i.texImage2D(i.TEXTURE_2D,0,dn(i,e.internalFormat),dn(i,e.format),fr(i,e.type),e.data));e.generateMipMaps&&i.generateMipmap(i.TEXTURE_2D)}e.data&&(e.data={width:e.data.width,height:e.data.height,buffer:null}),e.needsDataUpload=!1}updateTexturePartialData(e){if(!e.needsPartialDataUpload||!e.gl||!e.gl.textureId)return;if(e.gl.textureUnit<0){console.warn(this.debugContext,"A Texture object attempted to update it's data without an established Texture Unit.",e);return}const i=this.gl;this.state.setActiveTextureUnit(e.gl.textureUnit),this.state.bindTexture(e,d.GLSettings.Texture.TextureBindingTarget.TEXTURE_2D),e.updateRegions.forEach(n=>{const r=n[0],s=n[1];(i instanceof WebGLRenderingContext||i instanceof WebGL2RenderingContext)&&(Ql(r)?i.texSubImage2D(i.TEXTURE_2D,0,s.x,s.y,r.width,r.height,dn(i,e.format),fr(i,e.type),r.buffer):r&&i.texSubImage2D(i.TEXTURE_2D,0,s.x,s.y,dn(i,e.format),fr(i,e.type),r),e.generateMipMaps&&i.generateMipmap(i.TEXTURE_2D))}),e.needsPartialDataUpload=!1}updateTextureSettings(e){if(!e.needsSettingsUpdate||!e.gl||!e.data||!e.gl.textureId)return;if(e.gl.textureUnit<0){console.warn(this.debugContext,"A Texture object attempted to update it's settings without an established Texture Unit.",e);return}const i=Un(e.data.width)&&Un(e.data.height),n=this.gl;this.state.setActiveTextureUnit(e.gl.textureUnit),this.state.bindTexture(e,d.GLSettings.Texture.TextureBindingTarget.TEXTURE_2D);let r,s;if(e.isHalfFloatTexture)if(L.FLOAT_TEXTURE_READ.halfLinearFilter)switch(r=fn(n,e.magFilter),e.minFilter){case d.GLSettings.Texture.TextureMinFilter.Nearest:case d.GLSettings.Texture.TextureMinFilter.NearestMipMapLinear:case d.GLSettings.Texture.TextureMinFilter.NearestMipMapNearest:s=mi(n,d.GLSettings.Texture.TextureMinFilter.Nearest,e.generateMipMaps);break;case d.GLSettings.Texture.TextureMinFilter.Linear:case d.GLSettings.Texture.TextureMinFilter.LinearMipMapLinear:case d.GLSettings.Texture.TextureMinFilter.LinearMipMapNearest:s=mi(n,d.GLSettings.Texture.TextureMinFilter.Nearest,e.generateMipMaps);break}else r=fn(n,d.GLSettings.Texture.TextureMagFilter.Nearest),s=mi(n,d.GLSettings.Texture.TextureMinFilter.Nearest,e.generateMipMaps);else if(e.isFloatTexture)if(L.FLOAT_TEXTURE_READ.fullLinearFilter)switch(r=fn(n,e.magFilter),e.minFilter){case d.GLSettings.Texture.TextureMinFilter.Nearest:case d.GLSettings.Texture.TextureMinFilter.NearestMipMapLinear:case d.GLSettings.Texture.TextureMinFilter.NearestMipMapNearest:s=mi(n,d.GLSettings.Texture.TextureMinFilter.Nearest,e.generateMipMaps);break;case d.GLSettings.Texture.TextureMinFilter.Linear:case d.GLSettings.Texture.TextureMinFilter.LinearMipMapLinear:case d.GLSettings.Texture.TextureMinFilter.LinearMipMapNearest:s=mi(n,d.GLSettings.Texture.TextureMinFilter.Nearest,e.generateMipMaps);break}else r=fn(n,d.GLSettings.Texture.TextureMagFilter.Nearest),s=mi(n,d.GLSettings.Texture.TextureMinFilter.Nearest,e.generateMipMaps);else!i&&n instanceof WebGLRenderingContext?(r=fn(n,d.GLSettings.Texture.TextureMagFilter.Linear),s=mi(n,d.GLSettings.Texture.TextureMinFilter.Linear,e.generateMipMaps)):(r=fn(n,e.magFilter),s=mi(n,e.minFilter,e.generateMipMaps));if(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,s),e.isFloatTexture||(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,Io(n,e.wrapHorizontal)),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,Io(n,e.wrapVertical))),e.isFloatTexture||(n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.premultiplyAlpha),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,e.flipY)),this.extensions.anisotropicFiltering){const{ext:a,stat:o}=this.extensions.anisotropicFiltering,c=Math.min(o.maxAnistropicFilter,Math.floor(e.anisotropy||0));!isNaN(c)&&!e.isFloatTexture&&n.texParameterf(n.TEXTURE_2D,a.TEXTURE_MAX_ANISOTROPY_EXT,c)}e.needsSettingsUpdate=!1}updateAttribute(e){if(!e.gl)return this.compileAttribute(e);if(!e.fullUpdate&&!e.needsUpdate)return!0;const i=this.gl;if(e.fullUpdate||e.updateRange.count<0||e.updateRange.offset<0)this.state.bindVBO(e.gl.bufferId),i.bufferData(i.ARRAY_BUFFER,e.data,e.isDynamic?i.DYNAMIC_DRAW:i.STATIC_DRAW);else if(e.updateRange.count>0){this.state.bindVBO(e.gl.bufferId);const n=e.updateRange.offset;i.bufferSubData(i.ARRAY_BUFFER,n*4,e.data.subarray(n,n+e.updateRange.count))}return e.resolve(),!0}useAttribute(e,i,n){if(!this.state.currentProgram||!i.gl)return!1;i.gl.locations=i.gl.locations||new Map;let r=i.gl.locations.get(this.state.currentProgram);if(r===void 0&&(r=this.gl.getAttribLocation(this.state.currentProgram,e),r===-1&&wi("WARN: An attribute is not being used with the current material: %o",e,i),i.gl.locations.set(this.state.currentProgram,r)),r!==-1){switch(this.state.bindVBO(i.gl.bufferId),i.size){case 1:case 2:case 3:case 4:this.state.willUseVertexAttributeArray(r),this.gl.vertexAttribPointer(r,i.size,this.gl.FLOAT,i.normalize,0,0),n.isInstanced&&i.isInstanced&&this.extensions.instancing?this.state.setVertexAttributeArrayDivisor(r,1):this.state.setVertexAttributeArrayDivisor(r,0);break;default:{const s=Math.ceil(i.size/4);for(let a=0;a<s;++a)this.state.willUseVertexAttributeArray(r+a),this.gl.vertexAttribPointer(r+a,4,this.gl.FLOAT,i.normalize,s*4*4,a*16),n.isInstanced&&i.isInstanced&&this.extensions.instancing?this.state.setVertexAttributeArrayDivisor(r+a,1):this.state.setVertexAttributeArrayDivisor(r+a,0);break}}return!0}}}var be=(t=>(t[t.FLOAT=0]="FLOAT",t[t.VEC2=1]="VEC2",t[t.VEC3=2]="VEC3",t[t.VEC4=3]="VEC4",t[t.VEC4_ARRAY=4]="VEC4_ARRAY",t[t.FLOAT_ARRAY=5]="FLOAT_ARRAY",t[t.MATRIX3x3=6]="MATRIX3x3",t[t.MATRIX4x4=7]="MATRIX4x4",t[t.TEXTURE=8]="TEXTURE",t))(be||{});function Cp(t){return t.type===1}function Op(t){return t.type===2}function Np(t){return t.type===3}function Xl(t){return t.type===4}function Pp(t){return t.type===6}function Dp(t){return t.type===7}function Fp(t){return t.type===8}function Bp(t){return t.type===0}const Up=window.OffscreenCanvas||xs;function gn(t){return t instanceof Up}var gt=(t=>(t[t.INVALID=0]="INVALID",t[t.VALID=1]="VALID",t[t.NO_RENDER_TARGET_MATCHES=2]="NO_RENDER_TARGET_MATCHES",t))(gt||{});class Wi{constructor(e){this.isInvalid=!1,this._uid=G(),this._validFramebuffer=!1,this._disabledTargets=new Set,this.retainTextureTargets=!1,this._buffers={color:Array.isArray(e.buffers.color)?e.buffers.color.slice(0):e.buffers.color,depth:e.buffers.depth,stencil:e.buffers.stencil},this._width=e.width||0,this._height=e.height||0,this.retainTextureTargets=e.retainTextureTargets||!1,this.calculateDimensions()}get uid(){return this._uid}get buffers(){return{color:Array.isArray(this._buffers.color)?this._buffers.color.slice(0):this._buffers.color,depth:this._buffers.depth,stencil:this._buffers.stencil}}get height(){return this._height}get width(){return this._width}get validFramebuffer(){return this._validFramebuffer}get disabledTargets(){return this._disabledTargets}set disabledTargets(e){this._disabledTargets=e}calculateDimensions(){const e=[];if(this._buffers.color instanceof se)e.push(this._buffers.color);else if(Array.isArray(this._buffers.color))for(let i=0,n=this._buffers.color.length;i<n;++i){const r=this._buffers.color[i];r.buffer instanceof se&&e.push(r.buffer)}else this._buffers.color&&this._buffers.color.buffer instanceof se&&e.push(this._buffers.color.buffer);if(this._buffers.depth instanceof se&&e.push(this._buffers.depth),this._buffers.stencil instanceof se&&e.push(this._buffers.stencil),e.length>0&&e[0].data){const{width:i,height:n}=e[0].data;for(let r=0,s=e.length;r<s;++r){const a=e[r];if(!a.data){console.warn("A texture specified for thie RenderTarget did not have any data associated with it.");return}const{width:o,height:c}=a.data;(o!==i||c!==n)&&(console.warn("Texture applied to the render target is invalid as it does not match dimensions of all textures applied:",a,e,"The texture will be removed as a target for the render target"),this.removeTextureFromBuffer(a))}this._width=i,this._height=n}(!this._width||!this._height)&&console.warn("A RenderTarget was not able to establish valid dimensions. This target had no texture buffers and did not specify valid width and height values.",this)}dispose(){this.gl&&this.gl.proxy.disposeRenderTarget(this)}getBuffers(){return Array.isArray(this.buffers.color)?this.buffers.color:this.buffers.color?[this.buffers.color]:[]}getGLBuffers(){return this.gl?Array.isArray(this.gl.colorBufferId)?this.gl.colorBufferId:[this.gl.colorBufferId]:(this.isInvalid||console.warn("Attempted to retrieve gl buffers before the render target was compiled."),[])}getOutputTypes(){return this.getBuffers().map(e=>e.outputType)}getSize(){return[this._width,this._height]}getTextures(){const e=[];return Array.isArray(this.buffers.color)?this.buffers.color.forEach(i=>{i.buffer instanceof se&&e.push(i.buffer)}):this.buffers.color&&this.buffers.color.buffer instanceof se&&e.push(this.buffers.color.buffer),this.buffers.depth instanceof se&&e.push(this.buffers.depth),this.buffers.stencil instanceof se&&e.push(this.buffers.stencil),e}isColorTarget(){var e;if(Array.isArray(this.buffers.color)){if(this.buffers.color.length===1)return this.buffers.color[0].outputType===$.COLOR}else return((e=this.buffers.color)==null?void 0:e.outputType)===$.COLOR;return!1}removeTextureFromBuffer(e){var i;if(Array.isArray(this._buffers.color)){const n=this._buffers.color.find(s=>s.buffer===e);if(!n)return;const r=this._buffers.color.indexOf(n);r>-1&&this._buffers.color.splice(r,1)}else((i=this._buffers.color)==null?void 0:i.buffer)===e&&delete this._buffers.color;this._buffers.depth===e&&delete this._buffers.depth,this._buffers.stencil===e&&delete this._buffers.stencil}setSize(e,i){this.dispose(),this._width=e,this._height=i,this.getTextures().forEach(r=>{r.data={buffer:null,height:i,width:e}})}setAsValid(){this._validFramebuffer=!0}}const Yl=xe("performance");class ql{constructor(e,i){this.debugContext="",this._textureUnitToTexture=new Map,this._freeUnits=[],this._blendingEnabled=!0,this._blendDstFactor=d.GLSettings.Material.BlendingDstFactor.One,this._blendSrcFactor=d.GLSettings.Material.BlendingDstFactor.One,this._blendEquation=d.GLSettings.Material.BlendingEquations.Add,this._cullFace=d.GLSettings.Material.CullSide.NONE,this._colorMask=[!0,!0,!0,!0],this._clearColor=[0,0,0,1],this._depthFunc=d.GLSettings.Material.DepthFunctions.ALWAYS,this._depthTestEnabled=!0,this._depthMask=!0,this._ditheringEnabled=!0,this._boundFBO=null,this._renderTarget=null,this._boundRBO=null,this._boundVAO=null,this._boundVBO=null,this._boundTexture={id:null,unit:-1},this._currentProgram=null,this._scissorTestEnabled=!1,this._scissorBounds={x:0,y:0,width:1,height:1},this._currentUniforms={},this._activeTextureUnit=-1,this._drawBuffers=[],this._textureWillBeUsed=new Map,this._viewport={x:0,y:0,width:100,height:100},this._enabledVertexAttributeArray=[],this._willUseVertexAttributeArray=[],this._vertexAttributeArrayDivisor=new Map,this.gl=e,this.extensions=i;const n=this.gl.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS);for(let r=0;r<n;++r)this._freeUnits.push(Vl(e,r));this._activeTextureUnit=e.TEXTURE0}get blendingEnabled(){return this._blendingEnabled}get blendDstFactor(){return this._blendDstFactor}get blendSrcFactor(){return this._blendSrcFactor}get blendEquation(){return this._blendEquation}get cullFace(){return this._cullFace}get colorMask(){return this._colorMask}get clearColor(){return this._clearColor}get depthFunc(){return this._depthFunc}get depthTestEnabled(){return this._depthTestEnabled}get depthMask(){return this._depthMask}get ditheringEnabled(){return this._ditheringEnabled}get boundFBO(){return this._boundFBO}get renderTarget(){return this._renderTarget}get boundRBO(){return this._boundRBO}get boundVAO(){return this._boundVAO}get boundVBO(){return this._boundVBO}get boundTexture(){return this._boundTexture}get currentProgram(){return this._currentProgram}get scissorTestEnabled(){return this._scissorTestEnabled}get scissorBounds(){return this._scissorBounds}get currentUniforms(){return this._currentUniforms}get activeTextureUnit(){return this._activeTextureUnit}get drawBuffers(){return this._drawBuffers}get textureWillBeUsed(){return this._textureWillBeUsed}get viewport(){return this._viewport}get enabledVertexAttributeArray(){return this._enabledVertexAttributeArray.slice(0).filter(e=>e!==void 0)}bindVAO(e){this._boundVAO!==e&&(this._boundVAO=e,this.extensions.vao&&(this.extensions.vao instanceof WebGL2RenderingContext?this.extensions.vao.bindVertexArray(e):this.extensions.vao.bindVertexArrayOES(e)))}bindVBO(e){this._boundVBO!==e&&(this._boundVBO=e,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e))}bindRBO(e){this._boundRBO!==e&&(this._boundRBO=e,this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,e))}bindFBO(e){this._boundFBO!==e&&(this._boundFBO=e,this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e))}bindTexture(e,i){if(!(!e.gl||!e.gl.textureId)&&(!e||this._boundTexture.id!==e.gl.textureId||this._boundTexture.unit!==this._activeTextureUnit)){switch(this._boundTexture={id:e.gl.textureId,unit:this._activeTextureUnit},i){case d.GLSettings.Texture.TextureBindingTarget.TEXTURE_2D:this.gl.bindTexture(this.gl.TEXTURE_2D,e.gl.textureId);break;case d.GLSettings.Texture.TextureBindingTarget.CUBE_MAP:this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,e.gl.textureId);break}const n=this._textureUnitToTexture.get(this._activeTextureUnit);n&&n.gl&&(n.gl.textureUnit=-1),this._textureUnitToTexture.set(this._activeTextureUnit,e),e.gl.textureUnit=this._activeTextureUnit}}disableVertexAttributeArray(){for(let e=0,i=this._enabledVertexAttributeArray.length;e<i;++e){const n=this._enabledVertexAttributeArray[e];this.gl.disableVertexAttribArray(n)}this._enabledVertexAttributeArray=[],this._willUseVertexAttributeArray=[],this._vertexAttributeArrayDivisor.clear()}willUseVertexAttributeArray(e){this._willUseVertexAttributeArray[e]=e,this._enabledVertexAttributeArray[e]===void 0&&(this._enabledVertexAttributeArray[e]=e,this.gl.enableVertexAttribArray(e))}applyVertexAttributeArrays(){for(let e=0,i=this._enabledVertexAttributeArray.length;e<i;++e){const n=this._enabledVertexAttributeArray[e];if(n!==void 0){if(this._willUseVertexAttributeArray[n]!==void 0)return;this.gl.disableVertexAttribArray(n),delete this._enabledVertexAttributeArray[n]}}this._willUseVertexAttributeArray=[]}setVertexAttributeArrayDivisor(e,i){this.extensions.instancing&&this._enabledVertexAttributeArray[e]!==void 0&&this._vertexAttributeArrayDivisor.get(e)!==i&&(this.extensions.instancing instanceof WebGL2RenderingContext?this.extensions.instancing.vertexAttribDivisor(e,i):this.extensions.instancing.vertexAttribDivisorANGLE(e,i),this._vertexAttributeArrayDivisor.set(e,i))}freeTextureUnit(e){e.gl&&e.gl.textureUnit>-1&&(this._freeUnits.unshift(e.gl.textureUnit),e.gl.textureUnit=-1)}setActiveTextureUnit(e){this._activeTextureUnit!==e&&(this._activeTextureUnit=e,this.gl.activeTexture(e))}setClearColor(e){gs(e,this._clearColor)||(this._clearColor=At(e),this.applyClearColor())}setDrawBuffers(e,i){let n=e.length!==this._drawBuffers.length;if(!n){for(let r=0,s=e.length;r<s;++r)if(this._drawBuffers[r]!==e[r]){n=!0;break}}if(n){if(this.glProxy.extensions.drawBuffers instanceof WebGL2RenderingContext)i||this.glProxy.extensions.drawBuffers.drawBuffers(e);else if(this.glProxy.extensions.drawBuffers)i||this.glProxy.extensions.drawBuffers.drawBuffersWEBGL(e);else{console.warn("Attempted to use drawBuffers for MRT, but MRT is NOT supported by this hardware. Use multiple render targets instead");return}this._drawBuffers=e}}setProxy(e){this.glProxy=e}setScissor(e){e?(this._scissorTestEnabled||(this._scissorTestEnabled=!0,this.gl.enable(this.gl.SCISSOR_TEST)),(e.x!==this._scissorBounds.x||e.y!==this._scissorBounds.y||e.width!==this._scissorBounds.width||e.height!==this._scissorBounds.height)&&(this._scissorBounds=e,this.applyScissorBounds())):this._scissorTestEnabled&&(this._scissorTestEnabled=!1,this.gl.disable(this.gl.SCISSOR_TEST))}setViewport(e,i,n,r){(e!==this._viewport.x||i!==this._viewport.y||n!==this._viewport.width||r!==this._viewport.height)&&(this._viewport={x:e,y:i,width:n,height:r},this.applyViewport())}useProgram(e){this._currentProgram!==e&&(this._currentProgram=e,this.gl.useProgram(this._currentProgram))}useMaterial(e){if(!e.gl&&(!this.glProxy.compileMaterial(e)||!e.gl)||!e.gl.programId||e.gl.programId.length===0)return gt.INVALID;const i=this.findMaterialProgram(e);if(i===void 0)return console.warn("Could NOT determine a program for the given material that would appropriately match with the current RenderTarget"),gt.NO_RENDER_TARGET_MATCHES;if(this._renderTarget&&(e.gl.programByTarget.set(this._renderTarget,i),this.glProxy.extensions.drawBuffers)){const n=e.gl.outputsByProgram.get(i),r=this._renderTarget.getGLBuffers();if(!n||!r)return console.warn("Could not establish the buffers to utilize for the render target"),gt.NO_RENDER_TARGET_MATCHES;const s=[];for(let a=0,o=r.length;a<o;++a){const c=r[a];n.find(u=>(c==null?void 0:c.outputType)===u)===void 0?s.push(this.gl.NONE):this._renderTarget.disabledTargets.has((c==null?void 0:c.outputType)||0)?s.push(this.gl.NONE):s.push((c==null?void 0:c.attachment)||this.gl.NONE)}this.setDrawBuffers(s)}return this.useProgram(i),this.syncMaterial(e),gt.VALID}findMaterialProgram(e){if(!e.gl)return;if(!this._renderTarget||this._renderTarget.isColorTarget()){let o;if(this._renderTarget&&(o=e.gl.programByTarget.get(this._renderTarget),o!==void 0))return o;let c=Number.MAX_SAFE_INTEGER;for(let l=0,u=e.gl.programId.length;l<u;++l){const h=e.gl.programId[l];h.outputTypes.length<c&&h.outputTypes.indexOf($.COLOR)>=0&&(o=h.id,c=h.outputTypes.length)}return o||(o=e.gl.programId[e.gl.programId.length-1]),o}let i=e.gl.programByTarget.get(this._renderTarget);if(i!==void 0)return i;const n=new Set,r=this._renderTarget.getBuffers();for(let o=0,c=r.length;o<c;++o){const l=r[o];l&&n.add(l.outputType)}let s=0,a=[];for(let o=0,c=e.gl.programId.length;o<c;++o){const l=e.gl.programId[o];let u=0;for(let h=0,f=l.outputTypes.length;h<f;++h){const p=l.outputTypes[h];n.has(p)&&u++}u>s?(s=u,a=[l]):u===s&&a.push(l)}if(a.length!==0)return a.length===1?i=a[0].id:a.length>1&&(i=a.reduce((o,c)=>c.outputTypes.length<o.outputTypes.length?c:o)),i}useRenderTarget(e){return e?e.gl?(this.bindFBO(e.gl.fboId),this._renderTarget=e,!0):!1:(this.bindFBO(null),this._renderTarget=null,!0)}syncMaterial(e){return this.setDepthMask(e.depthWrite),this.setDepthTest(e.depthTest),this.setDepthFunc(e.depthFunc),this.setBlending(e.blending),this.setCullFace(e.culling),this.setColorMask(e.colorWrite),this.setDithering(e.dithering),this._currentUniforms=e.uniforms,!(!this._currentProgram||(Object.entries(e.uniforms).forEach(([i,n])=>{if(!this._currentProgram)return;n.gl||(n.gl=new Map);let r=n.gl.get(this._currentProgram);if(!r){const s=this.gl.getUniformLocation(this._currentProgram,i);if(!s){r={location:void 0},Yl(this.debugContext,`A Material specified a uniform ${i}, but none was found in the current program.`);return}r={location:s},n.gl.set(this._currentProgram,r)}r.location&&this.uploadUniform(r.location,n)}),this._textureWillBeUsed.size>0&&!this.applyUsedTextures()))}setDepthMask(e){this._depthMask!==e&&(this._depthMask=e,this.gl.depthMask(this._depthMask))}setDepthTest(e){this._depthTestEnabled!==e&&(this._depthTestEnabled=e,this._depthTestEnabled?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST))}setDepthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this.applyDepthFunc())}setBlending(e){e?(this._blendingEnabled||(this.gl.enable(this.gl.BLEND),this._blendingEnabled=!0),(this._blendDstFactor!==e.blendDst||this._blendSrcFactor!==e.blendSrc||this._blendEquation!==e.blendEquation)&&(this._blendDstFactor=e.blendDst||this._blendDstFactor,this._blendSrcFactor=e.blendSrc||this._blendSrcFactor,this._blendEquation=e.blendEquation||this._blendEquation,this.applyBlendFactors())):this._blendingEnabled&&(this.gl.disable(this.gl.BLEND),this._blendingEnabled=!1)}setDithering(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._ditheringEnabled?this.gl.enable(this.gl.DITHER):this.gl.disable(this.gl.DITHER))}setColorMask(e){(this._colorMask[0]!==e[0]||this._colorMask[1]!==e[1]||this._colorMask[2]!==e[2]||this._colorMask[3]!==e[3])&&(this._colorMask=e,this.applyColorMask())}setCullFace(e){this._cullFace!==e&&(this._cullFace=e,this.applyCullFace())}uploadUniform(e,i){let n;switch(i.type){case be.FLOAT:n=i.value,this.gl.uniform1f(e,n);break;case be.VEC2:n=i.value,this.gl.uniform2f(e,n[0],n[1]);break;case be.VEC3:n=i.value,this.gl.uniform3f(e,n[0],n[1],n[2]);break;case be.VEC4:n=i.value,this.gl.uniform4f(e,n[0],n[1],n[2],n[3]);break;case be.VEC4_ARRAY:n=i.value,this.gl.uniform4fv(e,ms(n));break;case be.MATRIX3x3:n=i.value,this.gl.uniformMatrix3fv(e,!1,n);break;case be.MATRIX4x4:n=i.value,this.gl.uniformMatrix4fv(e,!1,n);break;case be.FLOAT_ARRAY:n=i.value,this.gl.uniform1fv(e,n);break;case be.TEXTURE:n=i.value,this.willUseTextureUnit(n,e);break;default:console.warn(this.debugContext,"A uniform specified an unrecognized type. It will not sync with the GPU:",i)}}applyUsedTextures(){const e=this.assignTextureUnits(Array.from(this._textureWillBeUsed.keys()));e.forEach(r=>{r.gl?r.gl.textureUnit=this.gl.TEXTURE0:r.gl={textureId:null,textureUnit:this.gl.TEXTURE0,proxy:this.glProxy}});const i=new Map,n=new Set;return this._textureWillBeUsed.forEach((r,s)=>{r instanceof Wi?n.add(r):i.set(s,r)}),n.forEach(r=>{r.getTextures().some(o=>{if(e.indexOf(o)<0)this.glProxy.updateTexture(o);else return!0;return!1})?console.warn(this.debugContext,"A RenderTarget can not be used because all of it's textures could not be compiled."):this.glProxy.compileRenderTarget(r)}),i.forEach((r,s)=>{e.indexOf(s)<0?(this.glProxy.updateTexture(s),r.forEach(a=>{this.uploadTextureToUniform(a,s)})):r.forEach(a=>{this.gl.uniform1i(a,Lo(this.gl,0))})}),this._textureWillBeUsed.clear(),!0}assignTextureUnits(e){const i=[],n=[];for(e.forEach(a=>{!a.gl||a.gl.textureUnit<0?i.push(a):n.push(a)});this._freeUnits.length>0&&i.length>0;){const a=i.shift();if(!a)continue;const o=this._freeUnits.shift();if(o===void 0){i.unshift(a);continue}a.gl?a.gl.textureUnit=o:a.gl={textureId:null,textureUnit:o,proxy:this.glProxy},n.push(a)}if(i.length<=0)return i;Yl("WARNING: Too many textures in use are causing texture units to be swapped. Doing this occasionally is fine, but handling this on a frame loop can have serious performance concerns.");const r=new Map;this._textureUnitToTexture.forEach(a=>{a&&r.set(a,!1)}),n.forEach(a=>{r.set(a,!0)});const s=[];if(r.forEach((a,o)=>{a||s.push(o)}),s.length===0)return console.warn(this.debugContext,"There are too many textures being used for a single draw call. These textures will not be utilized on the GPU",i),console.warn("Current GL State:",this),i;for(;s.length>0&&i.length>0;){const a=i.shift();if(!a)continue;const o=s.shift();if(o===void 0||!o.gl||o.gl.textureUnit<0){i.unshift(a);continue}a.gl?a.gl.textureUnit=o.gl.textureUnit:a.gl={textureId:null,textureUnit:o.gl.textureUnit,proxy:this.glProxy},n.push(a)}return i.length>0&&(console.error(this.debugContext,"There are too many textures being used for a single draw call. These textures will not be utilized on the GPU",i),console.warn("Current GL State:",this)),i}uploadTextureToUniform(e,i){i.gl&&i.gl.textureUnit>=0?this.gl.uniform1i(e,Lo(this.gl,i.gl.textureUnit)):console.warn(this.debugContext,"Attempted to set a Texture Object to a uniform, but the Texture object did not have a valid texture unit.",i)}willUseTextureUnit(e,i){const n=this._textureWillBeUsed.get(e);i instanceof Wi?n?n instanceof Wi&&n!==i&&console.warn(this.debugContext,"A Texture is attempting to be used by two different render targets in a single draw."):this._textureWillBeUsed.set(e,i):n?n instanceof Wi?console.warn(this.debugContext,"A texture in a single draw is attempting to attach to a uniform AND a render target which is invalid."):n.add(i):this._textureWillBeUsed.set(e,new Set([i]))}syncState(){const e=this.gl;this._blendingEnabled?e.enable(e.BLEND):e.disable(e.BLEND),this._ditheringEnabled?e.enable(e.DITHER):e.disable(e.DITHER),this._depthTestEnabled?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._scissorTestEnabled?e.enable(e.SCISSOR_TEST):e.disable(e.SCISSOR_TEST),this.setActiveTextureUnit(this._activeTextureUnit),this.applyClearColor(),this.applyCullFace(),this.applyBlendFactors(),this.applyBlendEquation(),this.applyColorMask(),this.applyDepthFunc(),this.applyScissorBounds(),this.applyViewport(),e.depthMask(this._depthMask)}applyClearColor(){this.gl.clearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3])}applyDepthFunc(){const e=this.gl;switch(this._depthFunc){case d.GLSettings.Material.DepthFunctions.ALWAYS:e.depthFunc(e.ALWAYS);break;case d.GLSettings.Material.DepthFunctions.EQUAL:e.depthFunc(e.EQUAL);break;case d.GLSettings.Material.DepthFunctions.GREATER:e.depthFunc(e.GREATER);break;case d.GLSettings.Material.DepthFunctions.GREATER_OR_EQUAL:e.depthFunc(e.GEQUAL);break;case d.GLSettings.Material.DepthFunctions.LESS:e.depthFunc(e.LESS);break;case d.GLSettings.Material.DepthFunctions.LESS_OR_EQUAL:e.depthFunc(e.LEQUAL);break;case d.GLSettings.Material.DepthFunctions.NEVER:e.depthFunc(e.NEVER);break;case d.GLSettings.Material.DepthFunctions.NOTEQUAL:e.depthFunc(e.NOTEQUAL);break;default:e.depthFunc(e.ALWAYS);break}}applyScissorBounds(){this.gl.scissor(this._scissorBounds.x,this._scissorBounds.y,this._scissorBounds.width,this._scissorBounds.height)}applyColorMask(){this.gl.colorMask(this.colorMask[0]||!1,this.colorMask[1]||!1,this.colorMask[2]||!1,this.colorMask[3]||!1)}applyBlendEquation(){const e=this.gl;switch(this._blendEquation){case d.GLSettings.Material.BlendingEquations.Add:e.blendEquation(e.FUNC_ADD);break;case d.GLSettings.Material.BlendingEquations.Subtract:e.blendEquation(e.FUNC_SUBTRACT);break;case d.GLSettings.Material.BlendingEquations.ReverseSubtract:e.blendEquation(e.FUNC_REVERSE_SUBTRACT);break}}applyBlendFactors(){const e=this.gl;let i,n;switch(this._blendDstFactor){case d.GLSettings.Material.BlendingDstFactor.DstAlpha:i=e.BLEND_DST_ALPHA;break;case d.GLSettings.Material.BlendingDstFactor.DstColor:i=e.BLEND_DST_RGB;break;case d.GLSettings.Material.BlendingDstFactor.One:i=e.ONE;break;case d.GLSettings.Material.BlendingDstFactor.OneMinusDstAlpha:i=e.ONE_MINUS_DST_ALPHA;break;case d.GLSettings.Material.BlendingDstFactor.OneMinusDstColor:i=e.ONE_MINUS_DST_COLOR;break;case d.GLSettings.Material.BlendingDstFactor.OneMinusSrcAlpha:i=e.ONE_MINUS_SRC_ALPHA;break;case d.GLSettings.Material.BlendingDstFactor.OneMinusSrcColor:i=e.ONE_MINUS_SRC_COLOR;break;case d.GLSettings.Material.BlendingDstFactor.SrcAlpha:i=e.SRC_ALPHA;break;case d.GLSettings.Material.BlendingDstFactor.SrcColor:i=e.SRC_COLOR;break;case d.GLSettings.Material.BlendingDstFactor.Zero:i=e.ZERO;break;default:i=e.ONE;break}switch(this._blendSrcFactor){case d.GLSettings.Material.BlendingDstFactor.DstAlpha:n=e.BLEND_DST_ALPHA;break;case d.GLSettings.Material.BlendingDstFactor.DstColor:n=e.BLEND_DST_RGB;break;case d.GLSettings.Material.BlendingDstFactor.One:n=e.ONE;break;case d.GLSettings.Material.BlendingDstFactor.OneMinusDstAlpha:n=e.ONE_MINUS_DST_ALPHA;break;case d.GLSettings.Material.BlendingDstFactor.OneMinusDstColor:n=e.ONE_MINUS_DST_COLOR;break;case d.GLSettings.Material.BlendingDstFactor.OneMinusSrcAlpha:n=e.ONE_MINUS_SRC_ALPHA;break;case d.GLSettings.Material.BlendingDstFactor.OneMinusSrcColor:n=e.ONE_MINUS_SRC_COLOR;break;case d.GLSettings.Material.BlendingDstFactor.SrcAlpha:n=e.SRC_ALPHA;break;case d.GLSettings.Material.BlendingDstFactor.SrcColor:n=e.SRC_COLOR;break;case d.GLSettings.Material.BlendingDstFactor.Zero:n=e.ZERO;break;case d.GLSettings.Material.BlendingSrcFactor.SrcAlphaSaturate:n=e.SRC_ALPHA_SATURATE;break;default:n=e.ONE;break}e.blendFunc(n,i)}applyCullFace(){const e=this.gl;switch(this._cullFace!==d.GLSettings.Material.CullSide.NONE&&e.enable(e.CULL_FACE),this._cullFace){case d.GLSettings.Material.CullSide.CW:e.frontFace(e.CW),e.cullFace(e.FRONT);break;case d.GLSettings.Material.CullSide.CCW:e.frontFace(e.CCW),e.cullFace(e.FRONT);break;case d.GLSettings.Material.CullSide.BOTH:e.frontFace(e.CW),e.cullFace(e.FRONT_AND_BACK);break;default:e.disable(e.CULL_FACE)}}applyViewport(){this.gl.viewport(this._viewport.x,this._viewport.y,this._viewport.width,this._viewport.height)}}class yr{constructor(e){this.blending={blendDst:d.GLSettings.Material.BlendingDstFactor.OneMinusSrcAlpha,blendEquation:d.GLSettings.Material.BlendingEquations.Add,blendSrc:d.GLSettings.Material.BlendingSrcFactor.SrcAlpha},this.colorWrite=[!0,!0,!0,!0],this.culling=d.GLSettings.Material.CullSide.CCW,this.depthFunc=d.GLSettings.Material.DepthFunctions.LESS_OR_EQUAL,this.depthTest=!0,this.depthWrite=!0,this.dithering=!0,this.name="",this.uniforms={},this.vertexShader="",Object.assign(this,e),delete this.gl}clone(){const e=new yr(this);e.blending=Object.assign({},this.blending),e.polygonOffset=Object.assign({},this.polygonOffset),e.uniforms=Object.assign({},this.uniforms);for(const i in e.uniforms){const n=e.uniforms[i];if(n.gl){const r=new Map;n.gl.forEach((s,a)=>{r.set(a,Object.assign({},s))})}}return e}dispose(){this.gl&&this.gl.proxy.disposeMaterial(this)}}class Bo{constructor(e,i,n){this.drawMode=d.GLSettings.Model.DrawMode.TRIANGLES,this.vertexDrawRange=[-1,-1],this.drawInstances=-1,this.vertexCount=0,this.id=e,this.geometry=i,this.material=n}}class Ms{constructor(){this.models=new Set}add(e){this.models.add(e)}remove(e){this.models.delete(e)}}const Kl=xe("performance");class Zl{constructor(e){this.state={clearMask:[!1,!1,!1],currentRenderTarget:null,displaySize:[1,1],pixelRatio:1,renderSize:[1,1]},this.options=Object.assign({alpha:!1,antialias:!1,preserveDrawingBuffer:!1},e),this.options.canvas||console.warn("WebGLRenderer ERROR: A canvas is REQUIRED as a parameter."),this.getContext()}set debugContext(e){this.glProxy&&(this.glProxy.debugContext=e),this.glState&&(this.glState.debugContext=e)}get gl(){return this._gl}clear(e,i,n){const r=this.state.clearMask;this.state.clearMask=[r[0]||e||!1,r[1]||i||!1,r[2]||n||!1]}clearColor(e){e&&this.glState.setClearColor(e)}dispose(){}getContext(){if(this._gl)return this._gl;const e=Tr.getContext(this.options.canvas,{alpha:this.options.alpha||!1,antialias:this.options.antialias||!1,premultipliedAlpha:this.options.premultipliedAlpha||!1,preserveDrawingBuffer:this.options.preserveDrawingBuffer||!1});return e.context?(this._gl=e.context,this.glState=new ql(e.context,e.extensions),this.glProxy=new Tr(e.context,this.glState,e.extensions),this.glState.setProxy(this.glProxy),this.glState.syncState()):this.options.onNoContext?this.options.onNoContext():console.warn("No context was able to be produced, and the handler onNoContext was not implemented for such cases."),this._gl}getDisplaySize(){return this.state.displaySize}getPixelRatio(){return this.state.pixelRatio}getRenderSize(){return this.state.renderSize}getFullViewport(){const e=this.state.currentRenderTarget;if(Array.isArray(e))return{x:0,y:0,width:e[0].width,height:e[0].height};if(e)return{x:0,y:0,width:e.width,height:e.height};{const i=this.getRenderSize();return{x:0,y:0,width:i[0],height:i[1]}}}prepareAttribute(e,i,n){if(this.glProxy.updateAttribute(i))(!e.gl||!e.gl.vao)&&this.glProxy.useAttribute(n,i,e);else return console.warn("Could not update attribute",i),!1;return!0}render(e,i=null,n){if(!this.gl)return;this.setRenderTarget(i);const r=[];if(i&&!Array.isArray(i)&&(L.MRT||L.MRT_EXTENSION)){const a=i.getGLBuffers();this.glState.setDrawBuffers(a.map(o=>(o==null?void 0:o.attachment)||0))}const s=this.state.clearMask;if((s[0]||s[1]||s[2])&&(this.glProxy.clear(s[0],s[1],s[2]),this.state.clearMask=[!1,!1,!1]),Array.isArray(i))for(let a=0,o=i.length;a<o;++a){const c=i[a];if(this.glState.useRenderTarget(c),c&&!c.gl)return;e.models.forEach(l=>{this.renderModel(l,r,n)})}else{if(i&&!i.gl)return;e.models.forEach(a=>{this.renderModel(a,r,n)})}r.forEach(a=>{e.remove(a)})}renderModel(e,i,n){var o;const r=e.geometry,s=e.material;switch(this.glState.useMaterial(s)){case gt.VALID:{this.glProxy.compileGeometry(r);let c=!0;const l=(u,h)=>{c=this.prepareAttribute(r,u,h)&&c};r.attributes.forEach(l),(o=r.gl)!=null&&o.vao?this.glState.bindVAO(r.gl.vao):this.glState.applyVertexAttributeArrays(),n==null||n(this.glState,e.id),c?this.glProxy.draw(e):(console.warn("Geometry was unable to update correctly, thus we are skipping the drawing of",e),i.push(e)),this.glState.bindVAO(null);break}case gt.INVALID:{console.warn("Could not utilize material. Skipping draw call for:",s,r),i.push(e);break}case gt.NO_RENDER_TARGET_MATCHES:{Kl("Skipped draw for material due to no output matches for the current render target");break}default:Kl("Skipped draw for material due to unknown reasons");break}}readPixels(e,i,n,r,s,a=0){if(!this.gl)return;const o=this.state.currentRenderTarget;let c=!0,l;if(Array.isArray(o))l=o.find(u=>{var h;return Array.isArray(u.buffers.color)?u.buffers.color.find(f=>f.outputType===a):((h=u.buffers.color)==null?void 0:h.outputType)===a});else if(o&&Array.isArray(o==null?void 0:o.buffers.color)){if(o.buffers.color.length>1){console.warn("It is not yet implemented to read the pixels from a RenderTarget with multiple color buffers");return}l=o}else l=o;if(l&&(c=l.validFramebuffer),!c){console.warn("Framebuffer is incomplete. Can not read pixels at this time.");return}if(e=Math.max(0,e),i=Math.max(0,i),l){e+n>l.width&&(n=l.width-e),i+r>l.height&&(r=l.height-i);const u=l.height;this.gl.readPixels(e,u-i-r,n,r,this.gl.RGBA,this.gl.UNSIGNED_BYTE,s)}else{const u=this.getRenderSize(),h=u[1];e+n>u[0]&&(n=u[0]-e),i+r>u[1]&&(r=u[1]-i),this.gl.readPixels(e,h-i-r,n,r,this.gl.RGBA,this.gl.UNSIGNED_BYTE,s)}}setClearColor(e){this.glState.setClearColor(e)}setPixelRatio(e){const{canvas:i}=this.options,n=this.getDisplaySize();i.width=n[0]*e,i.height=n[1]*e,this.state.pixelRatio=e}setScissor(e,i){if(i=i||this.state.currentRenderTarget||null,Array.isArray(i)){const n=i[0].height;if(e){const{x:r,y:s,width:a,height:o}=e;this.glState.setScissor({x:r,y:n-s-o,width:a,height:o})}else this.glState.setScissor(null)}else if(i){const n=i.height;if(e){const{x:r,y:s,width:a,height:o}=e;this.glState.setScissor({x:r,y:n-s-o,width:a,height:o})}else this.glState.setScissor(null)}else{const{renderSize:n}=this.state,r=n[1];if(e){const{x:s,y:a,width:o,height:c}=e;this.glState.setScissor({x:s,y:r-a-c,width:o,height:c})}else this.glState.setScissor(null)}}setSize(e,i){const{canvas:n}=this.options,{pixelRatio:r}=this.state;n.width=Math.min(e*r,L.MAX_TEXTURE_SIZE),n.height=Math.min(i*r,L.MAX_TEXTURE_SIZE),n.style.width=`${e}px`,n.style.height=`${i}px`,this.state.renderSize=[n.width,n.height],this.state.displaySize=[e,i]}setRenderTarget(e){this.state.currentRenderTarget!==e&&(Array.isArray(e)?e.forEach(i=>{i.gl||this.glProxy.compileRenderTarget(i)}):!this.glState.useRenderTarget(e)&&e&&(e.getTextures().forEach(i=>{this.glState.willUseTextureUnit(i,e)}),this.glState.applyUsedTextures(),this.glProxy.compileRenderTarget(e)&&this.glState.useRenderTarget(e)),this.state.currentRenderTarget=e)}setViewport(e){const i=this.state.currentRenderTarget,{x:n,y:r,width:s,height:a}=e;if(Array.isArray(i)){const o=i[0].height;this.glState.setViewport(n,o-r-a,s,a)}else if(i){const o=i.height;this.glState.setViewport(n,o-r-a,s,a)}else{const{renderSize:o}=this.state,c=o[1];this.glState.setViewport(n,c-r-a,s,a)}}}var Is=!!(typeof window<"u"&&window.document&&window.document.createElement),Jl={canUseDOM:Is,canUseWorkers:typeof Worker<"u",canUseEventListeners:Is&&!!(window.addEventListener||window.attachEvent),canUseViewport:Is&&!!window.screen,isInWorker:!Is},eu;Jl.canUseDOM&&(eu=document.implementation&&document.implementation.hasFeature&&document.implementation.hasFeature("","")!==!0);/**
 * Checks if an event is supported in the current execution environment.
 *
 * NOTE: This will not work correctly for non-generic events such as `change`,
 * `reset`, `load`, `error`, and `select`.
 *
 * Borrows from Modernizr.
 *
 * @param {string} eventNameSuffix Event name, e.g. "click".
 * @param {?boolean} capture Check if the capture phase is supported.
 * @return {boolean} True if the event is supported.
 * @internal
 * @license Modernizr 3.0.0pre (Custom Build) | MIT
 */function Gp(t,e){if(!Jl.canUseDOM||e&&!("addEventListener"in document))return!1;var i="on"+t,n=i in document;if(!n){var r=document.createElement("div");r.setAttribute(i,"return;"),n=typeof r[i]=="function"}return!n&&eu&&t==="wheel"&&(n=document.implementation.hasFeature("Events.wheel","3.0")),n}var tu=!1,mn,Uo,Go,Ls,Cs,iu,Os,ko,zo,Vo,nu,Wo,$o,ru,su;function qe(){if(!tu){tu=!0;var t=navigator.userAgent,e=/(?:MSIE.(\d+\.\d+))|(?:(?:Firefox|GranParadiso|Iceweasel).(\d+\.\d+))|(?:Opera(?:.+Version.|.)(\d+\.\d+))|(?:AppleWebKit.(\d+(?:\.\d+)?))|(?:Trident\/\d+\.\d+.*rv:(\d+\.\d+))/.exec(t),i=/(Mac OS X)|(Windows)|(Linux)/.exec(t);if(Wo=/\b(iPhone|iP[ao]d)/.exec(t),$o=/\b(iP[ao]d)/.exec(t),Vo=/Android/i.exec(t),ru=/FBAN\/\w+;/i.exec(t),su=/Mobile/i.exec(t),nu=!!/Win64/.exec(t),e){mn=e[1]?parseFloat(e[1]):e[5]?parseFloat(e[5]):NaN,mn&&document&&document.documentMode&&(mn=document.documentMode);var n=/(?:Trident\/(\d+.\d+))/.exec(t);iu=n?parseFloat(n[1])+4:mn,Uo=e[2]?parseFloat(e[2]):NaN,Go=e[3]?parseFloat(e[3]):NaN,Ls=e[4]?parseFloat(e[4]):NaN,Ls?(e=/(?:Chrome\/(\d+\.\d+))/.exec(t),Cs=e&&e[1]?parseFloat(e[1]):NaN):Cs=NaN}else mn=Uo=Go=Cs=Ls=NaN;if(i){if(i[1]){var r=/(?:Mac OS X (\d+(?:[._]\d+)?))/.exec(t);Os=r?parseFloat(r[1].replace("_",".")):!0}else Os=!1;ko=!!i[2],zo=!!i[3]}else Os=ko=zo=!1}}var jo={ie:function(){return qe()||mn},ieCompatibilityMode:function(){return qe()||iu>mn},ie64:function(){return jo.ie()&&nu},firefox:function(){return qe()||Uo},opera:function(){return qe()||Go},webkit:function(){return qe()||Ls},safari:function(){return jo.webkit()},chrome:function(){return qe()||Cs},windows:function(){return qe()||ko},osx:function(){return qe()||Os},linux:function(){return qe()||zo},iphone:function(){return qe()||Wo},mobile:function(){return qe()||Wo||$o||Vo||su},nativeApp:function(){return qe()||ru},android:function(){return qe()||Vo},ipad:function(){return qe()||$o}};const au=10,ou=40,cu=800;function Ho(t){let e=0,i=0,n=0,r=0;return"detail"in t&&(i=t.detail),"wheelDelta"in t&&(i=-t.wheelDelta/120),"wheelDeltaY"in t&&(i=-t.wheelDeltaY/120),"wheelDeltaX"in t&&(e=-t.wheelDeltaX/120),"axis"in t&&t.axis===t.HORIZONTAL_AXIS&&(e=i,i=0),n=e*au,r=i*au,"deltaY"in t&&(r=t.deltaY),"deltaX"in t&&(n=t.deltaX),(n||r)&&t.deltaMode&&(t.deltaMode===1?(n*=ou,r*=ou):(n*=cu,r*=cu)),n&&!e&&(e=n<1?-1:1),r&&!i&&(i=r<1?-1:1),{spinX:e,spinY:-i,pixelX:n,pixelY:-r}}Ho.getEventType=function(){return jo.firefox()?"DOMMouseScroll":Gp("wheel")?"wheel":"mousewheel"};function Mt(t,e){let i=0,n=0,r=0,s=0,a=e||t.nativeEvent&&t.nativeEvent.target||t.target;if(t||(t=window.event),t.pageX||t.pageY)i=t.pageX,n=t.pageY;else if(t.clientX||t.clientY){let o=0,c=0;document.documentElement&&(o=document.documentElement.scrollLeft,c=document.documentElement.scrollTop),i=t.clientX+document.body.scrollLeft+o,n=t.clientY+document.body.scrollTop+c}if(a.offsetParent)do r+=a.offsetLeft,s+=a.offsetTop,a=a.offsetParent;while(a);return[i-r,n-s]}function me(t){return t!=null}function lu(t){return Array.isArray(t)?e=>t.indexOf(e.start.view.id)>=0:e=>e.start.view.id===t}function uu(t){return Array.isArray(t)?e=>e.start.views.find(i=>t.indexOf(i.view.id)>=0):e=>e.start.views.find(i=>i.view.id===t)}class Ns{constructor(){this._uid=G(),this.id="",this.pixelRatio=1,this._screenScale=[1,1]}get uid(){return this._uid}get screenBounds(){return this._scaledScreenBounds||(this._scaledScreenBounds=new te({x:this._screenBounds.x*this._screenScale[0],y:this._screenBounds.y*this._screenScale[1],width:this._screenBounds.width*this._screenScale[0],height:this._screenBounds.height*this._screenScale[1]})),this._scaledScreenBounds}set screenBounds(e){delete this._scaledScreenBounds,this._screenBounds=e}get screenScale(){return this._screenScale}set screenScale(e){cs(e,this._screenScale)||(delete this._scaledScreenBounds,this._screenScale=e)}screenToRenderSpace(e,i){return i=this.screenToView(e,i),de(i,e[0]*this.pixelRatio,e[1]*this.pixelRatio)}renderSpaceToScreen(e,i){return i=i||[0,0],de(i,e[0]/this.pixelRatio-this.screenBounds.x,e[1]/this.pixelRatio-this.screenBounds.y)}screenToView(e,i){return i=i||[0,0],de(i,e[0]-this.screenBounds.x,e[1]-this.screenBounds.y)}viewToScreen(e,i){return i=i||[0,0],de(i,e[0]+this.screenBounds.x,e[1]+this.screenBounds.y)}}class hu extends Ns{screenToWorld(e,i){return e}screenRay(e){return[[0,0,-1],[0,0,-2]]}worldToScreen(e,i){return e}viewToWorld(e,i){return e}worldToView(e,i){return e}}const{cos:ut,sin:ht,tan:It}=Math,dt=Math.PI/2,$i=0,ji=1,Hi=2,Qi=3,br=0,Er=1,_r=2,Rr=3,xr=4,Ar=5,Sr=6,Mr=7,Ir=8,Lt=0,Ct=1,Ot=2,Nt=3,Pt=4,Dt=5,Ft=6,Bt=7,Ut=8,Gt=9,kt=10,zt=11,Vt=12,Wt=13,$t=14,jt=15,vn=new Array(20).fill(0).map(t=>Ht()),Ue=new Array(20).fill(0).map(t=>ue());function ft(t,e,i,n,r){return t=t||new Array(4),t[0]=e,t[1]=i,t[2]=n,t[3]=r,t}function Ke(t,e,i,n,r,s,a,o,c,l){return t=t||new Array(9),t[0]=e,t[1]=i,t[2]=n,t[3]=r,t[4]=s,t[5]=a,t[6]=o,t[7]=c,t[8]=l,t}function ve(t,e,i,n,r,s,a,o,c,l,u,h,f,p,g,m,T){return t=t||new Array(16),t[0]=e,t[1]=i,t[2]=n,t[3]=r,t[4]=s,t[5]=a,t[6]=o,t[7]=c,t[8]=l,t[9]=u,t[10]=h,t[11]=f,t[12]=p,t[13]=g,t[14]=m,t[15]=T,t}const du=Ht(),fu=Ht(),Qo=Ht(),kp=Ht();function ge(t){return t[3]*t[0]-t[1]*t[2]}function wn(t){return t[0]*t[4]*t[8]-t[0]*t[5]*t[7]+t[1]*t[5]*t[6]-t[1]*t[3]*t[8]+t[2]*t[3]*t[7]-t[2]*t[4]*t[6]}function Xo(t){return Ke(du,t[5],t[6],t[7],t[9],t[10],t[11],t[13],t[14],t[15]),Ke(fu,t[4],t[6],t[7],t[8],t[10],t[11],t[12],t[14],t[15]),Ke(Qo,t[4],t[5],t[7],t[8],t[9],t[11],t[12],t[13],t[15]),Ke(Qo,t[4],t[5],t[6],t[8],t[9],t[10],t[12],t[13],t[14]),t[0]*wn(du)-t[1]*wn(fu)+t[2]*wn(Qo)-t[3]*wn(kp)}function pu(t,e){const i=ge(t);return i===0?null:ft(e,t[3]/i,-t[1]/i,-t[2]/i,t[0]/i)}function gu(t,e){const i=wn(t);if(i===0)return null;const n=ge([t[4],t[5],t[7],t[8]]),r=ge([t[3],t[5],t[6],t[8]]),s=ge([t[3],t[4],t[6],t[7]]),a=ge([t[1],t[2],t[7],t[8]]),o=ge([t[0],t[2],t[6],t[8]]),c=ge([t[0],t[1],t[6],t[7]]),l=ge([t[1],t[2],t[4],t[5]]),u=ge([t[0],t[2],t[3],t[5]]),h=ge([t[0],t[1],t[3],t[4]]);return Ke(e,n/i,-a/i,l/i,-r/i,o/i,u/i,s/i,-c/i,h/i)}function mu(t,e){const i=Xo(t);if(i===0)return null;const n=ge([t[0],t[1],t[4],t[5]]),r=ge([t[0],t[2],t[4],t[6]]),s=ge([t[0],t[3],t[4],t[7]]),a=ge([t[1],t[2],t[5],t[6]]),o=ge([t[1],t[3],t[5],t[7]]),c=ge([t[2],t[3],t[6],t[7]]),l=ge([t[10],t[11],t[14],t[15]]),u=ge([t[9],t[11],t[13],t[15]]),h=ge([t[9],t[10],t[13],t[14]]),f=ge([t[8],t[11],t[12],t[15]]),p=ge([t[8],t[10],t[12],t[14]]),g=ge([t[8],t[9],t[12],t[13]]);return ve(e,(t[5]*l-t[6]*u+t[7]*h)/i,(-t[1]*l+t[2]*u-t[3]*h)/i,(t[12]*c-t[13]*o+t[14]*a)/i,(-t[9]*c+t[10]*o-t[11]*a)/i,(-t[4]*l+t[6]*f-t[7]*p)/i,(t[0]*l-t[2]*f+t[3]*p)/i,(-t[12]*c+t[14]*s-t[15]*r)/i,(t[8]*c-t[10]*s+t[11]*r)/i,(t[4]*u-t[5]*f+t[7]*g)/i,(-t[0]*u+t[1]*f-t[3]*g)/i,(t[12]*o-t[13]*s+t[15]*n)/i,(-t[8]*o+t[9]*s-t[11]*n)/i,(-t[4]*h+t[5]*p-t[6]*g)/i,(t[0]*h-t[1]*p+t[2]*g)/i,(-t[12]*a+t[13]*r-t[14]*n)/i,(t[8]*a-t[9]*r+t[10]*n)/i)}function vu(t,e,i){return ft(i,t[0]*e,t[1]*e,t[2]*e,t[3]*e)}function wu(t,e,i){return Ke(i,t[0]*e,t[1]*e,t[2]*e,t[3]*e,t[4]*e,t[5]*e,t[6]*e,t[7]*e,t[8]*e)}function Tu(t,e,i){return ve(i,t[0]*e,t[1]*e,t[2]*e,t[3]*e,t[4]*e,t[5]*e,t[6]*e,t[7]*e,t[8]*e,t[9]*e,t[10]*e,t[11]*e,t[12]*e,t[13]*e,t[14]*e,t[15]*e)}function Lr(t){return ft(t,1,0,0,1)}function Ht(t){return Ke(t,1,0,0,0,1,0,0,0,1)}function ue(t){return ve(t,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}function yu(t,e,i){return ft(i,e[$i]*t[$i]+e[ji]*t[Hi],e[$i]*t[ji]+e[ji]*t[Qi],e[Hi]*t[$i]+e[Qi]*t[Hi],e[Hi]*t[ji]+e[Qi]*t[Qi])}function bu(t,e,i){return Ke(i,e[0]*t[0]+e[1]*t[3]+e[2]*t[6],e[0]*t[1]+e[1]*t[4]+e[2]*t[7],e[0]*t[2]+e[1]*t[5]+e[2]*t[8],e[3]*t[0]+e[4]*t[3]+e[5]*t[6],e[3]*t[1]+e[4]*t[4]+e[5]*t[7],e[3]*t[2]+e[4]*t[5]+e[5]*t[8],e[6]*t[0]+e[7]*t[3]+e[8]*t[6],e[6]*t[1]+e[7]*t[4]+e[8]*t[7],e[6]*t[2]+e[7]*t[5]+e[8]*t[8])}function rt(t,e,i){return i=i||[],i[0]=e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],i[1]=e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],i[2]=e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],i[3]=e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],i[4]=e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],i[5]=e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],i[6]=e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],i[7]=e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],i[8]=e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],i[9]=e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],i[10]=e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],i[11]=e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],i[12]=e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],i[13]=e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],i[14]=e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],i[15]=e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15],i}function Eu(t,...e){if(e.length<=0)return ue();if(t=t||ue(),e.length===1)return Gn(e[0],t);let i=e[0],n=Ue[Ue.length-1],r=Ue[Ue.length-2];t===n&&(n=Ue[Ue.length-3]),t===r&&(r=Ue[Ue.length-3]);let s=n;for(let a=1,o=e.length-1;a<o;++a){const c=e[a];i=rt(i,c,s),s=s===n?r:n}return rt(i,e[e.length-1],t)}function _u(t,e,i){return ft(i,t[0]+e[0],t[1]+e[1],t[2]+e[2],t[3]+e[3])}function Ru(t,e,i){return Ke(i,t[0]+e[0],t[1]+e[1],t[2]+e[2],t[3]+e[3],t[4]+e[4],t[5]+e[5],t[6]+e[6],t[7]+e[7],t[8]+e[8])}function xu(t,e,i){return ve(i,t[0]+e[0],t[1]+e[1],t[2]+e[2],t[3]+e[3],t[4]+e[4],t[5]+e[5],t[6]+e[6],t[7]+e[7],t[8]+e[8],t[9]+e[9],t[10]+e[10],t[11]+e[11],t[12]+e[12],t[13]+e[13],t[14]+e[14],t[15]+e[15])}function Au(t,e,i){return ft(i,t[0]-e[0],t[1]-e[1],t[2]-e[2],t[3]-e[3])}function Su(t,e,i){return Ke(i,t[0]-e[0],t[1]-e[1],t[2]-e[2],t[3]-e[3],t[4]-e[4],t[5]-e[5],t[6]-e[6],t[7]-e[7],t[8]-e[8])}function Mu(t,e,i){return ve(i,t[0]-e[0],t[1]-e[1],t[2]-e[2],t[3]-e[3],t[4]-e[4],t[5]-e[5],t[6]-e[6],t[7]-e[7],t[8]-e[8],t[9]-e[9],t[10]-e[10],t[11]-e[11],t[12]-e[12],t[13]-e[13],t[14]-e[14],t[15]-e[15])}function Iu(t,e,i){return ft(i,t[0]*e[0],t[1]*e[1],t[2]*e[2],t[3]*e[3])}function Lu(t,e,i){return Ke(i,t[0]*e[0],t[1]*e[1],t[2]*e[2],t[3]*e[3],t[4]*e[4],t[5]*e[5],t[6]*e[6],t[7]*e[7],t[8]*e[8])}function Cu(t,e,i){return ve(i,t[0]*e[0],t[1]*e[1],t[2]*e[2],t[3]*e[3],t[4]*e[4],t[5]*e[5],t[6]*e[6],t[7]*e[7],t[8]*e[8],t[9]*e[9],t[10]*e[10],t[11]*e[11],t[12]*e[12],t[13]*e[13],t[14]*e[14],t[15]*e[15])}function Ou(t,e){return ft(e,t[0],t[2],t[1],t[3])}function Cr(t,e){return Ke(e,t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8])}function Nu(t,e){return ve(e,t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15])}function Pu(t,e){return(t>=Math.PI/2||t<=-Math.PI/2)&&console.warn("A shear matrix can not have radians >= PI / 2 or <= -PI / 2"),e=e||Lr(),ft(e,1,0,It(t),1)}function Du(t,e){return(t>=Math.PI/2||t<=-Math.PI/2)&&console.warn("A shear matrix can not have radians >= PI / 2 or <= -PI / 2"),e=e||Lr(),ft(e,1,It(t),0,1)}function Fu(t,e,i){(e>=dt||e<=-dt||t>=dt||t<=-dt)&&console.warn("A shear matrix can not have radians >= PI / 2 or <= -PI / 2"),i=i||ue();const n=It(e),r=It(t);return ve(i,1,0,0,0,r,1,0,0,n,0,1,0,0,0,0,1)}function Bu(t,e,i){(e>=dt||e<=-dt||t>=dt||t<=-dt)&&console.warn("A shear matrix can not have radians >= PI / 2 or <= -PI / 2"),i=i||ue();const n=It(e),r=It(t);return ve(i,1,r,0,0,0,1,0,0,0,n,1,0,0,0,0,1)}function Uu(t,e,i){(e>=dt||e<=-dt||t>=dt||t<=-dt)&&console.warn("A shear matrix can not have radians >= PI / 2 or <= -PI / 2"),i=i||ue();const n=It(e),r=It(t);return ve(i,1,0,r,0,0,1,n,0,0,0,1,0,0,0,0,1)}function Gu(t,e,i){return de(i,t[$i]*e[0]+t[Hi]*e[1],t[ji]*e[0]+t[Qi]*e[1])}function ku(t,e,i){return pe(i,t[br]*e[0]+t[Rr]*e[1]+t[Sr]*e[2],t[Er]*e[0]+t[xr]*e[1]+t[Mr]*e[2],t[_r]*e[0]+t[Ar]*e[1]+t[Ir]*e[2])}function zu(t,e,i){return fe(i,t[Lt]*e[0]+t[Pt]*e[1]+t[Ut]*e[2]+t[Vt]*1,t[Ct]*e[0]+t[Dt]*e[1]+t[Gt]*e[2]+t[Wt]*1,t[Ot]*e[0]+t[Ft]*e[1]+t[kt]*e[2]+t[$t]*1,t[Nt]*e[0]+t[Bt]*e[1]+t[zt]*e[2]+t[jt]*1)}function Or(t,e,i){return fe(i,t[Lt]*e[0]+t[Pt]*e[1]+t[Ut]*e[2]+t[Vt]*e[3],t[Ct]*e[0]+t[Dt]*e[1]+t[Gt]*e[2]+t[Wt]*e[3],t[Ot]*e[0]+t[Ft]*e[1]+t[kt]*e[2]+t[$t]*e[3],t[Nt]*e[0]+t[Bt]*e[1]+t[zt]*e[2]+t[jt]*e[3])}function Vu(t){return`Matrix: [
  ${t[0]}, ${t[1]},
  ${t[2]}, ${t[3]},
]`}function Wu(t){return`Matrix: [
  ${t[0]}, ${t[1]}, ${t[2]},
  ${t[3]}, ${t[4]}, ${t[5]},
  ${t[6]}, ${t[7]}, ${t[8]},
]`}function $u(t){return`Matrix: [
  ${t[0]}, ${t[1]}, ${t[2]}, ${t[3]},
  ${t[4]}, ${t[5]}, ${t[6]}, ${t[7]},
  ${t[8]}, ${t[9]}, ${t[10]}, ${t[11]},
  ${t[12]}, ${t[13]}, ${t[14]}, ${t[15]},
]`}function Yo(t,e){e=e||new Array(4);const i=Math.cos(t),n=Math.sin(t);return e[$i]=i,e[ji]=-n,e[Hi]=n,e[Qi]=i,e}function qo(t,e,i,n){if(t)if(e)if(i){const r=ut(t),s=ut(e),a=ut(i),o=ht(t),c=ht(e),l=ht(i);return ve(n,s*a,s*l,-c,0,o*c*a-r*l,o*c*l+r*a,o*s,0,r*c*a+o*l,r*c*l-o*a,r*s,0,0,0,0,1)}else{const r=ut(t),s=ut(e),a=ht(t),o=ht(e);return ve(n,s,0,-o,0,a*o,r,a*s,0,r*o,-a,r*s,0,0,0,0,1)}else if(i){const r=ut(t),s=ut(i),a=ht(t),o=ht(i);return ve(n,s,o,0,0,-r*o,r*s,a,0,a*o,-a*s,r,0,0,0,0,1)}else{const r=ut(t),s=ht(t);return ve(n,1,0,0,0,0,r,s,0,0,-s,r,0,0,0,0,1)}else if(e)if(i){const r=ut(e),s=ut(i),a=ht(e),o=ht(i);return ve(n,r*s,r*o,-a,0,-o,s,0,0,a*s,a*o,r,0,0,0,0,1)}else{const r=ut(e),s=ht(e);return ve(n,r,0,-s,0,0,1,0,0,s,0,r,0,0,0,0,1)}else if(i){const r=ut(i),s=ht(i);return ve(n,r,s,0,0,-s,r,0,0,0,0,1,0,0,0,0,1)}else return ue(n)}function ju(t,e){return qo(t[0],t[1],t[2],e)}function Hu(t,e){return Ko(t[0],t[1],t[2],e)}function Ko(t,e,i,n){return ve(n,t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1)}function Qu(t,e){return Zo(t[0],t[1],t[2],e)}function Zo(t,e,i,n){return ve(n,1,0,0,0,0,1,0,0,0,0,1,0,t,e,i,1)}function Ps(t,e,i,n,r,s,a){return a=a||ue(),ve(a,2*t/(n-i),0,0,0,0,2*t/(r-s),0,0,(n+i)/(n-i),(r+s)/(r-s),-(e+t)/(e-t),-1,0,0,-(2*e*t)/(e-t),0)}function Jo(t,e,i,n,r,s){const a=i/e,o=It(t/2)*n,c=-o,l=a*o,u=-l;return Ps(n,r,c,o,l,u,s)}function Xu(t,e,i,n,r,s){const a=e/i,o=It(t/2)*n,c=-o,l=a*o,u=-l;return Ps(n,r,u,l,o,c,s)}function ec(t,e,i,n,r,s,a){return ve(a,2/(e-t),0,0,0,0,2/(n-i),0,0,0,0,-1/(s-r),0,(e+t)/(t-e),(n+i)/(i-n),-r/(r-s),1)}function tc(t,e,i,n,r){return r=r||[0,0,0,0],Or(t,e,r),fe(r,(r[0]/r[3]+1)*.5*i,(r[1]/r[3]+1)*.5*n,r[2]/r[3],1)}function Ds(t,e,i,n,r){return tc(t,[e[0],e[1],e[2],1],i,n,r)}function Yu(t,e){return Math.abs(t[0]-e[0])<=1e-7&&Math.abs(t[1]-e[1])<=1e-7&&Math.abs(t[2]-e[2])<=1e-7&&Math.abs(t[3]-e[3])<=1e-7}function qu(t,e){return Math.abs(t[0]-e[0])<=1e-7&&Math.abs(t[1]-e[1])<=1e-7&&Math.abs(t[2]-e[2])<=1e-7&&Math.abs(t[3]-e[3])<=1e-7&&Math.abs(t[4]-e[4])<=1e-7&&Math.abs(t[5]-e[5])<=1e-7&&Math.abs(t[6]-e[6])<=1e-7&&Math.abs(t[7]-e[7])<=1e-7&&Math.abs(t[8]-e[8])<=1e-7}function ic(t,e){return Math.abs(t[0]-e[0])<=1e-7&&Math.abs(t[1]-e[1])<=1e-7&&Math.abs(t[2]-e[2])<=1e-7&&Math.abs(t[3]-e[3])<=1e-7&&Math.abs(t[4]-e[4])<=1e-7&&Math.abs(t[5]-e[5])<=1e-7&&Math.abs(t[6]-e[6])<=1e-7&&Math.abs(t[7]-e[7])<=1e-7&&Math.abs(t[8]-e[8])<=1e-7&&Math.abs(t[9]-e[9])<=1e-7&&Math.abs(t[10]-e[10])<=1e-7&&Math.abs(t[11]-e[11])<=1e-7&&Math.abs(t[12]-e[12])<=1e-7&&Math.abs(t[13]-e[13])<=1e-7&&Math.abs(t[14]-e[14])<=1e-7&&Math.abs(t[15]-e[15])<=1e-7}function Ku(t){return[t[0],t[1],t[2],t[3]]}function Zu(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]}function Gn(t,e){return e?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e):[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]}function Nr(t,e,i,n){n=n||[];const[r,s,a]=t,[o,c,l]=i,[u,h,f,p,g,m,T,w,y]=e;n[Lt]=u*r,n[Ct]=h*s,n[Ot]=f*a,n[Nt]=0,n[Pt]=p*r,n[Dt]=g*s,n[Ft]=m*a,n[Bt]=0,n[Ut]=T*r,n[Gt]=w*s,n[kt]=y*a,n[zt]=0,n[Vt]=r*(u*o+p*c+T*l),n[Wt]=s*(h*o+g*c+w*l),n[$t]=a*(f*o+m*c+y*l),n[jt]=1}function Fs(t,e,i,n){n=n||[];const[r,s,a]=t,[o,c,l]=i,[u,h,f,p,g,m,T,w,y]=e;n[Lt]=u*r,n[Ct]=h*r,n[Ot]=f*r,n[Nt]=0,n[Pt]=p*s,n[Dt]=g*s,n[Ft]=m*s,n[Bt]=0,n[Ut]=T*a,n[Gt]=w*a,n[kt]=y*a,n[zt]=0,n[Vt]=o,n[Wt]=c,n[$t]=l,n[jt]=1}function Ju(t,e,i,n){n=n||[];const[r,s]=t,[a,o]=i,[c,l,u,h]=e;n[Lt]=c*r,n[Ct]=l*s,n[Ot]=0,n[Nt]=0,n[Pt]=u*r,n[Dt]=h*s,n[Ft]=0,n[Bt]=0,n[Ut]=0,n[Gt]=0,n[kt]=1,n[zt]=0,n[Vt]=r*(c*a+u*o),n[Wt]=s*(l*a+h*o),n[$t]=0,n[jt]=1}function nc(t,e,i,n){n=n||[];const[r,s]=t,[a,o]=i,[c,l,u,h]=e;n[Lt]=c*r,n[Ct]=l*r,n[Ot]=0,n[Nt]=0,n[Pt]=u*s,n[Dt]=h*s,n[Ft]=0,n[Bt]=0,n[Ut]=0,n[Gt]=0,n[kt]=1,n[zt]=0,n[Vt]=a,n[Wt]=o,n[$t]=0,n[jt]=1}const zp=Object.freeze(Object.defineProperty({__proto__:null,Hadamard2x2:Iu,Hadamard3x3:Lu,Hadamard4x4:Cu,M200:$i,M201:ji,M210:Hi,M211:Qi,M300:br,M301:Er,M302:_r,M310:Rr,M311:xr,M312:Ar,M320:Sr,M321:Mr,M322:Ir,M3R:vn,M400:Lt,M401:Ct,M402:Ot,M403:Nt,M410:Pt,M411:Dt,M412:Ft,M413:Bt,M420:Ut,M421:Gt,M422:kt,M423:zt,M430:Vt,M431:Wt,M432:$t,M433:jt,M4R:Ue,SRT4x4:Fs,SRT4x4_2D:nc,TRS4x4:Nr,TRS4x4_2D:Ju,add2x2:_u,add3x3:Ru,add4x4:xu,affineInverse2x2:pu,affineInverse3x3:gu,affineInverse4x4:mu,apply2x2:ft,apply3x3:Ke,apply4x4:ve,compare2x2:Yu,compare3x3:qu,compare4x4:ic,concat4x4:Eu,copy2x2:Ku,copy3x3:Zu,copy4x4:Gn,determinant2x2:ge,determinant3x3:wn,determinant4x4:Xo,identity2:Lr,identity3:Ht,identity4:ue,multiply2x2:yu,multiply3x3:bu,multiply4x4:rt,multiplyScalar2x2:vu,multiplyScalar3x3:wu,multiplyScalar4x4:Tu,orthographic4x4:ec,perspective4x4:Jo,perspectiveFOVY4x4:Xu,perspectiveFrustum4x4:Ps,project3As4ToScreen:Ds,projectToScreen:tc,rotation2x2:Yo,rotation4x4:qo,rotation4x4by3:ju,scale4x4:Ko,scale4x4by3:Hu,shearX2x2:Pu,shearX4x4:Fu,shearY2x2:Du,shearY4x4:Bu,shearZ4x4:Uu,subtract2x2:Au,subtract3x3:Su,subtract4x4:Mu,toString2x2:Vu,toString3x3:Wu,toString4x4:$u,transform2:Gu,transform3:ku,transform3as4:zu,transform4:Or,translation4x4:Zo,translation4x4by3:Qu,transpose2x2:Ou,transpose3x3:Cr,transpose4x4:Nu},Symbol.toStringTag,{value:"Module"}));function rc(t,e){return!t||!e?t===e:!Object.keys(Object.assign({},t,e)).find(i=>t[i]!==e[i])}const{min:Vp,max:Wp,pow:eh,round:$p,sin:Pr,PI:kn}=Math,Dr=$p(kn*1e3)/1e3;function Z(t,e,i){return Vp(Wp(t,e),i)}var Qt=(t=>(t[t.NONE=1]="NONE",t[t.CONTINUOUS=4]="CONTINUOUS",t[t.REPEAT=2]="REPEAT",t[t.REFLECT=3]="REFLECT",t))(Qt||{});const jp=`
\${easingMethod} {
  return end;
}
`,Hp=`
\${easingMethod} {
  return (end - start) * t + start;
}
`,Qp=`
\${easingMethod} {
  float time = t * t;
  return (end - start) * time + start;
}
`,Xp=`
\${easingMethod} {
  float time = t * (2.0 - t);
  return (end - start) * time + start;
}
`,Yp=`
\${easingMethod} {
  float time = t < 0.5 ? 2.0 * t * t : -1.0 + (4.0 - 2.0 * t) * t;
  return (end - start) * time + start;
}
`,qp=`
\${easingMethod} {
  float time = t * t * t;
  return (end - start) * time + start;
}
`,Kp=`
\${easingMethod} {
  float t1 = t - 1.0;
  float time = t1 * t1 * t1 + 1.0;
  return (end - start) * time + start;
}
`,Zp=`
\${easingMethod} {
  float time = t < 0.5 ? 4.0 * t * t * t : (t - 1.0) * (2.0 * t - 2.0) * (2.0 * t - 2.0) + 1.0;
  return (end - start) * time + start;
}
`,Jp=`
\${easingMethod} {
  float time = t * t * t * t;
  return (end - start) * time + start;
}
`,eg=`
\${easingMethod} {
  float t1 = t - 1.0;
  float time = 1.0 - t1 * t1 * t1 * t1;
  return (end - start) * time + start;
}
`,tg=`
\${easingMethod} {
  float t1 = t - 1.0;
  float time = t < 0.5 ? 8.0 * t * t * t * t : 1.0 - 8.0 * t1 * t1 * t1 * t1;
  return (end - start) * time + start;
}
`,ig=`
\${easingMethod} {
  float time = t * t * t * t * t;
  return (end - start) * time + start;
}
`,ng=`
\${easingMethod} {
  float t1 = t - 1.0;
  float time = 1.0 + t1 * t1 * t1 * t1 * t1;
  return (end - start) * time + start;
}
`,rg=`
\${easingMethod} {
  float t1 = t - 1.0;
  float time = t < 0.5 ? 16.0 * t * t * t * t * t : 1.0 + 16.0 * t1 * t1 * t1 * t1 * t1;
  return (end - start) * time + start;
}
`,sg=`
\${easingMethod} {
  float p = 0.3;
  float time = pow(2.0, -10.0 * t) * sin((t - p / 4.0) * (2.0 * ${Dr}) / p) + 1.0;
  return (end - start) * time + start;
}
`,ag=`
\${easingMethod} {
  float time = t * t * t - t * 1.05 * sin(t * ${Dr});
  return (end - start) * time + start;
}
`,og=`
\${easingMethod} {
  float t1 = t - 1.0;
  float a = 1.7;
  float time = (t1 * t1 * ((a + 1.0) * t1 + a) + 1.0);
  return (end - start) * time + start;
}
`,cg=`
\${easingMethod} {
  float a = 1.4;
  float a1 = a * 1.525;
  float t1 = t / 0.5;
  float t2 = t1 - 2.0;
  float time =
    (t1 < 1.0) ? 0.5 * (t1 * t1 * (a1 + 1.0) * t1 - a1) :
    0.5 * (t2 * t2 * ((a1 + 1.0) * t2 + a1) + 2.0)
  ;

  return (end - start) * time + start;
}
`,lg=`
\${easingMethod} {
  \${T} direction = end - start;
  return start + direction * 0.5 + direction * sin(t * ${Dr} * 2.0) * 0.5;
}
`,ug=`
\${easingMethod} {
  float cosom = dot(start, end);
  \${T} end1 = mix(end, -end, float(cosom < 0.0));
  cosom = mix(cosom, -cosom, float(cosom < 0.0));

  float omega = acos(cosom);
  float sinom = sin(omega);

  vec2 scale = mix(
    vec2(1.0 - t, t),
    vec2(sin((1.0 - t) * omega) / sinom, sin(t * omega) / sinom),
    float(1.0 - cosom > 0.0000001)
  );

  return scale.x * start + scale.y * end1;
}
`,hg=`
\${easingMethod} {
  float time = t * t;
  float cosom = dot(start, end);
  \${T} end1 = mix(end, -end, float(cosom < 0.0));
  cosom = mix(cosom, -cosom, float(cosom < 0.0));

  float omega = acos(cosom);
  float sinom = sin(omega);

  vec2 scale = mix(
    vec2(1.0 - time, time),
    vec2(sin((1.0 - time) * omega) / sinom, sin(time * omega) / sinom),
    float(1.0 - cosom > 0.0000001)
  );

  return scale.x * start + scale.y * end1;
}
`,dg=`
\${easingMethod} {
  float time = t * (2.0 - t);
  float cosom = dot(start, end);
  \${T} end1 = mix(end, -end, float(cosom < 0.0));
  cosom = mix(cosom, -cosom, float(cosom < 0.0));

  float omega = acos(cosom);
  float sinom = sin(omega);

  vec2 scale = mix(
    vec2(1.0 - time, time),
    vec2(sin((1.0 - time) * omega) / sinom, sin(time * omega) / sinom),
    float(1.0 - cosom > 0.0000001)
  );

  return scale.x * start + scale.y * end1;
}
`,fg=`
\${easingMethod} {
  float time = t < 0.5 ? 2.0 * t * t : -1.0 + (4.0 - 2.0 * t) * t;
  float cosom = dot(start, end);
  \${T} end1 = mix(end, -end, float(cosom < 0.0));
  cosom = mix(cosom, -cosom, float(cosom < 0.0));

  float omega = acos(cosom);
  float sinom = sin(omega);

  vec2 scale = mix(
    vec2(1.0 - time, time),
    vec2(sin((1.0 - time) * omega) / sinom, sin(time * omega) / sinom),
    float(1.0 - cosom > 0.0000001)
  );

  return scale.x * start + scale.y * end1;
}
`,pg=`
\${easingMethod} {
  float time = t * t * t;
  float cosom = dot(start, end);
  \${T} end1 = mix(end, -end, float(cosom < 0.0));
  cosom = mix(cosom, -cosom, float(cosom < 0.0));

  float omega = acos(cosom);
  float sinom = sin(omega);

  vec2 scale = mix(
    vec2(1.0 - time, time),
    vec2(sin((1.0 - time) * omega) / sinom, sin(time * omega) / sinom),
    float(1.0 - cosom > 0.0000001)
  );

  return scale.x * start + scale.y * end1;
}
`,gg=`
\${easingMethod} {
  float t1 = t - 1.0;
  float time = t1 * t1 * t1 + 1.0;
  float cosom = dot(start, end);
  \${T} end1 = mix(end, -end, float(cosom < 0.0));
  cosom = mix(cosom, -cosom, float(cosom < 0.0));

  float omega = acos(cosom);
  float sinom = sin(omega);

  vec2 scale = mix(
    vec2(1.0 - time, time),
    vec2(sin((1.0 - time) * omega) / sinom, sin(time * omega) / sinom),
    float(1.0 - cosom > 0.0000001)
  );

  return scale.x * start + scale.y * end1;
}
`,mg=`
\${easingMethod} {
  float time = t < 0.5 ? 4.0 * t * t * t : (t - 1.0) * (2.0 * t - 2.0) * (2.0 * t - 2.0) + 1.0;
  float cosom = dot(start, end);
  \${T} end1 = mix(end, -end, float(cosom < 0.0));
  cosom = mix(cosom, -cosom, float(cosom < 0.0));

  float omega = acos(cosom);
  float sinom = sin(omega);

  vec2 scale = mix(
    vec2(1.0 - time, time),
    vec2(sin((1.0 - time) * omega) / sinom, sin(time * omega) / sinom),
    float(1.0 - cosom > 0.0000001)
  );

  return scale.x * start + scale.y * end1;
}
`,vg=`
\${easingMethod} {
  float time = t * t * t * t;
  float cosom = dot(start, end);
  \${T} end1 = mix(end, -end, float(cosom < 0.0));
  cosom = mix(cosom, -cosom, float(cosom < 0.0));

  float omega = acos(cosom);
  float sinom = sin(omega);

  vec2 scale = mix(
    vec2(1.0 - time, time),
    vec2(sin((1.0 - time) * omega) / sinom, sin(time * omega) / sinom),
    float(1.0 - cosom > 0.0000001)
  );

  return scale.x * start + scale.y * end1;
}
`,wg=`
\${easingMethod} {
  float t1 = t - 1.0;
  float time = 1.0 - t1 * t1 * t1 * t1;
  float cosom = dot(start, end);
  \${T} end1 = mix(end, -end, float(cosom < 0.0));
  cosom = mix(cosom, -cosom, float(cosom < 0.0));

  float omega = acos(cosom);
  float sinom = sin(omega);

  vec2 scale = mix(
    vec2(1.0 - time, time),
    vec2(sin((1.0 - time) * omega) / sinom, sin(time * omega) / sinom),
    float(1.0 - cosom > 0.0000001)
  );

  return scale.x * start + scale.y * end1;
}
`,Tg=`
\${easingMethod} {
  float t1 = t - 1.0;
  float time = t < 0.5 ? 8.0 * t * t * t * t : 1.0 - 8.0 * t1 * t1 * t1 * t1;
  float cosom = dot(start, end);
  \${T} end1 = mix(end, -end, float(cosom < 0.0));
  cosom = mix(cosom, -cosom, float(cosom < 0.0));

  float omega = acos(cosom);
  float sinom = sin(omega);

  vec2 scale = mix(
    vec2(1.0 - time, time),
    vec2(sin((1.0 - time) * omega) / sinom, sin(time * omega) / sinom),
    float(1.0 - cosom > 0.0000001)
  );

  return scale.x * start + scale.y * end1;
}
`,yg=`
\${easingMethod} {
  float time = t * t * t * t * t;
  float cosom = dot(start, end);
  \${T} end1 = mix(end, -end, float(cosom < 0.0));
  cosom = mix(cosom, -cosom, float(cosom < 0.0));

  float omega = acos(cosom);
  float sinom = sin(omega);

  vec2 scale = mix(
    vec2(1.0 - time, time),
    vec2(sin((1.0 - time) * omega) / sinom, sin(time * omega) / sinom),
    float(1.0 - cosom > 0.0000001)
  );

  return scale.x * start + scale.y * end1;
}
`,bg=`
\${easingMethod} {
  float t1 = t - 1.0;
  float time = 1.0 + t1 * t1 * t1 * t1 * t1;
  float cosom = dot(start, end);
  \${T} end1 = mix(end, -end, float(cosom < 0.0));
  cosom = mix(cosom, -cosom, float(cosom < 0.0));

  float omega = acos(cosom);
  float sinom = sin(omega);

  vec2 scale = mix(
    vec2(1.0 - time, time),
    vec2(sin((1.0 - time) * omega) / sinom, sin(time * omega) / sinom),
    float(1.0 - cosom > 0.0000001)
  );

  return scale.x * start + scale.y * end1;
}
`,Eg=`
\${easingMethod} {
  float t1 = t - 1.0;
  float time = t < 0.5 ? 16.0 * t * t * t * t * t : 1.0 + 16.0 * t1 * t1 * t1 * t1 * t1;
  float cosom = dot(start, end);
  \${T} end1 = mix(end, -end, float(cosom < 0.0));
  cosom = mix(cosom, -cosom, float(cosom < 0.0));

  float omega = acos(cosom);
  float sinom = sin(omega);

  vec2 scale = mix(
    vec2(1.0 - time, time),
    vec2(sin((1.0 - time) * omega) / sinom, sin(time * omega) / sinom),
    float(1.0 - cosom > 0.0000001)
  );

  return scale.x * start + scale.y * end1;
}
`,_g=`
\${easingMethod} {
  float p = 0.3;
  float time = pow(2.0, -10.0 * t) * sin((t - p / 4.0) * (2.0 * ${Dr}) / p) + 1.0;
  float cosom = dot(start, end);
  \${T} end1 = mix(end, -end, float(cosom < 0.0));
  cosom = mix(cosom, -cosom, float(cosom < 0.0));

  float omega = acos(cosom);
  float sinom = sin(omega);

  vec2 scale = mix(
    vec2(1.0 - time, time),
    vec2(sin((1.0 - time) * omega) / sinom, sin(time * omega) / sinom),
    float(1.0 - cosom > 0.0000001)
  );

  return scale.x * start + scale.y * end1;
}
`,Rg=`
\${easingMethod} {
  float time = t * t * t - t * 1.05 * sin(t * ${Dr});
  float cosom = dot(start, end);
  \${T} end1 = mix(end, -end, float(cosom < 0.0));
  cosom = mix(cosom, -cosom, float(cosom < 0.0));

  float omega = acos(cosom);
  float sinom = sin(omega);

  vec2 scale = mix(
    vec2(1.0 - time, time),
    vec2(sin((1.0 - time) * omega) / sinom, sin(time * omega) / sinom),
    float(1.0 - cosom > 0.0000001)
  );

  return scale.x * start + scale.y * end1;
}
`,xg=`
\${easingMethod} {
  float t1 = t - 1.0;
  float a = 1.7;
  float time = (t1 * t1 * ((a + 1.0) * t1 + a) + 1.0);
  float cosom = dot(start, end);
  \${T} end1 = mix(end, -end, float(cosom < 0.0));
  cosom = mix(cosom, -cosom, float(cosom < 0.0));

  float omega = acos(cosom);
  float sinom = sin(omega);

  vec2 scale = mix(
    vec2(1.0 - time, time),
    vec2(sin((1.0 - time) * omega) / sinom, sin(time * omega) / sinom),
    float(1.0 - cosom > 0.0000001)
  );

  return scale.x * start + scale.y * end1;
}
`,Ag=`
\${easingMethod} {
  float a = 1.4;
  float a1 = a * 1.525;
  float t1 = t / 0.5;
  float t2 = t1 - 2.0;
  float time =
    (t1 < 1.0) ? 0.5 * (t1 * t1 * (a1 + 1.0) * t1 - a1) :
    0.5 * (t2 * t2 * ((a1 + 1.0) * t2 + a1) + 2.0)
  ;
  float cosom = dot(start, end);
  \${T} end1 = mix(end, -end, float(cosom < 0.0));
  cosom = mix(cosom, -cosom, float(cosom < 0.0));

  float omega = acos(cosom);
  float sinom = sin(omega);

  vec2 scale = mix(
    vec2(1.0 - time, time),
    vec2(sin((1.0 - time) * omega) / sinom, sin(time * omega) / sinom),
    float(1.0 - cosom > 0.0000001)
  );

  return scale.x * start + scale.y * end1;
}
`;class Bs{constructor(e,i,n,r){this.uid=G(),this.delay=0,this.duration=500,this.loop=1,this.cpu=e,this.gpu=i,this.duration=n||500,this.methodName=r||"easingMethod"}static immediate(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{const{copy:c}=B(r);return c(s,o)},delay:i,duration:e,gpu:jp,loop:n,methodName:"immediate"}}static linear(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{const{add:c,scale:l,subtract:u}=B(r);return a=Z(a,0,1),c(l(u(s,r),a),r,o)},delay:i,duration:e,gpu:Hp,loop:n,methodName:"linear"}}static easeInQuad(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{a=Z(a,0,1);const c=a*a,{add:l,scale:u,subtract:h}=B(r);return l(u(h(s,r),c),r,o)},delay:i,duration:e,gpu:Qp,loop:n,methodName:"easeInQuad"}}static easeOutQuad(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{a=Z(a,0,1);const c=a*(2-a),{add:l,scale:u,subtract:h}=B(r);return l(u(h(s,r),c),r,o)},delay:i,duration:e,gpu:Xp,loop:n,methodName:"easeOutQuad"}}static easeInOutQuad(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{a=Z(a,0,1);const c=a<.5?2*a*a:-1+(4-2*a)*a,{add:l,scale:u,subtract:h}=B(r);return l(u(h(s,r),c),r,o)},delay:i,duration:e,gpu:Yp,loop:n,methodName:"easeInOutQuad"}}static easeInCubic(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{a=Z(a,0,1);const c=a*a*a,{add:l,scale:u,subtract:h}=B(r);return l(u(h(s,r),c),r,o)},delay:i,duration:e,gpu:qp,loop:n,methodName:"easeInCubic"}}static easeOutCubic(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{a=Z(a,0,1);const c=--a*a*a+1,{add:l,scale:u,subtract:h}=B(r);return l(u(h(s,r),c),r,o)},delay:i,duration:e,gpu:Kp,loop:n,methodName:"easeOutCubic"}}static easeInOutCubic(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{a=Z(a,0,1);const c=a<.5?4*a*a*a:(a-1)*(2*a-2)*(2*a-2)+1,{add:l,scale:u,subtract:h}=B(r);return l(u(h(s,r),c),r,o)},delay:i,duration:e,gpu:Zp,loop:n,methodName:"easeInOutCubic"}}static easeInQuart(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{a=Z(a,0,1);const c=a*a*a*a,{add:l,scale:u,subtract:h}=B(r);return l(u(h(s,r),c),r,o)},delay:i,duration:e,gpu:Jp,loop:n,methodName:"easeInQuart"}}static easeOutQuart(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{a=Z(a,0,1);const c=1- --a*a*a*a,{add:l,scale:u,subtract:h}=B(r);return l(u(h(s,r),c),r,o)},delay:i,duration:e,gpu:eg,loop:n,methodName:"easeOutQuart"}}static easeInOutQuart(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{a=Z(a,0,1);const c=a<.5?8*a*a*a*a:1-8*--a*a*a*a,{add:l,scale:u,subtract:h}=B(r);return l(u(h(s,r),c),r,o)},delay:i,duration:e,gpu:tg,loop:n,methodName:"easeInOutQuart"}}static easeInQuint(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{a=Z(a,0,1);const c=a*a*a*a*a,{add:l,scale:u,subtract:h}=B(r);return l(u(h(s,r),c),r,o)},delay:i,duration:e,gpu:ig,loop:n,methodName:"easeInQuint"}}static easeOutQuint(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{a=Z(a,0,1);const c=1+--a*a*a*a*a,{add:l,scale:u,subtract:h}=B(r);return l(u(h(s,r),c),r,o)},delay:i,duration:e,gpu:ng,loop:n,methodName:"easeOutQuint"}}static easeInOutQuint(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{a=Z(a,0,1);const c=a<.5?16*a*a*a*a*a:1+16*--a*a*a*a*a,{add:l,scale:u,subtract:h}=B(r);return l(u(h(s,r),c),r,o)},delay:i,duration:e,gpu:rg,loop:n,methodName:"easeInOutQuint"}}static easeOutElastic(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{a=Z(a,0,1);const c=.3,l=eh(2,-10*a)*Pr((a-c/4)*(2*kn)/c)+1,{add:u,scale:h,subtract:f}=B(r);return u(h(f(s,r),l),r,o)},delay:i,duration:e,gpu:sg,loop:n,methodName:"easeOutElastic"}}static easeBackIn(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{a=Z(a,0,1);const c=1.05,l=a*a*a-a*c*Pr(a*kn),{add:u,scale:h,subtract:f}=B(r);return u(h(f(s,r),l),r,o)},delay:i,duration:e,gpu:ag,loop:n,methodName:"easeBackIn"}}static easeBackOut(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{a=Z(a,0,1);const c=1.7,l=a-1,u=l*l*((c+1)*l+c)+1,{add:h,scale:f,subtract:p}=B(r);return h(f(p(s,r),u),r,o)},delay:i,duration:e,gpu:og,loop:n,methodName:"easeBackOut"}}static easeBackInOut(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{a=Z(a,0,1);const l=1.7*1.525,u=a/.5,h=u-2,f=u<1?.5*(u*u*(l+1)*u-l):.5*(h*h*((l+1)*h+l)+2),{add:p,scale:g,subtract:m}=B(r);return p(g(m(s,r),f),r,o)},delay:i,duration:e,gpu:cg,loop:n,methodName:"easeBackInOut"}}static continuousSinusoidal(e,i=0,n=4){return{uid:G(),cpu:(r,s,a,o)=>{const{add:c,scale:l,subtract:u}=B(r);a=Z(a,0,1);const h=u(s,r),f=l(h,.5);return c(c(r,f),l(f,Pr(a*kn*2)*1),o)},delay:i,duration:e,gpu:lg,loop:n,methodName:"repeatingSinusoidal",validation:{ignoreEndValueCheck:!0,ignoreOverTimeCheck:!0}}}static slerpQuatLinear(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{if(!U(r)||!U(s)||!U(o)){const{vec:u}=B(s);return console.warn("SLERP QUAT AutoEasingMethod was specified on a non Vec4/Quaternion type which is invalid. This AutoEasingMethod will ONLY work on tuples that have 4 or more elements."),u(1,0,0,0)}a=Z(a,0,1);const{slerpQuat:c,vec:l}=B(r);return c?c(r,s,a,o):l(1,0,0,0)},delay:i,duration:e,gpu:ug,loop:n,methodName:"slerpQuatLinear"}}static slerpQuatInQuad(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{if(!U(r)||!U(s)||!U(o)){const{vec:h}=B(s);return console.warn("SLERP QUAT AutoEasingMethod was specified on a non Vec4/Quaternion type which is invalid. This AutoEasingMethod will ONLY work on tuples that have 4 or more elements."),h(1,0,0,0)}a=Z(a,0,1);const c=a*a,{slerpQuat:l,vec:u}=B(r);return l?l(r,s,c,o):u(1,0,0,0)},delay:i,duration:e,gpu:hg,loop:n,methodName:"slerpQuatInQuad"}}static slerpQuatOutQuad(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{if(!U(r)||!U(s)||!U(o)){const{vec:h}=B(s);return console.warn("SLERP QUAT AutoEasingMethod was specified on a non Vec4/Quaternion type which is invalid. This AutoEasingMethod will ONLY work on tuples that have 4 or more elements."),h(1,0,0,0)}a=Z(a,0,1);const c=a*(2-a),{slerpQuat:l,vec:u}=B(r);return l?l(r,s,c,o):u(1,0,0,0)},delay:i,duration:e,gpu:dg,loop:n,methodName:"slerpQuatOutQuad"}}static slerpQuatInOutQuad(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{if(!U(r)||!U(s)||!U(o)){const{vec:h}=B(s);return console.warn("SLERP QUAT AutoEasingMethod was specified on a non Vec4/Quaternion type which is invalid. This AutoEasingMethod will ONLY work on tuples that have 4 or more elements."),h(1,0,0,0)}a=Z(a,0,1);const c=a<.5?2*a*a:-1+(4-2*a)*a,{slerpQuat:l,vec:u}=B(r);return l?l(r,s,c,o):u(1,0,0,0)},delay:i,duration:e,gpu:fg,loop:n,methodName:"slerpQuatInOutQuad"}}static slerpQuatInCubic(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{if(!U(r)||!U(s)||!U(o)){const{vec:h}=B(s);return console.warn("SLERP QUAT AutoEasingMethod was specified on a non Vec4/Quaternion type which is invalid. This AutoEasingMethod will ONLY work on tuples that have 4 or more elements."),h(1,0,0,0)}a=Z(a,0,1);const c=a*a*a,{slerpQuat:l,vec:u}=B(r);return l?l(r,s,c,o):u(1,0,0,0)},delay:i,duration:e,gpu:pg,loop:n,methodName:"slerpQuatInCubic"}}static slerpQuatOutCubic(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{if(!U(r)||!U(s)||!U(o)){const{vec:h}=B(s);return console.warn("SLERP QUAT AutoEasingMethod was specified on a non Vec4/Quaternion type which is invalid. This AutoEasingMethod will ONLY work on tuples that have 4 or more elements."),h(1,0,0,0)}a=Z(a,0,1);const c=--a*a*a+1,{slerpQuat:l,vec:u}=B(r);return l?l(r,s,c,o):u(1,0,0,0)},delay:i,duration:e,gpu:gg,loop:n,methodName:"slerpQuatOutCubic"}}static slerpQuatInOutCubic(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{if(!U(r)||!U(s)||!U(o)){const{vec:h}=B(s);return console.warn("SLERP QUAT AutoEasingMethod was specified on a non Vec4/Quaternion type which is invalid. This AutoEasingMethod will ONLY work on tuples that have 4 or more elements."),h(1,0,0,0)}a=Z(a,0,1);const c=a<.5?4*a*a*a:(a-1)*(2*a-2)*(2*a-2)+1,{slerpQuat:l,vec:u}=B(r);return l?l(r,s,c,o):u(1,0,0,0)},delay:i,duration:e,gpu:mg,loop:n,methodName:"slerpQuatInOutCubic"}}static slerpQuatInQuart(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{if(!U(r)||!U(s)||!U(o)){const{vec:h}=B(s);return console.warn("SLERP QUAT AutoEasingMethod was specified on a non Vec4/Quaternion type which is invalid. This AutoEasingMethod will ONLY work on tuples that have 4 or more elements."),h(1,0,0,0)}a=Z(a,0,1);const c=a*a*a*a,{slerpQuat:l,vec:u}=B(r);return l?l(r,s,c,o):u(1,0,0,0)},delay:i,duration:e,gpu:vg,loop:n,methodName:"slerpQuatInQuart"}}static slerpQuatOutQuart(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{if(!U(r)||!U(s)||!U(o)){const{vec:h}=B(s);return console.warn("SLERP QUAT AutoEasingMethod was specified on a non Vec4/Quaternion type which is invalid. This AutoEasingMethod will ONLY work on tuples that have 4 or more elements."),h(1,0,0,0)}a=Z(a,0,1);const c=1- --a*a*a*a,{slerpQuat:l,vec:u}=B(r);return l?l(r,s,c,o):u(1,0,0,0)},delay:i,duration:e,gpu:wg,loop:n,methodName:"slerpQuatOutQuart"}}static slerpQuatInOutQuart(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{if(!U(r)||!U(s)||!U(o)){const{vec:h}=B(s);return console.warn("SLERP QUAT AutoEasingMethod was specified on a non Vec4/Quaternion type which is invalid. This AutoEasingMethod will ONLY work on tuples that have 4 or more elements."),h(1,0,0,0)}a=Z(a,0,1);const c=a<.5?8*a*a*a*a:1-8*--a*a*a*a,{slerpQuat:l,vec:u}=B(r);return l?l(r,s,c,o):u(1,0,0,0)},delay:i,duration:e,gpu:Tg,loop:n,methodName:"slerpQuatInOutQuart"}}static slerpQuatInQuint(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{if(!U(r)||!U(s)||!U(o)){const{vec:h}=B(s);return console.warn("SLERP QUAT AutoEasingMethod was specified on a non Vec4/Quaternion type which is invalid. This AutoEasingMethod will ONLY work on tuples that have 4 or more elements."),h(1,0,0,0)}a=Z(a,0,1);const c=a*a*a*a*a,{slerpQuat:l,vec:u}=B(r);return l?l(r,s,c,o):u(1,0,0,0)},delay:i,duration:e,gpu:yg,loop:n,methodName:"slerpQuatInQuint"}}static slerpQuatOutQuint(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{if(!U(r)||!U(s)||!U(o)){const{vec:h}=B(s);return console.warn("SLERP QUAT AutoEasingMethod was specified on a non Vec4/Quaternion type which is invalid. This AutoEasingMethod will ONLY work on tuples that have 4 or more elements."),h(1,0,0,0)}a=Z(a,0,1);const c=1+--a*a*a*a*a,{slerpQuat:l,vec:u}=B(r);return l?l(r,s,c,o):u(1,0,0,0)},delay:i,duration:e,gpu:bg,loop:n,methodName:"slerpQuatOutQuint"}}static slerpQuatInOutQuint(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{if(!U(r)||!U(s)||!U(o)){const{vec:h}=B(s);return console.warn("SLERP QUAT AutoEasingMethod was specified on a non Vec4/Quaternion type which is invalid. This AutoEasingMethod will ONLY work on tuples that have 4 or more elements."),h(1,0,0,0)}a=Z(a,0,1);const c=a<.5?16*a*a*a*a*a:1+16*--a*a*a*a*a,{slerpQuat:l,vec:u}=B(r);return l?l(r,s,c,o):u(1,0,0,0)},delay:i,duration:e,gpu:Eg,loop:n,methodName:"slerpQuatInOutQuint"}}static slerpQuatOutElastic(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{if(!U(r)||!U(s)||!U(o)){const{vec:f}=B(s);return console.warn("SLERP QUAT AutoEasingMethod was specified on a non Vec4/Quaternion type which is invalid. This AutoEasingMethod will ONLY work on tuples that have 4 or more elements."),f(1,0,0,0)}a=Z(a,0,1);const c=.3,l=eh(2,-10*a)*Pr((a-c/4)*(2*kn)/c)+1,{slerpQuat:u,vec:h}=B(r);return u?u(r,s,l,o):h(1,0,0,0)},delay:i,duration:e,gpu:_g,loop:n,methodName:"slerpQuatOutElastic"}}static slerpQuatBackIn(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{if(!U(r)||!U(s)||!U(o)){const{vec:f}=B(s);return console.warn("SLERP QUAT AutoEasingMethod was specified on a non Vec4/Quaternion type which is invalid. This AutoEasingMethod will ONLY work on tuples that have 4 or more elements."),f(1,0,0,0)}a=Z(a,0,1);const c=1.05,l=a*a*a-a*c*Pr(a*kn),{slerpQuat:u,vec:h}=B(r);return u?u(r,s,l,o):h(1,0,0,0)},delay:i,duration:e,gpu:Rg,loop:n,methodName:"slerpQuatBackIn"}}static slerpQuatBackOut(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{if(!U(r)||!U(s)||!U(o)){const{vec:p}=B(s);return console.warn("SLERP QUAT AutoEasingMethod was specified on a non Vec4/Quaternion type which is invalid. This AutoEasingMethod will ONLY work on tuples that have 4 or more elements."),p(1,0,0,0)}a=Z(a,0,1);const c=1.7,l=a-1,u=l*l*((c+1)*l+c)+1,{slerpQuat:h,vec:f}=B(r);return h?h(r,s,u,o):f(1,0,0,0)},delay:i,duration:e,gpu:xg,loop:n,methodName:"slerpQuatBackOut"}}static slerpQuatBackInOut(e,i=0,n=1){return{uid:G(),cpu:(r,s,a,o)=>{if(!U(r)||!U(s)||!U(o)){const{vec:m}=B(s);return console.warn("SLERP QUAT AutoEasingMethod was specified on a non Vec4/Quaternion type which is invalid. This AutoEasingMethod will ONLY work on tuples that have 4 or more elements."),m(1,0,0,0)}a=Z(a,0,1);const l=1.7*1.525,u=a/.5,h=u-2,f=u<1?.5*(u*u*(l+1)*u-l):.5*(h*h*((l+1)*h+l)+2),{slerpQuat:p,vec:g}=B(r);return p?p(r,s,f,o):g(1,0,0,0)},delay:i,duration:e,gpu:Ag,loop:n,methodName:"slerpQuatBackInOut"}}}const{cos:Fr,sin:Xi,sqrt:st,exp:th,acos:sc,atan2:ih,PI:nh}=Math;let Ze,Xt,Yt,qt,Oe,Ge,zn,Kt,Je,Se,Vn,Us,Gs,Yi,F,mt,ks,Wn;const rh=we(),sh=we(),ah=we(),oh=we(),ch=1,lh=2,uh=3,hh=0;function et(t,e,i){return t>i?i:t<e?e:t}function we(t){return t?(t[0]=0,t[1]=0,t[2]=0,t[3]=0,t):[0,0,0,0]}function dh(t,e,i){return i=i||we(),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i}function ac(t,e,i){i=i||we();const n=t[0],r=e[0],s=t[1],a=e[1],o=t[2],c=e[2],l=t[3],u=e[3];return i[0]=n*r-s*a-o*c-l*u,i[1]=n*a+s*r+o*u-l*c,i[2]=n*c-s*u+o*r+l*a,i[3]=n*u+s*c-o*a+l*r,i}function fh(t,e,i){i=i||we();const n=t[0],r=t[1],s=t[2],a=t[3],o=e[0],c=e[1],l=e[2],u=e[3],h=o*o+c*c+l*l+u*u;if(h===0)i[0]=0,i[1]=0,i[2]=0,i[3]=0;else{const f=1/h;i[0]=(n*o+r*c+s*l+a*u)*f,i[1]=(r*o-n*c-s*u+a*l)*f,i[2]=(s*o-n*l-a*c+r*u)*f,i[3]=(a*o-n*u-r*l+s*c)*f}return i}function ph(t,e){e=e||we();const i=t[0],n=t[1],r=t[2],s=t[3],a=st(n*n+r*r+s*s),o=th(i),c=o/a*Xi(a);return a===0?(e[0]=th(i),e[1]=0,e[2]=0,e[3]=0):(e[0]=o*Fr(a),e[1]=n*c,e[2]=r*c,e[3]=s*c),e}function oc(t,e,i){return i=i||we(),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i}function gh(t,e,i){return i=i||we(),ac(e,cc(t),i)}function cc(t,e){return e=e||we(),e[0]=t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e}function mh(t,e){e=e||we();const i=t[0],n=t[1],r=t[2],s=t[3],a=i*i+n*n+r*r+s*s;if(a===0)e[0]=0,e[1]=0,e[2]=0,e[3]=0;else{const o=1/a;e[0]=i*o,e[1]=-n*o,e[2]=-r*o,e[3]=-s*o}return e}function lc(t){const e=t[0],i=t[1],n=t[2],r=t[3];return st(e*e+i*i+n*n+r*r)}function vh(t,e){e=e||we();const i=lc(t);if(i===0)return[0,0,0,0];const n=1/i;return oc(t,n,e)}function wh(t){return t[0]}function Th(t){return[t[1],t[2],t[3]]}function yh(t,e){return Ts(t,e)}function bh(t,e,i){i=i||we();const n=t[0],r=t[1],s=t[2],a=1/st(n*n+r*r+s*s),o=Xi(e/2);return i[0]=Fr(e/2),i[1]=o*n*a,i[2]=o*r*a,i[3]=o*s*a,i}function uc(t,e,i){i=i||we();const n=t[0],r=t[1],s=t[2],a=Math.cos,o=Math.sin,c=a(n/2),l=a(r/2),u=a(s/2),h=o(n/2),f=o(r/2),p=o(s/2);switch(e){case re.xyz:i[1]=h*l*u+c*f*p,i[2]=c*f*u-h*l*p,i[3]=c*l*p+h*f*u,i[0]=c*l*u-h*f*p;break;case re.yxz:i[0]=c*l*u+h*f*p,i[1]=h*l*u+c*f*p,i[2]=c*f*u-h*l*p,i[3]=c*l*p-h*f*u;break;case re.zxy:i[0]=c*l*u-h*f*p,i[1]=h*l*u-c*f*p,i[2]=c*f*u+h*l*p,i[3]=c*l*p+h*f*u;break;case re.zyx:i[0]=c*l*u+h*f*p,i[1]=h*l*u-c*f*p,i[2]=c*f*u+h*l*p,i[3]=c*l*p-h*f*u;break;case re.yzx:i[0]=c*l*u-h*f*p,i[1]=h*l*u+c*f*p,i[2]=c*f*u+h*l*p,i[3]=c*l*p-h*f*u;break;case re.xzy:i[0]=c*l*u+h*f*p,i[1]=h*l*u-c*f*p,i[2]=c*f*u-h*l*p,i[3]=c*l*p+h*f*u;break}return i}function Eh(t,e,i){i=i||[0,0,0];const n=uc(t,e);return zs(n,re.xyz,i),i}function $n(t,e,i,n,r,s){s[0]=ih(t,e),s[1]=sc(i),s[2]=ih(n,r)}function _h(t,e){return zs(t,re.zyx,e)}function zs(t,e,i){i=i||[0,0,0];const n=t[0],r=t[1],s=t[2],a=t[3],o=Ws(t),c=o[0],l=o[4],u=o[8],h=o[1],f=o[5],p=o[9],g=o[2],m=o[6],T=o[10];switch(e){case re.zyx:i[1]=Math.asin(-et(g,-1,1)),Math.abs(g)<.99999?(i[0]=Math.atan2(m,T),i[2]=Math.atan2(h,c)):(i[0]=0,i[2]=Math.atan2(-l,f));break;case re.zyz:$n(2*s*a+2*n*r,2*n*s-2*r*a,a*a-s*s-r*r+n*n,2*s*a-2*n*r,2*r*a+2*n*s,i);break;case re.zxy:i[0]=Math.asin(et(m,-1,1)),Math.abs(m)<.99999?(i[1]=Math.atan2(-g,T),i[2]=Math.atan2(-l,f)):(i[1]=0,i[2]=Math.atan2(h,c));break;case re.zxz:$n(2*r*a-2*n*s,2*s*a+2*n*r,a*a-s*s-r*r+n*n,2*r*a+2*n*s,2*n*r-2*s*a,i);break;case re.yxz:i[0]=Math.asin(-et(p,-1,1)),Math.abs(p)<.9999?(i[1]=Math.atan2(u,T),i[2]=Math.atan2(h,f)):(i[1]=Math.atan2(-g,c),i[2]=0);break;case re.yxy:$n(2*r*s+2*n*a,2*n*r-2*s*a,s*s-a*a+n*n-r*r,2*r*s-2*n*a,2*s*a+2*n*r,i);break;case re.yzx:i[2]=Math.asin(et(h,-1,1)),Math.abs(h)<.99999?(i[0]=Math.atan2(-p,f),i[1]=Math.atan2(-g,c)):(i[0]=0,i[1]=Math.atan2(u,T));break;case re.yzy:$n(2*s*a-2*n*r,2*r*s+2*n*a,s*s-a*a+n*n-r*r,2*s*a+2*n*r,2*n*a-2*r*s,i);break;case re.xyz:i[1]=Math.asin(et(u,-1,1)),Math.abs(u)<.99999?(i[0]=Math.atan2(-p,T),i[2]=Math.atan2(-l,c)):(i[0]=Math.atan2(m,f),i[2]=0);break;case re.xyx:$n(2*r*s-2*n*a,2*r*a+2*n*s,r*r+n*n-a*a-s*s,2*r*s+2*n*a,2*n*s-2*r*a,i);break;case re.xzy:i[2]=Math.asin(-et(l,-1,1)),Math.abs(l)<.99999?(i[0]=Math.atan2(m,f),i[1]=Math.atan2(u,c)):(i[0]=Math.atan2(-p,T),i[1]=0);break;case re.xzx:$n(2*r*a+2*n*s,2*n*a-2*r*s,r*r+n*n-a*a-s*s,2*r*a-2*n*s,2*r*s+2*n*a,i);break;default:console.warn("Invalid Euler rotation order.");break}return i}function Rh(t,e,i){i=i||[0,0,0];const n=Ws(t),r=n[0],s=n[4],a=n[8],o=n[1],c=n[5],l=n[9],u=n[2],h=n[6],f=n[10];switch(e){case re.xyz:i[1]=Math.asin(et(a,-1,1)),Math.abs(a)<.99999?(i[0]=Math.atan2(-l,f),i[2]=Math.atan2(-s,r)):(i[0]=Math.atan2(h,c),i[2]=0);break;case re.yxz:i[0]=Math.asin(-et(l,-1,1)),Math.abs(l)<.9999?(i[1]=Math.atan2(a,f),i[2]=Math.atan2(o,c)):(i[1]=Math.atan2(-u,r),i[2]=0);break;case re.zxy:i[0]=Math.asin(et(h,-1,1)),Math.abs(h)<.99999?(i[1]=Math.atan2(-u,f),i[2]=Math.atan2(-s,c)):(i[1]=0,i[2]=Math.atan2(o,r));break;case re.zyx:i[1]=Math.asin(-et(u,-1,1)),Math.abs(u)<.99999?(i[0]=Math.atan2(h,f),i[2]=Math.atan2(o,r)):(i[0]=0,i[2]=Math.atan2(-s,c));break;case re.yzx:i[2]=Math.asin(et(o,-1,1)),Math.abs(o)<.99999?(i[0]=Math.atan2(-l,c),i[1]=Math.atan2(-u,r)):(i[0]=0,i[1]=Math.atan2(a,f));break;case re.xzy:i[2]=Math.asin(-et(s,-1,1)),Math.abs(s)<.99999?(i[0]=Math.atan2(h,c),i[1]=Math.atan2(a,r)):(i[0]=Math.atan2(-l,f),i[1]=0);break}}function xh(t){const e=t[0];if(e<-1||e>1)return 0;const i=2*sc(e);return i>nh?i-2*nh:i}function Ah(t){const e=t[1],i=t[2],n=t[3];if(st(e*e+i*i+n*n)===0)return[0,0,0];const s=1/st(e*e+i*i+n*n);return[e*s,i*s,n*s]}function Vs(t,e){e=e||Ht();const i=t[1]+t[1],n=t[2]+t[2],r=t[3]+t[3],s=t[1]*i,a=t[1]*n,o=t[1]*r,c=t[2]*n,l=t[2]*r,u=t[3]*r,h=t[0]*i,f=t[0]*n,p=t[0]*r;return e[br]=1-(c+u),e[Er]=a-p,e[_r]=o+f,e[Rr]=a+p,e[xr]=1-(s+u),e[Ar]=l-h,e[Sr]=o-f,e[Mr]=l+h,e[Ir]=1-(s+c),e}function Sh(t,e){e=e||ue();const i=t[1]+t[1],n=t[2]+t[2],r=t[3]+t[3],s=t[1]*i,a=t[1]*n,o=t[1]*r,c=t[2]*n,l=t[2]*r,u=t[3]*r,h=t[0]*i,f=t[0]*n,p=t[0]*r;return e[Lt]=1-(c+u),e[Ct]=a-p,e[Ot]=o+f,e[Nt]=0,e[Pt]=a+p,e[Dt]=1-(s+u),e[Ft]=l-h,e[Bt]=0,e[Ut]=o-f,e[Gt]=l+h,e[kt]=1-(s+c),e[zt]=0,e[Vt]=0,e[Wt]=0,e[$t]=0,e[jt]=1,e}function Mh(t,e){e=e||Ht();const i=t[1]+t[1],n=t[2]+t[2],r=t[3]+t[3],s=t[1]*i,a=t[1]*n,o=t[1]*r,c=t[2]*n,l=t[2]*r,u=t[3]*r,h=t[0]*i,f=t[0]*n,p=t[0]*r;return e[br]=1-(c+u),e[Rr]=a-p,e[Sr]=o+f,e[Er]=a+p,e[xr]=1-(s+u),e[Mr]=l-h,e[_r]=o-f,e[Ar]=l+h,e[Ir]=1-(s+c),e}function Ws(t,e){e=e||ue();const i=t[1]+t[1],n=t[2]+t[2],r=t[3]+t[3],s=t[1]*i,a=t[1]*n,o=t[1]*r,c=t[2]*n,l=t[2]*r,u=t[3]*r,h=t[0]*i,f=t[0]*n,p=t[0]*r;return e[Lt]=1-(c+u),e[Pt]=a-p,e[Ut]=o+f,e[Vt]=0,e[Ct]=a+p,e[Dt]=1-(s+u),e[Gt]=l-h,e[Wt]=0,e[Ot]=o-f,e[Ft]=l+h,e[kt]=1-(s+c),e[$t]=0,e[Nt]=0,e[Bt]=0,e[zt]=0,e[jt]=1,e}function Ih(t,e){e=e||we();const[i,n,r]=t,s=Fr(i/2),a=Fr(n/2),o=Fr(r/2),c=Xi(i/2),l=Xi(n/2),u=Xi(r/2),h=a*o,f=l*u,p=a*u,g=l*o;return e[0]=s*h+c*f,e[1]=c*h-s*f,e[2]=s*g+c*p,e[3]=s*p-c*g,e}function hc(t,e,i){return i=i||we(),Wn=ct([-t[0],-t[1],-t[2]],$e[$e.length-1]),mt=ct(Ye(e,Wn,$e[$e.length-2])),ks=Ye(Wn,mt,$e[$e.length-3]),Oe=mt[0],Ge=ks[0],zn=Wn[0],Je=mt[1],Se=ks[1],Vn=Wn[1],Us=mt[2],Gs=ks[2],Yi=Wn[2],F=(1+Oe+Se+Yi)*.25,F>0?(F=Math.sqrt(F),i[0]=F,F=1/(4*F),i[1]=(Vn-Gs)*F,i[2]=(Us-zn)*F,i[3]=(Ge-Je)*F):(i[0]=0,F=-.5*(Se+Yi),F>0?(F=Math.sqrt(F),i[1]=F,F*=2,i[2]=Ge/F,i[3]=zn/F):(i[1]=0,F=.5*(1-Yi),F>0?(F=Math.sqrt(F),i[2]=F,i[3]=Vn/(2*F)):(i[2]=0,i[3]=1))),i}function Lh(t,e){if(e=e||we(),Ze=t[0],Xt=t[3],Yt=t[6],qt=t[1],Oe=t[4],Ge=t[7],Kt=t[2],Je=t[5],Se=t[8],F=Ze+Oe+Se,F>0){const n=st(F+1)*2;return e[0]=.25*n,e[1]=(Je-Ge)/n,e[2]=(Yt-Kt)/n,e[3]=(qt-Xt)/n,e}if(Ze>Oe&&Ze>Se){const n=st(1+Ze-Oe-Se)*2;return e[0]=(Je-Ge)/n,e[1]=.25*n,e[2]=(Xt+qt)/n,e[3]=(Yt+Kt)/n,e}if(Oe>Se){const n=st(1+Oe-Ze-Se)*2;return e[0]=(Yt-Kt)/n,e[1]=(qt+Xt)/n,e[2]=.25*n,e[3]=(Je+Ge)/n,e}const i=st(1+Se-Ze-Oe)*2;return e[0]=(qt-Xt)/i,e[1]=(Kt+Yt)/i,e[2]=(Je+Ge)/i,e[3]=.25*i,e}function Ch(t,e){if(e=e||we(),Ze=t[0],Xt=t[4],Yt=t[8],qt=t[1],Oe=t[5],Ge=t[9],Kt=t[2],Je=t[6],Se=t[10],F=Ze+Oe+Se,F>0){const n=st(F+1)*2;return e[0]=.25*n,e[1]=(Je-Ge)/n,e[2]=(Yt-Kt)/n,e[3]=(qt-Xt)/n,e}if(Ze>Oe&&Ze>Se){const n=st(1+Ze-Oe-Se)*2;return e[0]=(Je-Ge)/n,e[1]=.25*n,e[2]=(Xt+qt)/n,e[3]=(Yt+Kt)/n,e}if(Oe>Se){const n=st(1+Oe-Ze-Se)*2;return e[0]=(Yt-Kt)/n,e[1]=(qt+Xt)/n,e[2]=.25*n,e[3]=(Je+Ge)/n,e}const i=st(1+Se-Ze-Oe)*2;return e[0]=(qt-Xt)/i,e[1]=(Kt+Yt)/i,e[2]=(Je+Ge)/i,e[3]=.25*i,e}function $s(t,e,i,n,r){return r=r||we(),Oe=t[0]/e,Ge=t[4]/i,zn=t[8]/n,Je=t[1]/e,Se=t[5]/i,Vn=t[9]/n,Us=t[2]/e,Gs=t[6]/i,Yi=t[10]/n,F=(1+Oe+Se+Yi)*.25,F>0?(F=Math.sqrt(F),r[0]=F,F=1/(4*F),r[1]=(Vn-Gs)*F,r[2]=(Us-zn)*F,r[3]=(Ge-Je)*F):(r[0]=0,F=-.5*(Se+Yi),F>0?(F=Math.sqrt(F),r[1]=F,F*=2,r[2]=Ge/F,r[3]=zn/F):(r[1]=0,F=.5*(1-Yi),F>0?(F=Math.sqrt(F),r[2]=F,r[3]=Vn/(2*F)):(r[2]=0,r[3]=1))),r}function Oh(t,e,i){i=i||ue();const n=ct([-t[0],-t[1],-t[2]]),r=ct(Ye(e,n)),s=Ye(n,r);return i[0]=r[0],i[1]=s[0],i[2]=n[0],i[3]=0,i[4]=r[1],i[5]=s[1],i[6]=n[1],i[7]=0,i[8]=r[2],i[9]=s[2],i[10]=n[2],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function js(t,e,i){return mt=ki(e[1],e[2],e[3]),F=e[0],Rt(Rt(nt(mt,2*hr(mt,t)),nt(t,F*F-hr(mt,mt))),nt(Ye(mt,t),2*F),i)}function Nh(t,e,i,n){n=n||we();const r=[0,0,0,0];let s,a,o,c,l;return a=t[1]*e[1]+t[2]*e[2]+t[3]*e[3]+t[0]*e[0],a<0?(a=-a,r[0]=-e[1],r[1]=-e[2],r[2]=-e[3],r[3]=-e[0]):(r[0]=e[1],r[1]=e[2],r[2]=e[3],r[3]=e[0]),1-a>1e-7?(s=sc(a),o=Xi(s),c=Xi((1-i)*s)/o,l=Xi(i*s)/o):(c=1-i,l=i),n[1]=c*t[1]+l*r[0],n[2]=c*t[2]+l*r[1],n[3]=c*t[3]+l*r[2],n[0]=c*t[0]+l*r[3],n}function Br(){return[1,0,0,0]}function Ph(){return[0,1,0,0]}function Dh(){return[0,0,1,0]}function Fh(){return[0,0,0,1]}const Sg=Object.freeze(Object.defineProperty({__proto__:null,QR1:rh,QR2:sh,QR3:ah,QR4:oh,QW:hh,QX:ch,QY:lh,QZ:uh,addQuat:dh,angleQuat:xh,axisQuat:Ah,clamp:et,conjugateQuat:cc,decomposeRotation:$s,diffUnitQuat:gh,divideQuat:fh,dotQuat:yh,eulerToQuat:Ih,exponentQuat:ph,fromEulerAxisAngleToQuat:bh,fromOrderedEulerToQuat:uc,iQuat:Ph,imaginaryQuat:Th,inverseQuat:mh,jQuat:Dh,kQuat:Fh,lengthQuat:lc,lookAtMatrix:Oh,lookAtQuat:hc,matrix3x3FromUnitQuatModel:Vs,matrix3x3FromUnitQuatView:Mh,matrix3x3ToQuaternion:Lh,matrix4x4FromUnitQuatModel:Sh,matrix4x4FromUnitQuatView:Ws,matrix4x4ToQuaternion:Ch,multiplyQuat:ac,normalizeQuat:vh,oneQuat:Br,realQuat:wh,rotateVectorByUnitQuat:js,scaleQuat:oc,slerpUnitQuat:Nh,toEulerFromQuat:_h,toEulerXYZfromOrderedEuler:Eh,toOrderedEulerFromQuat:zs,toOrderedEulerFromQuat2:Rh,zeroQuat:we},Symbol.toStringTag,{value:"Module"}));function dc(t,e){return[t,e]}function Bh(t,e,i){return i=i||[0,0,0],Rt(t[0],nt(t[1],e),i)}function fc(t,e,i){return i=i||[[0,0,0],[0,0,0]],it(t,i[0]),ct(xt(e,t),i[1]),i}const Mg=Object.freeze(Object.defineProperty({__proto__:null,ray:dc,rayFromPoints:fc,rayToLocation:Bh},Symbol.toStringTag,{value:"Module"})),Ig=zp,Lg=Sg,Cg=Mg,Og=up;let ke=class{constructor(){this.promise=new Promise((e,i)=>(this.resolver=e,this.rejector=i))}resolve(e){this.resolver(e)}reject(e){this.rejector(e)}},vt=-1,Hs=0,Qs=[],Ur=[],Gr=[];const jn=new Map,Hn=t=>{Hs=t;let e=!1;const i=[];jn.forEach((r,s)=>{e=!0;let[a,o,c,l,u]=r;if(l!==-1&&(u===-1&&(u=t,r[4]=t),t-u>=l)){i.push(s),a(t,u+l);return}if(o!==-1){if(c===-1&&(r[2]=t,c=t),t-c>=o)for(a(t);t-c>=o;)r[2]+=o,c+=o}else a(t)});for(let r=0,s=i.length;r<s;++r){const a=i[r];jn.delete(a)}const n=Ur.slice();Ur=[];for(let r=0,s=n.length;r<s;++r){const[a,o,c]=n[r];o<=0?a&&a(t):t-c>o?a(t):(e=!0,Ur.push(n[r]))}for(let r=0,s=Gr.length;r<s;++r){const a=Gr[r];a&&(e=!0,a(t))}Gr=Qs.slice(0),Qs=[],Gr.length>0&&(e=!0),e?vt=requestAnimationFrame(Hn):vt=-1};vt=requestAnimationFrame(Hn);function kr(t){const e=new ke;return Qs.push(i=>{t&&t(i),e.resolve(i)}),vt===-1&&(vt=requestAnimationFrame(Hn)),e.promise}function Ti(t,e){const i=new ke,n=r=>{t&&t(r),i.resolve(r)};return Ur.push([n,e||-1,Hs]),vt===-1&&(vt=requestAnimationFrame(Hn)),i.promise}function pc(t,e,i){const n=new ke,r=(s,a)=>{t(s),i!==void 0&&i>0?a!==void 0&&n.resolve(a):n.resolve(s)};return jn.set(n.promise,[r,e||-1,-1,i||-1,-1]),vt===-1&&(vt=requestAnimationFrame(Hn)),n.promise}function Uh(t){jn.delete(t),vt===-1&&(vt=requestAnimationFrame(Hn))}function Ng(){jn.forEach(t=>t[0](Hs,Hs)),jn.clear(),Ur=[],Qs=[],Gr=[]}const Tn=new Set,gc=Tn.add.bind(Tn),mc=Tn.delete.bind(Tn),Gh=async()=>{await pc(()=>{Tn.size!==0&&(Tn.forEach(t=>t.update()),Tn.clear())},void 0,Number.POSITIVE_INFINITY),Gh()};Gh();class vc{constructor(){this._children=[],this._needsUpdate=!1,this._childUpdate=new Set}get parent(){return this._parent}set parent(e){this.setParent(e)}get children(){return this._children}get needsUpdate(){return this._needsUpdate}get childUpdate(){return this._childUpdate}addChild(e,i){e.parent!==this&&(i||e.setParent(this,!0),this._children.push(e),this._childUpdate.add(e),e.invalidate())}invalidate(){if(this._needsUpdate)return!1;this._needsUpdate=!0;for(let e=0,i=this._children.length;e<i;++e){const n=this._children[e];this._childUpdate.add(n),n.invalidate()}return!0}processParentUpdates(e){if(!this._parent||!this._parent._needsUpdate)return;const i=[];let n=this._parent;for(;n&&(i.push(n),n._parent&&n._parent.needsUpdate);)n=n._parent;for(let r=i.length-1;r>=0;--r){const s=i[r];e(s),s.resolve()}}removeChild(e,i){e._parent===this&&(e._parent!==void 0&&!i&&e.setParent(void 0,!0),this._children.splice(this._children.indexOf(e),1),this._childUpdate.delete(e))}resolve(){this._needsUpdate&&(this._needsUpdate=!1,this._parent&&this._parent._childUpdate.delete(this))}setParent(e,i){this._parent!==e&&(i||(e!==void 0&&e.addChild(this,!0),this._parent&&this._parent.removeChild(this,!0)),this._parent=e,this.invalidate())}}class Xs extends vc{constructor(e){super(),this.isQueuedForUpdate=!1,this.needsWorldOrientation=!1,this.needsWorldDecomposition=!1,this.hasViewMatrix=!1,this._instance=null,this._matrix={value:ue()},this._localMatrix={value:this._matrix.value},this._rotation={value:Br()},this._localRotation={value:this._rotation.value},this.localRotationMatrix=Ht(),this._scale={value:[1,1,1]},this._localScale={value:this._scale.value},this._position={value:[0,0,0]},this._localPosition={value:this._position.value},this._forward={value:hn()},this._localForward={value:this._forward.value},this.needsForwardUpdate=!1,e&&(e.localPosition&&(this.localPosition=e.localPosition),e.localRotation&&(this.localRotation=e.localRotation),e.localScale&&(this.localScale=e.localScale),e.parent&&(this.parent=e.parent))}set instance(e){this._instance!==e&&this._instance&&(this._instance.transform.instance=null,e&&(e.transform=this)),this._instance=e}get matrix(){return this.update(),this._matrix.value}get localMatrix(){return this.update(),this._localMatrix.value}get viewMatrix(){return this.hasViewMatrix=!0,this._viewMatrix===void 0&&this.invalidate(),this.update(),this._viewMatrix===void 0?ue():this._viewMatrix.value}get localViewMatrix(){return this.hasViewMatrix=!0,this._localViewMatrix===void 0&&this.invalidate(),this.update(),this._localViewMatrix===void 0?ue():this._localViewMatrix.value}get localTransform(){var e;return(e=this._localTransform)==null?void 0:e.value}set localTransform(e){e?(this._localTransform||(this._localTransform={value:ue()}),Gn(e,this._localTransform.value),this._localTransform.didUpdate=!0):delete this._localTransform,this.invalidate()}get localViewTransform(){var e;return(e=this._localViewTransform)==null?void 0:e.value}set localViewTransform(e){e?(this._localViewTransform||(this._localViewTransform={value:ue()}),Gn(e,this._localViewTransform.value),this._localViewTransform.didUpdate=!0):delete this._localViewTransform,this.invalidate()}get rotation(){return this.needsWorldOrientation=!0,this.update(),this._rotation.value}set rotation(e){this.parent?console.warn("NOT IMPLEMENTED: Setting world rotation when a parent is present is not supported yet. Use localRotation for now."):this.localRotation=e}get localRotation(){return this._localRotation.value}set localRotation(e){fe(this._localRotation.value,e[0],e[1],e[2],e[3]),this._localRotation.didUpdate=!0,this.invalidate(),this.needsForwardUpdate=!0}get scale(){return this.needsWorldOrientation=!0,this.update(),this._scale.value}set scale(e){this.parent?console.warn("NOT IMPLEMENTED: Setting world scale is not supported yet. Use localScale for now."):this.localScale=e}get localScale(){return this._localScale.value}set localScale(e){pe(this._localScale.value,e[0],e[1],e[2]),this._localScale.didUpdate=!0,this.invalidate()}get position(){return this.needsWorldOrientation=!0,this.update(),this._position.value}set position(e){this.parent?console.warn("NOT IMPLEMENTED: Setting world position is not supported yet. Use localPosition for now."):this.localPosition=e}get localPosition(){return this._localPosition.value}set localPosition(e){this._localPosition.value[0]=e[0],this._localPosition.value[1]=e[1],this._localPosition.value[2]=e[2],this._localPosition.didUpdate=!0,this.invalidate()}get forward(){var e;return(this.needsForwardUpdate||(e=this.parent)!=null&&e.childUpdate.has(this))&&(this.needsForwardUpdate=!1,js(hn(),this._rotation.value,this._forward.value)),this._forward.value}get localForward(){return this.needsForwardUpdate&&(this.needsForwardUpdate=!1,js(hn(),this._localRotation.value,this._localForward.value)),this._localForward.value}applyLocalSRT(e,i,n){this._localScale.value=e,this._localPosition.value=n,this._localRotation.value=i,this._localScale.didUpdate=!0,this._localPosition.didUpdate=!0,this._localRotation.didUpdate=!0,this.invalidate(),this._instance&&(this._instance.transform=this)}decomposeWorldMatrix(){if(!this.needsWorldDecomposition||!this.parent||!this._matrix.didUpdate||this._matrix.value===this._localMatrix.value)return;if(this._instance){if(!this._instance.needsWorldUpdate||!this.needsWorldOrientation)return}else if(!this.needsWorldOrientation)return;this.needsWorldDecomposition=!1;const e=this._matrix.value,i=this._position.value,n=this._scale.value;this._position.didUpdate=i[0]!==e[12]||i[1]!==e[13]||i[2]!==e[14],this._position.didUpdate&&pe(i,e[12],e[13],e[14]);const r=pi(e[0],e[1],e[2],e[3]),s=pi(e[4],e[5],e[6],e[7]),a=pi(e[8],e[9],e[10],e[11]);this._scale.didUpdate=n[0]!==r||n[1]!==s||n[2]!==a,pe(n,r,s,a),this._scale.didUpdate=!0;const[o,c,l,u]=this._rotation.value;$s(this._matrix.value,r,s,a,this._rotation.value);const h=this._rotation.value;this._rotation.didUpdate=h[0]!==o||h[1]!==c||h[2]!==l||h[3]!==u}lookAtLocal(e,i){hc(xt(e,this._localPosition.value,$e[0]),i||[0,1,0],this._localRotation.value),this._localRotation.didUpdate=!0,this.invalidate(),this.needsForwardUpdate=!0}divideMemory(){this._forward.value=hn(),this._matrix.value=ue(),this._rotation.value=Br(),this._scale.value=[1,1,1],this._position.value=[0,0,0],this.hasViewMatrix&&this._viewMatrix&&this._localViewMatrix&&(this._viewMatrix.value=ue())}mergeMemory(){this._forward.value=this._localForward.value,this._matrix.value=this._localMatrix.value,this._rotation.value=this._localRotation.value,this._scale.value=this._localScale.value,this._position.value=this._localPosition.value,this.hasViewMatrix&&this._viewMatrix&&this._localViewMatrix&&(this._viewMatrix.value=this._localViewMatrix.value)}setParent(e,i){e!==this.parent&&(e?this.parent||this.divideMemory():this.mergeMemory(),this.invalidate(),this.needsForwardUpdate=!0,this._localScale.didUpdate=!0,this._localRotation.didUpdate=!0,this._localPosition.didUpdate=!0,super.setParent(e,i))}invalidate(){return this.queueForUpdate(),super.invalidate()}optimize(){this.needsWorldOrientation=!1}queueForUpdate(){!this.isQueuedForUpdate&&this._instance&&this._instance.active&&(this.isQueuedForUpdate=!0,gc(this))}update(e){let i=!1;if(this.isQueuedForUpdate&&(mc(this),this.isQueuedForUpdate=!1),this.needsUpdate){const n=this.localRotationMatrix;this._localRotation.didUpdate&&Vs(this._localRotation.value,n),this._localTransform?(Fs(this._localScale.value,n,this._localPosition.value,Ue[0]),rt(this._localTransform.value,Ue[0],this._localMatrix.value)):Fs(this._localScale.value,n,this._localPosition.value,this._localMatrix.value),this._localMatrix.didUpdate=!0,i=!0,this.hasViewMatrix&&(this._viewMatrix===void 0&&(this._viewMatrix={value:ue()}),this._localViewMatrix===void 0&&(this.parent?this._localViewMatrix={value:ue()}:this._localViewMatrix={value:this._viewMatrix.value}),this._localViewTransform?(Nr(Fn(this._localScale.value,$e[0]),Cr(n,vn[1]),nt(this._localPosition.value,-1,$e[1]),Ue[0]),rt(this._localViewTransform.value,Ue[0],this._localViewMatrix.value)):Nr(Fn(this._localScale.value,$e[0]),Cr(n,vn[1]),nt(this._localPosition.value,-1,$e[1]),this._localViewMatrix.value),this._localViewMatrix.didUpdate=!0)}this.parent&&(this.parent.needsUpdate?(e||this.processParentUpdates(n=>{n.update(!0)}),i=!0):this.parent.childUpdate.has(this)&&(i=!0),i&&(rt(this.parent._matrix.value,this._localMatrix.value,this._matrix.value),this._matrix.didUpdate=!0,this.needsWorldDecomposition=!0,this.hasViewMatrix&&this._viewMatrix&&this._localViewMatrix&&(this.parent.hasViewMatrix&&this.parent._viewMatrix&&this.parent._localViewMatrix?rt(this.parent._viewMatrix.value,this._localViewMatrix.value,this._viewMatrix.value):(Vs(this.parent.rotation,vn[0]),Nr(Fn(this.parent._scale.value,$e[0]),Cr(vn[0],vn[1]),nt(this.parent._position.value,-1,$e[1]),Ue[0]),rt(this._localViewMatrix.value,Ue[0],this._viewMatrix.value)),this._viewMatrix.didUpdate=!0))),this.decomposeWorldMatrix(),this._instance&&this._instance.active&&(this._localMatrix.didUpdate||this._matrix.didUpdate)&&(this._instance.needsLocalUpdate&&(this._localRotation.didUpdate&&(this._instance._localRotation=this._localRotation.value),this._localPosition.didUpdate&&(this._instance._localPosition=this._localPosition.value),this._localScale.didUpdate&&(this._instance._localScale=this._localScale.value)),this._instance.needsWorldUpdate&&(this.parent?(this._rotation.didUpdate&&(this._instance._rotation=this._rotation.value),this._scale.didUpdate&&(this._instance._scale=this._scale.value),this._position.didUpdate&&(this._instance._position=this._position.value)):(this._localRotation.didUpdate&&(this._instance._rotation=this._localRotation.value),this._localPosition.didUpdate&&(this._instance._position=this._localPosition.value),this._localScale.didUpdate&&(this._instance._scale=this._localScale.value))),this._matrix.didUpdate&&(this._instance._matrix=this._matrix.value),this._localMatrix.didUpdate&&(this._instance._localMatrix=this._localMatrix.value,this.parent||(this._instance._matrix=this._matrix.value))),this._localScale.didUpdate=!1,this._localRotation.didUpdate=!1,this._localPosition.didUpdate=!1,this._rotation.didUpdate=!1,this._scale.didUpdate=!1,this._position.didUpdate=!1,this._matrix.didUpdate=!1,this._localMatrix.didUpdate=!1,this.resolve()}}const kh=new Xs;var yi=(t=>(t[t.PERSPECTIVE=0]="PERSPECTIVE",t[t.ORTHOGRAPHIC=1]="ORTHOGRAPHIC",t))(yi||{});function zh(t){return t.projectionOptions.type===1&&"left"in t.projectionOptions}function wc(t){return t.projectionOptions.type===0&&"fov"in t.projectionOptions}class bi{constructor(e){this._id=G(),this.animationEndTime=0,this.needsViewDrawn=!0,this.needsBroadcast=!1,this.viewChangeViewId="",this.transform=new Xs,this._projection=ue(),this._needsUpdate=!0,this._viewProjection=ue(),this._projectionOptions=e,this._needsUpdate=!0,this.onChange=e.onViewChange,this.update()}get id(){return this._id}broadcast(e){this.onChange&&this.onChange(this,e)}static makeOrthographic(e){return new bi(Object.assign({left:-100,right:100,top:-100,bottom:100,near:-100,far:1e5,type:1},e))}static makePerspective(e){return new bi(Object.assign({type:0,far:1e4,near:1,fov:90*Math.PI/180,height:1e3,width:1e3},e))}get projectionType(){return this._projectionOptions.type}get projection(){return this.update(!0),this._projection}get view(){return this.transform.viewMatrix}get needsUpdate(){return this._needsUpdate}get position(){return this.transform.position}set position(e){this._needsUpdate=this._needsUpdate||!lr(e,this.transform.position),this.transform.position=e}lookAt(e,i){const n=Gn(this.transform.matrix);this.transform.lookAtLocal(e,i||[0,1,0]),this._needsUpdate=this._needsUpdate||!ic(n,this.transform.matrix)}get scale(){return this.transform.scale}set scale(e){this._needsUpdate=this._needsUpdate||!lr(e,this.transform.scale),this.transform.scale=e}get projectionOptions(){return this._projectionOptions}set projectionOptions(e){this._needsUpdate=this._needsUpdate||!rc(e,this._projectionOptions),this._projectionOptions=e}get viewProjection(){return this.update(!0),this._viewProjection}setOrthographic(e){this._projectionOptions=Object.assign({left:-100,right:100,top:-100,bottom:100,near:-100,far:1e5,type:1},e)}setPerspective(e){this._projectionOptions=Object.assign({type:0,far:1e4,near:1,fov:90*Math.PI/180,height:1e3,width:1e3},e)}resolve(){this._needsUpdate=!1,this.needsViewDrawn=!1,this.needsBroadcast=!1}update(e){(this._needsUpdate||e)&&(this.updateProjection(),this._needsUpdate=!1,this.needsViewDrawn=!0)}updateProjection(){zh(this)?ec(this.projectionOptions.left,this.projectionOptions.right,this.projectionOptions.bottom,this.projectionOptions.top,this.projectionOptions.near,this.projectionOptions.far,this._projection):wc(this)&&Jo(this.projectionOptions.fov,this.projectionOptions.width,this.projectionOptions.height,this.projectionOptions.near,this.projectionOptions.far,this._projection),rt(this._projection,this.transform.viewMatrix,this._viewProjection)}}class yn{get id(){return this._key}get key(){return this._key}constructor(e){this._key=e.key}}function Pg(t){return{key:"",type:le.COLOR_BUFFER,...t}}function Ys(t){return t!==void 0&&t.key!==void 0&&t.type===le.COLOR_BUFFER}class Vh extends yn{constructor(e,i){super(e),this.type=le.COLOR_BUFFER,this.height=e.height,this.width=e.width,this.colorBufferSettings=e.colorBufferSettings,this.createColorBuffer(i)}destroy(){this.colorBuffer.destroy()}createColorBuffer(e){if(this.colorBuffer)return;this.colorBufferSettings={...this.colorBufferSettings};let i,n;const r=(e==null?void 0:e.getRenderSize())||[1,1];if(this.width<=lt.SCREEN){if(!e)throw new Error("Can not generate Render Texture with a dynamic width or height when the WebGLRenderer is not available");i=r[0]/-this.width}else i=this.width;if(this.height<=lt.SCREEN){if(!e)throw new Error("Can not generate Render Texture with a dynamic width or height when the WebGLRenderer is not available");n=r[1]/-this.width}else n=this.height;this.colorBuffer=new Wl({internalFormat:d.GLSettings.RenderTarget.ColorBufferFormat.RGBA4,size:[i,n],...this.colorBufferSettings})}}class Qn{get webGLRenderer(){return this._webGLRenderer}set webGLRenderer(e){this._webGLRenderer=e}getIOExpansion(){return[]}resize(){}setAttributeContext(e){}}class Wh extends Qn{constructor(){super(...arguments),this.resources=new Map}async dequeueRequests(){return!1}destroy(){}destroyResource(e){this.resources.delete(e.key)}getResource(e){return this.resources.get(e)||{key:"",type:-1}}async initResource(e){this.resources.set(e.key,e)}request(e,i,n){return[0,0,0,0]}updateResource(e){}}const $h=new Wh;class Dg extends Qn{constructor(){super(...arguments),this.resources=new Map}async dequeueRequests(){return!1}destroy(){this.resources.forEach(e=>e.destroy()),this.resources.clear()}getIOExpansion(){return[]}getResource(e){return this.resources.get(e)||null}destroyResource(e){const i=this.resources.get(e.key);i&&(i.destroy(),this.resources.delete(e.key))}async initResource(e){let i=this.resources.get(e.key);if(i){console.warn("Attempted to generate a RenderTexture that already exists for key",e.key);return}i=new Vh(e,this.webGLRenderer),this.resources.set(e.key,i)}request(e,i,n,r){const s=this.resources.get(n.key);return s?(n.colorBuffer=s.colorBuffer,[0,0,1,1]):[0,0,0,0]}resize(){const e=new Map;this.resources.forEach((i,n)=>{i.width>lt.SCREEN&&i.height>lt.SCREEN||(i.colorBuffer.destroy(),i=new Vh(i,this.webGLRenderer),e.set(n,i))}),e.forEach((i,n)=>this.resources.set(n,i))}updateResource(e){this.resources.get(e.key)&&console.warn("UPDATING AN EXISTING COLOR BUFFER IS NOT SUPPORTED YET")}}function Tc(t){return{type:le.COLOR_BUFFER,...t}}const zr=class{static setObservableMonitor(t){zr.gatherIds=t,zr.observableIds=[]}static getObservableMonitorIds(t){const e=zr.observableIds.slice(0);return t&&(zr.observableIds=[]),e}};let je=zr;je.setCycle=!1,je.gatherIds=!1,je.observableIds=[],je.observableNamesToUID=new Map;const Zt=je,qs=new Map;let Fg=1;const Bg={}.constructor;function Ug(t,e){const i=Zt.observableNamesToUID.get(e)||0;if(i===0){console.warn("A property with name",e,"for",t,"has not been assigned a UID which is an error in this step of the process.");return}function n(){return Zt.gatherIds&&(Zt.setCycle||Zt.observableIds.push(i)),t.observableStorage[i]}function r(a){Zt.gatherIds&&(Zt.setCycle=!0),t.observableStorage[i]=a,t.changes[i]=i,t.observer&&t.observer.instanceUpdated(t),Zt.gatherIds&&(Zt.setCycle=!1)}const s=t[e];Object.defineProperty(t,e,{configurable:!0,enumerable:!0,get:n,set:r}),t[e]=s}function M(t,e,i){i||(i={configurable:!0,enumerable:!0});let n=qs.get(t.constructor),r=Zt.observableNamesToUID.get(e)||0;r===0&&(r=++Fg,Zt.observableNamesToUID.set(e,r)),n||(n=new Set,qs.set(t.constructor,n)),n.add(e);let s=Object.getPrototypeOf(t),a=0;for(;s.constructor!==Bg&&++a<100;){const o=qs.get(s.constructor);o&&o.forEach(c=>n==null?void 0:n.add(c)),s=Object.getPrototypeOf(s)}a>=100&&console.warn("@observable decorator encountered a type that has 100+ levels of inheritance. This is most likely an error, and may be a result of a circular dependency and will not be supported by this decorator."),i.enumerable=!0,i.writable=!0,Object.defineProperty(t,e,i)}function He(t,e){if(t.constructor!==e)return;const i=qs.get(e);i&&i.forEach(n=>Ug(t,n))}class he{constructor(e){if(this._uid=G(),this.cleanObservation=new Map,this.instanceChanges=new Map,this.allowChanges=!0,this.resolveContext="",e)for(let i=0,n=e.length;i<n;++i){const r=e[i];this.add(r)}}get uid(){return this._uid}get changeList(){this.allowChanges=!1;const e=[];return this.instanceChanges.forEach(i=>e.push(i)),e}add(e){if(this.cleanObservation.get(e.uid))return e;if(this.allowChanges){e.observer=this;const i=e.observableDisposer;this.cleanObservation.set(e.uid,[e,i]),this.instanceChanges.set(e.uid,[e,Le.INSERT,e.changes])}return e}has(e){return this.cleanObservation.has(e.uid)}clear(){this.cleanObservation.forEach(e=>{this.remove(e[0])})}destroy(){this.cleanObservation.forEach(e=>{e[1]()}),this.cleanObservation.clear(),this.instanceChanges.clear()}instanceUpdated(e){this.allowChanges&&this.instanceChanges.set(e.uid,[e,Le.CHANGE,e.changes])}remove(e){if(this.allowChanges){const i=this.cleanObservation.get(e.uid);i&&(i[1](),this.cleanObservation.delete(e.uid),this.instanceChanges.set(e.uid,[i[0],Le.REMOVE,{}]))}return!1}resolve(e){if(this.allowChanges=!0,this.instanceChanges.clear(),this.resolveContext&&this.resolveContext!==e)throw new Error("An instance provider has been issued to two layers. This is not a suppported feature yet and can cause issues.");this.resolveContext=e}sync(){const e=[];this.cleanObservation.forEach(i=>{const[n]=i;this.instanceChanges.set(n.uid,[n,Le.INSERT,e])})}}class Gg extends he{constructor(e){super(e),this._instances=[]}get instances(){return this._instances}add(e){return this._instances.push(e),super.add(e)}clear(){this._instances.length=0,super.clear()}remove(e){const i=this._instances.findIndex(n=>n.uid===e.uid);return i!==-1&&this._instances.splice(i,1),super.remove(e)}destroy(){this._instances.length=0,super.destroy()}}class jh{constructor(e){this.delay=0,this.isManualStart=!1,this.isTimeSet=!1,this.startTime=-1,Object.assign(this,e)}setAutomatic(){this.isManualStart=!1,this.isTimeSet=!1}setStart(e){e&&(this.start.length!==e.length?console.warn("A manual easing adjustment provided an incompatible value for the easing type."):(this.start=e,this.isManualStart=!0))}setTiming(e,i){this.delay=e===void 0?this.delay:e,this.duration=i===void 0?this.duration:i,this.isTimeSet=!0}}var kg=Object.defineProperty,zg=Object.getOwnPropertyDescriptor,Hh=(t,e,i,n)=>{for(var r=n>1?void 0:n?zg(e,i):e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(r=(n?a(e,i,r):a(r))||r);return n&&r&&kg(e,i,r),r};let Qh=0;const yc=class{constructor(t){this._active=!1,this.changes={},this._observer=null,this.observableStorage=[],this._uid=yc.newUID,this.reactivate=!1,He(this,yc),t&&(this.active=t.active||this.active)}static get newUID(){return Qh=++Qh%16777215}get active(){return this._active}set active(t){this._active=t,this.reactivate=!0}get observableDisposer(){return()=>this._observer=null}get observer(){return this._observer||null}set observer(t){const e=this._observer;e&&e!==t&&(this.easing&&this.easing.clear(),e.remove(this)),this._observer=t}getEasing(t){if(this.easingId){const e=this.easingId[`_${t}_end`];if(e&&this.easing){const i=this.easing.get(e);if(i instanceof jh)return i}}}get uid(){return this._uid}resourceTrigger(){console.warn("resourceTrigger called on an instance that did not override resourceTrigger. resourceTrigger MUST be overridden for instances","that utilize a resource. The observable that is tied to committing the resource should be 'triggered' in this method.")}};let ze=yc;Hh([M],ze.prototype,"_active",2),Hh([M],ze.prototype,"_uid",2);class Vg extends ze{resourceTrigger(){}}function bc(t){return{key:"",type:le.TEXTURE,...t}}function bn(t){return t&&t.key!==void 0&&t.type===le.TEXTURE}class Ec extends yn{constructor(e,i){super(e),this.type=le.TEXTURE,this.height=e.height,this.width=e.width,this.textureSettings=e.textureSettings,this.createTexture(i)}destroy(){this.texture.destroy()}createTexture(e){var s;if(this.texture)return;this.textureSettings={generateMipMaps:!0,premultiplyAlpha:!1,...this.textureSettings};let i,n;const r=(e==null?void 0:e.getRenderSize())||[1,1];if(this.width<=lt.SCREEN){if(!e)throw new Error("Can not generate Render Texture with a dynamic width or height when the WebGLRenderer is not available");i=r[0]/-this.width}else i=this.width;if(this.height<=lt.SCREEN){if(!e)throw new Error("Can not generate Render Texture with a dynamic width or height when the WebGLRenderer is not available");n=r[1]/-this.width}else n=this.height;this.texture=new se({data:((s=this.textureSettings)==null?void 0:s.data)||{width:i,height:n,buffer:null},...this.textureSettings})}}const Wg=`varying highp vec4 _picking_color_pass_;
void main() {
\${out: _picking_fragment_} = _picking_color_pass_;
}`;function Xh(t){return t}class Qe{constructor(e,i,n,r){this.child=[null,null],this.isLeaf=!0,this.data=null,this.bounds=new te({height:r,width:n,x:e,y:i})}destroy(){const e=this.child[0],i=this.child[1];this.data=null,e&&e.destroy(),i&&i.destroy(),this.child[0]=null,this.child[1]=null}hasChild(){const e=this.child[0],i=this.child[1];return e&&!e.data?!e.isLeaf:i&&!i.data?!i.isLeaf:!1}insert(e){let i=this.child[0],n=this.child[1];if(!this.isLeaf&&i&&n){const r=i.insert(e);return r!==null?r:n.insert(e)}else{if(this.data)return null;const r=this.bounds.fits(e.bounds);if(r===0)return null;if(r===1)return this.data=e.data,this;this.isLeaf=!1;const s=e.bounds.width,a=e.bounds.height,o=this.bounds.width-s,c=this.bounds.height-e.bounds.height;o>c?(i=this.child[0]=new Qe(this.bounds.x,this.bounds.y,s,this.bounds.height),n=this.child[1]=new Qe(this.bounds.x+s,this.bounds.y,o,this.bounds.height)):(i=this.child[0]=new Qe(this.bounds.x,this.bounds.y,this.bounds.width,a),n=this.child[1]=new Qe(this.bounds.x,this.bounds.y+a,this.bounds.width,c))}return i.insert(e)}remove(e){const i=this.child[0],n=this.child[1];if(n&&i&&!this.isLeaf){let r=i.remove(e);return r?!0:(r=n.remove(e),i.hasChild()||n.hasChild()||(this.child[0]=null,this.child[1]=null),r)}else return this.data===e?(this.data=null,!0):!1}static applyToSubTexture(e,i,n,r,s){if(!n)return;r=r||{top:0,left:0,bottom:0,right:0};const a=i instanceof Qe?i.bounds:i,o=(a.x+r.left)/e.bounds.width,c=(a.y+r.top)/e.bounds.height,l=(a.width-r.left-r.right)/e.bounds.width,u=(a.height-r.top-r.bottom)/e.bounds.height;let h;s?h=new te({bottom:1-c,left:o,right:o+l,top:1-(c+u)}):h=new te({top:1-c,left:o,right:o+l,bottom:1-(c+u)});const f=h.bottom,p=h.y,g=h.x,m=h.x+h.width;n.atlasTL=[g,p],n.atlasBR=[m,f],n.atlasBL=[g,f],n.atlasTR=[m,p],n.widthOnAtlas=Math.abs(n.atlasTR[0]-n.atlasTL[0]),n.heightOnAtlas=Math.abs(n.atlasTR[1]-n.atlasBR[1]),n.pixelWidth=l*e.bounds.width,n.pixelHeight=u*e.bounds.height}}function Yh(t){return t&&t.call!==void 0&&t.apply!==void 0}function qi(t,e,i){let n=t.get(e);return n===void 0&&(Yh(i)?n=i():n=i,t.set(e,n)),n}function Ks(t,e,i){let n=t.get(e);return n===void 0&&(Yh(i)?n=i():n=i),n}class tt{}tt.transparentShapeBlending={blending:{blendDst:d.GLSettings.Material.BlendingDstFactor.OneMinusSrcAlpha,blendEquation:d.GLSettings.Material.BlendingEquations.Add,blendSrc:d.GLSettings.Material.BlendingSrcFactor.SrcAlpha},culling:d.GLSettings.Material.CullSide.NONE,modify(t){return Object.assign({},this,t)}},tt.transparentImageBlending={blending:{blendSrc:d.GLSettings.Material.BlendingSrcFactor.One,blendDst:d.GLSettings.Material.BlendingDstFactor.OneMinusSrcAlpha,blendEquation:d.GLSettings.Material.BlendingEquations.Add},culling:d.GLSettings.Material.CullSide.NONE,modify(t){return Object.assign({},this,t)}};class $g{static async modify(e,i,n){for(let r=0,s=i.length;r<s;++r){const a=i[r];for(let o=0,c=e.length;o<c;++o){const l=e[o],u=l.getEasing(a);u&&n(u,l,o,r)}}}static async all(e,i,n,r){let s=xs;const a=new Promise(l=>s=l);let o=0;for(let l=0,u=n.length;l<u;++l){const h=n[l];for(let f=0,p=i.length;f<p;++f){const g=i[f],m=g.getEasing(h);m&&(r&&r(m,g,f,l),o=Math.max((m.delay||0)+m.duration,o))}}const c=l=>{l<o?Ti(c):s()};return e?Ti(l=>{o+=l,c(l)}):s(),a}}const jg=5,Hg=10;function Qg(t,e){const i=[];return e.forEach(n=>{t.find(r=>n instanceof r)&&i.push(n)}),i}class qh{destroy(){this.TL.destroy(),this.TR.destroy(),this.BL.destroy(),this.BR.destroy()}constructor(e,i){const n=e.mid;this.TL=new Xn(e.x,n[0],e.y,n[1],i),this.TR=new Xn(n[0],e.right,e.y,n[1],i),this.BL=new Xn(e.x,n[0],n[1],e.bottom,i),this.BR=new Xn(n[0],e.right,n[1],e.bottom,i)}}class Xn{constructor(e,i,n,r,s){this.children=[],this.depth=0,arguments.length>=4?this.bounds=new te({left:e,right:i,top:n,bottom:r}):this.bounds=new te({left:0,right:1,top:0,bottom:1}),this.depth=s||0}destroy(){this.children=[],this.nodes&&(this.nodes.destroy(),delete this.nodes)}add(e,i){return e.isInside(this.bounds)?this.doAdd(e):(this.cover(e),this.add(e,i))}addAll(e){let i=Number.MAX_SAFE_INTEGER,n=Number.MAX_SAFE_INTEGER,r=Number.MIN_SAFE_INTEGER,s=Number.MIN_SAFE_INTEGER;const{min:a,max:o}=Math;for(let c=0,l=e.length;c<l;++c){const u=e[c];i=a(i,u.x),r=o(u.right,r),n=a(n,u.y),s=o(s,u.bottom)}this.cover(new te({left:i,right:r,top:n,bottom:s})),e.forEach(c=>this.doAdd(c))}cover(e){if(e.isInside(this.bounds))return;this.bounds.encapsulate(e),this.bounds.x-=1,this.bounds.y-=1,this.bounds.width+=2,this.bounds.height+=2;const i=this.gatherChildren([]);this.nodes&&(this.nodes.destroy(),delete this.nodes),i.forEach(n=>this.doAdd(n))}doAdd(e){return this.nodes?e.isInside(this.nodes.TL.bounds)?this.nodes.TL.doAdd(e):e.isInside(this.nodes.TR.bounds)?this.nodes.TR.doAdd(e):e.isInside(this.nodes.BL.bounds)?this.nodes.BL.doAdd(e):e.isInside(this.nodes.BR.bounds)?this.nodes.BR.doAdd(e):(this.children.push(e),!0):e.isInside(this.bounds)?(this.children.push(e),this.children.length>jg&&this.depth<Hg&&this.split(),!0):(isNaN(e.width+e.height+e.x+e.y)?console.error("Child did not fit into bounds because a dimension is NaN",e):e.area===0&&console.error("Child did not fit into bounds because the area is zero",e),!0)}gatherChildren(e,i){i&&i(this);for(let n=0,r=this.children.length;n<r;++n)e.push(this.children[n]);return this.nodes&&(this.nodes.TL.gatherChildren(e,i),this.nodes.TR.gatherChildren(e,i),this.nodes.BL.gatherChildren(e,i),this.nodes.BR.gatherChildren(e,i)),e}query(e,i){return e instanceof te?e.hitBounds(this.bounds)?this.queryBounds(e,[],i):[]:Aa(e)&&this.bounds.containsPoint(e)?this.queryPoint(e,[],i):[]}queryBounds(e,i,n){return this.bounds.isInside(e)?(this.gatherChildren(i,n),i):(this.children.forEach(r=>{r.hitBounds(e)&&i.push(r)}),n&&n(this),this.nodes&&(e.hitBounds(this.nodes.TL.bounds)&&this.nodes.TL.queryBounds(e,i,n),e.hitBounds(this.nodes.TR.bounds)&&this.nodes.TR.queryBounds(e,i,n),e.hitBounds(this.nodes.BL.bounds)&&this.nodes.BL.queryBounds(e,i,n),e.hitBounds(this.nodes.BR.bounds)&&this.nodes.BR.queryBounds(e,i,n)),i)}queryPoint(e,i,n){return this.children.forEach(r=>{r.containsPoint(e)&&i.push(r)}),n&&n(this),this.nodes&&(this.nodes.TL.bounds.containsPoint(e)&&this.nodes.TL.queryPoint(e,i,n),this.nodes.TR.bounds.containsPoint(e)&&this.nodes.TR.queryPoint(e,i,n),this.nodes.BL.bounds.containsPoint(e)&&this.nodes.BL.queryPoint(e,i,n),this.nodes.BR.bounds.containsPoint(e)&&this.nodes.BR.queryPoint(e,i,n)),i}split(){const e=[];this.gatherChildren(e),this.nodes=new qh(this.bounds,this.depth+1),this.children=[];for(let i=0,n=e.length;i<n;++i){const r=e[i];r&&this.doAdd(r)}}visit(e){const i=!!e(this);this.nodes&&!i&&(this.nodes.TL.visit(e),this.nodes.TR.visit(e),this.nodes.BL.visit(e),this.nodes.BR.visit(e))}}class Kh extends Xn{}class Vr{constructor(e){this.willDispose=new Set,this.keyToItem=new Map,this.keyToInitializer=new Map,this.currentInitalizerIndex=0,this.currentInitializers=[],this._items=[],this.inlineDeferred=i=>{this.deferredInlining=i},this.inlineImmediate=i=>{if(i.length>0&&this.currentInitializers&&this.currentItem){this.currentInitializers.splice(this.currentInitalizerIndex+1,0,...i);for(let n=0,r=i.length;n<r;++n){const s=i[n];s.parent=this.currentItem}}},this.inline=this.inlineImmediate,this.options=e}get items(){return this._items.slice(0)}async destroy(){const e=[];for(let i=0,n=this.currentInitializers.length;i<n;++i){const r=this.currentInitializers[i],s=this.keyToItem.get(r.key);s&&e.push(this.options.destroyItem(r,s))}await Promise.all(e)}async diff(e){const i=e.slice(0);this.currentInitializers=i,this._items=[];let n=0;for(;n<i.length;){const r=i[n];if(this.currentInitalizerIndex=n,this.currentInitializer=r,this.willDispose.has(r.key)){let s=this.keyToItem.get(r.key)||null;s?(this.currentItem=s,await this.options.updateItem(r,s)):s=await this.options.buildItem(r),s&&(this.keyToInitializer.set(r.key,r),this.willDispose.delete(r.key),this._items.push(s))}else{this.inline=this.inlineDeferred;const s=await this.options.buildItem(r);this.inline=this.inlineImmediate,s&&(this.currentItem=s,this.deferredInlining&&(this.inline(this.deferredInlining),delete this.deferredInlining),this.keyToItem.set(r.key,s),this.keyToInitializer.set(r.key,r),this._items.push(s))}delete this.currentItem,n++}this.willDispose.forEach(async r=>{const s=this.keyToItem.get(r),a=this.keyToInitializer.get(r);if(!s||!a)return;await this.options.destroyItem(a,s)&&(this.keyToItem.delete(r),this.keyToInitializer.delete(r))}),this.willDispose.clear(),this.keyToInitializer.forEach(r=>{this.willDispose.add(r.key)}),this.currentInitializers=[],delete this.currentItem,delete this.currentInitializer}getByKey(e){return this.keyToItem.get(e)}async rebuild(){if(!this.currentItem||!this.currentInitializer)return;this.keyToItem.delete(this.currentItem.id),this.keyToInitializer.delete(this.currentItem.id),this.options.destroyItem(this.currentInitializer,this.currentItem);const e=await this.options.buildItem(this.currentInitializer);e&&(this.keyToItem.set(this.currentItem.id,e),this.keyToInitializer.set(this.currentItem.id,this.currentInitializer))}}function Ki(t){const{shader:e,options:i={},required:n,onError:r,onToken:s,onMain:a}=t,o=new Map,c=new Map,l=new Map,u=new Map,h=e.replace(/\$\{([^\}]*)\}/g,(p,g)=>{let m="";return u.set(g,(u.get(g)||0)+1),g in i?(o.set(g,(o.get(g)||0)+1),m=i[g]):c.set(g,(c.get(g)||0)+1),s&&(m=s(g,m)),m});Object.keys(i).forEach(p=>{o.get(p)||l.set(p,(l.get(p)||0)+1)});const f={resolvedShaderOptions:o,shader:h,shaderProvidedOptions:u,unresolvedProvidedOptions:l,unresolvedShaderOptions:c};if(n&&n.values.forEach(p=>{if(f.unresolvedProvidedOptions.get(p)){const g=`${n.name}: Could not resolve all the required inputs. Input: ${p}`;r?r(g):console.error(g)}else if(f.unresolvedShaderOptions.get(p)){const g=`${n.name}: A required option was not provided in the options parameter. Option: ${p}`;r?r(g):console.error(g)}else if(!f.resolvedShaderOptions.get(p)){const g=`${n.name}: A required option was not provided in the options parameter. Option: ${p}`;r?r(g):console.error(g)}}),a){const p=f.shader,g=p.match(/void((.+)|\s)(main(\s+)\(\)|main\(\))(((.+)(\s*)\{)|(\s*)\{)/gm);if(g&&g.length>0){const m=p.indexOf(g[0]);if(m<0)a(null);else{const T=p.substr(0,m),w=p.substr(m+g[0].length);let y=!1,b=!1,x=1,R=0,N=-1;for(let I=0,S=w.length;I<S;++I){const j=w[I],Q=w[I+1];switch(j){case"/":switch(Q){case"*":!y&&!b&&(y=!0,I++);break;case"/":!y&&!b&&(b=!0,I++);break}break;case"*":Q==="/"&&(b||(y=!1,I++));break;case`
`:case"\r":y||(b=!1);break;case"{":!y&&!b&&x++;break;case"}":!y&&!b&&R++,x===R&&(N=I);break}if(N!==-1)break}if(N!==-1){const I=w.substr(0,N),S=w.substr(N+1),j=a(I,`${T}
${S}`);typeof j=="string"?f.shader=p.substr(0,m+g[0].length)+j+p.substr(m+g[0].length+N):f.shader=p.substr(0,m)+j.header+p.substr(m,g[0].length)+j.main+p.substr(m+g[0].length+N)}else a(null)}}}return f}function Xg(t){return new Promise(e=>setTimeout(e,t))}function Yg(t){let e=0,i=[];return Object.assign(async r=>{if(r!==void 0&&r!==t&&(i.forEach(u=>u.resolve(!1)),t=r),!t)return!1;const s=++e,a=new ke;let o=t.getBoundingClientRect(),c;if(i.push(a),o.width===0||o.height===0){let u=!0;const h={attributes:!0};c=new MutationObserver(f=>{if(u){for(const p of f)if(p.type==="attributes"){if(!t)return;o=t.getBoundingClientRect(),o.width!==0&&o.height!==0&&(c&&(c.disconnect(),c=void 0),u=!1,a.resolve(s===e))}}}),c.observe(t,h),await kr(),o=t.getBoundingClientRect(),u&&o.width!==0&&o.height!==0&&(c.disconnect(),u=!1,a.resolve(s===e))}else await kr(),a.resolve(s===e);const l=await a.promise;return c&&(c.disconnect(),c=void 0),l&&(i.forEach(u=>u.resolve(!1)),i=[]),l},{cancel:()=>{i.forEach(r=>r.resolve(!1)),i=[]}})}function En(t,e){const i=Object.assign(e,{key:e.key||t.defaultProps.key,data:e.data||t.defaultProps.data});return{get key(){return e.key||""},init:[t,i]}}function _n(t,e){const i=Object.assign(e,{key:e.key||t.defaultProps.key,data:e.data||t.defaultProps.data});return{get key(){return e.key||""},init:[t,i]}}function Zh(t){return t}function Jh(t){return t}const qg={layer:En,view:Pc,vertex:Jh,uniform:Zh,attribute:Xh};class Kg{constructor(e){this.index=-1,this.marker=new Map,this.pool=new Array(e.firstAlloc);for(let i=0,n=e.firstAlloc;i<n;++i)this.pool[i]=e.create();this.options=e}destroy(){for(let e=0,i=this.pool.length;e<i;++e)this.options.destroy(this.pool[e]);this.pool=[],this.marker.clear()}retrieve(){const e=this.pool[this.index+1];return this.index++,this.marker.set(e,this.index),e}replace(e){const i=this.marker.get(e);i!==void 0&&(this.pool[i]=this.pool[this.index],this.pool[this.index]=e,this.marker.delete(e),this.index--)}}function Zg(t,e,i,n){return e<0&&(e=t.length+e,e<0&&(e=0)),t.slice(0,e)+(n||"")+t.slice(e+i)}function Wr(t){let e=!1,i=!1;const n=[];let r={start:-1,stop:-1},s={start:-1,stop:-1};for(let a=0,o=t.length;a<o;++a){const c=t[a],l=t[a+1];switch(c){case"/":switch(l){case"*":!i&&!e&&(r.start=a,e=!0,a++);break;case"/":!e&&!i&&(s.start=a,i=!0,a++);break}break;case"*":l==="/"&&e&&(r.stop=a+2,n.push(r),r={start:-1,stop:-1},e=!1,a++);break;case`
`:case"\r":i&&(s.stop=a,n.push(s),s={start:-1,stop:-1},i=!1);break}}return n.reverse(),n.forEach(a=>{t=Zg(t,a.start,a.stop-a.start)}),t}function Zi(t){return t?[t.atlasTL[0],t.atlasTL[1],t.atlasBR[0],t.atlasBR[1]]:[0,0,0,0]}class Ei{constructor(e){this._uid=G(),this.aspectRatio=1,this.atlasTL=[0,0],this.atlasTR=[0,0],this.atlasBL=[0,0],this.atlasBR=[0,0],this.heightOnAtlas=0,this.isValid=!1,this.pixelWidth=0,this.pixelHeight=0,this.texture=null,this.widthOnAtlas=0,Object.assign(this,e)}get uid(){return this._uid}static fromRegion(e,i){if(!e.data)return null;const n=i.x/e.data.width,r=i.y/e.data.height,s=i.width/e.data.width,a=i.height/e.data.height,o=new te({bottom:r+a,left:n,right:n+s,top:r}),c=o.bottom,l=o.y,u=o.x,h=o.x+o.width,f=new Ei;return f.atlasTL=[u,l],f.atlasBR=[h,c],f.atlasBL=[u,c],f.atlasTR=[h,l],f}update(){!this.texture||!this.source||!this.atlasRegion||this.texture.update(this.source,this.atlasRegion)}toString(){return JSON.stringify({atlas:{TL:this.atlasTL,TR:this.atlasTR,BL:this.atlasBL,BR:this.atlasBR},width:this.pixelWidth,height:this.pixelHeight},null,2)}}const Jg=xe("performance");function ed(t){return{key:"",type:le.ATLAS,...t}}function _c(t){return t&&t.type===le.ATLAS}class td extends yn{constructor(e){super(e),this.resourceReferences=new Map,this.type=le.ATLAS;const i=document.createElement("canvas");if(this.width=i.width=e.width,this.height=i.height=e.height,this.textureSettings=e.textureSettings,e.width<0||e.height<0)throw new Error("TextureSize Error: An atlas does NOT support Screen Texture sizing.");this.packing=new Qe(0,0,e.width,e.height),this.createTexture(i)}createTexture(e){if(this.texture)return;let i;this.textureSettings?i={generateMipMaps:!0,premultiplyAlpha:!0,...this.textureSettings}:i={generateMipMaps:!0,premultiplyAlpha:!0},this.texture=new se({data:e,...i})}destroy(){var e;(e=this.texture)==null||e.destroy(),this.resourceReferences.forEach(i=>{this.invalidateTexture(i.subtexture)})}invalidateTexture(e){const i=[0,0];e.aspectRatio=1,e.atlasBL=i,e.atlasBR=i,e.atlasTL=i,e.atlasTR=i,e.isValid=!1,e.texture=null,e.pixelHeight=0,e.pixelWidth=0,delete e.source,e.video&&(e.video.monitor.destroy(),delete e.video)}resolveResources(){const e=[];this.resourceReferences.forEach((i,n)=>{i.count<=0&&i.subtexture&&(Jg("A subtexture on an atlas has been invalidated as it is deemed no longer used: %o",i.subtexture),this.invalidateTexture(i.subtexture),e.push(n))});for(let i=0,n=e.length;i<n;++i)this.resourceReferences.delete(e[i])}stopUsingResource(e){const i=this.resourceReferences.get(e.source)||{subtexture:e.texture||new Ei,count:0};i.count--}useResource(e){const i=this.resourceReferences.get(e.source)||{subtexture:e.texture,count:0};i.count++}}let De;class Rn{static async awaitContext(){for(;!De;)this.getContext(),await new Promise(e=>setTimeout(e,10))}static getContext(){De||(De=document.createElement("canvas").getContext("2d"))}static async calculateImageSize(e){if(await this.awaitContext(),!De){console.warn("The Image rasterizer was unable to establish a valid canvas context. Please ensure the system supports contexts and ensure the document is ready first.");return}if(e.width===0||e.height===0){console.warn("Images provided shoud have valid dimensions! Please ensure the image is loaded first.");return}return De.canvas.width=100,De.canvas.height=100,De.drawImage(e,0,0,1,1),[e.width,e.height]}static async resizeImage(e,i){if(await this.awaitContext(),!De)return console.warn("The Image rasterizer was unable to establish a valid canvas context. Please ensure the system supports contexts and ensure the document is ready first."),e;if(e.width===0||e.height===0)return console.warn("Images provided shoud have valid dimensions! Please ensure the image is loaded first."),e;De.canvas.width=Math.floor(e.width*i),De.canvas.height=Math.floor(e.height*i),e instanceof ImageData?De.putImageData(e,0,0,0,0,De.canvas.width,De.canvas.height):De.drawImage(e,0,0,De.canvas.width,De.canvas.height);const n=new Image;return n.src=De.canvas.toDataURL("image/png"),await Rn.calculateImageSize(n),n}}class em{constructor(e,i){this.video=e,this.subTexture=i,this.isDestroyed=!1,this.renderedTime=-1,this.previousTime=-1,this.playedFrames=0,this.caughtFrames=0,this.timeFrame=0,this.doUpdate=()=>{Math.abs(this.video.currentTime-this.renderedTime)<.015||(this.renderedTime=this.video.currentTime,this.subTexture.update())},this.loop=n=>{this.doUpdate(),this.isDestroyed||Ti(this.loop)},this.addEventListeners()}async addEventListeners(){this.isDestroyed||this.loop(await Ti())}destroy(){this.video.pause(),this.isDestroyed=!0,this.removeEventListeners()}removeEventListeners(){}}const id=xe("performance"),tm=new Ei({aspectRatio:0,atlasBL:[0,0],atlasBR:[0,0],texture:null,atlasTL:[0,0],atlasTR:[0,0],heightOnAtlas:0,isValid:!1,pixelHeight:0,pixelWidth:0,widthOnAtlas:0});function im(t){return!!(t&&t.isValid&&t.pixelWidth&&t.pixelHeight)}class nd{constructor(){this.allAtlas=new Map}async createAtlas(e){const i=new td(e);return this.allAtlas.set(i.id,i),id("Atlas Created-> %o",i),i}destroy(){this.allAtlas.forEach(e=>e.destroy())}destroyAtlas(e){const i=this.allAtlas.get(e);i&&i.destroy()}setDefaultImage(e,i){return e=Object.assign(e,tm,{atlasReferenceID:i}),e}async draw(e,i){var o;const n=e.id;if(i.disposeResource)return!0;const r=e.resourceReferences.get(i.source);if(r)return i.texture=r.subtexture,!0;i.texture=new Ei,i.texture.isValid=!0,e.resourceReferences.set(i.source,{subtexture:i.texture,count:0});const s=await this.loadImage(i),a=i.texture;if(s&&im(a)){const c=new te({bottom:a.pixelHeight,left:0,right:a.pixelWidth,top:0}),l={data:a,bounds:c};l.bounds.width+=0,l.bounds.height+=0;let u=e.packing,h=u.insert(l);if(!h){if(!this.repackResources(e))return console.error("Repacking the atlas failed. Some resources may be in an undefined state. Consider making another atlas."),!1;u=e.packing,h=u.insert(l)}return h?(h.data=a,Qe.applyToSubTexture(u,h,a,{top:.5,left:.5,right:.5,bottom:.5}),a.texture=e.texture||null,a.source=s,a.atlasRegion={...h.bounds,y:e.height-h.bounds.y-h.bounds.height},(o=e.texture)==null||o.update(s,a.atlasRegion),s instanceof HTMLVideoElement&&(a.video={monitor:new em(s,a)}),!0):(console.error("Could not fit resource into atlas",i),i.texture=this.setDefaultImage(a,n),!1)}else return a&&!a.isValid?id("Resource was invalidated during load:",i):console.error("Could not load resource:",i),i.texture&&(i.texture=this.setDefaultImage(i.texture,n)),!1}getAtlasTexture(e){return this.allAtlas.get(e)}async loadImage(e){const i=e.texture||new Ei,n=e.source;if(e.texture=i,e.texture.isValid===!1)return null;if(n instanceof HTMLImageElement){let r=await new Promise(s=>{if(!(n instanceof HTMLImageElement))return;const a=n;if(a.width&&a.height){Rn.calculateImageSize(a),i.pixelWidth=a.width,i.pixelHeight=a.height,i.aspectRatio=a.width/a.height,s(a);return}a?(a.onload=function(){i.pixelWidth=a.width,i.pixelHeight=a.height,i.aspectRatio=a.width/a.height,a.onload=null,s(a)},a.onerror=function(){console.error("Error generating Image element for source:",n),a.onload=null,s(null)}):s(null)});return r&&e.rasterizationScale!==void 0&&e.rasterizationScale!==1&&(r=await Rn.resizeImage(r,e.rasterizationScale||1)),r}else{if(n instanceof HTMLVideoElement)return n.videoHeight===0||n.videoWidth===0?(console.warn("Video requests to the atlas manager MUST have the video completely loaded and ready for loading","There are too many caveats to automate video loading at this low of a level to have it prepped properly for","use in the texture for all browsers. Consider handling video resources at the layer level to have them","prepped for use."),null):(i.pixelWidth=n.videoWidth,i.pixelHeight=n.videoHeight,i.aspectRatio=n.videoWidth/n.videoHeight,n);if(vi(n)){const r=n;let s=await new Promise(a=>{const o=new Image;o.onload=function(){i.pixelWidth=o.width,i.pixelHeight=o.height,i.aspectRatio=o.width/o.height,o.onload=null,a(o)},o.onerror=function(){console.error("Error generating Image element for source:",n),a(null)},o.crossOrigin="anonymous",o.src=r});return s&&e.rasterizationScale!==void 0&&e.rasterizationScale!==1&&(s=await Rn.resizeImage(s,e.rasterizationScale||1)),s}else{let r=n;return r&&e.rasterizationScale!==void 0&&e.rasterizationScale!==1&&(r=await Rn.resizeImage(r,e.rasterizationScale||1)),r}}}repackResources(e){if(!this.renderer)return console.warn("Attempted to repack resources for an atlas, but no renderer has been specified for this manager yet."),!1;const i=[e.packing],n=[];let r=0;const s=new Map;for(;r<i.length;){const b=i[r];r++,b.data&&b.data.texture&&(n.push(b),s.set(b.bounds,new te(b.bounds))),b.child[0]&&i.push(b.child[0]),b.child[1]&&i.push(b.child[1])}if(n.sort((b,x)=>Math.max(x.bounds.width,x.bounds.height)-Math.max(b.bounds.width,b.bounds.height)),n.length<=0)return e.packing=new Qe(0,0,e.width,e.height),!0;if(!e.texture)return console.warn("Attempted to repack resources for an atlas with no texture."),!1;const a=new se(e.texture);a.data={buffer:new Uint8Array(e.width*e.height*4),width:e.width,height:e.height};const o=new Qe(0,0,e.width,e.height);let c=!1;for(let b=0,x=n.length;b<x;++b){const R=n[b];if(!R.data){console.warn("Attempted to repack a node with no valid data.");continue}R.bounds.x=0,R.bounds.y=0;const N=o.insert({bounds:R.bounds,data:R.data});if(!N){console.warn("When repacking the atlas, an existing node was unable to be repacked",R),c=!0;continue}Qe.applyToSubTexture(o,N,R.data)}if(c)return!1;const l=new Float32Array(n.length*2*6),u=new Float32Array(n.length*2*6),h=new Ei;for(let b=0,x=n.length;b<x;++b){const R=n[b],N=s.get(R.bounds),I=R.data;if(!N||!I){console.warn("While repacking there was an issue finding the previous bounds and the next texture to use",N,I);continue}Qe.applyToSubTexture(o,N,h);const S=b*2*6;l[S]=I.atlasTL[0]*2-1,l[S+1]=I.atlasTL[1]*2-1,l[S+2]=I.atlasTR[0]*2-1,l[S+3]=I.atlasTR[1]*2-1,l[S+4]=I.atlasBL[0]*2-1,l[S+5]=I.atlasBL[1]*2-1,l[S+6]=I.atlasTR[0]*2-1,l[S+7]=I.atlasTR[1]*2-1,l[S+8]=I.atlasBR[0]*2-1,l[S+9]=I.atlasBR[1]*2-1,l[S+10]=I.atlasBL[0]*2-1,l[S+11]=I.atlasBL[1]*2-1,u[S]=h.atlasTL[0],u[S+1]=h.atlasTL[1],u[S+2]=h.atlasTR[0],u[S+3]=h.atlasTR[1],u[S+4]=h.atlasBL[0],u[S+5]=h.atlasBL[1],u[S+6]=h.atlasTR[0],u[S+7]=h.atlasTR[1],u[S+8]=h.atlasBR[0],u[S+9]=h.atlasBR[1],u[S+10]=h.atlasBL[0],u[S+11]=h.atlasBL[1],I.texture=a}const f=new zi,p=new gi(l,2),g=new gi(u,2);f.addAttribute("position",p),f.addAttribute("texCoord",g);const m=new Wi({buffers:{color:{buffer:a,outputType:0}},retainTextureTargets:!0}),T=new yr({culling:d.GLSettings.Material.CullSide.NONE,uniforms:{texture:{type:be.TEXTURE,value:e.texture}},fragmentShader:new Map([[m,{outputNames:[],outputTypes:[0],source:`
          precision highp float;

          uniform sampler2D texture;
          varying vec2 _texCoord;

          void main() {
            gl_FragColor = texture2D(texture, _texCoord);
          }
        `}]]),vertexShader:`
        precision highp float;

        attribute vec2 position;
        attribute vec2 texCoord;
        varying vec2 _texCoord;

        void main() {
          _texCoord = texCoord;
          gl_Position = vec4(position, 0.0, 1.0);
        }
      `}),w=new Bo("__atlas_manager__",f,T);w.vertexCount=n.length*6,w.drawMode=d.GLSettings.Model.DrawMode.TRIANGLES;const y=new Ms;return y.add(w),this.renderer.setRenderTarget(m),this.renderer.setViewport(this.renderer.getFullViewport()),this.renderer.setScissor(this.renderer.getFullViewport()),this.renderer.render(y,m),T.dispose(),f.destroy(),m.dispose(),e.texture.destroy(),e.texture=a,e.packing=o,!0}async updateAtlas(e,i){const n=this.allAtlas.get(e);if(n){for(const r of i)r.disposeResource||await this.draw(n,r);for(let r=0,s=i.length;r<s;++r){const a=i[r];a.disposeResource?n.stopUsingResource(a):n.useResource(a)}n.resolveResources()}else console.warn("Can not update non-existing atlas:",e,"These resources will not be loaded:",i);return n}}const nm=xe("performance");class rd{setDeclaration(e,i,n,r){e.has(i)&&nm(`%s: Overriding declaration %s
Setting new value: %s`,r||"Expand IO Declarations",i,n),e.set(i,n)}}class $r extends rd{expand(e,i,n,r){return{instanceAttributes:[],uniforms:[],vertexAttributes:[]}}validate(e,i,n,r){return!0}processHeaderInjection(e,i,n,r,s,a,o){return{injection:""}}processAttributeDestructuring(e,i,n,r,s,a){return""}}const rm="TextureIOExpansion";function sm(t,e,i){return t&&t.resource&&e.getResourceType(t.resource.key())===i&&t.resource.name!==void 0&&t.resource.key!==void 0}class Zs extends $r{constructor(e,i){super(),this.manager=i,this.resourceType=e}expand(e,i,n,r){const s=this.manager,a=[],o=new Map;i.forEach(u=>{if(sm(u,this.manager.router,this.resourceType)){u.size===void 0&&(u.size=C.FOUR);const h=u.resource.shaderInjection||A.FRAGMENT,f=o.get(u.resource.name);f?o.set(u.resource.name,[f[0]||h===A.VERTEX||h===A.ALL,f[1]||h===A.FRAGMENT||h===A.ALL]):(a.push(u),o.set(u.resource.name,[h===A.VERTEX||h===A.ALL,h===A.FRAGMENT||h===A.ALL]))}});const c=a.map(u=>{let h=A.FRAGMENT;if(u.resource){const f=o.get(u.resource.name);f&&(h=f[0]&&f[1]&&A.ALL||f[0]&&!f[1]&&A.VERTEX||!f[0]&&f[1]&&A.FRAGMENT||h)}return[{name:u.resource.name,shaderInjection:h,size:E.TEXTURE,update:()=>{const f=s.getResource(u.resource.key());return f&&f.texture||se.emptyTexture}},{name:`${u.resource.name}_size`,shaderInjection:h,size:E.TWO,update:()=>{const f=s.getResource(u.resource.key());if(f){const p=f.texture;if(p&&p.data){const{width:g,height:m}=p.data;return[g||1,m||1]}}return[1,1]}}]}),l=[];return c.forEach(u=>u.forEach(h=>l.push(h))),{instanceAttributes:[],vertexAttributes:[],uniforms:l}}validate(e,i,n,r){let s=!1;return i.forEach(a=>{a.easing&&a.resource&&(console.warn("An instance attribute can not have both easing and resource properties. Undefined behavior will occur."),console.warn(a),s=!0)}),!s}processHeaderInjection(e,i,n,r,s,a,o){const c={injection:""};for(let l=0,u=o.length;l<u;++l){const h=o[l],f=h.shaderInjection||A.VERTEX;h.size===E.TEXTURE&&f===e&&this.setDeclaration(i,h.name,`uniform sampler2D ${h.name};
`,rm)}return c}}class sd extends Qn{constructor(e){super(),this.resources=new Map,this.requestQueue=new Map,this.requestLookup=new Map,this.atlasManager=e&&e.atlasManager||new nd}get webGLRenderer(){return this._webGLRenderer}set webGLRenderer(e){this._webGLRenderer=e,this.atlasManager.renderer=e}async dequeueRequests(){let e=!1;const i=[];this.requestQueue.forEach((n,r)=>{i.push([r,n])}),this.requestQueue.clear();for(const[n,r]of i)if(r.length>0){e=!0;const s=r.slice(0);r.length=0,await this.atlasManager.updateAtlas(n,s);const a=this.requestLookup.get(n);if(a){const o=new Set;s.forEach(c=>{const l=a.get(c);if(a.delete(c),l&&!c.disposeResource)for(let u=0,h=l.length;u<h;++u){const[f,p]=l[u];f.managesInstance(p)&&(p.active=!0),o.add(p)}}),kr(()=>{o.forEach(c=>{c.active=!0,c.resourceTrigger()})})}}return e}destroy(){this.atlasManager.destroy()}destroyResource(e){this.resources.get(e.key)&&(this.atlasManager.destroyAtlas(e.key),this.resources.delete(e.key))}getAtlasTexture(e){const i=this.atlasManager.getAtlasTexture(e);return i&&i.texture||null}getResource(e){return this.resources.get(e)||null}getIOExpansion(){return[new Zs(le.ATLAS,this)]}async initResource(e){if(_c(e)){const i=await this.atlasManager.createAtlas(e);this.resources.set(e.key,i)}}request(e,i,n,r){const s=n.key||"",a=n.texture;if(a)return Zi(a);let o=this.requestLookup.get(s);if(o){const l=o.get(n);if(l)return l.push([e,i]),i.active=!1,Zi(n.texture)}else o=new Map,this.requestLookup.set(s,o);n.disposeResource||(i.active=!1);let c=this.requestQueue.get(s);return c||(c=[],this.requestQueue.set(s,c)),c.push(n),o.set(n,[[e,i]]),Zi(a)}updateResource(e){_c(e)}}const am=new Image;function Yn(t){return{type:le.ATLAS,source:am,...t}}class ad extends Qn{constructor(){super(...arguments),this.resources=new Map}async dequeueRequests(){return!1}destroy(){this.resources.forEach(e=>e.destroy()),this.resources.clear()}getIOExpansion(){return[new Zs(le.TEXTURE,this)]}getResource(e){return this.resources.get(e)||null}destroyResource(e){const i=this.resources.get(e.key);i&&(i.destroy(),this.resources.delete(e.key))}async initResource(e){let i=this.resources.get(e.key);if(i){console.warn("Attempted to generate a RenderTexture that already exists for key",e.key);return}i=new Ec(e,this.webGLRenderer),this.resources.set(e.key,i)}request(e,i,n,r){const s=this.resources.get(n.key);return s?(n.texture=s.texture,[0,0,1,1]):[0,0,0,0]}resize(){const e=new Map;this.resources.forEach((i,n)=>{i.width>lt.SCREEN&&i.height>lt.SCREEN||(i.texture.destroy(),i=new Ec(i,this.webGLRenderer),e.set(n,i))}),e.forEach((i,n)=>this.resources.set(n,i))}updateResource(e){this.resources.get(e.key)&&console.warn("UPDATING AN EXISTING RENDER TEXTURE IS NOT SUPPORTED YET")}}function jr(t){return{type:le.TEXTURE,...t}}const{ceil:om,max:od,log2:cm,pow:lm,sqrt:um}=Math,at=[-1,-1];function hm(t,e){const{width:i,height:n}=t;let r;const s=[],a=[];for(let o=0;o<i;++o){s[o]=[],a[o]=[];for(let c=0;c<n;++c){const l=c*(i*4)+o*4;r=e[l+3],r?(s[o][c]=[o,c],a[o][c]=at):(s[o][c]=at,a[o][c]=[o,c])}}return{seed:s,inverse:a}}function dm(t){const e=[];for(let i=0,n=t.length;i<n;++i)e[i]=[];return e}function cd(t,e,i=!1){const n=i?-1:1;let r,s,a,o;const c=[];let l=-1;for(let u=0,h=t.length;u<h;++u){const f=t[u];c[u]=[];for(let p=0,g=f.length;p<g;++p)r=f[p],r===e?o=256:(s=[u,p],a=ye(r,s),o=um(Dn(a,a))),c[u][p]=o,l=od(o,l)}for(let u=0,h=t.length;u<h;++u){const f=t[u];for(let p=0,g=f.length;p<g;++p)o=c[u][p],c[u][p]=o/l*255*n}return c}function fm(t,e,i,n){let r;const s=cd(t,i,!0),a=cd(e,i,!1),o=s.length,c=s;for(let l=0,u=s.length;l<u;++l){const h=s[l],f=a[l];for(let p=0,g=h.length;p<g;++p){const m=h[p],T=f[p];h[p]=m+T}}for(let l=0,u=c.length;l<u;++l){const h=c[l];for(let f=0,p=h.length;f<p;++f){r=h[f];const g=f*(o*4)+l*4;n[g]=r,n[g+1]=r,n[g+2]=r,n[g+3]=255}}}function ld(t,e){const i=t.length,n=t[0].length;let r=dm(t),s=t,a,o,c,l,u,h,f,p,g;for(let m=0;m<e;++m){const T=r;r=s,s=T;const w=lm(2,e-m-1);for(f=0;f<i;++f)for(p=0;p<n;++p){for(a=[f,p],c=[(r[f-w]||[])[p-w]||at,(r[f]||[])[p-w]||at,(r[f+w]||[])[p-w]||at,(r[f-w]||[])[p]||at,(r[f]||[])[p]||at,(r[f+w]||[])[p]||at,(r[f-w]||[])[p+w]||at,(r[f]||[])[p+w]||at,(r[f+w]||[])[p+w]||at],u=0,l=Number.MAX_VALUE,g=0;g<9;++g){const y=c[g];y!==at&&(o=ye(y,a),h=Dn(o,o),h<l&&(l=h,u=g))}s[f][p]=c[u]}}return s}function pm(t,e=fm){const{width:i,height:n}=t,r=t.getContext("2d");if(!r)return;const s=r.getImageData(0,0,i,n).data,a=od(i,n),o=om(cm(a)),c=hm(t,s),l=ld(c.seed,o),u=ld(c.inverse,o),h=new ImageData(i,n);e(l,u,at,h.data),r.putImageData(h,0,0)}function gm(t){}const Js=xe("performance");var ea=(t=>(t[t.BITMAP=0]="BITMAP",t[t.SDF=1]="SDF",t[t.MSDF=2]="MSDF",t))(ea||{});class ud extends yn{constructor(e){super(e),this.dynamic=!1,this.glyphCount=0,this.glyphMap={},this.kerning={},this.spaceWidth=0,this.type=le.FONT,this.dynamic=e.dynamic||!1,this.fontSource=e.fontSource,e.characters&&e.characters.forEach(n=>{this.doRegisterGlyph(n[0],n[1])});const i=e.fontMapSize?e.fontMapSize:[lt._1024,lt._1024];this.makeGlyphTypeTextureSettings(e.glyphType),this.createTexture(i),this.packing=new Qe(0,0,i[0],i[1]),this.addCachedKerning()}get fontString(){return`${this.fontSource.size}px ${this.fontSource.family}`}getKerningCacheName(){return`__deltav_kerning_cache_${this.fontSource.family}__`}addCachedKerning(){if(this.fontSource.localKerningCache){const e=localStorage.getItem(this.getKerningCacheName());if(e){Js("Loading cached kerning items:",this.getKerningCacheName());try{const i=JSON.parse(e);let n=0;for(const r in i){let s=typeof r=="string"&&r.length===1;if(!s)continue;const a=i[r],o=this.kerning[r]||{};this.kerning[r]=o;for(const c in a)s=typeof r=="string"&&r.length===1,s&&(o[c]=a[c],n++)}Js("Found kerning items in the cache!","Count:",n)}catch{}}}}addKerning(e){let i=!1;for(const n in e){const r=e[n],s=this.kerning[n]||{};this.kerning[n]||(i=!0),this.kerning[n]=s;for(const a in r)s[a]||(i=!0),s[a]=r[a]}if(i&&this.fontSource.localKerningCache)try{Js("Storing kerning info in cache...");const n=JSON.stringify(this.kerning);localStorage.setItem(this.getKerningCacheName(),n)}catch{Js("Could not cache kerning info")}}createTexture(e){if(this.texture)return;let i;this.textureSettings?i={generateMipMaps:!0,premultiplyAlpha:!0,...this.textureSettings}:i={generateMipMaps:!0,premultiplyAlpha:!0},this.texture=new se({data:{width:e[0],height:e[1],buffer:null},...i})}destroy(){var e;(e=this.texture)==null||e.destroy()}doRegisterGlyph(e,i){const n=e[0];this.glyphMap[n]?console.warn("A Glyph is already registered with a rendering"):this.glyphMap[n]=i}findMissingCharacters(e){const i=new Set;let n="";for(let r=0,s=e.length;r<s;++r){const a=e[r];!this.glyphMap[a]&&!i.has(a)&&(i.add(a),n+=a)}return n}getGlyphTexture(e){return this.glyphMap[e[0]]||null}getGlyphKerning(e,i){const n=this.kerning[e];return n?n[i]||[0,0]:[0,0]}getGlyphWidth(e,i,n){const r=e.positions[i],s=e.positions[n];if(!i||!n)return 0;const a=this.glyphMap[e.glyphs[n]];return a?s[0]+a.pixelWidth-r[0]:0}async getTruncatedLayout(e,i,n,r,s,a){if(e.size[0]>n){let o="",c=0;for(let g=0,m=i.length;g<m;++g)c+=this.glyphMap[i[g]].pixelWidth;if(c>n)return{fontScale:1,glyphs:"",positions:[],size:[0,0],text:""};let l=0,u=e.positions.length,h=0,f=0,p="";for(;l!==u;){if(h=Math.floor((u-l)/2)+l,p=e.glyphs[h],f=e.positions[h][0]+this.glyphMap[p].pixelWidth+c,f>n)u=h;else if(f<n)l=h;else break;if(Math.abs(l-u)<=1){if(f<n)break;for(;f>n&&h>=0;)h--,f=e.positions[h][0]+this.glyphMap[p].pixelWidth+c;break}}if(f=e.positions[h][0]+this.glyphMap[p].pixelWidth+c,f<n){let g=0,m=0;for(let y=0,b=e.text.length;y<b&&g<=h;++y){const x=e.text[y];m++,pn(x)||g++}const T=e.text[m-1];let w;for(let y=0,b=i.length;y<b;++y)if(!pn(i[y])){w=i[y];break}if(T&&w&&!this.kerning[T][w]){const y=await a.estimateKerning([T+w],this.fontString,this.fontSource.size,this.kerning,!1,this.fontSource.embed);this.addKerning(y.pairs)}o=`${e.text.substr(0,m)}${i}`}else o=i;return this.getStringLayout(o,r,s)}return e}getStringWidth(e,i,n){const r=e.text;let s=0,a=r.length;if(typeof i=="string"){const h=r.indexOf(i);if(h<0)return 0;s=h,a=s+i.length}else s=i;n!==void 0&&(a=n);let o=0;const c=Math.min(r.length,s),l=Math.min(r.length,a);for(;o<c;++o)pn(r[o])&&(s--,a--);for(;o<l;++o)pn(r[o])&&a--;const u=this.glyphMap[e.text[a]||""];return u?(e.positions[a]||[0,0])[0]-(e.positions[s]||[0,0])[0]+u.pixelWidth:0}getStringLayout(e,i,n){const r=[];let s="";const a=i/this.fontSource.size;let o=Number.MAX_SAFE_INTEGER,c=0,l=0,u=[0,0];const h=this.spaceWidth;let f=0,p="",g,m;for(let y=0,b=e.length;y<b;++y){const x=e[y];if(pn(x)){f++;continue}g=[0,0],p&&(g=this.kerning[p][x]||[0,0]),u=fi(fi(u,Re(g,a)),[f*h*a+(y===0?0:n),0]),r.push([u[0],u[1]]),s+=x,m=this.glyphMap[x],o=Math.min(u[1],o),c=Math.max(u[1]+m.pixelHeight*a,c),p=x,l=u[0]+m.pixelWidth*a,f=0}const T=c-o,w=[l,T];for(let y=0,b=r.length;y<b;++y)u=r[y],u[1]-=o;return{fontScale:a,glyphs:s,positions:r,size:w,text:e}}makeGlyphTypeTextureSettings(e){switch(e){case 0:this.textureSettings={magFilter:d.GLSettings.Texture.TextureMagFilter.Linear,minFilter:d.GLSettings.Texture.TextureMinFilter.LinearMipMapLinear,internalFormat:d.GLSettings.Texture.TexelDataType.LuminanceAlpha,format:d.GLSettings.Texture.TexelDataType.LuminanceAlpha};break;case 1:this.textureSettings={magFilter:d.GLSettings.Texture.TextureMagFilter.Linear,minFilter:d.GLSettings.Texture.TextureMinFilter.Linear,internalFormat:d.GLSettings.Texture.TexelDataType.Luminance,format:d.GLSettings.Texture.TexelDataType.Luminance};break;case 2:this.textureSettings={magFilter:d.GLSettings.Texture.TextureMagFilter.Linear,minFilter:d.GLSettings.Texture.TextureMinFilter.Linear,internalFormat:d.GLSettings.Texture.TexelDataType.RGB,format:d.GLSettings.Texture.TexelDataType.RGB};break}}registerGlyph(e,i){this.dynamic?this.doRegisterGlyph(e,i):console.warn("Attempted to register a new glyph with a non-dynamic FontMap")}supportsKerning(e){for(let i=1,n=e.length;i<n;++i){const r=e[i],s=e[i-1];if(this.kerning[s]){if(!this.kerning[s][r])return!1}else return!1}return!0}}const{min:hd,max:ta}=Math,xn=document.createElement("canvas");let _i;function mm(t){const{width:e,height:i}=t.canvas,n=t.getImageData(0,0,e,i).data;let r,s=!1,a=Number.MAX_SAFE_INTEGER,o=Number.MAX_SAFE_INTEGER,c=Number.MIN_SAFE_INTEGER,l=Number.MIN_SAFE_INTEGER;for(let u=0;u<e;++u)for(let h=0;h<i;++h){const f=h*(e*4)+u*4;r=n[f],r>0&&(s=!0,a=hd(a,h),o=hd(o,u),c=ta(c,u),l=ta(l,h))}return s?(a-=1,l+=2,c+=2,o-=1,a=ta(a,0),o=ta(o,0),{minX:o,minY:a,maxX:c,maxY:l}):null}function Rc(t,e,i,n){if(t=t[0],(xn.width<e||xn.height<i)&&(xn.width=e,xn.height=i),!_i){const c=xn.getContext("2d",{willReadFrequently:!0});if(c)_i=c;else return null}_i.clearRect(0,0,xn.width,xn.height),_i.font=n,_i.fillStyle="white",_i.fillText(t,e/2,i/2);const r=mm(_i);if(!r)return{data:_i.getImageData(0,0,1,1),size:[0,0]};const s=r.maxX-r.minX,a=r.maxY-r.minY;return{data:_i.getImageData(r.minX,r.minY,s,a),size:[s,a]}}const Jt=document.createElement("img"),ot=document.createElement("canvas");function vm(t,e,i=400,n="normal",r="woff2"){return`
    @font-face {
      font-family: '${t}';
      src: url('${e}') ${r?`format('${r}')`:""};
      font-weight: ${i};
      font-style: ${n};
    }
  `}async function dd(t,e,i){const n=new ke;if(!Jt||!ot)return null;if(i&&e){const h=document.createElementNS(e,"style");h.textContent=i.map(f=>vm(f.familyName,f.source,f.weight,f.style,f.fontType)).join(`
`),t.prepend(h)}const r=new XMLSerializer().serializeToString(t),o="data:image/svg+xml;base64,"+btoa(r);let c=!1;const l=async()=>{if(c)return;c=!0,ot.width=Jt.width*window.devicePixelRatio,ot.height=Jt.height*window.devicePixelRatio;const h=ot.getContext("2d",{willReadFrequently:!0});if(!h){n.resolve(null);return}h.clearRect(0,0,ot.width,ot.height),h.mozImageSmoothingEnabled=!1,h.webkitImageSmoothingEnabled=!1,h.msImageSmoothingEnabled=!1,h.imageSmoothingEnabled=!1,h.drawImage(Jt,0,0,Jt.width*window.devicePixelRatio,Jt.height*window.devicePixelRatio),n.resolve(h.getImageData(0,0,ot.width,ot.height)),ot.style.position="absolute",ot.style.top="100px",ot.style.left="0px",ot.style.zIndex="9999",ot.id="svg-to-data"};return Jt.onload=l,Jt.src=o,Jt.width>0&&Jt.height>0&&l(),await n.promise}const ia=xe("performance"),{floor:xc}=Math;async function wm(t,e,i,n,r){const s="http://www.w3.org/2000/svg",a=L.MAX_TEXTURE_SIZE/window.devicePixelRatio,o=e*2,c=e*1.3,l=xc(a/o),u=document.createElementNS(s,"svg");u.setAttribute("width",`${a}px`),u.style.font=t,u.style.fontFamily="RedHatDisplay",u.style.position="relative",u.style.left="0px",u.style.top="0px";const h=[],f=Math.floor(a/c);let p=0,g=0,m=0,T,w,y=0;for(;g<i.all.length;){const D=document.createElementNS(s,"g");T=D,p=Math.floor(h.length/f),D.setAttribute("transform",`translate(0, ${(h.length-p*f)*c})`),h.push(D);let H=a;for(m=0;m<l&&g<i.all.length;m++){const z=document.createElementNS(s,"text");z.setAttribute("x",`${m*o}`),z.setAttribute("dy","1em");const V=i.all[g];g++;const ne=V[0],W=V[1],oe=document.createElementNS(s,"tspan"),Y=document.createElementNS(s,"tspan");oe.setAttribute("fill","#ff0000"),Y.setAttribute("fill","#0000ff"),oe.textContent=ne,Y.textContent=W,z.appendChild(oe),z.appendChild(Y),D.appendChild(z),H-=o}if(H>=0){const z=document.createElementNS(s,"text");z.setAttribute("width",`${H}px`),D.appendChild(z),w=z}else w=null;y=H}const b=[];for(let D=0;D<i.all.length;D++)b.push([Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER]);let x=0,R=!1;if(n){const D="M",H=document.createElementNS(s,"text");H.setAttribute("dy","1em"),H.style.width=`${o}`,H.style.height=`${c}`,H.setAttribute("x",`${o*m}`),H.style.font=t;const z=await Rc(D,128,128,t);if(z){x=z.size[0];const V=document.createElementNS(s,"tspan"),ne=document.createElementNS(s,"tspan"),W=document.createElementNS(s,"tspan");if(V.setAttribute("fill","#ff0000"),W.setAttribute("fill","#0000ff"),V.textContent=D,W.textContent=D,ne.textContent=" ",H.appendChild(V),H.appendChild(ne),H.appendChild(W),m<l&&T)T.appendChild(H),y-=o,w&&(w.remove(),y>0&&(T.style.width=`${y}px`,T.appendChild(w)));else{const oe=document.createElement("g");p=Math.floor(h.length/f),oe.setAttribute("transform",`translate(0, ${(h.length-p*f)*c})`),T=oe,T.appendChild(H),h.push(oe),w=document.createElementNS(s,"text"),oe.appendChild(w)}b.push([Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER]),R=!0}}const N=h.length*c,I=Math.ceil(N/a);let S=null;ia("Rendering table canvas batches for font kerning analysis",i,h);for(let D=0;D<I;++D){const H=h.splice(0,f),z=H.length*c;for(u.setAttribute("height",`${z}px`);u.lastElementChild;)u.lastElementChild.remove();for(let V=0,ne=H.length;V<ne;++V){const W=H[V];u.appendChild(W)}if(!S)S=await dd(u,s,r);else{const V=await dd(u,s,r);if(!V){console.warn("Font Renderer: Could not generate image data for analyzing font kerning");continue}const ne=new Uint8ClampedArray(S.data.length+V.data.length);ne.set(S.data),ne.set(V.data,S.data.length),S=new ImageData(ne,a*window.devicePixelRatio,S.height+V.height)}}ia("Analyzing rendered data",S);const j=o*window.devicePixelRatio,Q=c*window.devicePixelRatio;if(S){const D=S.data;let H,z,V,ne,W,oe;for(let Y=0,Ce=S.height;Y<Ce;Y++)for(let ee=0,Me=S.width;ee<Me;ee++)H=(Me*Y+ee)*4,z=D[H+0],V=D[H+1],ne=D[H+2],oe=xc(Y/Q)*l+xc(ee/j),oe<b.length&&(W=b[oe],z>0&&V===0&&ne===0&&(ee<W[0]&&(W[0]=ee),Y<W[1]&&(W[1]=Y)),z===0&&V===0&&ne>0&&(ee<W[2]&&(W[2]=ee),Y<W[3]&&(W[3]=Y)));if(R){const Y=b.pop();if(Y){const Ce=[Y[2]-Y[0],0],ee=Re(Ce,1/window.devicePixelRatio);i.spaceWidth=Math.ceil(ee[0])-x}}for(let Y=0,Ce=b.length;Y<Ce;Y++){const ee=i.all[Y],Me=ee[0],Pi=ee[1],Di=b[Y],Fi=[Di[2]-Di[0],Di[3]-Di[1]],di=i.pairs[Me];if(di){const Bi=Re(Fi,1/window.devicePixelRatio);di[Pi]=[Math.ceil(Bi[0]),Bi[1]]}}}else console.warn("html2canvas did not produce a valid canvas context to analyze");ia("Kerning rendering analysis complete",i.pairs)}function Tm(t,e,i){t=t.replace(/\s/g,"");const n=i&&i.all||[],r=i&&i.pairs||{};for(let s=0;s<t.length-1;s++){const a=t[s],o=t[s+1];let c=r[a];c||(c=r[a]={}),(!e[a]||!e[a][o])&&!c[o]&&(c[o]=[0,0],n.push(`${a}${o}`))}return{all:n,pairs:r,spaceWidth:0}}class fd{makeBitmapGlyphs(e,i,n){const r={},s=new Set;for(let o=0,c=e.length;o<c;++o)s.add(e[o]);const a=Array.from(s.values());for(let o=0,c=a.length;o<c;++o){const l=a[o],u=Rc(l,n*2,n*2,i);u?r[l]={glyph:u.data,glyphIndex:o}:console.warn("Unable to render character",l,"to font map for rendering.")}return r}async estimateKerning(e,i,n,r,s,a){const o={all:[],pairs:{},spaceWidth:0};ia("Estimating Kerning for",e);for(let c=0,l=e.length;c<l;++c){const u=e[c];Tm(u,r,o)}return(o.all.length>0||s)&&await wm(i,n,o,s,a),o}}var An=(t=>(t[t.TEXCOORDS=0]="TEXCOORDS",t[t.IMAGE_SIZE=1]="IMAGE_SIZE",t))(An||{});function Sn(t){return{type:le.FONT,...t}}function ym(){return".101112131415161718191.202122232425262728292.303132333435363738393.404142434445464748494.505152535455565758595.606162636465666768696.707172737475767778797.808182838485868788898.909192939495969798999.000102030405060708090.$0$1$2$3$4$5$6$7$8$9$%0%1%2%3%4%5%6%7%8%9%-0-1-2-3-4-5-6-7-8-9-+0+1+2+3+4+5+6+7+8+9+)0)1)2)3)4)5)6)7)8)9)(0(1(2(3(4(5(6(7(8(9("}async function bm(t,e){let i=0,n,r;try{if(!e)return;for(const s of e)n=s,i=0,!document.fonts.check(t)&&(i++,r=new FontFace(s.familyName,`url(${s.source})`,{weight:`${s.weight}`,style:s.style}),i++,await r.load(),i++,document.fonts.add(r));await document.fonts.ready}catch(s){switch(console.error("Font embedding Error:"),i){case 0:console.error("Font embedding failed check:",t);break;case 1:console.error("Font embedding failed to create the font face:",n);break;case 2:console.error("Font embedding failed to load the font face:",{fontFace:r,embedding:n});break;case 3:console.error("Font embedding failed to add the font face",{fontFace:r,embedding:n});break}s instanceof Error&&console.error(s.stack||s.message)}}const pd=xe("performance");var gd=(t=>(t[t._16=16]="_16",t[t._32=32]="_32",t[t._64=64]="_64",t[t._128=128]="_128",t))(gd||{});function Ac(t){return t&&t.type===le.FONT}function Em(t){return t&&t.type===void 0}function Sc(t){return{key:"",type:le.FONT,...t}}class md{constructor(){this.fontMaps=new Map,this.fontRenderer=new fd}async calculateMetrics(e,i){pd("Calculating metrics for requests");const n=this.fontMaps.get(e);if(n)for(let r=0,s=i.length;r<s;++r){const o=i[r].metrics;o&&(o.layout=n.getStringLayout(o.text,o.fontSize,o.letterSpacing),o.maxWidth&&(pd("Calculating truncation for",o.text,o.maxWidth),o.layout=await n.getTruncatedLayout(o.layout,o.truncation||"",o.maxWidth,o.fontSize,o.letterSpacing,this.fontRenderer),o.truncatedText=o.layout.text))}}characterFilterToCharacters(e){const i=new Set;let n="";for(let r=0,s=e.length;r<s;++r){const a=e[r];i.has(a)||(i.add(a),n+=a)}return n}async createFontMap(e){const i=this.characterFilterToCharacters(e.characterFilter||""),n=e.fontSource;let r=ea.SDF;n&&(Em(n)?r=ea.BITMAP:r=n.type||r);const s=new ud({...e,glyphType:r});return await this.updateFontMapCharacters(i,s),this.fontMaps.set(e.key,s),e.fontSource.preload&&this.updateFontMap(e.key,[Sn({key:e.key,character:"",kerningPairs:[e.fontSource.preload],metrics:{fontSize:12,text:e.fontSource.preload,letterSpacing:0}})]),s}destroy(){this.fontMaps.forEach(e=>e.destroy())}destroyFontMap(e){const i=this.fontMaps.get(e);i&&i.destroy()}async updateFontMap(e,i){const n=this.fontMaps.get(e);if(!n)return;let r=[];const s=new Set;for(let o=0,c=i.length;o<c;++o){const l=i[o];if(l.character&&s.add(l.character),l.kerningPairs&&(r=r.concat(l.kerningPairs)),l.metrics&&l.metrics.truncation){const u=l.metrics.truncation.replace(/\s/g,"");r.push(u);for(let h=0,f=l.metrics.truncation.length;h<f;++h)s.add(u)}}for(let o=0,c=r.length;o<c;++o)s.add(r[o]);let a="";s.forEach(o=>a+=o),await bm(n.fontString,n.fontSource.embed),await this.updateFontMapCharacters(a,n),await this.updateKerningPairs(r,n);for(let o=0,c=i.length;o<c;++o)i[o].fontMap=n}async updateKerningPairs(e,i){if(!i)return;const n=await this.fontRenderer.estimateKerning(e,i.fontString,i.fontSource.size,i.kerning,!i.spaceWidth,i.fontSource.embed);i.addKerning(n.pairs),i.spaceWidth=i.spaceWidth||n.spaceWidth}async updateFontMapCharacters(e,i){if(!i)return;const n=i.texture,r=i.findMissingCharacters(e);if(r.length<=0)return;const s=this.fontRenderer.makeBitmapGlyphs(r,i.fontString,i.fontSource.size);for(const a in s){const o=s[a];if(n!=null&&n.data){const c=new te({x:0,y:0,width:o.glyph.width,height:o.glyph.height}),l=new Ei,u=i.packing.insert({data:l,bounds:c});if(!u){console.warn("Font map is full and could not pack in any more glyphs");return}Qe.applyToSubTexture(i.packing,u,l,void 0,!0),n.update(o.glyph,{...u.bounds,y:i.packing.bounds.height-u.bounds.y-u.bounds.height}),l?i.registerGlyph(a,l):console.warn("Could not generate a subtexture for the font map registration.")}else console.warn("Can not update font map as the maps texture data is not defined.")}}async getPrerenderedImageData(e,i,n){const r=[];return n.forEach(s=>{let a=e.glyphs[s];if(a||(a=e.errorGlyph),!e.errorGlyph)return console.warn("The prerendered source provided did NOT provide a proper glyph for rendering when a glyph could not be located."),[];const o=new Image;let c;const l=new Promise(u=>c=u);return o.onload=function(){const u=document.createElement("canvas"),h=u.getContext("2d");if(!h)return;u.width=i,u.height=i,h.drawImage(o,0,0,i,i);const f=h.getImageData(0,0,i,i);c(f)},o.onerror=function(){console.warn("There was an issue with loading the glyph data for character:",s),c(null)},o.src=e.glyphs[s],r.push(l),[]}),await Promise.all(r)}}const Hr=xe("performance");class vd extends Qn{constructor(){super(...arguments),this.requestLookup=new Map,this.requestQueue=new Map,this.resourceLookup=new Map,this.fontManager=new md}async dequeueRequests(){let e=!1;const i=[];this.requestQueue.forEach((n,r)=>{i.push([r,n])}),this.requestQueue.clear();for(let n=0,r=i.length;n<r;++n){const[s,a]=i[n];if(a.length>0){e=!0;const o=a.slice(0);a.length=0,Hr("Processing requests for resource '%s'",s),await this.fontManager.updateFontMap(s,o),await this.fontManager.calculateMetrics(s,o);const c=this.requestLookup.get(s);c?(o.forEach(l=>{const u=c.get(l);if(c.delete(l),u){for(let h=0,f=u.length;h<f;++h){const[p,g]=u[h];p.managesInstance(g)&&(g.active=!0)}kr(()=>{const h=new Set;for(let f=0,p=u.length;f<p;++f){const g=u[f][1];h.has(g)||(h.add(g),g.resourceTrigger())}})}}),Hr("All requests for resource '%s' are processed",s)):Hr("There were no Font requests waiting for completion for resource",s)}}return e}destroy(){this.fontManager.destroy()}destroyResource(e){const i=this.resourceLookup.get(e.key);i&&(this.fontManager.destroyFontMap(i.id),this.resourceLookup.delete(e.key))}getResource(e){return this.resourceLookup.get(e)||null}getIOExpansion(){return[new Zs(le.FONT,this)]}async initResource(e){if(Ac(e)){const i=await this.fontManager.createFontMap(e);i&&this.resourceLookup.set(e.key,i),Hr("Font map created->",i)}}request(e,i,n,r){const s=n,a=s.fontMap;let o=null;if(a)return s.character&&(o=a.getGlyphTexture(s.character)),o?s.fetch===An.IMAGE_SIZE?[o.pixelWidth,o.pixelHeight]:Zi(o):s.fetch===An.IMAGE_SIZE?[0,0]:Zi(null);const c=n.key;let l=this.requestLookup.get(c);if(l){const h=l.get(s);if(h)return h.push([e,i]),i.active=!1,s.fetch===An.IMAGE_SIZE?[0,0]:Zi(o)}else l=new Map,this.requestLookup.set(c,l);i.active=!1;let u=this.requestQueue.get(c);return u||(u=[],this.requestQueue.set(c,u)),u.push(s),l.set(s,[[e,i]]),s.fetch?[0,0]:Zi(o)}updateResource(e){if(!Ac(e))return;const i=this.resourceLookup.get(e.key);i&&(rc(e.fontSource,i.fontSource)||Hr("Font resources currently do not update. To update their properties simply destroy and recreate for now."))}}const _m=xe("performance");class Mc{constructor(){this.managers=new Map,this.resourceKeyToType=new Map}async dequeueRequests(){let e=!1;const i=Array.from(this.managers.values());for(let n=0,r=i.length;n<r;++n){const a=await i[n].dequeueRequests();e=e||a}return e}destroy(){this.managers.forEach(e=>e.destroy()),this.resourceKeyToType.clear(),this.managers.clear(),delete this.webGLRenderer}async destroyResource(e){const i=this.managers.get(e.type);if(!i){console.warn(`A Resource is trying to be destroyed but has no manager to facilitate the operation: ${e.type}`);return}return this.resourceKeyToType.delete(e.key),await i.destroyResource(e)}getIOExpansion(){let e=[];return this.managers.forEach(i=>{e=e.concat(i.getIOExpansion())}),e}getManager(e){const i=this.managers.get(e);return i||(console.warn(`A manager was requested that does not exist for type ${e}`),$h)}getResourceType(e){return this.resourceKeyToType.get(e)}async initResource(e){const i=this.managers.get(e.type);if(!i){console.warn(`A Resource is trying to be created but has no manager to facilitate the operation: ${e.type}`);return}if(this.resourceKeyToType.has(e.key)){console.warn("Detected two resources with identical keys. The duplicate resource will not be generated:",e.key);return}return this.resourceKeyToType.set(e.key,e.type),await i.initResource(e)}request(e,i,n,r){const s=this.managers.get(n.type);return s?s.request(e,i,n,r):(console.warn(`A Layer is requesting a resource for which there is no manager set. Please make sure a Resource Manager is set for resource of type: ${n.type}`),[-1,-1,-1,-1])}resize(){this.managers.forEach(e=>e.resize())}setManager(e,i){this.managers.get(e)&&_m(`A manager was assigned to a resource type: ${e} that overrides another manager already set to that type.`),i.router=this,this.managers.set(e,i),i.webGLRenderer=this.webGLRenderer}setWebGLRenderer(e){this.webGLRenderer=e,this.managers.forEach(i=>i.webGLRenderer=e)}async updateResource(e){const i=this.managers.get(e.type);if(!i){console.warn(`A Resource is trying to be updated but has no manager to facilitate the operation: ${e.type}`);return}return await i.updateResource(e)}}const wd=new Mc,Rm={createFont:Sc,createAtlas:ed,createTexture:bc,createColorBuffer:Pg},xm={textureRequest:jr,atlasRequest:Yn,fontRequest:Sn,colorBufferRequest:Tc};function Td(t){const e=t.canvas.height,i=t.canvas.width,r={aspectRatio:i/e,bottom:-e/2,far:1e7,left:-i/2,near:-100,right:i/2,top:e/2,viewSize:e},s=new bi({type:yi.ORTHOGRAPHIC,left:r.left,right:r.right,top:r.top,bottom:r.bottom,near:r.near,far:r.far});return s.scale=[1,-1,1],s.position=[0,0,-300],s.update(),{camera:s,viewport:{bottom:0,left:0,right:0,top:0}}}const Am={[E.ONE]:be.FLOAT,[E.TWO]:be.VEC2,[E.THREE]:be.VEC3,[E.FOUR]:be.VEC4,[E.MATRIX3]:be.MATRIX3x3,[E.MATRIX4]:be.MATRIX4x4,[E.FLOAT_ARRAY]:be.FLOAT_ARRAY,[E.TEXTURE]:be.TEXTURE},Sm={[E.ONE]:[0],[E.TWO]:[0,0],[E.THREE]:[0,0,0],[E.FOUR]:[0,0,0,0],[E.MATRIX3]:[0,0,0,0,0,0,0,0,0],[E.MATRIX4]:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};function Mm(t){return{type:Am[t.size],value:Sm[t.size]}}function yd(t,e,i,n,r){const s=t.getMaterialOptions(),a=new Map;i.forEach((c,l)=>{a.set(l.renderTarget||null,c)}),Object.assign(s,t.props.materialOptions||{}),s.vertexShader=e,s.fragmentShader=a,s.name=t.id,s.uniforms={};for(let c=0,l=n.length;c<l;++c){const u=n[c],h=Mm(u);s.uniforms[u.name]=h}for(let c=0,l=r.length;c<l;++c){const u=r[c];s.uniforms[u.name]={type:u.type,value:u.value}}return new yr(s)}function Im(t){return!Array.isArray(t[0])}function bd(t,e,i,n){const r=[];(t.bufferType===Ae.INSTANCE_ATTRIBUTE||t.bufferType===Ae.INSTANCE_ATTRIBUTE_PACKING)&&(e=1);for(let h=0,f=i.length;h<f;++h){const p=i[h];r.push(new Float32Array(p.size*n*e))}const s=i.length;let a,o,c,l=!1;for(let h=0,f=n;h<f;++h)for(let p=0;p<s;++p)if(o=i[p],a=r[p],c=o.update(h),Im(c))for(let g=h*o.size,m=g+o.size,T=0;g<m;++g,++T)a[g]=c[T];else l=!0;l&&console.warn("A vertex buffer updating method should not use arrays of arrays of numbers.");for(let h=0,f=i.length;h<f;++h){const g=i[h].size*n;for(let m=1,T=e;m<T;++m)r[h].copyWithin(g*m,0,g)}if(t.bufferType===Ae.UNIFORM){const h=r[0];for(let f=0,p=e;f<p;++f){const g=f*n;for(let m=0;m<n;++m)h[m+g]=f}}const u=new zi;for(let h=0,f=i.length;h<f;++h){const p=i[h],g=new gi(r[h],p.size);p.materialAttribute=g,u.addAttribute(p.name,g)}return u}function na(t,e,i,n){const r=new Bo(t,e,i);return r.drawMode=n||d.GLSettings.Model.DrawMode.TRIANGLE_STRIP,r}const Ji="EasingIOExpansion",{abs:Lm,max:Cm}=Math,Om={duration:0,start:[0],end:[0],startTime:0},Ed={1:"float",2:"vec2",3:"vec3",4:"vec4",9:"mat3",16:"mat4",99:"vec4"},Ic={easingMethod:"easingMethod",T:"T"};function Nm(t){return!!t&&t.easing&&t.size!==void 0&&t.size<=4}function Pm(t){return t}class _d extends $r{constructor(){super(...arguments),this.baseAttributeName=new Map}expand(e,i,n,r){const s=new Set,a=[],o=[];for(const l of i)Nm(l)&&a.push(l);const c={};e.easingId=c;for(let l=0,u=a.length;l<u;++l){const h=a[l],{cpu:f,loop:p,uid:g}=h.easing,{name:m,size:T,update:w}=h,y=g;this.baseAttributeName.set(h,h.name),h.name=`_${h.name}_end`,c[h.name]=y,s.has(y)&&console.error("Undefined behavior occurs if you reuse an IAutoEasingMethod. Please ensure you are using uid() from the util to give the IAutoEasingMethod its uid, or just use the default provided methods"),s.add(y);const b={values:Om};let x,R,N,I,S,j,Q,D,H,z,V,ne,W;h.update=ee=>{if(H=e.surface.frameMetrics,R=h.easing.delay,N=h.easing.duration,Q=w(ee),D=H.currentTime,ee.easing=ne=ee.easing||new Map,z=ne.get(y),!V||!z?(V=B(Q),z=new jh({duration:N,end:V.copy(Q),start:V.copy(Q),startTime:D}),ne.set(y,z)):ee.reactivate&&(V.copy(Q,z.end),V.copy(Q,z.end),z.startTime=D),S=z,I=N,x=R,S.isTimeSet&&(I=S.duration||N,x=S.delay||0),!S.isManualStart){switch(j=1,p){case Qt.CONTINUOUS:j=(D-S.startTime)/I,W=!0;break;case Qt.REPEAT:j=(D-S.startTime)/I%1,W=!0;break;case Qt.REFLECT:{const Me=(D-S.startTime)/I;j=Lm(Me/2%1-.5)*2,W=!0;break}case Qt.NONE:default:j=(D-S.startTime)/I,W=!1;break}S.start=f(S.start,S.end,j,S.start)}return S.startTime=D+x,V.copy(Q,S.end),b.values=S,e.animationEndTime=Cm(e.animationEndTime,S.startTime+I+H.frameDuration),e.alwaysDraw=W,Q},h.childAttributes=h.childAttributes||[];const oe={name:`_${m}_start`,parentAttribute:h,size:T,update:ee=>b.values.start};h.childAttributes.push(oe),o.push(oe);const Y={name:`_${m}_start_time`,parentAttribute:h,size:C.ONE,update:ee=>[b.values.startTime]};h.childAttributes.push(Y),o.push(Y);const Ce={name:`_${m}_duration`,parentAttribute:h,size:C.ONE,update:ee=>[b.values.duration]};h.childAttributes.push(Ce),o.push(Ce)}return{instanceAttributes:o,vertexAttributes:[],uniforms:[]}}validate(e,i,n,r){let s=!1;return i.forEach(a=>{a.easing&&a.resource&&(console.warn("An instance attribute can not have both easing and resource properties. Undefined behavior will occur."),console.warn(a),s=!0),a.easing&&a.size===void 0&&console.warn("An Instance Attribute with easing MUST have a size declared")}),!s}processAttributeDestructuring(e,i,n,r,s,a){const o="";for(let c=0,l=s.length;c<l;++c){const u=s[c];if(!u.easing||!u.size)continue;const h=this.baseAttributeName.get(u);if(!h){console.warn("Could not determine a base name for an easing attribute.");continue}this.baseAttributeName.delete(u);const f=`_${h}_time`,p=`_${h}_duration`,g=`_${h}_start_time`;switch(u.easing.loop){case Qt.CONTINUOUS:{this.setDeclaration(i,f,`  float ${f} = (currentTime - ${g}) / ${p};
`,Ji);break}case Qt.REPEAT:{this.setDeclaration(i,f,`  float ${f} = clamp(fract((currentTime - ${g}) / ${p}), 0.0, 1.0);
`,Ji);break}case Qt.REFLECT:{const m=`_${h}_timePassed`,T=`_${h}_pingPong`;this.setDeclaration(i,m,`  float ${m} = (currentTime - ${g}) / ${p};
`,Ji),this.setDeclaration(i,T,`  float ${T} = abs((fract(${m} / 2.0)) - 0.5) * 2.0;
`,Ji),this.setDeclaration(i,f,`  float ${f} = clamp(${T}, 0.0, 1.0);
`,Ji);break}case Qt.NONE:default:{this.setDeclaration(i,f,`  float ${f} = clamp((currentTime - ${g}) / ${p}, 0.0, 1.0);
`,Ji);break}}this.setDeclaration(i,h,`  ${Ed[u.size]} ${h} = ${u.easing.methodName}(_${h}_start, _${h}_end, _${h}_time);
`,Ji)}return o}processHeaderInjection(e,i,n,r,s,a,o){const c={injection:""};if(e!==A.VERTEX)return c;const l=new Map;if(c.injection=`// Auto Easing Methods specified by the layer
`,a.forEach(h=>{if(h.easing&&h.size){let f=l.get(h.easing.methodName);f||(f=new Map,l.set(h.easing.methodName,f)),f.set(h.size,h.easing.gpu)}}),l.size===0)return c.injection="",c;const u={name:"Easing Method Generation",values:[Ic.easingMethod]};return l.forEach((h,f)=>{h.forEach((p,g)=>{const m=Ed[g],T={[Ic.easingMethod]:`${m} ${f}(${m} start, ${m} end, float t)`,[Ic.T]:`${m}`},w=Ki({options:T,required:u,shader:p});this.setDeclaration(i,`${m} ${f}`,`${w.shader}
`,Ji)})}),c}}const Mn="BasicIOExpansion",Dm=["x","y","z","w"],In={[E.ONE]:"float",[E.TWO]:"vec2",[E.THREE]:"vec3",[E.FOUR]:"vec4",[E.MATRIX3]:"mat3",[E.MATRIX4]:"mat4",[E.FLOAT_ARRAY]:"float",[E.VEC4_ARRAY]:"vec4",[E.TEXTURE]:"vec4"};function Rd(t){return t&&t.length}function Fm(t){const e=t.size;if(e===E.FLOAT_ARRAY||e===E.VEC4_ARRAY){const i=t.update(t);if(Rd(i))return`#define ${t.name}_length ${i.length}
`}return""}function Bm(t){const e=t.size;if(e===E.FLOAT_ARRAY||e===E.VEC4_ARRAY){const i=t.update(t);if(Rd(i))return`[${t.name}_length]`}return""}function Um(t,e){return Dm.slice(t,t+e).join("")}class xd extends $r{processAttributeDestructuring(e,i,n,r,s,a){let o="";const c=s.slice(0);switch(e.bufferType){case Ae.INSTANCE_ATTRIBUTE:o=this.processDestructuringInstanceAttribute(i,c);break;case Ae.INSTANCE_ATTRIBUTE_PACKING:o=this.processDestructuringInstanceAttributePacking(i,c);break}return e.picking.type===X.SINGLE&&(o+=`
// This portion is where the shader assigns the picking color that gets passed to the fragment shader
_picking_color_pass_ = _pickingColor;
`),o}processDestructuringInstanceAttribute(e,i){return""}processDestructuringInstanceAttributePacking(e,i){let n="";return n+=this.processDestructureBlocks(e,i),n}processDestructureBlocks(e,i){const n="";return i.forEach(r=>{const s=r.block||0;r.size===C.MAT4X4?this.setDeclaration(e,r.name,`  ${In[r.size]} ${r.name} = mat4(block${s}, block${s+1}, block${s+2}, block${s+3});
`,Mn):r.size===C.FOUR?this.setDeclaration(e,r.name,`  ${In[r.size]} ${r.name} = block${s};
`,Mn):this.setDeclaration(e,r.name,`  ${In[r.size||1]} ${r.name} = block${s}.${Um(r.blockIndex||0,r.size||1)};
`,Mn)}),n}processHeaderInjection(e,i,n,r,s,a,o){let c={injection:""};e===A.VERTEX&&(c=this.processAttributeHeader(i,n,r,s,a));const l=this.processUniformHeader(i,o,e);return{...c,injection:c.injection+l}}processAttributeHeader(e,i,n,r,s){let o=`// Shader input
`;return o+=this.processVertexAttributes(e,r),i.bufferType===Ae.INSTANCE_ATTRIBUTE&&s.length>0&&(o+=this.processInstanceAttributeBufferStrategy(e,s)),i.bufferType===Ae.INSTANCE_ATTRIBUTE_PACKING&&s.length>0&&(o+=this.processInstanceAttributePackingBufferStrategy(e,n.instanceMaxBlock)),{injection:o,material:void 0}}processUniformHeader(e,i,n){const r="",s=n||A.VERTEX;return i.forEach(a=>{a.shaderInjection=a.shaderInjection||A.VERTEX,(a.shaderInjection===s||a.shaderInjection===A.ALL)&&this.setDeclaration(e,a.name,`${Fm(a)}uniform ${a.qualifier||""}${a.qualifier?" ":""}${In[a.size]} ${a.name}${Bm(a)};
`,Mn)}),r}processInstanceAttributeBufferStrategy(e,i){let n="attribute";return L.SHADERS_3_0&&(n="in"),i.forEach(r=>{this.setDeclaration(e,r.name,`${n} ${In[r.size||1]} ${r.qualifier||""}${r.qualifier&&" "||""} ${r.name};
`,Mn)}),""}processInstanceAttributePackingBufferStrategy(e,i){let n="attribute";L.SHADERS_3_0&&(n="in");for(let r=0,s=i+1;r<s;++r)this.setDeclaration(e,`block${r}`,`${n} ${In[C.FOUR]} block${r};
`,Mn);return""}processVertexAttributes(e,i){let n="attribute";return L.SHADERS_3_0&&(n="in"),i.forEach(r=>{this.setDeclaration(e,r.name,`${n} ${In[r.size]} ${r.qualifier||""}${r.qualifier&&" "||""}${r.name};
`,Mn)}),""}}const Gm=`if (_active < 0.5) {
gl_Position = vec4(0.0, 0.0, 0.0, 1.0);
return;
}`,km="instanceData",zm="_active",Vm="ActiveIOExpansion";class Ad extends $r{processAttributeDestructuring(e,i,n,r,s,a){const o="";return s.find(c=>c.name===zm)&&this.setDeclaration(i,"__active_attribute_handler__",Gm,Vm),o}}function Wm(t){return t&&t.buffer&&t.buffer.value}function Sd(t){return t&&t.propertyToBufferLocation}class ra{constructor(e,i){this.add=()=>{},this.remove=n=>n,this.layer=e,this.scene=i}changesProcessed(){delete this.changeListContext}incomingChangeList(e){this.changeListContext=e}makeLayerMaterial(){const e=this.layer.shaderIOInfo;return yd(this.layer,e.vs,e.fs,e.uniforms,e.materialUniforms)}}let qn={};function en(t,e){const i=qn[t]||[e,-1,0];qn[t]=i,i[2]++,clearTimeout(i[1]),i[1]=window.setTimeout(()=>{e(i[2],t),delete qn[t]},1)}function Md(){for(const t in qn){const e=qn[t];clearTimeout(e[1]),e[0](e[2],t)}qn={}}const Kn=xe("performance"),{max:$m}=Math;function jm(t){return!!(t&&t.buffer&&t.buffer.value)}function Id(t){return Sd(t)}class Ld extends ra{constructor(e,i){super(e,i),this.allBufferLocations={},this.availableLocations=[],this.currentInstancedCount=0,this.instanceToBufferLocation={},this.maxInstancedCount=0,this.attributeToPropertyIds=new Map,this.updateAllPropertyIdList=[],this.activePropertyId=-1,this.currentAvailableLocation=-1,this.remove=n=>{const r=this.instanceToBufferLocation[n.uid];return r&&(delete this.instanceToBufferLocation[n.uid],this.availableLocations.push(r)),n},this.add=this.doAddWithRegistration}changesProcessed(){super.changesProcessed(),this.availableLocations.splice(0,this.currentAvailableLocation+1),this.currentAvailableLocation=-1}doAddWithRegistration(e){je.setObservableMonitor(!0),this.layer.shaderIOInfo.instanceAttributes.forEach(n=>{if(n.parentAttribute)return;n.update(e);const r=je.getObservableMonitorIds(!0);this.attributeToPropertyIds.set(n,[r[r.length-1]]),r.length>1&&Kn("Property has multiple observables. Only the last trigger will be retained as the feature is not complete yet"),n===this.layer.shaderIOInfo.activeAttribute&&(this.activePropertyId=r[0])}),je.setObservableMonitor(!1),this.makeUpdateAllPropertyIdList();const i=this.resizeBuffer();return this.gatherLocationsIntoGroups(i.newLocations,i.growth),this.add=this.doAdd,this.doAdd(e)}doAdd(e){if(this.availableLocations.length<=0||this.currentAvailableLocation>=this.availableLocations.length-1){const n=this.resizeBuffer();this.gatherLocationsIntoGroups(n.newLocations,n.growth)}const i=this.availableLocations[++this.currentAvailableLocation];return i&&this.geometry?(this.instanceToBufferLocation[e.uid]=i,this.currentInstancedCount=this.geometry.maxInstancedCount=$m(this.currentInstancedCount,i.instanceIndex+1),this.model&&(this.model.vertexDrawRange=[0,this.layer.shaderIOInfo.instanceVertexCount],this.model.drawInstances=this.currentInstancedCount,this.layer.shaderIOInfo.instanceVertexCount===0&&(this.model.vertexDrawRange[1]=this.model.drawInstances))):console.error("Add Error: Instance Attribute Buffer Manager failed to pair an instance with a buffer location"),i}destroy(){this.geometry&&this.geometry.destroy(),this.material&&this.material.dispose(),this.scene&&this.scene.container&&this.model&&this.scene.container.remove(this.model)}getBufferLocations(e){return this.instanceToBufferLocation[e.uid]}getActiveAttributePropertyId(){return this.activePropertyId}getUpdateAllPropertyIdList(){return this.updateAllPropertyIdList}managesInstance(e){return this.instanceToBufferLocation[e.uid]!==void 0}makeUpdateAllPropertyIdList(){const e={};this.attributeToPropertyIds.forEach(i=>{e[i[0]]=i[0]}),this.updateAllPropertyIdList=Object.values(e).filter(Boolean)}removeFromScene(){this.scene&&this.scene.container&&this.model&&this.scene.container.remove(this.model),delete this.scene}resizeBuffer(){var r;Kn("Gathering resize growth amount...");const e=this.layer.shaderIOInfo;let i=0;const n=new Map;if(this.changeListContext){i=1e3;for(let s=0,a=this.changeListContext.length;s<a;++s){const o=this.changeListContext[s];switch(o[1]){case Le.CHANGE:case Le.INSERT:this.instanceToBufferLocation[o[0].uid]||i++;break}}}if(Kn("BEGIN: Resizing unpacked attribute buffer by %d instances",i),this.geometry){this.geometry.destroy(),this.geometry=new zi;const s=this.maxInstancedCount;for(const a of e.vertexAttributes)a.materialAttribute&&this.geometry.addAttribute(a.name,a.materialAttribute);this.maxInstancedCount+=i,this.attributes=this.attributes||[];for(const a of this.attributes){const o=a.bufferAttribute,c=a.size||0;if(o.data instanceof Float32Array){let l=o.data;l.length<this.maxInstancedCount*c&&(l=new Float32Array(this.maxInstancedCount*c*2),l.set(o.data,0));const u=new gi(l,c,!0,!0);u.setDynamic(!0),a.bufferAttribute=u,this.geometry.addAttribute(a.name,u);let h=n.get(a.name);const f=this.allBufferLocations[a.name]||[];this.allBufferLocations[a.name]=f;for(let T=0,w=f.length;T<w;++T)f[T].buffer.value=l;h||(h=[],n.set(a.name,h));let p,g=h.length;const m=this.maxInstancedCount-s;h.length+=m,f.length+=m;for(let T=s,w=this.maxInstancedCount;T<w;++T,++g)p={attribute:a,buffer:{value:l},instanceIndex:T,range:[T*c,T*c+c]},h[g]=p,f[T]=p}}(r=this.scene)!=null&&r.container&&this.model&&this.scene.container.remove(this.model)}else{this.maxInstancedCount+=i,this.geometry=new zi;for(const s of e.vertexAttributes)s.materialAttribute&&this.geometry.addAttribute(s.name,s.materialAttribute);this.attributes=[];for(const s of e.instanceAttributes){const a=s.size||0,o=new Float32Array(a*this.maxInstancedCount),c=new gi(o,a,!0,!0);c.setDynamic(!0),this.geometry.addAttribute(s.name,c);let l=n.get(s.name);l||(l=[],n.set(s.name,l));const u=this.allBufferLocations[s.name]||[];this.allBufferLocations[s.name]=u;const h=Object.assign({},s,{uid:G(),bufferAttribute:c});for(let f=0;f<this.maxInstancedCount;++f){const p={attribute:h,buffer:{value:o},instanceIndex:f,range:[f*a,f*a+a]};l.push(p),u.push(p)}this.attributes.push(h)}this.geometry.maxInstancedCount=0,this.material=this.makeLayerMaterial();for(let s=0,a=e.uniforms.length;s<a;++s){const o=e.uniforms[s];o.materialUniforms.push(this.material.uniforms[o.name])}}return this.scene&&this.model&&this.scene.container&&this.scene.container.remove(this.model),this.material=this.material||this.makeLayerMaterial(),this.model=na(this.layer.id,this.geometry,this.material,e.drawMode),this.scene&&this.scene.container&&this.model&&this.scene.container.add(this.model),Kn("COMPLETE: Resizing unpacked attribute buffer"),{growth:i,newLocations:n}}gatherLocationsIntoGroups(e,i){if(this.attributeToPropertyIds.size===0)return;Kn("BEGIN: Unpacked attribute manager grouping new buffer locations");const n=[];this.attributeToPropertyIds.forEach((u,h)=>{n.push({attribute:h,bufferLocationsForAttribute:e.get(h.name)||[],childBufferLocations:(h.childAttributes||[]).map(f=>({location:e.get(f.name)||[],bufferIndex:-1})),ids:u,bufferIndex:-1})});let r,s,a,o,c,l;for(let u=0;u<i;++u){const h={instanceIndex:-1,propertyToBufferLocation:{}};for(let f=0,p=n.length;f<p;++f){if(r=n[f],s=r.attribute,a=r.ids,o=r.bufferLocationsForAttribute,!o){en("Instance Attribute Buffer Error",(g,m)=>{console.warn(`${m}: There is an error in forming buffer location groups in InstanceAttributeBufferManager. Error count: ${g}`)});continue}if(c=o[++r.bufferIndex],!c){en("Instance Attribute Buffer Error",(g,m)=>{console.warn(`${m}: There is an error in forming buffer location groups in InstanceAttributeBufferManager. Error count: ${g}`)});continue}if(h.instanceIndex===-1)h.instanceIndex=c.instanceIndex;else if(c.instanceIndex!==h.instanceIndex){en("Instance Attribute Parallelism Error",(g,m)=>{console.warn(`${m}: A buffer location does not have a matching instance index which means the buffer locations are not in parallel with each other somehow. Error count: ${g}`),console.warn(s.name,c)});continue}if(s.childAttributes){c.childLocations=[];for(let g=0,m=s.childAttributes.length;g<m;++g){const T=r.childBufferLocations[g];if(T){const w=T.location[++T.bufferIndex];w?c.childLocations.push(w):(l=s.childAttributes[g],en("Instance Attribute Child Attribute Error",(y,b)=>{console.warn(`${b}: A child attribute does not have a buffer location available. Error count: ${y}`),console.warn(`Parent Attribute: ${s.name} Child Attribute: ${l.name}`)}))}}}for(let g=0,m=a.length;g<m;++g)h.propertyToBufferLocation[a[g]]=c}this.availableLocations.push(h)}Kn("COMPLETE: Unpacked attribute buffer manager buffer location grouping"),Md()}getInstanceCount(){return this.maxInstancedCount}}const{max:Hm}=Math,Zn=xe("performance");class Cd extends ra{constructor(e,i){super(e,i),this.allBufferLocations={},this.availableLocations=[],this.currentInstancedCount=0,this.instanceToBufferLocation={},this.maxInstancedCount=1e3,this.blockSubAttributesLookup=new Map,this.attributeToPropertyIds=new Map,this.updateAllPropertyIdList=[],this.activePropertyId=-1,this.currentAvailableLocation=-1,this.remove=n=>{const r=this.instanceToBufferLocation[n.uid];return r&&(delete this.instanceToBufferLocation[n.uid],this.availableLocations.push(r)),n},this.add=this.doAddWithRegistration}changesProcessed(){super.changesProcessed(),this.availableLocations.splice(0,this.currentAvailableLocation+1),this.currentAvailableLocation=-1}doAddWithRegistration(e){this.layer.shaderIOInfo.instanceAttributes.forEach(n=>{if(n.parentAttribute)return;je.setObservableMonitor(!0),n.update(e);const r=je.getObservableMonitorIds(!0);this.attributeToPropertyIds.set(n,[r[r.length-1]]),r.length>1&&Zn("Property has multiple observables. Only the last trigger will be retained as the feature is not complete yet"),n===this.layer.shaderIOInfo.activeAttribute&&(this.activePropertyId=r[0])}),je.setObservableMonitor(!1),this.makeUpdateAllPropertyIdList();const i=this.resizeBuffer();return this.gatherLocationsIntoGroups(i.newLocations,i.growth),this.add=this.doAdd,this.doAdd(e)}doAdd(e){if(this.availableLocations.length<=0||this.currentAvailableLocation>=this.availableLocations.length-1){const n=this.resizeBuffer();this.gatherLocationsIntoGroups(n.newLocations,n.growth)}const i=this.availableLocations[++this.currentAvailableLocation];return i&&this.geometry?(this.instanceToBufferLocation[e.uid]=i,this.currentInstancedCount=this.geometry.maxInstancedCount=Hm(this.currentInstancedCount,i.instanceIndex+1),this.model&&(this.model.vertexDrawRange=[0,this.layer.shaderIOInfo.instanceVertexCount],this.model.drawInstances=this.currentInstancedCount,this.layer.shaderIOInfo.instanceVertexCount===0&&(this.model.vertexDrawRange[1]=this.model.drawInstances))):console.error("Add Error: Instance Attribute Buffer Manager failed to pair an instance with a buffer location"),i}destroy(){this.geometry&&this.geometry.destroy(),this.material&&this.material.dispose(),this.scene&&this.scene.container&&this.model&&this.scene.container.remove(this.model)}getBufferLocations(e){return this.instanceToBufferLocation[e.uid]}getActiveAttributePropertyId(){return this.activePropertyId}getUpdateAllPropertyIdList(){return this.updateAllPropertyIdList}managesInstance(e){return this.instanceToBufferLocation[e.uid]!==void 0}makeUpdateAllPropertyIdList(){const e={};this.attributeToPropertyIds.forEach(i=>{e[i[0]]=i[0]}),this.updateAllPropertyIdList=Object.values(e).filter(Boolean)}removeFromScene(){this.scene&&this.scene.container&&this.model&&this.scene.container.remove(this.model),delete this.scene}resizeBuffer(){const e=this.layer.shaderIOInfo;let i=0;const n=new Map;if(this.changeListContext){i=1e3;for(let r=0,s=this.changeListContext.length;r<s;++r){const a=this.changeListContext[r];switch(a[1]){case Le.CHANGE:case Le.INSERT:this.instanceToBufferLocation[a[0].uid]||i++;break}}}if(Zn("BEGIN: Resizing packed attribute buffer by %d instances",i),this.geometry){Zn(`Info: Vertex packing buffer is being resized for layer ${this.layer.id}`),this.geometry.destroy(),this.geometry=new zi;const r=this.maxInstancedCount;for(const s of e.vertexAttributes)s.materialAttribute&&this.geometry.addAttribute(s.name,s.materialAttribute);this.maxInstancedCount+=i,this.attributes=this.attributes||[],this.blockAttributes=this.blockAttributes||[];for(let s=0,a=this.blockAttributes.length;s<a;++s){const o=this.blockAttributes[s];let c=o.bufferAttribute;const l=o.size||0;if(c.data instanceof Float32Array){let u=c.data;u.length<this.maxInstancedCount*l&&(u=new Float32Array(this.maxInstancedCount*l*2),u.set(c.data,0)),u.set(c.data,0);const h=new gi(u,l,!0,!0);o.bufferAttribute=c=h,this.geometry.addAttribute(o.name,h);const f=this.blockSubAttributesLookup.get(s),p=o.size||0;if(f)for(let g=0,m=f.length;g<m;++g){const T=f[g];let w=n.get(T.name);w||(w=[],n.set(T.name,w));const y=this.allBufferLocations[T.name]||[];this.allBufferLocations[T.name]=y;const b=Object.assign({},T,{uid:G(),packUID:o.packUID,bufferAttribute:c}),x=T.blockIndex||0,R=T.size||1;let N;for(let Q=0,D=y.length;Q<D;++Q)N=y[Q],N.attribute=b,N.buffer.value=u;let I,S=w.length;const j=this.maxInstancedCount-r;w.length+=j,y.length+=j;for(let Q=r;Q<this.maxInstancedCount;++Q,++S)I={attribute:b,block:s,buffer:{value:u},instanceIndex:Q,range:[Q*p+x,Q*p+x+R]},w[S]=I,y[Q]=I}}}}else{this.maxInstancedCount+=i,this.geometry=new zi;for(const a of e.vertexAttributes)a.materialAttribute&&this.geometry.addAttribute(a.name,a.materialAttribute);this.attributes=[],this.blockAttributes=[];const r=new Map,s=new Map;this.blockSubAttributesLookup=s;for(let a=0,o=e.instanceAttributes.length;a<o;++a){const c=e.instanceAttributes[a],l=c.block||0;let u=r.get(l)||0;u=Math.max(u,(c.blockIndex||0)+(c.size||0)),r.set(l,u);let h=s.get(l);h||(h=[],s.set(l,h)),h.push(c)}s.forEach(a=>a.sort((o,c)=>(o.blockIndex||0)-(c.blockIndex||0)));for(let a=0,o=r.size;a<o;++a){const c=r.get(a)||0,l=G();c||console.warn("Instance Attribute Packing Error: The system tried to build an attribute with a size of zero.","These are the attributes used:",e.instanceAttributes,"These are the block sizes calculated",r,"This is the block to attribute lookup generated",s);const u=new Float32Array(c*this.maxInstancedCount),h=new gi(u,c,!0,!0);this.geometry.addAttribute(`block${a}`,h);const f=s.get(a);if(f){for(let p=0,g=f.length;p<g;++p){const m=f[p];let T=n.get(m.name);T||(T=[],n.set(m.name,T));const w=this.allBufferLocations[m.name]||[];this.allBufferLocations[m.name]=w;const y=Object.assign({},m,{uid:a,packUID:l,bufferAttribute:h,size:c}),b=m.blockIndex||0,x=m.size||1;for(let R=0;R<this.maxInstancedCount;++R){const N={attribute:y,block:a,buffer:{value:u},instanceIndex:R,range:[R*c+b,R*c+b+x]};T.push(N),w.push(N)}this.attributes.push(y)}this.blockAttributes.push({uid:G(),packUID:l,bufferAttribute:h,name:`block${a}`,size:c,update:()=>[0]})}else console.warn("Instance Attribute Packing Buffer Error: Somehow there are no attributes associated with a block.","These are the attributes used:",e.instanceAttributes,"These are the block sizes calculated",r,"This is the block to attribute lookup generated",s)}this.geometry.maxInstancedCount=0,this.material=this.makeLayerMaterial();for(let a=0,o=e.uniforms.length;a<o;++a){const c=e.uniforms[a];c.materialUniforms.push(this.material.uniforms[c.name])}}return this.scene&&this.model&&this.scene.container&&this.scene.container.remove(this.model),this.material=this.material||this.makeLayerMaterial(),this.model=na(this.layer.id,this.geometry,this.material,this.layer.shaderIOInfo.drawMode),this.scene&&this.scene.container&&this.model&&this.scene.container.add(this.model),Zn("COMPLETE: Resizing unpacked attribute buffer"),{growth:i,newLocations:n}}gatherLocationsIntoGroups(e,i){if(this.attributeToPropertyIds.size===0)return;Zn("BEGIN: Packed attribute manager grouping new buffer locations");const n=[];this.attributeToPropertyIds.forEach((r,s)=>{n.push({attribute:s,bufferLocationsForAttribute:e.get(s.name)||[],childBufferLocations:(s.childAttributes||[]).map(a=>({location:e.get(a.name)||[],bufferIndex:-1})),ids:r,bufferIndex:-1})});for(let r=0;r<i;++r){const s={instanceIndex:-1,propertyToBufferLocation:{}};for(let a=0,o=n.length;a<o;++a){const c=n[a],l=c.attribute,u=c.ids,h=c.bufferLocationsForAttribute;if(!h){en("Instance Attribute Buffer Error",(p,g)=>{console.warn(`${g}: There is an error in forming buffer location groups in InstanceAttributePackingBufferManager. Error count: ${p}`)});continue}const f=h[++c.bufferIndex];if(!f){en("Instance Attribute Buffer Error",(p,g)=>{console.warn(`${g}: There is an error in forming buffer location groups in InstanceAttributePackingBufferManager. Error count: ${p}`)});continue}if(s.instanceIndex===-1)s.instanceIndex=f.instanceIndex;else if(f.instanceIndex!==s.instanceIndex){en("Instance Attribute Parallelism Error",(p,g)=>{console.warn(`${g}: A buffer location does not have a matching instance index which means the buffer locations are not in parallel with each other somehow. Error count: ${p}`),console.warn(l.name,f)});continue}if(l.childAttributes){const p=[];for(let g=0,m=l.childAttributes.length;g<m;++g){const T=l.childAttributes[g],w=c.childBufferLocations[g];if(w){const y=w.location[++w.bufferIndex];y?p.push(y):en("Instance Attribute Child Attribute Error",(b,x)=>{console.warn(`${x}: A child attribute does not have a buffer location available. Error count: ${b}`),console.warn(`Parent Attribute: ${l.name} Child Attribute: ${T.name}`)})}}f.childLocations=p}for(let p=0,g=u.length;p<g;++p){const m=u[p];s.propertyToBufferLocation[m]=f}}this.availableLocations.push(s)}Zn("COMPLETE: Packed attribute buffer manager buffer location grouping"),Md()}getInstanceCount(){return this.maxInstancedCount}}function Od(t){return t&&t.buffer&&t.buffer.value&&t.type===be.VEC4_ARRAY}class Nd extends ra{constructor(e,i){super(e,i),this.buffers=[],this.availableClusters=[],this.instanceToCluster={},this.clusterToBuffer=new Map,this.add=r=>{this.availableClusters.length<=0&&this.makeNewBuffer();const s=this.availableClusters.pop();return s?this.instanceToCluster[r.uid]=s:console.warn("No valid cluster available for instance added to uniform manager."),s},this.remove=r=>{const s=this.instanceToCluster[r.uid];return s&&(delete this.instanceToCluster[r.uid],this.availableClusters.push(s)),r};let n=0;e.shaderIOInfo.instanceAttributes.forEach(r=>{n=Math.max(r.block||0,n)}),this.uniformBlocksPerInstance=n+1}destroy(){this.buffers.forEach(e=>{e.geometry.destroy(),e.material.dispose()})}getBufferLocations(e){return this.instanceToCluster[e.uid]}getActiveAttributePropertyId(){return-1}getInstanceCount(){return-1}getUpdateAllPropertyIdList(){return[]}managesInstance(e){return this.instanceToCluster[e.uid]===void 0}removeFromScene(){const e=this.scene;if(e!=null&&e.container){for(let i=0,n=this.buffers.length;i<n;++i){const r=this.buffers[i];e.container.remove(r.model)}delete this.scene}}setScene(e){if(e.container){for(let i=0,n=this.buffers.length;i<n;++i){const r=this.buffers[i];e.container.add(r.model)}this.scene=e}else console.warn("Can not set a scene that has an undefined container.")}makeNewBuffer(){const e=this.layer.shaderIOInfo,i=new zi;e.vertexAttributes.forEach(u=>{u.materialAttribute&&i.addAttribute(u.name,u.materialAttribute)});const n=this.makeLayerMaterial(),r=na(this.layer.id,i,n,e.drawMode);r.vertexDrawRange=[0,e.maxInstancesPerBuffer*e.instanceVertexCount];const s={activeInstances:[],clusters:[],firstInstance:0,geometry:i,lastInstance:0,material:n,model:r};this.buffers.push(s);let a=0;const o=km,c=n.uniforms[o];if(Xl(c))c.value=c.value.map(()=>[0,0,0,0]);else{console.warn("Material is utilizing an invalid uniform type for Uniform Buffer Management. Buffering will not be possible.");return}const l=Object.assign({},e.instanceAttributes[0],{bufferAttribute:new gi(new Float32Array(1),1),uid:G()});for(let u=0,h=e.maxInstancesPerBuffer;u<h;++u){const f={attribute:l,buffer:c,instanceIndex:u,range:[a,0]};a+=this.uniformBlocksPerInstance,f.range[1]=a,s.clusters.push(f),this.availableClusters.push(f),this.clusterToBuffer.set(f,s)}for(let u=0,h=e.uniforms.length;u<h;++u){const f=e.uniforms[u];f.materialUniforms.push(n.uniforms[f.name])}this.scene&&this.scene.container&&this.scene.container.add(s.model)}}class Pd{constructor(e,i){this.layer=e,this.bufferManager=i}}const sa=[],{min:Lc,max:Cc}=Math;class Qm extends Pd{constructor(){super(...arguments),this.diffMode=0,this.bufferAttributeUpdateRange={},this.bufferAttributeWillUpdate={},this.updateInstance=this.updateInstancePartial}addInstance(e,i,n,r){if(r)e.changeInstance(e,i,sa,r);else{const s=e.layer.bufferManager.add(i);Id(s)&&(i.active=!0,e.layer.onDiffAdd&&e.layer.onDiffAdd(i),e.updateInstance(e.layer,i,sa,s))}}changeInstance(e,i,n,r){r?e.updateInstance(e.layer,i,n,r):e.addInstance(e,i,sa,r)}removeInstance(e,i,n,r){r&&(i.active=!1,e.layer.onDiffRemove&&e.layer.onDiffRemove(i),e.updateInstance(e.layer,i,sa,r),e.layer.bufferManager.remove(i))}updateInstancePartial(e,i,n,r){const s=r.propertyToBufferLocation,a=this.bufferAttributeUpdateRange;let o,c,l,u,h,f;if(i.active){(n.length===0||i.reactivate)&&(n=this.bufferManager.getUpdateAllPropertyIdList());for(let p=0,g=n.length;p<g;++p)if(o=s[n[p]],!!o&&(h=o.attribute,f=h.packUID||h.uid,c=h.update(i),o.buffer.value.set(c,o.range[0]),l=a[f]||[null,Number.MAX_SAFE_INTEGER,Number.MIN_SAFE_INTEGER],l[0]=h,l[1]=Lc(o.range[0],l[1]),l[2]=Cc(o.range[1],l[2]),a[f]=l,o.childLocations)){u=o.childLocations;for(let m=0,T=u.length;m<T;++m)o=u[m],o&&(f=o.attribute.packUID||o.attribute.uid,c=o.attribute.update(i),o.buffer.value.set(c,o.range[0]),l=a[f]||[null,Number.MAX_SAFE_INTEGER,Number.MIN_SAFE_INTEGER],l[0]=o.attribute,l[1]=Lc(o.range[0],l[1]),l[2]=Cc(o.range[1],l[2]),a[f]=l)}}else o=s[this.bufferManager.getActiveAttributePropertyId()],h=o.attribute,f=h.packUID||h.uid,c=h.update(i),o.buffer.value.set(c,o.range[0]),l=a[f]||[null,Number.MAX_SAFE_INTEGER,Number.MIN_SAFE_INTEGER],l[0]=h,l[1]=Lc(o.range[0],l[1]),l[2]=Cc(o.range[1],l[2]),a[f]=l;i.reactivate=!1}updateInstanceFull(e,i,n,r){const s=r.propertyToBufferLocation,a=this.bufferAttributeWillUpdate;let o,c,l,u;if(i.active){(n.length===0||i.reactivate)&&(n=this.bufferManager.getUpdateAllPropertyIdList());for(let h=0,f=n.length;h<f;++h)if(o=s[n[h]],!!o&&(u=o.attribute,c=u.update(i),o.buffer.value.set(c,o.range[0]),a[u.packUID||u.uid]=u,o.childLocations)){l=o.childLocations;for(let p=0,g=l.length;p<g;++p)o=l[p],o&&(u=o.attribute,c=u.update(i),o.buffer.value.set(c,o.range[0]),a[u.packUID||u.uid]=u)}}else o=s[this.bufferManager.getActiveAttributePropertyId()],u=o.attribute,c=u.update(i),o.buffer.value.set(c,o.range[0]),a[u.packUID||u.uid]=u;i.reactivate=!1}commit(){if(this.diffMode===0){const e=Object.values(this.bufferAttributeUpdateRange);for(let i=0,n=e.length;i<n;++i){const r=e[i],s=r[0].bufferAttribute;s.updateRange={count:r[2]-r[1],offset:r[1]}}}else{const e=Object.values(this.bufferAttributeWillUpdate);for(let i=0,n=e.length;i<n;++i){const r=e[i].bufferAttribute;r.updateRange={count:-1,offset:0}}}this.bufferAttributeUpdateRange={}}incomingChangeList(e){e.length===0?this.diffMode=0:e.length>this.bufferManager.getInstanceCount()*.7?this.diffMode=1:this.diffMode=0,this.diffMode===0?this.updateInstance=this.updateInstancePartial:this.updateInstance=this.updateInstanceFull}}const Dd=[];class Xm extends Pd{addInstance(e,i,n,r){if(r)e.changeInstance(e,i,Dd,r);else{const s=e.layer.bufferManager.add(i);Od(s)&&(i.active=!0,e.layer.onDiffAdd&&e.layer.onDiffAdd(i),e.updateInstance(e.layer,i,s))}}changeInstance(e,i,n,r){r?e.updateInstance(e.layer,i,r):e.addInstance(e,i,Dd,r)}removeInstance(e,i,n,r){r&&(i.active=!1,e.layer.onDiffRemove&&e.layer.onDiffRemove(i),e.updateInstance(e.layer,i,r),e.layer.bufferManager.remove(i))}updateInstance(e,i,n){if(i.active){const r=n.buffer,s=n.range[0],a=r.value;let o,c,l,u,h,f;for(let p=0,g=e.shaderIOInfo.instanceAttributes.length;p<g;++p)if(o=e.shaderIOInfo.instanceAttributes[p],c=o.update(i),l=a[s+(o.block||0)],u=o.blockIndex,u!==void 0)for(h=u,f=c.length+u;h<f;++h)l[h]=c[h-u];r.value=a}else{const r=n.buffer,s=n.range[0],a=r.value,o=e.shaderIOInfo.activeAttribute,c=o.update(i),l=a[s+(o.block||0)],u=o.blockIndex;if(u!==void 0)for(let h=u,f=c.length+u;h<f;++h)l[h]=c[h-u];r.value=a}}commit(){}incomingChangeList(e){}}class Ym{makeProcessor(e,i){if(this.processing)return this.processing;if(e.bufferType===Ae.INSTANCE_ATTRIBUTE||e.bufferType===Ae.INSTANCE_ATTRIBUTE_PACKING?this.processor=new Qm(e,i):this.processor=new Xm(e,i),!this.processor)throw new Error("Failed to create a diff processor");return this.processing=[this.processor.changeInstance,this.processor.addInstance,this.processor.removeInstance],this.processing}}class Fd{constructor(e){this.index=0,this.available=4,this.index=e}setAttribute(e){return(e.size||0)<=this.available?(e.block=this.index,e.blockIndex=4-this.available,this.available-=e.size||0,!0):!1}}function qm(t){t.forEach(e=>{if(e.resource&&e.size===void 0&&(e.size=C.FOUR),!e.size)try{const i=e.update(new ze({}));i.length>0&&i.length<=C.FOUR&&(e.size=i.length)}catch{console.warn("The system could not determine the size of the provided attribute. Please provide the size of the attribute:",e)}})}function Bd(t){qm(t);const e=[];t.forEach(i=>{if(i.size&&i.size===C.MAT4X4){i.block=e.length,i.blockIndex=No.INVALID;for(let r=0;r<4;++r){const s=new Fd(e.length);s.available=0,s.index=0,e.push(s)}return}if(!e.find(r=>r.setAttribute(i)?!!r:!1)){const r=new Fd(e.length);e.push(r),r.setAttribute(i)||console.warn("There was a problem packing an attribute into a block. No block would accommodate it:",i)}})}function Ud(t){return!!t}function Gd(t){return!!t}function kd(t){return!!t}function Km(t){return Object.assign({},t,{materialAttribute:null})}function Zm(t){return Object.assign({},t,{materialUniforms:[]})}function Jm(t,e,i,n){e.forEach(r=>{r.name===void 0&&console.warn("All instance attributes MUST have a name on Layer:",t.id),e.find(s=>s!==r&&s.name===r.name)&&console.warn("An instance attribute can not have the same name used more than once:",r.name),i.find(s=>s.name===r.name)&&console.warn("An instance attribute and a vertex attribute in a layer can not share the same name:",r.name),r.resource||r.size===void 0&&(console.warn("An instance attribute requires the size to be defined."),console.warn(r))})}function e0(t,e,i){if(!i)return;let n=e.instanceAttributes||[],r=e.uniforms||[],s=e.vertexAttributes||[];i.shaderModuleUnits.forEach(l=>{l.instanceAttributes&&(n=n.concat(l.instanceAttributes(t))),l.uniforms&&(r=r.concat(l.uniforms(t))),l.vertexAttributes&&(s=s.concat(l.vertexAttributes(t)))});const a=new Set,o=new Set,c=new Set;r.filter(l=>l?a.has(l.name)?(console.warn("Included shader modules has introduced duplicate uniform names:",l.name,"One will be overridden thus causing a potential crash of the shader."),!1):(a.add(l.name),!0):!1),n.filter(l=>l?o.has(l.name)?(console.warn("Included shader modules has introduced duplicate Instance Attribute names:",l.name,"One will be overridden thus causing a potential crash of the shader."),!1):(o.add(l.name),!0):!1),s.filter(l=>l?c.has(l.name)?(console.warn("Included shader modules has introduced duplicate Vertex Attribute names:",l.name,"One will be overridden thus causing a potential crash of the shader."),!1):(c.add(l.name),!0):!1),e.instanceAttributes=n,e.uniforms=r,e.vertexAttributes=s}function zd(t,e,i,n,r,s){e0(e,i,s);const a=(i.instanceAttributes||[]).filter(Ud),o=(i.vertexAttributes||[]).filter(Gd),c=(i.uniforms||[]).filter(kd);for(let f=0,p=n.length;f<p;++f){const g=n[f];if(g.validate(e,a,o,c)){const m=g.expand(e,a,o,c);m.instanceAttributes.filter(Ud).forEach(T=>a.push(T)),m.vertexAttributes.filter(Gd).forEach(T=>o.push(T)),m.uniforms.filter(kd).forEach(T=>c.push(T))}}Jm(e,a,o);const l=a.slice(0),u=(o||[]).map(Km),h=c.map(Zm);return l.sort(r.sortInstanceAttributes),h.sort(r.sortUniforms),u.sort(r.sortVertexAttributes),Bd(l),e.getLayerBufferType(t,o,l),{instanceAttributes:l,uniforms:h,vertexAttributes:u}}class Oc{static calculateUniformBlockUseage(e){let i=0;for(let n=0,r=e.length;n<r;++n)i+=Math.ceil(e[n].size/4);return i}process(e,i){this.instanceMaxBlock=0,e.forEach(n=>{this.instanceMaxBlock=Math.max(this.instanceMaxBlock,n.block||0)}),this.blocksPerInstance=this.instanceMaxBlock+1,this.maxUniforms=L.MAX_VERTEX_UNIFORMS,this.maxUniformsForInstancing=this.maxUniforms-Oc.calculateUniformBlockUseage(i),this.maxInstancesPerUniformBuffer=Math.floor(this.maxUniformsForInstancing/this.blocksPerInstance),this.totalInstanceUniformBlocks=this.maxInstancesPerUniformBuffer*this.blocksPerInstance}}const Qr="Once a ShaderModuleUnit has been registered, you CAN NOT modify it! Module ID:";class aa{constructor(e){this._dependents=null,Object.assign(this,e)}get content(){return this._content}set content(e){if(this._isLocked){console.warn(Qr,this._moduleId);return}this._content=e}get compatibility(){return this._compatibility}set compatibility(e){if(this._isLocked){console.warn(Qr,this._moduleId);return}this._compatibility=e}get dependents(){return this._dependents}set dependents(e){if(this._isLocked&&this._dependents!==null){console.warn(Qr,this._moduleId);return}this._dependents=e}isLocked(){return this._isLocked}get moduleId(){return this._moduleId}set moduleId(e){if(this._isLocked){console.warn(Qr,this._moduleId);return}this._moduleId=e}applyAnalyzedContent(e){if(this._isLocked&&this.dependents!==null){console.warn(Qr,this._moduleId);return}this._content=e}lock(){this._isLocked=!0}}const Vd=xe("performance"),t0=xe("shader-module-vs"),i0=xe("shader-module-fs"),Wd="import",$d=":";function jd(t,e){return!!t&&(t.compatibility===e||t.compatibility===A.ALL)}const tn=class{static register(t){if(!(t instanceof aa)){if(Array.isArray(t)){let a="";return t.forEach(o=>{const c=tn.register(o);c&&(a+=`${c}
`)}),a||null}return tn.register(new aa(t))}let e=tn.modules.get(t.moduleId);e||(e={},tn.modules.set(t.moduleId,e));const i=e.fs,n=e.vs,r=jd(t,A.FRAGMENT),s=jd(t,A.VERTEX);if(i&&r){if(i.isFinal)return`Module ID: ${t.moduleId} Can not override the module's existing Fragment registration as the exisitng module is marked as final`;Vd("A Shader Module Unit has overridden an existing module for the Fragment Shader Module ID: %o",t.moduleId)}if(n&&s){if(n.isFinal)return`Module ID: ${t.moduleId} Can not override the module's existing Vertex registration as the exisitng module is marked as final`;Vd("A Shader Module Unit has overridden an existing module for the Vertex Shader Module ID: %o",t.moduleId)}return r&&(e.fs=t),s&&(e.vs=t),t.lock(),null}static analyzeDependents(t){if(t.dependents&&t.isLocked())return[];const e=[],i=[],n=new Set,r=t.compatibility,s=t.moduleId,a=Ki({options:{},shader:t.content,onToken:o=>{const c=o.trim();if(c.indexOf(Wd)===0){const l=c.substr(Wd.length).trim();if(l[0]===$d){let u=!1;const h=l.substr($d.length).trim().split(",");return h[h.length-1].trim().length===0&&h.pop(),h.forEach(f=>{f=f.trim();const p=tn.modules.get(f);p?((r===A.FRAGMENT||r===A.ALL)&&(p.fs?(u=!0,n.has(f)||i.push(f)):e.push(`Could not find requested target fragment module for Module ID: ${f} requested by module: ${s}`)),(r===A.VERTEX||r===A.ALL)&&(p.vs?(u=!0,n.has(f)||i.push(f)):e.push(`Could not find requested target vertex module for Module ID: ${f} requested by module: ${s}`)),!p.vs&&!p.fs&&e.push("Could not find a vertex or fragment shader within exisitng module"),u||e.push(`Error Processing module Module ID: ${f} requested by module: ${s}`)):e.push(`Could not find requested module: ${f} requested by module: ${s}`)}),""}}return`\${${o}}`}});return t.applyAnalyzedContent(a.shader),t.dependents=i,e}static process(t,e,i,n){const r=new Set,s=new Set,a=[],o=[],c=i===A.VERTEX?t0:i0;c("Processing Shader for context %o:",t);function l(g){const m=g.moduleId;c("%o: %o",m,a.slice(0).reverse().join(" -> "));const T=a.indexOf(m);if(a.unshift(m),T>-1){const w=a.slice(0,T+2).reverse();return o.push(`A Shader has detected a Circular dependency in import requests: ${w.join(" -> ")}`),a.shift(),!1}return!0}function u(g){const m=g.moduleId;if(!l(g))return null;if(m&&s.has(m))return a.shift(),"";let T="";tn.analyzeDependents(g).forEach(b=>o.push(b));const y=g.dependents;if(c("Module dependencies detected %o",y),y&&y.length>0)for(let b=0,x=y.length;b<x;++b){const R=y[b],N=tn.modules.get(R);if(N){let I;(i===A.FRAGMENT||i===A.ALL)&&(N.fs?(r.add(N.fs),I=u(N.fs)):o.push(`Could not find requested target fragment module for Module ID: ${R} requested by module: ${m}`)),(i===A.VERTEX||i===A.ALL)&&(N.vs?(r.add(N.vs),I=u(N.vs)):o.push(`Could not find requested target vertex module for Module ID: ${R} requested by module: ${m}`)),!N.vs&&!N.fs&&o.push("Could not find a vertex or fragment shader within exisitng module"),I===null&&o.push(`Error Processing module Module ID: ${R} requested by module: ${m}`),T+=I||""}else o.push(`Could not find requested module: ${R} requested by module: ${m}`)}return a.shift(),s.add(m||""),`${T.trim()}

${g.content.trim()}`}let h=e;if(n){let g="";n.forEach(m=>{g+=`\${import: ${m}}
`}),h=g+e}const f=new aa({content:h,compatibility:i,moduleId:`Layer "${t}" ${i===A.ALL?"fs vs":i===A.VERTEX?"vs":"fs"}`});return{errors:o,shader:u(f),shaderModuleUnits:r}}};let Ee=tn;Ee.modules=new Map;const Hd={attributes:"attributes",easingMethod:"easingMethod",extend:"extend",extendHeader:"extendHeader",T:"T"},oa="out",ca=":";class Qd{constructor(){this.metricsProcessing=new Oc}static mergeFragmentOutputsForMRT(e,i,n,r,s,a){let o="",c="",l="";const u=new Set,h=[],f=new Set;return L.MRT||(l=" = gl_FragColor"),n.forEach((p,g)=>{let m=!0,T=!1;if(s&&s.indexOf(p.outputType)<0&&(m=!1),a&&g<n.length-1&&(m=!1),!a&&r.indexOf(p.outputType)<0&&(m=!1),f.has(p.outputType))throw new Error("Can not use the same Output Fragment type multiple times");f.add(p.outputType);const w=r.indexOf(p.outputType);Ki({shader:Wr(p.source),onToken(y){const b=y.trim();if(b.indexOf(oa)===0){if(T)throw console.error("Found multiple ${out} tokens in a single fragment shader. This is not supported nor logical","If you need to use the declared output multiple times, use the assigned name","and don't wrap it repeatedly in the shader.","eg-","void main() {","  ${out: myOutput} = value;","  vec4 somethingElse = myOutput;","}"),new Error("Invalid Shader Format");T=!0;const x=b.substr(oa.length).trim();if(x[0]===ca){const R=x.substr(ca.length).trim();if(!R)throw new Error("Output in a shader requires an identifier ${out: <name required>}");if(u.has(R))throw new Error("You can not declare the same output name in subsequent fragment shader outputs");if(R==="gl_FragColor")throw new Error("DO not use gl_FragColor as an identifier for an out. Choose something not used by the WebGL spec.");let N="";if(m)if(u.add(R),h.push(p.outputType),L.MRT_EXTENSION)l=` = gl_FragData[${w}]`,N="vec4 ";else if(L.MRT&&L.SHADERS_3_0)i.set(R,`layout(location = ${w}) out vec4 ${R};
`);else throw new Error(`Could not generate a proper output declaration for the fragment shader output: ${R}`);else N="vec4 ";return`${N}${R}${l}`}else throw new Error("Output in a shader requires an identifier ${out: <name required>}")}return`\${${y}}`},onMain(y,b){return!T&&y&&(y.match("gl_FragColor")?(h.push(p.outputType),L.MRT&&(L.SHADERS_3_0?(i.set("_FragColor",`layout(location = ${w}) out vec4 _FragColor;
`),y=y.replace(/gl_FragColor/g,"_FragColor")):(y=y.replace(/gl_FragColor\s+=/,`vec4 _FragColor = gl_FragData[${w}] =`),y=y.replace(/gl_FragColor\s+=/g,`_FragColor = gl_FragData[${w}] =`),y=y.replace(/gl_FragColor/g,"_FragColor"))),u.add("_FragColor")):h.push($.NONE)),o+=`
${(b||"").trim()}`,c+=`
  ${(y||"").trim()}`,(y||"").trim()}})}),{output:`${o}
void main() {
${c}
}`,outputNames:Array.from(u.values()),outputTypes:h}}static mergeOutputFragmentShaderForColor(e,i){if(i.length>1||i[0]!==$.COLOR)throw new Error("Merging fragment shaders for only COLOR output is only valid when the view has a single COLOR output target.");vi(e)&&(e=[{outputType:$.COLOR,source:e}]);let n="",r="";const s=new Set,a=[];return e.some(o=>{const c=o.outputType===$.COLOR;let l=!1;return c&&a.push($.COLOR),Ki({shader:Wr(o.source),onToken(u){const h=u.trim();if(h.indexOf(oa)===0){if(l)throw console.error("Found multiple ${out} tokens in a single fragment shader. This is not supported nor logical","If you need to use the declared output multiple times, use the assigned name","and don't wrap it repeatedly in the shader.","eg-","void main() {","  ${out: myOutput} = value;","  vec4 somethingElse = myOutput;","}"),new Error("Invalid Shader Format");l=!0;const f=h.substr(oa.length).trim();if(f[0]===ca){const p=f.substr(ca.length).trim();if(!p)throw new Error("Output in a shader requires an identifier ${out: <name required>}");if(s.has(p))throw new Error("You can not declare the same output name in subsequent fragment shader outputs");if(p==="gl_FragColor")throw new Error("DO not use gl_FragColor as an identifier for an out. Choose something not used by the WebGL spec.");return c?(s.add("gl_FragColor"),p!=="gl_FragColor"?`vec4 ${p} = gl_FragColor`:"gl_FragColor"):`vec4 ${p}`}}return`\${${u}}`},onMain(u,h){return r+=`
${(h||"").trim()}`,n+=`
  ${(u||"").trim()}`,(u||"").trim()}}),!!c}),{output:`${r}
void main() {
${n}
}`,outputNames:Array.from(s.values()),outputTypes:a}}static makeOutputFragmentShader(e,i,n,r){if(!n||vi(n))if(vi(r)){const s=this.mergeOutputFragmentShaderForColor([{source:r,outputType:$.COLOR}],[$.COLOR]);return{source:s.output,outputTypes:[$.COLOR],outputNames:s.outputNames}}else if(Array.isArray(r)){const s=r.find(c=>c.outputType===$.COLOR);let a=-1;s?a=r.indexOf(s):a=r.length-1;const o=this.mergeOutputFragmentShaderForColor(r.slice(0,a+1),[$.COLOR]);return{source:o.output,outputNames:o.outputNames,outputTypes:[$.COLOR]}}else return null;else if(Array.isArray(n)){if(!L.MRT)throw new Error("Multiple Render Targets were specified, but are not natively supported by user's hardware! MRT also does not have a fallback in deltav yet!");const s=n.map(a=>a.outputType);if(Array.isArray(r)){const a=new Map;for(let o=0,c=n.length;o<c;++o){const l=n[o];for(let u=0,h=r.length;u<h;++u)if(r[u].outputType===l.outputType){a.set(l.outputType,u);break}}if(L.MRT){let o=-1;const c=[];if(a.forEach((u,h)=>{c.push(h),o=Math.max(u,o)}),o===-1)return null;const l=this.mergeFragmentOutputsForMRT(e,i,r.slice(0,o+1),s,c);return{source:l.output,outputNames:l.outputNames,outputTypes:l.outputTypes}}else throw new Error("Fragment shader generation not supported for MRT systems on non MRT hardware...yet")}else if(n.find(o=>o.outputType===$.COLOR)&&r){const o=this.mergeFragmentOutputsForMRT(e,i,[{source:r,outputType:$.COLOR}],s);return{source:o.output,outputNames:o.outputNames,outputTypes:o.outputTypes}}}return null}process(e,i,n,r,s,a,o){try{if(!e.surface.gl)return console.warn("No WebGL context available for layer!"),null;const c=this.processImports(e,i,n);if(!c)return null;const{vertexAttributes:l,instanceAttributes:u,uniforms:h}=zd(e.surface.gl,e,i,s,o,c);e.getLayerBufferType(e.surface.gl,l,u),this.metricsProcessing.process(u,h);let f="",p="",g="";const m={uniforms:[]},T=r.vs||new Map,w=r.fs||new Map,y=r.destructure||new Map;for(let D=0,H=s.length;D<H;++D){const z=s[D],V=z.processHeaderInjection(A.VERTEX,T,e,this.metricsProcessing,l,u,h);f+=V.injection,V.material&&(m.uniforms=m.uniforms.concat(V.material.uniforms||[])),g+=z.processAttributeDestructuring(e,y,this.metricsProcessing,l,u,h)}let b="";T.forEach(D=>{b+=D}),f=b+f,b="",y.forEach(D=>{b+=D}),g=b+g;const x=this.processExtensions(),R=`precision highp float;

`,N=x+R+f+c.vs;let I={[Hd.attributes]:g},S=!1;const j=Ki({options:I,required:void 0,shader:N,onToken(D,H){return D===Hd.attributes&&(S=!0),H},onMain(D){return S?D||"":D===null?(console.warn("The body of void main() could not be determined."),""):`${g}
${D}`}});return c.fs.forEach((D,H)=>{I={},p="",b="";const z=w.get(H)||new Map;for(let W=0,oe=s.length;W<oe;++W){const Ce=s[W].processHeaderInjection(A.FRAGMENT,z,e,this.metricsProcessing,l,u,h);if(p+=Ce.injection,Ce.material){const ee=new Set;m.uniforms.forEach(Me=>ee.add(Me.name)),m.uniforms.forEach(Me=>{ee.has(Me.name)||m.uniforms.push(Me)})}}z.forEach(W=>{b+=W}),p=b+p;const V=x+R+p+D.source,ne=Ki({options:I,required:void 0,shader:V});D.source=ne.shader.trim();for(let W=0,oe=a.length;W<oe;++W){const Y=a[W];j.shader=Y.vertex(j.shader),D.source=Y.fragment(D.source)}}),{fs:c.fs,materialUniforms:m.uniforms,maxInstancesPerBuffer:this.metricsProcessing.maxInstancesPerUniformBuffer,modules:Array.from(c.shaderModuleUnits),vs:j.shader.trim(),vertexAttributes:l,instanceAttributes:u,uniforms:h}}catch(c){return c instanceof Error&&(console.warn("An unknown error occurred while processing the shaders for layer:",e.id),console.warn("Error:"),console.warn(c&&(c.stack||c.message))),null}}processExtensions(){let e="";return L.SHADERS_3_0&&(e+="#version 300 es"),L.MRT_EXTENSION&&(e+="#extension GL_EXT_draw_buffers : require"),e&&(e+=`

`),e}processImports(e,i,n){const r=new Set;let s=e.baseShaderModules(i);e.props.baseShaderModules&&(s=e.props.baseShaderModules(i,s));const a=Ee.process(e.id,i.vs,A.VERTEX,s.vs);if(a.errors.length>0)return console.warn("Error processing imports for the vertex shader of layer:",e.id,"Errors",...a.errors.reverse()),null;const o=new Map;return n.forEach((c,l)=>{const u=Ee.process(e.id,c.source,A.FRAGMENT,s.fs);if(u.errors.length>0){console.warn("Error processing imports for the fragment shader of layer:",e.id,"Errors",...u.errors.reverse());return}u.shaderModuleUnits.forEach(f=>r.add(f));const h={source:u.shader||"",outputTypes:c.outputTypes,outputNames:c.outputNames};o.set(l,h)}),a.shaderModuleUnits.forEach(c=>r.add(c)),{fs:o,vs:a.shader||"",shaderModuleUnits:r}}}class Xd{constructor(e){this.isMouseOver=new Set,this.isMouseDown=new Set,this.isTouchOver=new Map,this.isTouchDown=new Map,this.layer=e}getColorPickInstance(e){return this.colorPicking&&this.layer.picking.type===X.SINGLE&&this.colorPicking.view===e?this.layer.uidToInstance.get(16777215-this.colorPicking.nearestColor):null}handleMouseOver(e,i){}handleTouchOver(e,i,n){}handleMouseDown(e,i){if(this.layer.picking&&this.layer.picking.type!==X.NONE){const{onMouseDown:n}=this.layer.props;if(n){const r=e.projection.screenToWorld(i.screen.position),s=[];if(this.layer.picking.type===X.SINGLE){const o=this.getColorPickInstance(e);o&&s.push(o)}const a={interaction:i,instances:s,layer:this.layer.id,projection:e.projection,screen:i.screen.position,world:r};n(a),this.isMouseDown.clear(),s.forEach(o=>this.isMouseDown.add(o))}}}handleTouchDown(e,i,n){const{onTouchDown:r,onTouchOver:s}=this.layer.props;if(!this.layer.picking||this.layer.picking.type===X.NONE||!r&&!s)return;const a=e.projection.screenToWorld(n.screen.position),o=[];if(this.layer.picking.type===X.SINGLE){const h=this.getColorPickInstance(e);h&&o.push(h)}const c={interaction:i,touch:n,instances:o,layer:this.layer.id,projection:e.projection,screen:n.screen.position,world:a},l=qi(this.isTouchDown,n.touch.touch.identifier,()=>new Set),u=qi(this.isTouchOver,n.touch.touch.identifier,()=>new Set);o.forEach(h=>{l.add(h),u.add(h)}),s&&s(c),r&&r(c)}handleMouseOut(e,i){if(this.layer.picking&&this.layer.picking.type!==X.NONE){const{onMouseOut:n}=this.layer.props;if(n){const r=e.projection.screenToWorld(i.screen.position),s={interaction:i,instances:Array.from(this.isMouseOver.keys()),layer:this.layer.id,projection:e.projection,screen:i.screen.position,world:r};n(s)}}this.isMouseOver.clear()}handleTouchOut(e,i,n){const{onTouchOut:r}=this.layer.props;if(!this.layer.picking||this.layer.picking.type===X.NONE||!r)return;const s=e.projection.screenToWorld(n.screen.position),a={interaction:i,touch:n,instances:Array.from(this.isMouseOver.keys()),layer:this.layer.id,projection:e.projection,screen:n.screen.position,world:s};r(a),this.isTouchOver.delete(n.touch.touch.identifier)}handleMouseUp(e,i){const{onMouseUp:n,onMouseUpOutside:r}=this.layer.props;if(!this.layer.picking||this.layer.picking.type===X.NONE||!n)return;const s=e.projection.screenToWorld(i.screen.position),a=[];if(this.layer.picking.type===X.SINGLE){const c=this.getColorPickInstance(e);c&&a.push(c)}let o={interaction:i,instances:a,layer:this.layer.id,projection:e.projection,screen:i.screen.position,world:s};n(o),a.forEach(c=>this.isMouseDown.delete(c)),!(this.isMouseDown.size<=0||!r)&&(o={interaction:i,instances:Array.from(this.isMouseDown.values()),layer:this.layer.id,projection:e.projection,screen:i.screen.position,world:s},r(o))}handleTouchUp(e,i,n){const{onTouchUp:r,onTouchUpOutside:s,onTouchOut:a,onTouchAllEnd:o}=this.layer.props;if(!this.layer.picking||this.layer.picking.type===X.NONE||!r&&!s&&!a&&!o)return;const c=e.projection.screenToWorld(n.screen.position),l=[];if(this.layer.picking.type===X.SINGLE){const f=this.getColorPickInstance(e);f&&l.push(f)}let u={interaction:i,touch:n,instances:l,layer:this.layer.id,projection:e.projection,screen:n.screen.position,world:c};a&&a(u),r&&r(u);const h=Ks(this.isTouchDown,n.touch.touch.identifier,new Set);l.forEach(f=>h.delete(f)),h.size>0&&s&&(u={interaction:i,touch:n,instances:Array.from(h.values()),layer:this.layer.id,projection:e.projection,screen:n.screen.position,world:c},s(u)),this.isTouchDown.delete(n.touch.touch.identifier),this.isTouchDown.size<=0&&o&&(u={interaction:i,touch:n,instances:[],layer:this.layer.id,projection:e.projection,screen:n.screen.position,world:c},o(u))}handleMouseMove(e,i){const{onMouseOver:n,onMouseMove:r,onMouseOut:s}=this.layer.props;if(this.layer.picking&&this.layer.picking.type!==X.NONE&&(n||r||s)){let a;const o=e.projection.screenToWorld(i.screen.position),c=[];if(this.layer.picking.type===X.SINGLE){const u=this.getColorPickInstance(e);u&&c.push(u)}const l=new Set;if(c.forEach(u=>l.add(u)),s){const u=[];this.isMouseOver.forEach(h=>{l.has(h)||u.push(h)}),a={interaction:i,instances:u,layer:this.layer.id,projection:e.projection,screen:i.screen.position,world:o},u.length>0&&s(a)}if(n){const u=c.filter(h=>!this.isMouseOver.has(h));a={interaction:i,instances:u,layer:this.layer.id,projection:e.projection,screen:i.screen.position,world:o},u.length>0&&n(a)}r&&(a={interaction:i,instances:c,layer:this.layer.id,projection:e.projection,screen:i.screen.position,world:o},r(a)),this.isMouseOver=l}}handleTouchMove(e,i,n){const{onTouchOver:r,onTouchMove:s,onTouchOut:a}=this.layer.props;if(this.layer.picking&&this.layer.picking.type!==X.NONE&&(r||s||a)){let o;const c=e.projection.screenToWorld(n.screen.position),l=[];if(this.layer.picking.type===X.SINGLE){const f=this.getColorPickInstance(e);f&&l.push(f)}const u=Ks(this.isTouchOver,n.touch.touch.identifier,new Set),h=new Set;if(l.forEach(f=>h.add(f)),a){const f=[];u.forEach(p=>{h.has(p)||f.push(p)}),o={interaction:i,touch:n,instances:f,layer:this.layer.id,projection:e.projection,screen:n.screen.position,world:c},f.length>0&&a(o)}if(r){const f=l.filter(p=>!u.has(p));o={interaction:i,touch:n,instances:f,layer:this.layer.id,projection:e.projection,screen:n.screen.position,world:c},f.length>0&&r(o)}s&&(o={interaction:i,touch:n,instances:l,layer:this.layer.id,projection:e.projection,screen:n.screen.position,world:c},s(o)),this.isMouseOver=h}}handleMouseClick(e,i){if(this.layer.picking&&this.layer.picking.type!==X.NONE){const{onMouseClick:n}=this.layer.props;if(n){const r=e.projection.screenToWorld(i.screen.position),s=[];if(this.layer.picking.type===X.SINGLE){const o=this.getColorPickInstance(e);o&&s.push(o)}const a={interaction:i,instances:s,layer:this.layer.id,projection:e.projection,screen:i.screen.position,world:r};n(a)}}}handleTap(e,i,n){if(this.layer.picking&&this.layer.picking.type!==X.NONE){const{onTap:r}=this.layer.props;if(r){const s=e.projection.screenToWorld(n.screen.position),a=[];if(this.layer.picking.type===X.SINGLE){const c=this.getColorPickInstance(e);c&&a.push(c)}const o={interaction:i,touch:n,instances:a,layer:this.layer.id,projection:e.projection,screen:n.screen.position,world:s};r(o)}}}handleMouseDrag(e,i){}}const Nc=xe("performance"),Yd=class extends yn{constructor(t,e,i){super(i),this.animationEndTime=0,this.alwaysDraw=!1,this.depth=0,this._easingManager={easingComplete:new ke,complete:()=>this._easingManager.easingComplete.promise},this.lastFrameTime=0,this.needsViewDrawn=!1,this.picking={currentPickMode:X.NONE,type:X.SINGLE,uidToInstance:new Map},this.resource=wd,this.shaderIOInfo={},this.streamChanges={locked:!1,streamIndex:0},this._uid=G(),this.uidToInstance=new Map,this.willRebuildLayer=!1,this.surface=t,this.scene=e,this.props=Object.assign({},Yd.defaultProps||{},i)}get bufferManager(){return this._bufferManager}get bufferType(){return this._bufferType||Ae.INSTANCE_ATTRIBUTE}get easingManager(){return this._easingManager}get uid(){return this._uid}static createRef(){return{easing:null}}validateShaderIO(t){if(!t)return this.picking&&(this.picking.type=X.NONE),Nc("Shell layer initialized. Nothing will be rendered for this layer",this.id),!0;if(!t.fs||!t.vs)return console.warn("Layer needs to specify the fragment and vertex shaders:",this.id),!1}cleanShaderIOElements(t){t.instanceAttributes=(t.instanceAttributes||[]).filter(me),t.vertexAttributes=(t.vertexAttributes||[]).filter(me),t.uniforms=(t.uniforms||[]).filter(me)}checkForDuplicateOutputTypes(t){let{mapOutput:e}=this.props;vi(t.fs)&&(t.fs=[{outputType:$.COLOR,source:t.fs}]),e=e||{};const i=new Set;let n=!1,r=Number.MIN_SAFE_INTEGER;for(let s=0,a=t.fs.length;s<a;++s){const o=t.fs[s],c=e[o.outputType];if(c===void 0){i.has(o.outputType)&&(n=!0),i.add(o.outputType);continue}c===$.NONE?o.outputType=r++:o.outputType=c,i.has(o.outputType)&&(n=!0),i.add(o.outputType)}if(n)return console.warn("Layer has duplicate fragment shader output types"),!1}processFragmentShadersForEachView(t,e){vi(t.fs)&&(t.fs=[{outputType:$.COLOR,source:t.fs}]);const i=this.picking.type===X.SINGLE&&!t.fs.find(a=>a.outputType===$.PICKING);if(this.picking.type===X.SINGLE&&!i)throw new Error("Do NOT specify picking prop on a layer when you have your own Picking output declared.");const n={outputType:$.PICKING,source:Wg},r=new Map,s={fs:new Map,vs:new Map,destructure:new Map};for(let a=0,o=e.length;a<o;++a){const c=e[a];if(i){const p=t.fs.findIndex(g=>g.outputType===$.PICKING);p>-1&&t.fs.splice(p,1)}const l=c.getOutputTargets();let u=0;t.fs.forEach((p,g)=>{l!=null&&l.find(m=>m.outputType===p.outputType)&&(u=g)}),i&&t.fs.splice(u+1,0,n);let h=qi(s.fs,c,new Map);h||(h=new Map,s.fs.set(c,h));const f=Qd.makeOutputFragmentShader(s.vs,h,l,t.fs);if(!f)return console.warn("Could not generate output fragment shaders for the view specified."),!1;r.set(c,f)}return{outputFragmentShaders:r,declarations:s}}processLayerShaders(t,e,i){let n=null;if(n=new Qd().process(this,t,e,i,this.surface.getIOExpanders(),this.surface.getShaderTransforms(),this.surface.getIOSorting()),!n)return console.warn("The shader processor did not produce metrics for the layer."),!1;this.shaderIOInfo=Object.assign({activeAttribute:{name:"active",size:C.ONE,update:r=>[r.active?1:0]},instanceAttributes:n.instanceAttributes,instanceVertexCount:t.vertexCount,vs:n.vs,fs:n.fs,materialUniforms:n.materialUniforms,maxInstancesPerBuffer:n.maxInstancesPerBuffer,drawMode:t.drawMode||d.GLSettings.Model.DrawMode.TRIANGLE_STRIP,uniforms:n.uniforms,vertexAttributes:n.vertexAttributes},this.shaderIOInfo)}processVertexAttributes(t){bd(this,this.shaderIOInfo.maxInstancesPerBuffer,this.shaderIOInfo.vertexAttributes,t.vertexCount)}init(t){if(!this.surface.gl)return console.warn("The layer's surface does not have a valid WebGL context."),!1;const{picking:e=X.NONE}=this.props;e===X.SINGLE?this.picking={currentPickMode:X.NONE,type:X.SINGLE,uidToInstance:new Map}:this.picking={currentPickMode:X.NONE,type:X.NONE},this.resource=this.surface.resourceManager;const i=this.initShader();this.interactions=new Xd(this);const n=this.validateShaderIO(i);if(n!==void 0)return n;if(!i)return!1;let r;return this.surface.getShaderTransforms().forEach(a=>{i.vs=a.rawVertex(i.vs),i.fs=a.rawFragment(i.fs)}),r=this.cleanShaderIOElements(i),Vi(r)||(r=this.checkForDuplicateOutputTypes(i),Vi(r))||(r=this.processFragmentShadersForEachView(i,t),Vi(r))||(r=this.processLayerShaders(i,r.outputFragmentShaders,r.declarations),Vi(r))||(r=this.processVertexAttributes(i),Vi(r))||(r=this.makeLayerBufferManager(this.surface.gl,this.scene),Vi(r))||(r=this.updateDiffHandlers(),Vi(r))?r:(this.layerShaderDebugging(),this.props.ref&&(this.props.ref.easing=this.easingManager),!0)}layerShaderDebugging(){this.props.printShader&&(console.warn(`Layer: ${this.props.key}`,`
Shader Configuration:`,this.shaderIOInfo),console.warn(`VERTEX SHADER
`),console.warn(`
${this.shaderIOInfo.vs}`),this.shaderIOInfo.fs.forEach((t,e)=>{console.warn(`FRAGMENT SHADER:
`,`view: ${e.id}):
Output Targets${JSON.stringify(t.outputNames)}
${JSON.stringify(t.outputTypes)}
`),console.warn(`
${t.source}`)}))}baseShaderModules(t){const e=[],i=[];return e.push("instancing"),this.picking.type===X.SINGLE&&e.push("picking"),(t.instanceAttributes||[]).find(r=>!!(r&&r.easing))&&e.push("frame"),{fs:i,vs:e}}childLayers(){return[]}destroy(){this.bufferManager&&(this.bufferManager.scene&&this.bufferManager.scene.removeLayer(this),this.bufferManager.removeFromScene(),this.bufferManager.destroy())}didUpdateProps(){}draw(){this.updateStreamLock();const t=this.getChangeList();t.length>0&&(this.needsViewDrawn=!0);let e,i,n;const r=this.diffManager;if(!r||!this.bufferManager)return;const s=r.processing,a=r.processor;if(!a){console.warn("A layer is atttempting to draw without a diff processor for analyzing changes.");return}a.incomingChangeList(t),this.bufferManager.incomingChangeList(t);for(let o=0,c=t.length;o<c;++o)e=t[o],i=e[0],n=this.bufferManager.getBufferLocations(i),s==null||s[e[1]](a,i,Object.values(e[2]),n),i.changes={};a.commit(),this.bufferManager.changesProcessed(),this.updateEasingManager(),this.updateUniforms()}updateEasingManager(){if(this.props.streamChanges){if(!this.streamChanges.stream||this.streamChanges.stream.length<=0){const t=this._easingManager.easingComplete;this._easingManager.easingComplete=new ke,Ti(()=>{t.resolve()},this.animationEndTime-this.surface.frameMetrics.currentTime)}}else{const t=this._easingManager.easingComplete;this._easingManager.easingComplete=new ke,Ti(()=>{t.resolve()},this.animationEndTime-this.surface.frameMetrics.currentTime)}}getNextStreamChanges(){let t;const{streamChanges:e={count:1e4,strategy:As.LINEAR}}=this.props,{stream:i=[],streamIndex:n}=this.streamChanges;switch(e.count===void 0&&(e.count=1e4),e.count<=0&&(e.count=Number.MAX_SAFE_INTEGER),e.strategy){case As.LINEAR:default:{t=i.slice(n,n+e.count),this.streamChanges.streamIndex+=e.count;break}}return this.streamChanges.stream&&this.streamChanges.streamIndex>=this.streamChanges.stream.length&&delete this.streamChanges.stream,t}updateStreamLock(){this.streamChanges.locked=!!(this.streamChanges.stream&&this.streamChanges.streamIndex<this.streamChanges.stream.length)}getChangeList(){let t;return this.streamChanges.locked?t=this.getNextStreamChanges():this.props.streamChanges?(this.streamChanges.streamIndex=0,this.streamChanges.locked=!0,this.streamChanges.stream=this.props.data.changeList,t=[],this.props.data.resolve(this.id)):(t=this.props.data.changeList,this.props.data.resolve(this.id)),this.updateStreamLock(),t}getInstanceObservableIds(t,e){const i={};for(let n=0,r=e.length;n<r;++n){je.setObservableMonitor(!0),t[e[n]];const s=je.getObservableMonitorIds(!0);s[0]!==void 0&&(i[e[n]]=s[0])}return je.setObservableMonitor(!1),i}getMaterialOptions(){return{}}initShader(){return{fs:"${import: no-op}",instanceAttributes:[],uniforms:[],vertexAttributes:[],vertexCount:0,vs:"${import: no-op}"}}managesInstance(t){return me(this.bufferManager)&&this.bufferManager.managesInstance(t)}getLayerBufferType(t,e,i){let n=Ae.UNIFORM,r=0;if(this._bufferType!==void 0)return this._bufferType;if(L.HARDWARE_INSTANCING){for(let s=0,a=e.length;s<a;++s){const o=e[s];r+=Math.ceil(o.size/4)}for(let s=0,a=i.length;s<a;++s){const o=i[s];r+=Math.ceil($l[o.size||1]/4)}if(r>L.MAX_VERTEX_ATTRIBUTES){r=0;for(let s=0,a=i.length;s<a;++s){const o=i[s];r=Math.max(r,o.block||0)}for(let s=0,a=e.length;s<a;++s){const o=e[s];r+=Math.ceil(o.size/4)}r<L.MAX_VERTEX_ATTRIBUTES&&(n=Ae.INSTANCE_ATTRIBUTE_PACKING,Nc(`Performance Issue (Moderate):
            Layer %o is utilizing too many vertex attributes and is now using vertex packing.
            Max Vertex units %o
            Used Vertex units %o
            Instance Attributes %o
            Vertex Attributes %o`,this.id,L.MAX_VERTEX_ATTRIBUTES,r,i,e))}else n=Ae.INSTANCE_ATTRIBUTE}return n===Ae.UNIFORM&&(Nc(`Performance Issue (High):
        Layer %o is utilizing too many vertex attributes and is now using a uniform buffer.
        Max Vertex units %o
        Used Vertex units %o
        Instance Attributes %o
        Vertex Attributes %o`,this.id,L.MAX_VERTEX_ATTRIBUTES,r,i,e),n=Ae.UNIFORM),this.setBufferType(n),n}makeLayerBufferManager(t,e){switch(this.getLayerBufferType(t,this.shaderIOInfo.vertexAttributes,this.shaderIOInfo.instanceAttributes)){case Ae.INSTANCE_ATTRIBUTE:{this.setBufferManager(new Ld(this,e));break}case Ae.INSTANCE_ATTRIBUTE_PACKING:{this.setBufferManager(new Cd(this,e));break}default:{this.setBufferManager(new Nd(this,e));break}}}updateDiffHandlers(){(this.shaderIOInfo.instanceAttributes||[]).find(e=>!!(e&&e.easing))?this.picking.type===X.SINGLE?(this.onDiffAdd=this.handleDiffAddWithPickingAndEasing,this.onDiffRemove=this.handleDiffRemoveWithPickingAndEasing):(this.onDiffAdd=this.handleDiffAddWithEasing,this.onDiffRemove=this.handleDiffRemoveWithEasing):this.picking.type===X.SINGLE&&(this.onDiffAdd=this.handleDiffAddWithPicking,this.onDiffRemove=this.handleDiffRemoveWithPicking)}handleDiffAddWithEasing(t){t.easingId=this.easingId}handleDiffAddWithPicking(t){this.uidToInstance.set(t.uid,t)}handleDiffAddWithPickingAndEasing(t){this.uidToInstance.set(t.uid,t),t.easingId=this.easingId}handleDiffRemoveWithEasing(t){t.easing&&delete t.easing,delete t.easingId}handleDiffRemoveWithPicking(t){this.uidToInstance.delete(t.uid)}handleDiffRemoveWithPickingAndEasing(t){this.uidToInstance.delete(t.uid),t.easing&&delete t.easing,delete t.easingId}rebuildLayer(){if(this.willRebuildLayer=!0,this.children)for(let t=0,e=this.children.length;t<e;++t)this.children[t].rebuildLayer()}resolveChanges(t){const e=this.props.data.changeList;e.length>0&&(this.needsViewDrawn=!0),t||this.props.data.resolve(this.id);for(let i=0,n=e.length;i<n;++i)e[i][0].changes={};return e}setBufferManager(t){this._bufferManager?console.warn("You can not change a layer's buffer strategy once it has been instantiated."):(this._bufferManager=t,this.diffManager=new Ym,this.diffManager.makeProcessor(this,t))}setBufferType(t){this._bufferType===void 0?this._bufferType=t:console.warn("You can not change a layers buffer strategy once it has been instantiated.")}shouldDrawView(t,e){for(const i in e)if(e[i]!==t[i])return!0;return!1}updateUniforms(){let t,e;for(let i=0,n=this.shaderIOInfo.uniforms.length;i<n;++i)t=this.shaderIOInfo.uniforms[i],e=t.update(t),t.materialUniforms.forEach(r=>r.value=e)}willUpdateProps(t){t.picking!==this.props.picking&&this.rebuildLayer(),t.ref!==this.props.ref&&this.props.ref&&(this.props.ref.easing=this.easingManager)}};let ei=Yd;ei.defaultProps={};const qd=xe("performance");class la extends yn{constructor(e,i){super(i),this.container=new Ms,this.surface=e,this.init(i)}get layers(){return this.layerDiffs.items}get views(){return this.viewDiffs.items}init(e){if(!this.surface||!this.surface.gl)return;this.container=new Ms;const i=Td(this.surface.gl);this.layerDiffs=new Vr({buildItem:async n=>{if(qd("Building layer",n.key),!this.surface)return null;const r=n.init[0],s=n.init[1],a=new r(this.surface,this,Object.assign({},r.defaultProps,s));if(a.initializer=n,a.props.data.sync(),a.parent=s.parent,s.parent&&(s.parent.children?s.parent.children.push(a):s.parent.children=[a]),!a.init(this.views))return console.warn("Error initializing layer:",s.key,"A layer was unable to be added to the surface. See previous warnings (if any) to determine why they could not be instantiated"),null;const o=a.childLayers();return this.layerDiffs.inline(o),a},destroyItem:async(n,r)=>(qd("Destroying layer",n.key),r.destroy(),!0),updateItem:async(n,r)=>{const s=n.init[1];if(r.willUpdateProps(s),s.data!==r.props.data&&s.data.sync(),r.shouldDrawView(r.props,s)&&(r.needsViewDrawn=!0),Object.assign(r.props,s),r.initializer.init[1]=r.props,r.didUpdateProps(),s.parent&&r.parent&&r.parent!==s.parent){const a=r.parent.children||[],o=a.indexOf(r)||-1;o>-1&&a.splice(o,1)}r.parent=s.parent,r.willRebuildLayer?(this.layerDiffs.rebuild(),r.willRebuildLayer=!1):this.layerDiffs.inline(r.childLayers())}}),this.viewDiffs=new Vr({buildItem:async n=>{if(!this.surface)return null;const r=new n.init[0](this,n.init[1]);return r.props.camera=r.props.camera||i.camera,r.pixelRatio=this.surface.pixelRatio,r.resource=this.surface.resourceManager,this.surface.userInputManager.waitingForRender=!0,r},destroyItem:async(n,r)=>!0,updateItem:async(n,r)=>{const s=n.init[1];r.willUpdateProps(s),r.shouldDrawView(r.props,s)&&(r.needsDraw=!0),Object.assign(r.props,s),r.didUpdateProps(),this.surface&&(this.surface.userInputManager.waitingForRender=!0)}}),this.update(e)}destroy(){delete this.container,this.layerDiffs.destroy(),this.viewDiffs.destroy()}removeLayer(e){if(this.layers){const i=this.layers.indexOf(e);if(i>=0){this.layers.splice(i,1);return}}}async update(e){this.order=e.order,await this.viewDiffs.diff(e.views),await this.layerDiffs.diff(e.layers),this.views.forEach(i=>i.createRenderTarget())}}la.DEFAULT_SCENE_ID="__default__";var Jn=(t=>(t[t.COLOR=1]="COLOR",t[t.DEPTH=2]="DEPTH",t[t.STENCIL=4]="STENCIL",t))(Jn||{});function Pc(t,e){const i=Object.assign(e,{key:e.key||"",viewport:e.viewport||{left:0,right:0,top:0,bottom:0}});return{get key(){return e.key||""},init:[t,i]}}const Kd=class extends yn{constructor(t,e){super(e),this.animationEndTime=0,this.depth=0,this.lastFrameTime=0,this.needsDraw=!1,this.optimizeRendering=!1,this._pixelRatio=1,this.scene=t,this.props=Object.assign({},Kd.defaultProps||{},e)}get pixelRatio(){return this.props.pixelRatio??this._pixelRatio}set pixelRatio(t){this._pixelRatio=t}get screenBounds(){return this.projection.screenBounds}set screenBounds(t){this.projection.screenBounds=t}get viewBounds(){return this.projection.viewBounds}set viewBounds(t){this.projection.viewBounds=t}get clearFlags(){return this.props.clearFlags||[]}get order(){return this.props.order||0}getOutputTargets(){const{output:t}=this.props;let e=[];return t?(bn(t.buffers)||Ys(t.buffers)?e=[{outputType:$.COLOR,resource:t.buffers}]:Object.keys(t.buffers).forEach(i=>{const n=Number.parseFloat(i),r=t.buffers[n];r&&e.push({outputType:n,resource:r})}),e):null}getRenderTargets(){return this.renderTarget?[this.renderTarget]:[]}createRenderTarget(){this.renderTarget&&(Array.isArray(this.renderTarget)?this.renderTarget.forEach(u=>u.dispose()):this.renderTarget.dispose());const{output:t}=this.props,e=this.scene.surface;if(!t||!e)return;const i=new Set;for(let u=0,h=this.scene.layers.length;u<h;++u){const p=this.scene.layers[u].shaderIOInfo.fs.get(this);p&&p.outputTypes.forEach(g=>i.add(g))}const n=new Map,r=new ei(e,this.scene,{key:"",data:new he}),s=new ze({}),a=this.getOutputTargets()||[];for(let u=0,h=a.length;u<h;++u){const f=a[u],p=f.resource;if(i.has(f.outputType))if(bn(p)){const g=jr({key:f.resource.key});if(this.resource.request(r,s,g),!g.texture)throw console.warn("A view has a RenderTexture output target with key:",f.resource.key,"however, no RenderTexture was found for the key.","Please ensure you have a 'resource' specified for the Surface with the proper key","Also ensure the resource is made via createTexture()"),new Error(`Output target unable to be constructed for view ${this.id}`);n.set(f.outputType,g.texture)}else{const g=Tc({key:f.resource.key});if(this.resource.request(r,s,g),!g.colorBuffer)throw console.warn("A view has a ColorBuffer output target with key:",f.resource.key,"however, no ColorBuffer was found for the key.","Please ensure you have a 'resource' specified for the Surface with the proper key","Also ensure the resource is made via createColorBuffer()"),new Error(`Output target unable to be constructed for view ${this.id}`);n.set(f.outputType,g.colorBuffer)}}let o,c;n.forEach(u=>{var h,f,p;if(u instanceof se){if((o===void 0||c===void 0)&&(o=((h=u.data)==null?void 0:h.width)||0,c=((f=u.data)==null?void 0:f.height)||0),o===0||c===0)throw new Error("RenderTexture for View can NOT have a width or height of zero.");if(((p=u.data)==null?void 0:p.width)!==o||u.data.height!==c)throw new Error("When a view has multiple output targets: ALL RenderTextures and ColorBuffers that a view references MUST have the same dimensions")}else{if((o===void 0||c===void 0)&&(o=u.size[0]||0,c=u.size[1]||0),o===0||c===0)throw new Error("RenderTexture for View can NOT have a width or height of zero.");if(u.size[0]!==o||u.size[1]!==c)throw new Error("When a view has multiple output targets: ALL RenderTextures and ColorBuffers that a view references MUST have the same dimensions")}});let l;if(t.depth)if(bn(t.depth)){const u=jr({key:t.depth.key});if(this.resource.request(r,s,u),!u.texture)throw console.warn("A view has a depth buffer output target with key:",t.depth,"however, no RenderTexture was found for the key.","Please ensure you have a 'resource' specified for the Surface with the proper key","Also ensure the resource is made via createTexture()"),new Error(`Output target unable to be constructed for view ${this.id}`);l=u.texture}else if(Ys(t.depth)){const u=Tc({key:t.depth.key});if(this.resource.request(r,s,u),!u.colorBuffer)throw console.warn("A view has a depth buffer output target with key:",t.depth.key,"however, no ColorBuffer was found for the key.","Please ensure you have a 'resource' specified for the Surface with the proper key","Also ensure the resource is made via createColorBuffer()"),new Error(`Output target unable to be constructed for view ${this.id}`);l=u.colorBuffer}else l=d.GLSettings.RenderTarget.DepthBufferFormat.DEPTH_COMPONENT16;if(L.MRT){const u=[];n.forEach((h,f)=>u.push({buffer:h,outputType:f})),this.renderTarget=new Wi({buffers:{color:u,depth:l},retainTextureTargets:!0})}else throw new Error("MRT for non-MRT systems not supported yet.")}willUseView(){const t=this.getRenderTargets();this.props.screenScale&&(this.projection.screenScale=this.props.screenScale),t.some(i=>i.getBuffers().some(n=>!!n.buffer.destroyed))&&this.createRenderTarget()}shouldDrawView(t,e){for(const i in e)if(e[i]!==t[i])return!0;return!1}willUpdateProps(t){}didUpdateProps(){}};let Xr=Kd;Xr.defaultProps={key:"",camera:bi.makeOrthographic(),viewport:{left:0,right:0,top:0,bottom:0}};class Zd extends Xr{constructor(){super(new la(void 0,{key:"error",layers:[],views:[]}),{key:"error",viewport:{},camera:bi.makeOrthographic()}),this.projection=new hu,this.screenBounds=new te({x:0,y:0,width:100,height:100})}screenToWorld(e,i){return[0,0]}worldToScreen(e,i){return[0,0]}viewToWorld(e,i){return[0,0]}worldToView(e,i){return[0,0]}fitViewtoViewport(e,i){this.screenBounds=e}}const n0=1e3,r0=200,Ri=new Zd;Ri.fitViewtoViewport(new te({x:0,y:0,width:100,height:100}),new te({x:0,y:0,width:100,height:100}));function s0(t,e){return e.d&&t.d?e.d.depth-t.d.depth:0}function Dc(t,e){return t.touch.identifier-e.touch.identifier}class Jd{constructor(e,i,n,r){this.eventManagers=[],this.eventCleanup=[],this._waitingForRender=!0,this.getViewsUnderPosition=s=>{if(!this.quadTree)return[];const a=this.quadTree.query(s);return a.sort(s0),a},this.resize=()=>{this._waitingForRender=!0},this.context=e,this.surface=i,this.setControllers(n),this.addContextListeners(r)}get waitingForRender(){return this._waitingForRender}set waitingForRender(e){if(this._waitingForRender=e,!e){this.quadTree=new Kh(0,0,0,0);const i=this.scenes,n=[];for(let r=0,s=i.length;r<s;++r){const a=i[r];for(let o=0,c=a.views.length;o<c;++o){const l=a.views[o];n.push(l.screenBounds)}}this.quadTree.addAll(n)}}get scenes(){return!this.surface||!this.surface.sceneDiffs?[]:this.surface.sceneDiffs.items}addContextListeners(e){this.addMouseContextListeners(e),this.addTouchContextListeners()}addMouseContextListeners(e){const i=this.context;if(gn(i))return;let n,r=!1;if(e){const s=a=>{const o=Mt(a,i),c=this.getViewsUnderPosition(o);if(c.length<=0)return;n={canClick:!1,currentPosition:o,deltaPosition:[0,0],previousPosition:o,start:o,startTime:Date.now(),startView:c[0].d,event:a,wheel:this.makeWheel(a),button:-1};const l=this.makeMouseInteraction(n);this.eventManagers.forEach(u=>{u.handleWheel(l)}),a.stopPropagation(),a.preventDefault()};"onwheel"in i&&(i.onwheel=s),"addEventListener"in i&&(i.addEventListener("DOMMouseScroll",s),this.eventCleanup.push(["DOMMouseScroll",s]))}i.onmouseleave=s=>{if(this.waitingForRender||!n)return;const a=Mt(s,i);n.deltaPosition=ye(a,n.currentPosition),n.previousPosition=n.currentPosition,n.currentPosition=a;const o=this.makeMouseInteraction(n);this.eventManagers.forEach(c=>{c.handleMouseOut(o)})},i.onmousemove=s=>{if(this.waitingForRender)return;const a=Mt(s,i);if(!n){const c=this.getViewsUnderPosition(a);n={canClick:!1,currentPosition:a,deltaPosition:[0,0],previousPosition:a,start:a,startTime:Date.now(),startView:c[0].d,event:s,wheel:this.makeWheel(),button:-1}}n.deltaPosition=ye(a,n.currentPosition),n.previousPosition=n.currentPosition,n.currentPosition=a,n.canClick=!1;const o=this.makeMouseInteraction(n);this.eventManagers.forEach(c=>{c.handleMouseMove(o)}),r=!0},i.onmousedown=s=>{if(this.waitingForRender)return;const a=Mt(s,i),o=this.getViewsUnderPosition(a);if(o.length<=0)return;n={canClick:!0,currentPosition:a,deltaPosition:[0,0],previousPosition:a,start:a,startTime:Date.now(),startView:o[0].d,event:s,wheel:this.makeWheel(),button:s.button};const c=this.makeMouseInteraction(n);this.eventManagers.forEach(u=>{u.handleMouseDown(c)}),s.stopPropagation(),document.onmousemove=u=>{if(!n)return;if(!r){const f=Mt(u,i);n.deltaPosition=ye(f,n.currentPosition),n.previousPosition=n.currentPosition,n.currentPosition=f,n.canClick=!1}const h=this.makeMouseInteraction(n);this.eventManagers.forEach(f=>{f.handleDrag(h)}),u.preventDefault(),u.stopPropagation(),r=!1},document.onmouseup=u=>{document.onmousemove=null,document.onmouseup=null,document.onmouseover=null,n=void 0},document.onmouseover=u=>{if(!n)return;const h=Mt(u,i);n.deltaPosition=ye(h,n.currentPosition),n.previousPosition=n.currentPosition,n.currentPosition=h;const f=this.makeMouseInteraction(n);this.eventManagers.forEach(p=>{p.handleMouseOver(f)}),u.stopPropagation()},i.onmouseup=u=>{if(!n)return;const h=Mt(u,i);n.deltaPosition=ye(h,n.currentPosition),n.previousPosition=n.currentPosition,n.currentPosition=h,n.button=u.button;const f=this.makeMouseInteraction(n);this.eventManagers.forEach(p=>{p.handleMouseUp(f)}),n.canClick&&Date.now()-n.startTime<n0&&this.eventManagers.forEach(p=>{p.handleClick(f)}),n=void 0};const l=i;l.onselectstart!==void 0?l.onselectstart=function(){return!1}:i.addEventListener("selectstart",function(){s.preventDefault()})}}addTouchContextListeners(){const e=this.context;if(gn(e))return;const i=new Map,n=new Map;function r(u){return u.map(h=>h.touch)}function s(u){return u.reduce((h,f)=>f.touch.startTime>h.touch.startTime?f:h,u[0])}const a={center:u=>u.length<=0?[0,0]:this.getTouchCenter(r(u)),centerDelta:u=>{if(u.length<=0)return[0,0];const h=r(u),f=this.getTouchCenter(h,g=>g.previousPosition),p=this.getTouchCenter(h);return ye(p,f)},centerStart:u=>{if(u.length<=0)return[0,0];const h=s(u).touch;return this.getTouchCenter(r(u),f=>f===h?f.start:f.startRelative.get(h)||[0,0])},id:u=>r(u).sort(Dc).map(f=>f.touch.identifier).join("_"),rotation:u=>{if(u.length<=0)return 0;const h=r(u),f=this.getTouchCenter(h);return this.getAverageAngle(h,f)},rotationDelta:u=>{if(u.length<=0)return 0;const h=r(u),f=this.getTouchCenter(h,T=>T.previousPosition),p=this.getAverageAngle(h,f,T=>T.previousPosition),g=this.getTouchCenter(h);return this.getAverageAngle(h,g)-p},rotationStart:u=>{if(u.length<=0)return 0;const h=s(u).touch,f=r(u),p=this.getTouchCenter(f,g=>g===h?g.start:g.startRelative.get(h)||[0,0]);return this.getAverageAngle(f,p,g=>g===h?g.start:g.startRelative.get(h)||[0,0])},spread:u=>{if(u.length<=0)return 0;const h=r(u),f=this.getTouchCenter(h);return this.getAverageDistance(h,f)},spreadDelta:u=>{if(u.length<=0)return 0;const h=r(u),f=this.getTouchCenter(h,T=>T.previousPosition),p=this.getAverageDistance(h,f,T=>T.previousPosition),g=this.getTouchCenter(h);return this.getAverageDistance(h,g)-p},spreadStart:u=>{if(u.length<=0)return 0;const h=s(u).touch,f=r(u),p=this.getTouchCenter(f,g=>g===h?g.start:g.startRelative.get(h)||[0,0]);return this.getAverageDistance(f,p,g=>g===h?g.start:g.startRelative.get(h)||[0,0])}};e.ontouchstart=u=>{u.preventDefault(),u.stopPropagation();const h=this.getTouches(u),f=[],p=[];for(let g=0,m=h.length;g<m;++g){const T=h[g],w=i.get(T.identifier);if(w)f.push(w);else{const y=Mt(T),b=this.getViewsUnderPosition(y);if(b.length<=0)continue;const x=b[0].d,R={canTap:!0,currentPosition:y,deltaPosition:[0,0],startTime:Date.now(),start:y,startView:x,previousPosition:y,startRelative:new Map,touch:T};i.set(T.identifier,R),p.push(R)}}if(p.length>0){const g=p.concat(f),m=[];for(let w=0,y=p.length;w<y;++w){const b=p[w];for(let R=0,N=g.length;R<N;++R){const I=g[R];b!==I&&I.startRelative.set(b,I.currentPosition)}const x=this.makeSingleTouchInteraction(b);m.push(x),n.set(b.touch.identifier,x)}const T={touches:m,allTouches:g.map(w=>n.get(w.touch.identifier)).filter(me),multitouch:a};this.eventManagers.forEach(w=>{w.handleTouchDown(T)})}document.ontouchend=g=>{o.call(document,g),document.ontouchend=null,document.ontouchcancel=null,document.ontouchmove=null},document.ontouchcancel=g=>{l.call(document,g),document.ontouchend=null,document.ontouchcancel=null,document.ontouchmove=null},document.ontouchmove=c};const o=e.ontouchend=u=>{u.stopPropagation(),u.preventDefault();const h=this.getTouches(u,"changed"),f=Array.from(n.values()),p=[];for(let g=0,m=h.length;g<m;++g){const T=h[g],w=i.get(T.identifier);if(w){if(w.canTap&&Date.now()-w.startTime<r0){const b={touches:[this.makeSingleTouchInteraction(w)],allTouches:f,multitouch:a};this.eventManagers.forEach(x=>{x.handleTap(b)})}p.push(w),i.delete(T.identifier),n.delete(T.identifier)}}if(p.length>0){const m={touches:p.map(T=>this.makeSingleTouchInteraction(T)),allTouches:f,multitouch:a};this.eventManagers.forEach(T=>{T.handleTouchUp(m)})}},c=e.ontouchmove=u=>{u.stopPropagation(),u.preventDefault();const h=this.getTouches(u),f=[],p=[];for(let g=0,m=h.length;g<m;++g){const T=h[g],w=i.get(T.identifier);if(w){const y=Mt(T),b=ye(y,w.currentPosition);if(Gi(b)<=0){p.push(w),Object.assign(w,{currentPosition:y,deltaPosition:b,previousPosition:w.currentPosition,touch:T});continue}f.push(w),Object.assign(w,{canTap:!1,currentPosition:y,deltaPosition:b,previousPosition:w.currentPosition,touch:T})}}if(f.length>0){const g=f.concat(p),T={touches:f.map(w=>this.makeSingleTouchInteraction(w)),allTouches:g.map(w=>n.get(w.touch.identifier)).filter(me),multitouch:a};this.eventManagers.forEach(w=>{w.handleTouchDrag(T)})}},l=e.ontouchcancel=u=>{u.stopPropagation(),u.preventDefault();const h=this.getTouches(u,"changed"),f=Array.from(n.values()),p=[];for(let g=0,m=h.length;g<m;++g){const T=h[g],w=i.get(T.identifier);w&&(p.push(w),i.delete(T.identifier),n.delete(T.identifier))}if(p.length>0){const m={touches:p.map(T=>this.makeSingleTouchInteraction(T)),allTouches:f,multitouch:a};this.eventManagers.forEach(T=>{T.handleTouchCancelled(m)})}}}getAverageDistance(e,i,n){let r=0;if(e.length<=0)return r;n||(n=s=>s.currentPosition);for(let s=0,a=e.length;s<a;++s){const o=e[s];r+=Gi(ye(n(o),i))}return r/e.length}getAverageAngle(e,i,n){let r=0;if(e.length<=0)return r;n||(n=s=>s.currentPosition);for(let s=0,a=e.length;s<a;++s){const o=e[s],c=ye(n(o),i);let l=Math.atan2(c[1],c[0]);l<0&&(l+=Math.PI*2),r+=l}return r/e.length}getTouchCenter(e,i){let n=[0,0];if(e.length<=0)return n;i||(i=r=>r.currentPosition);for(let r=0,s=e.length;r<s;++r){const a=e[r],o=i(a);n=fi(n,o)}return Re(n,1/e.length)}getTouches(e,i){const n=new Map;if(e.touches&&e.touches.length>0&&(!i||i==="touches"))for(let r=0,s=e.touches.length;r<s;++r){const a=e.touches.item(r);a&&n.set(a.identifier,a)}if(e.changedTouches&&e.changedTouches.length>0&&(!i||i==="changed"))for(let r=0,s=e.changedTouches.length;r<s;++r){const a=e.changedTouches.item(r);a&&n.set(a.identifier,a)}if(e.targetTouches&&e.targetTouches.length>0&&(!i||i==="target"))for(let r=0,s=e.targetTouches.length;r<s;++r){const a=e.targetTouches.item(r);a&&n.set(a.identifier,a)}return Array.from(n.values())}getView(e){const i=this.scenes;for(let n=0,r=i.length;n<r;++n){const a=i[n].viewDiffs.getByKey(e);if(a)return a}return null}makeMouseInteraction(e){const i=this.getViewsUnderPosition(e.currentPosition);let n=i[0]&&i[0].d;n||(n=Ri);const r=this.getViewsUnderPosition(e.start);let s=e.startView;s||(s=Ri);const a={canvas:gn(this.context)?void 0:this.context,mouse:e,screen:{position:e.currentPosition},start:{position:s.projection.screenToView(e.start),view:s,views:r.map(o=>(o.d||(o.d=Ri),{position:o.d.projection.screenToView(e.start),view:o.d}))},target:{position:n.projection.screenToView(e.currentPosition),view:n,views:i.map(o=>(o.d||(o.d=Ri),{position:o.d.projection.screenToView(e.currentPosition),view:o.d}))}};return this.currentInteraction=a,a}makeSingleTouchInteraction(e){const i=e.currentPosition,n=this.getViewsUnderPosition(i);let r=n[0]&&n[0].d;r||(r=Ri);let s=e.startView;s||(s=Ri);const a={canvas:gn(this.context)?void 0:this.context,touch:e,screen:{position:i},start:{position:s.projection.screenToView(e.start),view:s,views:this.getViewsUnderPosition(e.start).map(o=>(o.d||(o.d=Ri),{position:o.d.projection.screenToView(e.start),view:o.d}))},target:{position:r.projection.screenToView(i),view:r,views:n.map(o=>(o.d||(o.d=Ri),{position:o.d.projection.screenToView(i),view:o.d}))}};return this.currentInteraction=a,a}makeMultiTouchInteractions(e,i){e.sort(Dc);const n=this.allTouchCombinations(e);for(let r=0,s=n.length;r<s;++r){const a=n[r],o=a.map(l=>l.touch.identifier).join("_");let c=i.get(o);if(!c){const l=this.getTouchCenter(a);c={touches:a,averageSpreadDelta:0,startCenter:l,currentCenter:l,currentRotation:this.getAverageAngle(a,l),centerDelta:[0,0],rotationDelta:0},i.set(o,c)}}}updateMultiTouchInteractions(e,i){e.sort(Dc);const n=this.allTouchCombinations(e);for(let r=0,s=n.length;r<s;++r){const a=n[r],o=a.map(l=>l.touch.identifier).join("_"),c=i.get(o);if(c){const l=this.getTouchCenter(a),u=this.getAverageAngle(a,l);c.centerDelta=ye(l,c.currentCenter),c.currentCenter=l,c.rotationDelta=u-c.currentRotation,c.currentRotation=u}}}allTouchCombinations(e){const i=[],n=e.length,r=1<<n;for(let s=1;s<r;s++){const a=[];for(let o=0;o<n;o++)s&1<<o&&a.push(e[o]);i.push(a)}return i}makeWheel(e){if(!e)return{delta:[0,0]};const i=Ho(e);return{delta:[i.pixelX,i.pixelY]}}setControllers(e){this.eventManagers=e;for(const i of this.eventManagers)i.setUserInputManager(this)}destroy(){delete this.quadTree,gn(this.context)||(this.context.onmousedown=null,this.context.onmousemove=null,this.context.onmouseleave=null);const e=this.context;e.onmousewheel&&(e.onmousewheel=null),this.eventCleanup.forEach(i=>{this.context.removeEventListener(i[0],i[1])})}}class Fc extends Pn{constructor(e,i=!1){super(),this.preserveQueueMouse=[],this.singleQueueMouse=new Map,this.preserveQueueTouch=[],this.singleQueueTouch=new Map,this.preserveEvents=!1,this.handlers=new ns(e),this.preserveEvents=i}dequeue(){try{this.preserveEvents?(this.preserveQueueMouse.forEach(e=>{e[0](e[1])}),this.preserveQueueTouch.forEach(e=>{e[0](e[1])})):(this.singleQueueMouse.forEach((e,i)=>{i(e)}),this.singleQueueTouch.forEach((e,i)=>{i(e)}))}catch(e){console.error("Queued events had errors. Further events aborted"),e instanceof Error&&console.error(e.stack||e.message)}this.preserveQueueMouse=[],this.singleQueueMouse.clear(),this.preserveQueueTouch=[],this.singleQueueTouch.clear()}handleMouseDown(e){this.preserveEvents?this.preserveQueueMouse.push([this.handlers.handleMouseDown,e]):this.singleQueueMouse.set(this.handlers.handleMouseDown,e)}handleMouseUp(e){this.preserveEvents?this.preserveQueueMouse.push([this.handlers.handleMouseUp,e]):this.singleQueueMouse.set(this.handlers.handleMouseUp,e)}handleMouseOver(e){this.preserveEvents?this.preserveQueueMouse.push([this.handlers.handleMouseOver,e]):this.singleQueueMouse.set(this.handlers.handleMouseOver,e)}handleMouseOut(e){this.preserveEvents?this.preserveQueueMouse.push([this.handlers.handleMouseOut,e]):this.singleQueueMouse.set(this.handlers.handleMouseOut,e)}handleMouseMove(e){this.preserveEvents?this.preserveQueueMouse.push([this.handlers.handleMouseMove,e]):this.singleQueueMouse.set(this.handlers.handleMouseMove,e)}handleClick(e){this.preserveEvents?this.preserveQueueMouse.push([this.handlers.handleClick,e]):this.singleQueueMouse.set(this.handlers.handleClick,e)}handleDrag(e){this.preserveEvents?this.preserveQueueMouse.push([this.handlers.handleDrag,e]):this.singleQueueMouse.set(this.handlers.handleDrag,e)}handleWheel(e){this.preserveEvents?this.preserveQueueMouse.push([this.handlers.handleWheel,e]):this.singleQueueMouse.set(this.handlers.handleWheel,e)}handleTouchCancelled(e){this.preserveEvents?this.preserveQueueTouch.push([this.handlers.handleTouchCancelled,e]):this.singleQueueTouch.set(this.handlers.handleTouchCancelled,e)}handleTouchDown(e){this.preserveEvents?this.preserveQueueTouch.push([this.handlers.handleTouchDown,e]):this.singleQueueTouch.set(this.handlers.handleTouchDown,e)}handleTouchUp(e){this.preserveEvents?this.preserveQueueTouch.push([this.handlers.handleTouchUp,e]):this.singleQueueTouch.set(this.handlers.handleTouchUp,e)}handleTouchOut(e){this.preserveEvents?this.preserveQueueTouch.push([this.handlers.handleTouchOut,e]):this.singleQueueTouch.set(this.handlers.handleTouchOut,e)}handleTouchDrag(e){this.preserveEvents?this.preserveQueueTouch.push([this.handlers.handleTouchDrag,e]):this.singleQueueTouch.set(this.handlers.handleTouchDrag,e)}handleTap(e){this.preserveEvents?this.preserveQueueTouch.push([this.handlers.handleTap,e]):this.singleQueueTouch.set(this.handlers.handleTap,e)}handleDoubleTap(e){this.preserveEvents?this.preserveQueueTouch.push([this.handlers.handleDoubleTap,e]):this.singleQueueTouch.set(this.handlers.handleDoubleTap,e)}handleLongTouch(e){this.preserveEvents?this.preserveQueueTouch.push([this.handlers.handleLongTouch,e]):this.singleQueueTouch.set(this.handlers.handleLongTouch,e)}handleLongTap(e){this.preserveEvents?this.preserveQueueTouch.push([this.handlers.handleLongTap,e]):this.singleQueueTouch.set(this.handlers.handleLongTap,e)}handlePinch(e){this.preserveEvents?this.preserveQueueTouch.push([this.handlers.handlePinch,e]):this.singleQueueTouch.set(this.handlers.handlePinch,e)}handleSpread(e){this.preserveEvents?this.preserveQueueTouch.push([this.handlers.handleSpread,e]):this.singleQueueTouch.set(this.handlers.handleSpread,e)}handleTouchRotate(e){this.preserveEvents?this.preserveQueueTouch.push([this.handlers.handleTouchRotate,e]):this.singleQueueTouch.set(this.handlers.handleTouchRotate,e)}handleSwipe(e){this.preserveEvents?this.preserveQueueTouch.push([this.handlers.handleSwipe,e]):this.singleQueueTouch.set(this.handlers.handleSwipe,e)}}const ef=`vec3 cameraSpace(vec3 world) {
return (world + cameraOffset) * cameraScale2D;
}
vec3 cameraSpaceSize(vec3 worldSize) {
return worldSize * cameraScale2D;
}
vec4 clipSpace(vec3 world) {
return (viewProjection) * vec4(cameraSpace(world), 1.0);
}
vec4 clipSpaceSize(vec3 worldSize) {
return (viewProjection) * vec4(cameraSpaceSize(worldSize), 0.0);
}`,a0=Bs.immediate(0);class xi{constructor(e,i){this._id=G(),this.animation=Bs.immediate(0),this.animationEndTime=0,this.offsetBroadcastTime=0,this.scaleBroadcastTime=0,this._offset=[0,0,0],this.startOffset=[0,0,0],this.startOffsetTime=0,this.offsetEndTime=0,this._scale=[1,1,1],this.startScale=[1,1,1],this.startScaleTime=0,this.scaleEndTime=0,this.needsBroadcast=!1,this.camera=e,i&&(this._offset=it(i.offset||this._offset),this._scale=it(i.scale||this._scale))}get id(){return this._id}broadcast(e){this.offset,this.scale,this.needsBroadcast&&(this.needsBroadcast=!1,this.onViewChange&&this.onViewChange(this.camera,e))}centerOn(e,i){var o;const n=(o=this.surface)==null?void 0:o.getViewSize(e);if(!n)return;const r=[n.width/2,n.height/2,0],s=xt(i,ur(r,this._scale)),a=this.animation;this.setOffset(it(this.offset)),this.animation=a0,this.setOffset(nt(s,-1)),this.animation=a}getCurrentTime(){return this.surface?this.surface.frameMetrics.currentTime:0}getOffset(){return this._offset}getScale(){return this._scale}get offset(){const e=this.getCurrentTime();return this.onViewChange&&this.offsetBroadcastTime<this.offsetEndTime&&(this.offsetBroadcastTime=e,this.needsBroadcast=!0),this.animation.cpu(this.startOffset,this._offset,(e-this.startOffsetTime)/this.animation.duration)}setId(e){this._id=e,this.camera.needsViewDrawn=!0}setOffset(e){this.startOffset=it(this.offset),this._offset=it(e),this.startOffsetTime=this.getCurrentTime(),this.offsetEndTime=this.startOffsetTime+this.animation.duration,this.updateEndTime(),this.camera.needsViewDrawn=!0,this.onViewChange&&(this.offsetBroadcastTime=this.startOffsetTime,this.needsBroadcast=!0)}get scale(){const e=this.getCurrentTime();return this.onViewChange&&this.scaleBroadcastTime<this.scaleEndTime&&(this.scaleBroadcastTime=e,this.needsBroadcast=!0),this.animation.cpu(this.startScale,this._scale,(e-this.startScaleTime)/this.animation.duration)}setViewChangeHandler(e){this.onViewChange=e}setScale(e){this.startScale=it(this.scale),this._scale=it(e),this.startScaleTime=this.getCurrentTime(),this.scaleEndTime=this.startScaleTime+this.animation.duration,this.updateEndTime(),this.camera.needsViewDrawn=!0,this.onViewChange&&(this.scaleBroadcastTime=this.startScaleTime,this.needsBroadcast=!0)}resolve(){this.camera.needsViewDrawn=!1,this.needsBroadcast=!1}update(){this.camera.needsViewDrawn=!0}updateEndTime(){this.animationEndTime=Math.max(this.scaleEndTime,this.offsetEndTime)}}class Ai extends bi{constructor(e){super({left:-100,right:100,top:-100,bottom:100,near:-100,far:1e5,type:yi.ORTHOGRAPHIC}),this.control2D=new xi(this,e)}get control2D(){return this._control2D}set control2D(e){this._control2D=e}get scale2D(){return this.control2D.scale}get offset(){return this.control2D.offset}}class tf{sortInstanceAttributes(e,i){return e.resource&&!i.resource||e.easing&&!i.easing?-1:1}sortVertexAttributes(e,i){return 1}sortUniforms(e,i){return 1}}class nf extends Fc{constructor(){super({handleClick:async e=>{var i,n;this.enablePicking(),await((i=this.willRenderResolver)==null?void 0:i.promise),this.enablePicking(),await((n=this.didRenderResolver)==null?void 0:n.promise),this.handleInteraction(e,(r,s)=>{var a;(a=r.interactions)==null||a.handleMouseClick(s,e)})},handleTap:async e=>{var i,n;this.enablePicking(),await((i=this.willRenderResolver)==null?void 0:i.promise),this.enablePicking(),await((n=this.didRenderResolver)==null?void 0:n.promise),e.touches.forEach(r=>{this.handleInteraction(r,(s,a)=>{var o;(o=s.interactions)==null||o.handleTap(a,e,r)})})},handleDrag:async e=>{var i;await((i=this.willRenderResolver)==null?void 0:i.promise),this.handleInteraction(e,(n,r)=>{var s;(s=n.interactions)==null||s.handleMouseDrag(r,e)})},handleMouseDown:async e=>{var i;this.enablePicking(),await((i=this.willRenderResolver)==null?void 0:i.promise),this.handleInteraction(e,(n,r)=>{var s;return(s=n.interactions)==null?void 0:s.handleMouseDown(r,e)})},handleTouchDown:async e=>{var i;this.enablePicking(),await((i=this.willRenderResolver)==null?void 0:i.promise),e.touches.forEach(n=>{this.handleInteraction(n,(r,s)=>{var a;return(a=r.interactions)==null?void 0:a.handleTouchDown(s,e,n)})})},handleMouseUp:async e=>{var i;await((i=this.willRenderResolver)==null?void 0:i.promise),this.handleInteraction(e,(n,r)=>{var s;return(s=n.interactions)==null?void 0:s.handleMouseUp(r,e)})},handleTouchUp:async e=>{var i;await((i=this.willRenderResolver)==null?void 0:i.promise),e.touches.forEach(n=>{this.handleInteraction(n,(r,s)=>{var a;return(a=r.interactions)==null?void 0:a.handleTouchUp(s,e,n)})})},handleMouseOut:async e=>{var i;await((i=this.willRenderResolver)==null?void 0:i.promise),this.isOver.forEach(n=>{this.handleView(n,(r,s)=>{var a;return(a=r.interactions)==null?void 0:a.handleMouseOut(s,e)})}),this.isOver.clear()},handleTouchOut:async e=>{var i;await((i=this.willRenderResolver)==null?void 0:i.promise),e.touches.forEach(n=>{Ks(this.isTouchOver,n.touch.touch.identifier,new Set).forEach(s=>{this.handleView(s,(a,o)=>{var c;return(c=a.interactions)==null?void 0:c.handleTouchOut(o,e,n)})}),this.isOver.clear()})},handleMouseMove:async e=>{var r;this.enablePicking(),await((r=this.willRenderResolver)==null?void 0:r.promise);const i=this.handleInteraction(e,(s,a)=>{var o;return(o=s.interactions)==null?void 0:o.handleMouseMove(a,e)}),n=new Set;i.forEach(s=>n.add(s)),this.isOver.forEach(s=>{n.has(s)||this.handleView(s,(a,o)=>{var c;return(c=a.interactions)==null?void 0:c.handleMouseOut(o,e)})}),n.forEach(s=>{this.isOver.has(s)||this.handleView(s,(a,o)=>{var c;return(c=a.interactions)==null?void 0:c.handleMouseOver(o,e)})}),this.isOver=n},handleTouchDrag:async e=>{var i;this.enablePicking(),await((i=this.willRenderResolver)==null?void 0:i.promise),e.touches.forEach(n=>{const r=this.handleInteraction(n,(o,c)=>{var l;return(l=o.interactions)==null?void 0:l.handleTouchMove(c,e,n)}),s=new Set;r.forEach(o=>s.add(o));const a=qi(this.isTouchOver,n.touch.touch.identifier,new Set);a.forEach(o=>{s.has(o)||this.handleView(o,(c,l)=>{var u;return(u=c.interactions)==null?void 0:u.handleTouchOut(l,e,n)})}),s.forEach(o=>{a.has(o)||this.handleView(o,(c,l)=>{var u;return(u=c.interactions)==null?void 0:u.handleTouchOver(l,e,n)})}),this.isTouchOver.set(n.touch.touch.identifier,s)})}}),this.isOver=new Set,this.isTouchOver=new Map}get scenes(){return!this.surface||!this.surface.sceneDiffs?[]:this.surface.sceneDiffs.items}enablePicking(){this.surface&&this.surface.enableOptimizedOutput($.PICKING)}willRender(){var e;for(let i=0,n=this.scenes.length;i<n;++i){const r=this.scenes[i];for(let s=0,a=r.layers.length;s<a;++s)(e=r.layers[s].interactions)==null||delete e.colorPicking}this.willRenderResolver&&this.willRenderResolver.resolve(),this.willRenderResolver=new ke,this.dequeue()}async didRender(){this.didRenderResolver&&this.didRenderResolver.resolve(),this.didRenderResolver=new ke}getSceneViewsUnderMouse(e){const i=new Map;for(let n=0,r=this.scenes.length;n<r;++n){const s=this.scenes[n];for(let a=0,o=s.views.length;a<o;++a){const c=s.views[a];i.set(c.id,c)}}return e.target.views.map(n=>i.get(n.view.id)).filter(me)}handleInteraction(e,i){const n=this.getSceneViewsUnderMouse(e);for(let r=0,s=n.length;r<s;++r){const a=n[r];this.handleView(a,i)}return n}handleView(e,i){for(let n=0,r=e.scene.layers.length;n<r;++n){const s=e.scene.layers[n];s.picking&&s.picking.type!==X.NONE&&i(s,e)}}}class o0{rawVertex(e){return e}rawFragment(e){return e}}class c0 extends o0{vertex(e){let i=Wr(e);return L.SHADERS_3_0?(i=i.replace(/\s+varying\s+/g,`
out `),i=i.replace(/(texture2D(\s+)\(|texture2D\()/g,"texture(")):(i=i.replace(/^#version 300 es/g,""),i=i.replace(/\s+out\s+/g,`
varying `)),i}fragment(e){let i=Wr(e);if(L.SHADERS_3_0){if(i=i.replace(/\s+varying\s+/g,`
in `),i=i.replace(/(texture2D(\s+)\(|texture2D\()/g,"texture("),i.match(/gl_FragColor/g)&&(i=i.replace(/gl_FragColor/g,"_FragColor"),!i.match("out vec4 _FragColor"))){const n=i.split(`
`);n.splice(3,0,"layout(location = 0) out vec4 _FragColor;"),i=n.join(`
`)}}else i=i.replace(/^#version 300 es/g,""),i=i.replace(/\s+in\s+/g,`
varying `);return i}}function l0(t,e,i,n,r){const s={view:t,allColors:[],colorData:i,dataHeight:r,dataWidth:n,mouse:e,nearestColor:0,nearestColorBytes:[0,0,0,0]},a=new Map;let o=0;const c=n/2,l=r/2;let u=0,h=[0,0,0,0],f=Number.MAX_SAFE_INTEGER;for(let p=0;p<r;++p)for(let g=0;g<n;++g){const m=i[o],T=i[o+1],w=i[o+2];o+=4;const y=m<<16|T<<8|w;if(a.set(y,!0),y!==0){const b=g-c,x=p-l,R=b*b+x*x;R<f&&(f=R,u=y,h=[m,T,w,255])}}return s.allColors=Array.from(a.keys()),s.nearestColor=u,s.nearestColorBytes=h,s}class u0{constructor(e){this.pickingRenderTargets=new Map,this.surface=e.surface}analyzePickedPixels(e,i){if(i.optimizeRendering)return;const n=cr(Re(e,this.surface.pixelRatio),i.projection.screenScale),r=5,s=5,a=4,o=new Uint8Array(r*s*a);this.surface.renderer.readPixels(Math.floor(n[0]-r/2),Math.floor(n[1]-s/2),r,s,o);const c=l0(i,[n[0]-i.screenBounds.x,n[1]-i.screenBounds.y],o,r,s);for(let l=0,u=i.scene.layers.length;l<u;++l){const h=i.scene.layers[l];h.picking.type===X.SINGLE&&(h.interactions.colorPicking=c)}}decodePicking(){const e=this.surface.getCurrentInteraction();if(!e)return;const i=e.screen.position,n=e.target.views.map(s=>s.view),r=new Set;this.pickingRenderTargets.forEach((s,a)=>{const o=s.getBuffers()[0].buffer;o instanceof se&&(!o.gl||o.destroyed)&&(s.dispose(),r.add(a))}),r.forEach(s=>this.pickingRenderTargets.delete(s)),n.forEach(s=>{let a=this.pickingRenderTargets.get(s);if(a||s.getRenderTargets().forEach(l=>{l.gl&&l.getBuffers().forEach(u=>{if(u.outputType===$.PICKING){if(a=new Wi({buffers:{color:u}}),a.width===0||a.height===0){a=void 0;return}this.pickingRenderTargets.set(s,a)}})}),!a)return;const o=this.surface.renderer.state.currentRenderTarget;let c=!1;o?(Array.isArray(o)||o.getBuffers()[0].buffer!==a.getBuffers()[0].buffer)&&(c=!0):c=!0,c&&this.surface.renderer.setRenderTarget(a),this.analyzePickedPixels(i,s)})}}const rf=()=>[new xd,new Ad,new _d],sf=()=>[{type:le.COLOR_BUFFER,manager:new Dg},{type:le.TEXTURE,manager:new ad},{type:le.ATLAS,manager:new sd({})},{type:le.FONT,manager:new vd}],af=()=>[new c0],h0=[0,0,0,0];function Bc(t,e){return(t.order||Number.MAX_SAFE_INTEGER)-(e.order||Number.MAX_SAFE_INTEGER)}class of{constructor(e){this.commands=new u0({surface:this}),this.frameMetrics={currentFrame:0,currentTime:Date.now()|0,frameDuration:1e3/60,previousTime:Date.now()|0},this.isBufferingResources=!1,this.ioExpanders=[],this.shaderTransforms=[],this.optimizedOutputs=new Set([$.PICKING]),this.ioSorting=new tf,this.pixelRatio=window.devicePixelRatio,this.enabledOptimizedOutputs=new Set,this.viewDrawDependencies=new Map,this.resourceDiffs=new Vr({buildItem:async i=>(await this.resourceManager.initResource(i),{id:i.key}),destroyItem:async(i,n)=>(await this.resourceManager.destroyResource(i),!0),updateItem:async(i,n)=>{await this.resourceManager.updateResource(i)}}),this.sceneDiffs=new Vr({buildItem:async i=>new la(this,{key:i.key,views:i.views,layers:i.layers}),destroyItem:async(i,n)=>(n.destroy(),!0),updateItem:async(i,n)=>{await n.update(i)}}),this.readyResolver=new ke,this.ready=this.readyResolver.promise,e&&this.init(e)}get gl(){return this.context}get scenes(){return this.sceneDiffs.items}broadcastEventManagerCycle(e){for(let i=0,n=this.userInputManager.eventManagers.length;i<n;++i){const r=this.userInputManager.eventManagers[i];switch(e){case 1:r.didRender();break;case 0:r.willRender();break}}}async commit(e,i,n){if(!this.gl)return;let r=!1;i&&this.frameMetrics.currentFrame++,this.frameMetrics.frameDuration=this.frameMetrics.currentTime-this.frameMetrics.previousTime,this.frameMetrics.previousTime=this.frameMetrics.currentTime,e===void 0?this.frameMetrics.currentTime=Date.now()|0:(this.frameMetrics.previousTime===this.frameMetrics.currentTime&&(this.frameMetrics.previousTime=e),this.frameMetrics.currentTime=e),e=this.frameMetrics.currentTime;const s=this.sceneDiffs.items;s.sort(Bc);const a={};for(let c=0,l=s.length;c<l;++c){const u=s[c],h=u.views,f=u.layers;h.sort(Bc),f.sort(Bc);for(let p=0,g=h.length;p<g;++p){const m=h[p],T={};f.length>0&&m.willUseView();const w=this.renderer.getRenderSize();let y=new te({width:w[0],height:w[1],x:0,y:0});if(m.renderTarget){const N=(Array.isArray(m.renderTarget)?m.renderTarget[0]:m.renderTarget).getSize();y=new te({width:N[0],height:N[1],x:0,y:0})}const b=Mo(m.props.viewport,y,this.pixelRatio);m.fitViewtoViewport(y,b);for(let R=0,N=f.length;R<N;++R){const I=f[R];I.view=m;try{I.draw(),(I.needsViewDrawn||I.alwaysDraw)&&(m.needsDraw=!0),T[I.id]=I,m.animationEndTime=Math.max(m.animationEndTime,I.animationEndTime,m.props.camera.animationEndTime),I.lastFrameTime=e}catch(S){S instanceof Error&&(a[I.id]||(a[I.id]=[I,S]))}}if(m.needsDraw||e&&e<m.lastFrameTime||e&&e<m.animationEndTime||m.props.camera.needsViewDrawn){m.needsDraw=!0,r=!0;const R=this.viewDrawDependencies.get(m);R&&R.forEach(N=>{N.needsDraw=!0})}const x=Object.values(T);f.length!==x.length&&u.layerDiffs.diff(x.map(R=>R.initializer)),u.container&&n&&n(r,u,m)}}const o=Object.values(a);this.printLayerErrors(o)}destroy(){this.resourceManager.destroy(),this.userInputManager.destroy(),this.sceneDiffs.destroy(),this.renderer.dispose(),delete this.context}async draw(e){if(this.gl){this.broadcastEventManagerCycle(0);for(let i=0,n=this.sceneDiffs.items.length;i<n;++i){const r=this.sceneDiffs.items[i];for(let s=0,a=r.views.length;s<a;++s){const o=r.views[s];o.props.camera.broadcast(o.id)}}if(await this.commit(e,!0,(i,n,r)=>{n.container&&i&&this.drawSceneView(n.container,r)}),this.userInputManager.waitingForRender&&(this.userInputManager.waitingForRender=!1),!this.isBufferingResources){this.isBufferingResources=!0;const i=await this.resourceManager.dequeueRequests();this.isBufferingResources=!1,i&&this.draw(await Ti())}for(let i=0,n=this.sceneDiffs.items.length;i<n;++i){const r=this.sceneDiffs.items[i];for(let s=0,a=r.views.length;s<a;++s){const o=r.views[s];o.needsDraw=!1,o.props.camera.resolve()}for(let s=0,a=r.layers.length;s<a;++s){const o=r.layers[s];o.needsViewDrawn=!1}}this.broadcastEventManagerCycle(1),this.enabledOptimizedOutputs.clear()}}drawSceneView(e,i,n,r){n=n||this.renderer;const s={x:i.viewBounds.left,y:i.viewBounds.top},a=i.viewBounds,o=i.props.background||h0,c=i.clearFlags.indexOf(Jn.COLOR)>-1,l=r||i.renderTarget||null;i.renderTarget&&(i.getRenderTargets().forEach(h=>this.optimizedOutputs.forEach(f=>h.disabledTargets.add(f))),this.enabledOptimizedOutputs.size>0&&i.getRenderTargets().forEach(f=>this.enabledOptimizedOutputs.forEach(p=>f.disabledTargets.delete(p)))),n.setRenderTarget(l),n.setScissor({x:s.x,y:s.y,width:a.width,height:a.height},l),c&&n.clearColor([o[0],o[1],o[2],o[3]]),n.setViewport({x:s.x,y:s.y,width:a.width,height:a.height}),i.clearFlags&&i.clearFlags.length>0?n.clear(c,i.clearFlags.indexOf(Jn.DEPTH)>-1,i.clearFlags.indexOf(Jn.STENCIL)>-1):n.clear(!1),n.render(e,l,i.props.glState),i.lastFrameTime=this.frameMetrics.currentTime}fitContainer(e){if(!this.context||gn(this.context.canvas))return;const i=this.context.canvas.parentElement;if(i){const n=this.context.canvas;n.className="",n.setAttribute("style",""),i.style.position="relative",n.style.position="absolute",n.style.left="0xp",n.style.top="0xp",n.style.width="100%",n.style.height="100%",n.setAttribute("width",""),n.setAttribute("height","");const r=i.getBoundingClientRect(),s=n.getBoundingClientRect();this.resize(s.width||100,r.height||100)}}gatherViewDrawDependencies(){if(!this.sceneDiffs)return;this.viewDrawDependencies.clear();const e=this.sceneDiffs.items,i=this.renderer.getRenderSize();for(let n=0,r=e.length;n<r;n++){const s=e[n];for(let a=0,o=s.views.length;a<o;++a){const c=s.views[a];c.willUseView();let l=new te({width:i[0],height:i[1],x:0,y:0});if(c.renderTarget){const f=(Array.isArray(c.renderTarget)?c.renderTarget[0]:c.renderTarget).getSize();l=new te({width:f[0],height:f[1],x:0,y:0})}const u=Mo(c.props.viewport,l,this.pixelRatio);c.fitViewtoViewport(l,u),c.props.camera.update(!0)}}for(let n=0,r=e.length;n<r;n++){const s=e[n];for(let a=0,o=s.views.length;a<o;++a){const c=s.views[a],l=[];for(let u=0,h=e.length;u<h;u++)if(u!==n){const f=e[u];for(let p=0,g=f.views.length;p<g;++p){const m=f.views[p];c.viewBounds.hitBounds(m.viewBounds)&&l.push(m)}}this.viewDrawDependencies.set(c,l)}}}getCurrentInteraction(){return this.userInputManager.currentInteraction}getIOExpanders(){return this.ioExpanders}getIOSorting(){return this.ioSorting}getShaderTransforms(){return this.shaderTransforms}getOptimizedOutputs(){return this.enabledOptimizedOutputs}getViewSize(e){for(let i=0,n=this.sceneDiffs.items.length;i<n;++i){const s=this.sceneDiffs.items[i].viewDiffs.getByKey(e);if(s)return s.renderTarget?s.viewBounds:s.screenBounds}return null}getViewWorldBounds(e){for(let i=0,n=this.sceneDiffs.items.length;i<n;++i){const s=this.sceneDiffs.items[i].viewDiffs.getByKey(e);if(s)if(s.screenBounds){const a=s.projection.viewToWorld([0,0]),o=s.projection.screenToWorld([s.screenBounds.right,s.screenBounds.bottom]);return new te({bottom:o[1],left:a[0],right:o[0],top:a[1]})}else return null}return null}getProjections(e){for(let i=0,n=this.sceneDiffs.items.length;i<n;++i){const s=this.sceneDiffs.items[i].viewDiffs.getByKey(e);if(s)return s.projection}return null}async init(e){var n;if(this.context)return this;this.pixelRatio=e.pixelRatio||this.pixelRatio,this.pixelRatio<1&&(this.pixelRatio=1);const i=this.initGL(e);return i?(this.context=i,this.gl?((n=e.optimizedOutputTargets)==null||n.forEach(r=>this.optimizedOutputs.add(r)),this.initUserInputManager(e),await this.initResources(e),await this.initIOExpanders(e),await this.initShaderTransforms(e)):console.warn("Could not establish a GL context. Layer Surface will be unable to render"),this.readyResolver.resolve(this),this):(this.readyResolver.reject({error:Fo.NO_WEBGL_CONTEXT,message:"Could not establish a webgl context. Surface is being destroyed to free resources."}),this.destroy(),this)}initGL(e){const i=e.context;if(!i)return null;const n=i.width,r=i.height;let s=!0;const a=Object.assign({alpha:!1,antialias:!1,preserveDrawingBuffer:!1,premultiplyAlpha:!1},e.rendererOptions);return this.renderer=new Zl({alpha:a.alpha,antialias:a.antialias,canvas:i,preserveDrawingBuffer:a.preserveDrawingBuffer,premultipliedAlpha:a.premultipliedAlpha,onNoContext:()=>{s=!1}}),!s||!this.renderer.gl?null:(this.context=this.renderer.gl,this.resourceManager&&this.resourceManager.setWebGLRenderer(this.renderer),this.setRendererSize(n,r),this.renderer.setPixelRatio(this.pixelRatio),this.renderer.gl)}initIOExpanders(e){const i=rf();Array.isArray(e.ioExpansion)||e.ioExpansion===void 0?this.ioExpanders=e.ioExpansion&&e.ioExpansion.slice(0)||i.slice(0)||[]:e.ioExpansion instanceof Function&&(this.ioExpanders=e.ioExpansion(i));const n=this.resourceManager.getIOExpansion();this.ioExpanders=this.ioExpanders.concat(n)}initShaderTransforms(e){const i=af();Array.isArray(e.shaderTransforms)||e.shaderTransforms===void 0?this.shaderTransforms=e.shaderTransforms&&e.shaderTransforms.slice(0)||i.slice(0)||[]:e.shaderTransforms instanceof Function&&(this.shaderTransforms=e.shaderTransforms(i))}initUserInputManager(e){if(!this.context)return;const i=[new nf].concat(e.eventManagers||[]);this.userInputManager=new Jd(this.context.canvas,this,i,e.handlesWheelEvents)}async initResources(e){const i=sf();this.resourceManager=new Mc,this.resourceManager.setWebGLRenderer(this.renderer),(e.resourceManagers&&e.resourceManagers.slice(0)||i.slice(0)||[]).forEach(r=>{this.resourceManager.setManager(r.type,r.manager)})}async pipeline(e){e.resources&&await this.resourceDiffs.diff(e.resources),e.scenes&&await this.sceneDiffs.diff(e.scenes),this.gatherViewDrawDependencies()}printLayerErrors(e){e.length>0&&(console.warn("Some layers errored during their draw update. These layers will be removed. They can be re-added if render() is called again:",e.map(i=>i[0].id)),e.forEach(i=>{if(console.warn(`Layer ${i[0].id} removed for the following error:`),i[1]){const n=i[1].stack||i[1].message;if(console.error(n),n.indexOf("RangeError")>-1||n.indexOf("Source is too large")>-1){const r=i[0],s=r.bufferManager.changeListContext||[];let a,o=0;for(let c=0,l=s.length;c<l;++c){const[u]=s[c];r.shaderIOInfo.instanceAttributes.forEach(h=>{h.update(u).length!==h.size&&(a||(a=["Example instance returned the wrong sized value for an attribute:",u,h]),o++)})}a&&(console.error("The following output shows discovered issues related to the specified error"),console.error(`Instances are returning too large IO for an attribute
`,a[0],a[1],a[2],"Total errors for too large IO values",o))}}}))}resize(e,i,n){if(this.pixelRatio=n||this.pixelRatio,this.pixelRatio<1&&(this.pixelRatio=1),this.setRendererSize(e,i),this.renderer.setPixelRatio(this.pixelRatio),this.userInputManager.resize(),this.resourceManager.resize(),this.sceneDiffs){const r=this.sceneDiffs.items;for(let s=0,a=r.length;s<a;++s){const o=r[s];for(let c=0,l=o.views.length;c<l;++c){const u=o.views[c];u.pixelRatio=this.pixelRatio,u.props.camera.update(!0)}}}this.gatherViewDrawDependencies()}redraw(){for(let e=0,i=this.sceneDiffs.items.length;e<i;++e){const n=this.sceneDiffs.items[e];for(let r=0,s=n.views.length;r<s;++r){const a=n.views[r];a.needsDraw=!0}}}setRendererSize(e,i){e=e||100,i=i||100,this.renderer.setSize(e,i)}enableOptimizedOutput(e){this.enabledOptimizedOutputs.add(e)}}class Uc extends ei{draw(){this.props.commands(this.surface)}initShader(){return null}}Uc.defaultProps={data:new he,key:"",commands:()=>{}};class Ne extends ei{constructor(e,i,n){super(e,i,n)}baseShaderModules(e){const i=super.baseShaderModules(e);return i.vs.push("world2D"),i}}const d0=`
These are projection methods and camera
related constants associated with a
View2D.

Methods:
vec3 cameraSpace(vec3 world);
vec3 cameraSpaceSize(vec3 worldSize);
vec4 clipSpace(vec3 world);
vec4 clipSpaceSize(vec3 worldSize);

Constants:
mat4 projection;
mat4 view;
mat4 viewProjection;
vec3 cameraOffset;
vec3 cameraPosition;
vec3 cameraScale;
vec3 cameraScale2D;
vec3 cameraRotation;
vec2 viewSize;
float pixelRatio;
`;Ee.register([{moduleId:"world2D",description:d0,content:ef,compatibility:A.ALL,uniforms:t=>t instanceof Ne?[{name:"projection",size:E.MATRIX4,update:()=>t.view.props.camera.projection},{name:"view",size:E.MATRIX4,update:()=>t.view.props.camera.view},{name:"viewProjection",size:E.MATRIX4,update:()=>t.view.props.camera.viewProjection},{name:"cameraOffset",size:E.THREE,update:()=>t.view.props.camera instanceof Ai?t.view.props.camera.control2D.offset:[0,0,0]},{name:"cameraPosition",size:E.THREE,update:()=>t.view.props.camera.position},{name:"cameraScale",size:E.THREE,update:()=>t.view.props.camera.scale},{name:"cameraScale2D",size:E.THREE,update:()=>t.view.props.camera instanceof Ai?t.view.props.camera.scale2D:[1,1,1]},{name:"cameraRotation",size:E.THREE,update:()=>t.view.props.camera.scale},{name:"viewSize",size:E.TWO,update:()=>[t.view.viewBounds.width,t.view.viewBounds.height]},{name:"pixelRatio",size:E.ONE,update:()=>[t.view.pixelRatio]}]:(console.warn("A shader requested the module world2D; however, the layer the shader comes from is NOT a Layer2D which is","required for the module to work."),[])}]);var P=(t=>(t[t.BottomLeft=0]="BottomLeft",t[t.BottomMiddle=1]="BottomMiddle",t[t.BottomRight=2]="BottomRight",t[t.Custom=3]="Custom",t[t.Middle=4]="Middle",t[t.MiddleLeft=5]="MiddleLeft",t[t.MiddleRight=6]="MiddleRight",t[t.TopLeft=7]="TopLeft",t[t.TopMiddle=8]="TopMiddle",t[t.TopRight=9]="TopRight",t))(P||{}),ti=(t=>(t[t.ALWAYS=1]="ALWAYS",t[t.BOUND_MAX=2]="BOUND_MAX",t[t.NEVER=3]="NEVER",t))(ti||{}),cf=(t=>(t[t.TOP_LEFT=0]="TOP_LEFT",t[t.TOP_MIDDLE=1]="TOP_MIDDLE",t[t.TOP_RIGHT=2]="TOP_RIGHT",t[t.MIDDLE_LEFT=3]="MIDDLE_LEFT",t[t.MIDDLE=4]="MIDDLE",t[t.MIDDLE_RIGHT=5]="MIDDLE_RIGHT",t[t.BOTTOM_LEFT=6]="BOTTOM_LEFT",t[t.BOTTOM_MIDDLE=7]="BOTTOM_MIDDLE",t[t.BOTTOM_RIGHT=8]="BOTTOM_RIGHT",t))(cf||{});class lf extends ns{constructor(e){super({}),this._uid=G(),this.isPanning=!1,this.isScaling=!1,this.panFilter=(i,n,r)=>i,this.scaleFilter=(i,n,r)=>i,this.startViews=[],this.optimizedViews=new Set,this.cameraImmediateAnimation=Bs.immediate(0),this.targetTouches=new Set,this.onRangeChanged=(i,n)=>{},this.startViewDidStart=!1,this.applyBounds=()=>{if(this.bounds&&this.camera){const i=this.getView(this.bounds.view);this.applyScaleBounds(),i&&(this.camera.control2D.getOffset()[0]=this.boundsHorizontalOffset(i,this.bounds),this.camera.control2D.getOffset()[1]=this.boundsVerticalOffset(i,this.bounds))}},this.applyScaleBounds=()=>{this.camera&&this.bounds&&(this.bounds.scaleMin&&this.camera.control2D.setScale(ds(this.camera.control2D.getScale(),this.bounds.scaleMin)),this.bounds.scaleMax&&this.camera.control2D.setScale(fs(this.camera.control2D.getScale(),this.bounds.scaleMax)))},this.handleCameraViewChange=(i,n)=>{if(n!==this.startViews[0])return;const r=this.surface.getProjections(n);r&&this.onRangeChanged(i,r)},e.bounds&&this.setBounds(e.bounds),this._camera=e.camera,this.scaleFactor=e.scaleFactor||1e3,this.ignoreCoverViews=e.ignoreCoverViews||!1,this.twoFingerPan=e.twoFingerPan||!1,e.startView&&(Array.isArray(e.startView)?(this.startViews=e.startView,this._camera.control2D.setViewChangeHandler(this.handleCameraViewChange)):(this.startViews=[e.startView],this._camera.control2D.setViewChangeHandler(this.handleCameraViewChange))),this.panFilter=e.panFilter||this.panFilter,this.scaleFilter=e.scaleFilter||this.scaleFilter,this.onRangeChanged=e.onRangeChanged||this.onRangeChanged,e.wheelShouldScroll&&(this.wheelShouldScroll=e.wheelShouldScroll)}get uid(){return this._uid}get camera(){return this._camera}anchoredByBoundsHorizontal(e,i){switch(i.anchor){case 0:case 3:case 6:return-(i.worldBounds.left-i.screenPadding.left/this.camera.control2D.getScale()[0]);case 1:case 4:case 7:return-(i.worldBounds.right-i.worldBounds.width/2-.5*((e.screenBounds.width+i.screenPadding.right)/this.camera.control2D.getScale()[0]));case 2:case 5:case 8:return-(i.worldBounds.right-(e.screenBounds.width-i.screenPadding.right)/this.camera.control2D.getScale()[0])}}anchoredByBoundsVertical(e,i){switch(i.anchor){case 0:case 1:case 2:return-(i.worldBounds.top-i.screenPadding.top/this.camera.control2D.getScale()[1]);case 3:case 4:case 5:return-(i.worldBounds.bottom-i.worldBounds.height/2-.5*((e.screenBounds.height+i.screenPadding.bottom)/this.camera.control2D.getScale()[1]));case 6:case 7:case 8:return-(i.worldBounds.bottom-(e.screenBounds.height-i.screenPadding.bottom)/this.camera.control2D.getScale()[1])}}boundsHorizontalOffset(e,i){const n=e.projection.worldToScreen([i.worldBounds.left,i.worldBounds.top]),r=e.projection.worldToScreen([i.worldBounds.right,i.worldBounds.bottom]);return r[0]-n[0]+i.screenPadding.left+i.screenPadding.right-e.screenBounds.width<0?this.anchoredByBoundsHorizontal(e,i):r[0]<e.screenBounds.right-i.screenPadding.right?-i.worldBounds.right+(e.screenBounds.width-i.screenPadding.right)/this.camera.control2D.getScale()[0]:n[0]>e.screenBounds.left+i.screenPadding.left?-i.worldBounds.left+i.screenPadding.left/this.camera.control2D.getScale()[0]:this.camera.control2D.getOffset()[0]}boundsVerticalOffset(e,i){const n=e.projection.worldToScreen([i.worldBounds.left,i.worldBounds.top]),r=e.projection.worldToScreen([i.worldBounds.right,i.worldBounds.bottom]);return r[1]-n[1]+i.screenPadding.top+i.screenPadding.bottom-e.screenBounds.height<0?this.anchoredByBoundsVertical(e,i):r[1]<e.screenBounds.bottom-i.screenPadding.bottom?-i.worldBounds.bottom+(e.screenBounds.height-i.screenPadding.bottom)/this.camera.control2D.getScale()[1]:n[1]>e.screenBounds.top+i.screenPadding.top?-i.worldBounds.top+i.screenPadding.top/this.camera.control2D.getScale()[0]:this.camera.control2D.getOffset()[1]}canStart(e){return this.startViews.length===0||this.startViews&&this.startViews.indexOf(e)>-1||this.startViewDidStart&&this.ignoreCoverViews}centerOn(e,i){if(!this.camera.control2D.surface)return;const n=this.camera.control2D.surface.getViewSize(e);if(!n)return;const r=[n.width/2,n.height/2,0],s=xt(i,ur(r,this.camera.control2D.getScale())),a=nt(s,-1);this.setOffset(e,a)}doPan(e,i,n){let r=ki(cr(n,this.camera.control2D.getScale()),0);this.panFilter&&(r=this.panFilter(r,i,e)),this.camera.control2D.getOffset()[0]+=r[0],this.camera.control2D.getOffset()[1]+=r[1],this.applyBounds(),this.onRangeChanged(this.camera,i.projection),this.applyBounds(),this.camera.control2D.update()}doScale(e,i,n,r){const s=i.projection.screenToWorld(e),a=this.camera.control2D.getScale()[0]||1,o=this.camera.control2D.getScale()[1]||1;this.scaleFilter&&(r=this.scaleFilter(r,i,n)),this.camera.control2D.getScale()[0]=a+r[0],this.camera.control2D.getScale()[1]=o+r[1],this.applyScaleBounds();const c=i.projection.screenToWorld(e),l=ye(s,c);this.camera.control2D.getOffset()[0]-=l[0],this.camera.control2D.getOffset()[1]-=l[1],this.applyBounds(),this.onRangeChanged(this.camera,i.projection),this.applyBounds(),this.camera.control2D.update(),this.camera.control2D.animation=this.cameraImmediateAnimation}filterTouchesByValidStart(e){return this.ignoreCoverViews?e.filter(uu(this.startViews)):e.filter(lu(this.startViews))}findCoveredStartView(e){const i=e.target.views.find(n=>this.startViews.indexOf(n.view.id)>-1);this.startViewDidStart=!!i,i&&(this.coveredStartView=i.view)}getRange(e){const i=this.getProjection(e),n=this.getViewScreenBounds(e);if(i&&n){const r=i.screenToWorld([n.x,n.y]),s=i.screenToWorld([n.right,n.bottom]);return new te({height:s[1]-r[1],width:s[0]-r[0],x:r[0],y:r[1]})}return new te({x:0,y:0,width:1,height:1})}getTargetView(e){return this.startViews&&!this.ignoreCoverViews?e.target.view:this.coveredStartView}handleMouseDown(e){this.startViews&&(this.findCoveredStartView(e),e.start&&(this.isPanning=this.canStart(e.start.view.id)||this.isPanning))}handleTouchDown(e){if(this.startViews){const i=this.filterTouchesByValidStart(e.allTouches);this.twoFingerPan?i.length>1&&(this.isPanning=!0):i.length>0&&(this.isPanning=!0),i.length>1&&(this.isScaling=!0);for(let n=0,r=i.length;n<r;++n){const s=i[n];this.targetTouches.add(s.touch.touch.identifier)}}}handleMouseUp(e){this.startViewDidStart=!1,this.isPanning=!1,this.optimizedViews.forEach(i=>i.optimizeRendering=!1),this.optimizedViews.clear()}handleTouchUp(e){e.touches.forEach(i=>{this.targetTouches.delete(i.touch.touch.identifier),this.targetTouches.size<=0&&(this.startViewDidStart=!1,this.isPanning=!1,this.optimizedViews.forEach(n=>n.optimizeRendering=!1),this.optimizedViews.clear())}),this.isPanning=!1,this.isScaling=!1,this.targetTouches.size>0&&(this.isPanning=!0),this.targetTouches.size>1&&(this.isScaling=!0)}handleTouchCancelled(e){e.touches.forEach(i=>{this.targetTouches.delete(i.touch.touch.identifier),this.targetTouches.size<=0&&(this.startViewDidStart=!1,this.isPanning=!1,this.optimizedViews.forEach(n=>n.optimizeRendering=!1),this.optimizedViews.clear())}),this.isPanning=!1,this.isScaling=!1,this.targetTouches.size>0&&(this.isPanning=!0),this.targetTouches.size>1&&(this.isScaling=!0)}handleDrag(e){e.start&&this.canStart(e.start.view.id)&&(e.target.views.forEach(i=>{i.view.optimizeRendering=!0,this.optimizedViews.add(i.view)}),this.doPan(e.target.views.map(i=>i.view),e.start.view,e.mouse.deltaPosition),this.camera.control2D.animation=this.cameraImmediateAnimation)}handleTouchDrag(e){const i=this.filterTouchesByValidStart(e.allTouches);if(i.length>0&&this.isPanning){for(let a=0,o=i.length;a<o;++a)i[a].target.views.forEach(l=>{l.view.optimizeRendering=!0,this.optimizedViews.add(l.view)});const n=new Set,s=i.reduce((a,o)=>{for(let c=0,l=o.target.views.length;c<l;++c){const u=o.target.views[c];n.add(u.view)}return o.touch.startTime<a.touch.startTime?o:a},i[0]).start.view;if(this.isPanning&&(this.doPan(Array.from(n.values()),s,e.multitouch.centerDelta(i)),this.camera.control2D.animation=this.cameraImmediateAnimation),this.isScaling){const a=e.multitouch.center(i),o=ye(i[0].touch.currentPosition,a),c=ye(a,e.multitouch.centerDelta(i)),l=ye(i[0].touch.previousPosition,c),u=Gi(o)/Gi(l),h=[u*this.camera.scale2D[0]-this.camera.scale2D[0],u*this.camera.scale2D[1]-this.camera.scale2D[1],0];u!==1&&this.doScale(a,s,Array.from(n.values()),h)}}}handleWheel(e){if(this.findCoveredStartView(e),this.canStart(e.target.view.id))if(this.wheelShouldScroll){const i=[-e.mouse.wheel.delta[0],e.mouse.wheel.delta[1]];e.start&&this.doPan(e.target.views.map(n=>n.view),e.start.view,i)}else{const i=this.camera.control2D.getScale()[0]||1,n=this.camera.control2D.getScale()[1]||1,r=this.getTargetView(e),s=[e.mouse.wheel.delta[1]/this.scaleFactor*i,e.mouse.wheel.delta[1]/this.scaleFactor*n,1];if(!r){console.warn("Could not find target view for wheel event");return}this.doScale(e.screen.position,r,e.target.views.map(a=>a.view),s)}}get pan(){return this.camera.control2D.offset}get scale(){return this.camera.control2D.getScale()}setBounds(e){this.bounds=e,this.applyBounds()}setOffset(e,i){const n=it(this.camera.control2D.offset);if(this.camera.control2D.getOffset()[0]=i[0],this.camera.control2D.getOffset()[1]=i[1],this.camera.control2D.getOffset()[2]=i[2],this.applyBounds(),this.camera.control2D.surface){const a=this.camera.control2D.surface.getProjections(e);a&&this.onRangeChanged(this.camera,a)}this.applyBounds();const r=it(this.camera.control2D.getOffset()),s=this.camera.control2D.animation;this.camera.control2D.setOffset(n),this.camera.control2D.animation=this.cameraImmediateAnimation,this.camera.control2D.setOffset(r),this.camera.control2D.animation=s}setRange(e,i){const n=this.getProjection(i),r=this.getViewScreenBounds(i),s=this.getView(i);if(n&&r&&s){const a=xt([r.width/e.width,r.height/e.height,1],this.camera.control2D.getScale());this.camera.control2D.setScale(Rt(this.camera.control2D.getScale(),this.scaleFilter(a,s,[s])));const o=xt([-e.x,-e.y,0],this.camera.control2D.offset);this.camera.control2D.setOffset(Rt(this.camera.control2D.offset,this.scaleFilter(o,s,[s]))),this.applyBounds(),this.onRangeChanged(this.camera,s.projection),this.applyBounds()}}setRangeChangeHandler(e){this.onRangeChanged=e}}class f0 extends xi{constructor(e,i){super(e),this.offsetFilter=n=>n,this.scaleFilter=n=>n,this.base=i.base,this.offsetFilter=i.offsetFilter||this.offsetFilter,this.scaleFilter=i.scaleFilter||this.scaleFilter}set offset(e){}get offset(){return this.offsetFilter(this.base.offset)}set scale(e){}get scale(){return this.scaleFilter(this.base.scale)}}class p0 extends Ai{constructor(e){super(),this.base=e.base,this._control2D=new f0(this.base,{base:this.base.control2D,offsetFilter:e.offsetFilter,scaleFilter:e.scaleFilter})}set control2D(e){}get control2D(){return this._control2D}}const g0=new Ai;class m0 extends Ns{constructor(){super(...arguments),this.camera=g0}screenToWorld(e,i){const n=this.screenToView(e),r=i||[0,0];return r[0]=(n[0]-this.camera.control2D.offset[0]*this.camera.scale2D[0])/this.camera.scale2D[0],r[1]=(n[1]-this.camera.control2D.offset[1]*this.camera.scale2D[1])/this.camera.scale2D[1],r}screenRay(e){const i=this.screenToWorld(e);return[[i[0],i[1],0],[i[0],i[1],-1]]}worldToScreen(e,i){const n=[0,0];return n[0]=(e[0]*this.camera.scale2D[0]+this.camera.control2D.offset[0]*this.camera.scale2D[0])*this.pixelRatio,n[1]=(e[1]*this.camera.scale2D[1]+this.camera.control2D.offset[1]*this.camera.scale2D[1])*this.pixelRatio,this.viewToScreen(n,i)}viewToWorld(e,i){const n=i||[0,0],r=e;return n[0]=(r[0]-this.camera.control2D.offset[0]*this.camera.scale2D[0])/this.camera.scale2D[0],n[1]=(r[1]-this.camera.control2D.offset[1]*this.camera.scale2D[1])/this.camera.scale2D[1],n}worldToView(e,i){const n=i||[0,0];return n[0]=e[0]*this.camera.scale2D[0]+this.camera.control2D.offset[0]*this.camera.scale2D[0],n[1]=e[1]*this.camera.scale2D[1]+this.camera.control2D.offset[1]*this.camera.scale2D[1],n}}function uf(t){return t.projectionType===yi.ORTHOGRAPHIC}class ua extends Xr{constructor(e,i){super(e,i),this.projection=new m0,this.projection.camera=i.camera||new Ai}fitViewtoViewport(e,i){if(uf(this.props.camera)){const n=i.width,r=i.height,s={bottom:-r/2,far:1e7,left:-n/2,near:-100,right:n/2,top:r/2},a=1/this.pixelRatio,o=1/this.pixelRatio,c=this.props.camera;c.projectionOptions=Object.assign(c.projectionOptions,s),c.position=[i.width/(2*this.pixelRatio),i.height/(2*this.pixelRatio),c.position[2]],c.scale=[a,-o,1],c.lookAt(Rt(c.position,[0,0,-1]),[0,1,0]),c.update(),this.projection.viewBounds=i,i.d=this,this.projection.screenBounds=new te({height:this.viewBounds.height/this.pixelRatio,width:this.viewBounds.width/this.pixelRatio,x:this.viewBounds.x/this.pixelRatio,y:this.viewBounds.y/this.pixelRatio}),this.screenBounds.d=this}else uf(this.props.camera)||console.warn("View2D does not support non-orthographic cameras.")}willUpdateProps(e){this.projection.camera=e.camera}}ua.defaultProps={key:"",camera:new Ai,viewport:{left:0,right:0,bottom:0,top:0}};const v0=`precision highp float;
varying vec4 vertexColor;
void main() {
gl_FragColor = vertexColor;
}`,w0=`precision highp float;
varying vec4 vertexColor;
vec2 interpolation(float t, vec2 center, float radius, float start, float end) {
float angle = (end - start) * t + start;
return center + vec2(cos(angle) * radius, sin(angle) * radius);
}
void main() {
float startAngle = angle.x;
float endAngle = angle.y;
float widthStart = thickness.x;
float widthEnd = thickness.y;
vec4 centerClip = clipSpace(vec3(center, depth));
vec2 centerScreen = (centerClip.xy + vec2(1.0, 1.0)) * vec2(0.5, 0.5) * viewSize;
float normal = position.x;
float interpolationTime = position.y;
float interpolationIncrement = 1.0 / position.z;
vec2 currentPosition = interpolation(interpolationTime, centerScreen, radius, startAngle, endAngle);
vec2 currentNormal = normalize(currentPosition - centerScreen);
float lineThickness = mix(widthStart, widthEnd, interpolationTime) / 2.0;
vec2 vertex = currentPosition + currentNormal * (normal * lineThickness);
vertexColor = mix(colorStart, colorEnd, interpolationTime);
vertexColor *= vertexColor.a;
gl_Position = vec4((vertex / viewSize) * vec2(2.0, 2.0) - vec2(1.0, 1.0), centerClip.zw);
gl_PointSize = 5.0;
}`,T0=`\${import: arc}
precision highp float;
varying vec4 vertexColor;
void main() {
float startAngle = angle.x + angleOffset;
float endAngle = angle.y + angleOffset;
float widthStart = thickness.x;
float widthEnd = thickness.y;
float normal = vertex.x;
float interpolationTime = vertex.y;
float interpolationIncrement = 1.0 / vertex.z;
vec2 currentPosition = arc(interpolationTime, center, radius, startAngle, endAngle);
vec2 currentNormal = normalize(currentPosition - center);
float lineThickness = mix(widthStart, widthEnd, interpolationTime) / 2.0;
vec2 vertex = currentPosition + currentNormal * (normal * lineThickness);
vertexColor = mix(colorStart, colorEnd, interpolationTime);
gl_Position = clipSpace(vec3(vertex, depth));
}`;var hf=(t=>(t[t.NONE=0]="NONE",t[t.SCREEN_CURVE=1]="SCREEN_CURVE",t))(hf||{});const Si=class extends Ne{initShader(){const{scaleType:t}=this.props,e=this.props.animate||{},{angle:i,angleOffset:n,center:r,radius:s,thickness:a,colorStart:o,colorEnd:c}=e,l=150,u={0:1,[l*2+2]:-1},h={0:0,[l*2+2]:1};let f=1;for(let g=0;g<l*2;++g)u[g+1]=f,h[g+1]=Math.floor(g/2)/(l-1),f*=-1;const p=t===0?T0:w0;return{fs:v0,instanceAttributes:[{easing:r,name:Si.attributeNames.center,size:C.TWO,update:g=>g.center},{easing:s,name:Si.attributeNames.radius,size:C.ONE,update:g=>[g.radius]},{name:Si.attributeNames.depth,size:C.ONE,update:g=>[g.depth]},{easing:a,name:Si.attributeNames.thickness,size:C.TWO,update:g=>g.thickness},{easing:i,name:Si.attributeNames.angle,size:C.TWO,update:g=>g.angle},{easing:n,name:Si.attributeNames.angleOffset,size:C.ONE,update:g=>[g.angleOffset]},{easing:o,name:Si.attributeNames.colorStart,size:C.FOUR,update:g=>g.colorStart},{easing:c,name:Si.attributeNames.colorEnd,size:C.FOUR,update:g=>g.colorEnd}],uniforms:[{name:"scaleFactor",size:E.ONE,update:g=>[1]}],vertexAttributes:[{name:"vertex",size:Be.THREE,update:g=>[u[g],h[g],l*2]}],vertexCount:l*2+2,vs:p}}getMaterialOptions(){return Object.assign({},tt.transparentShapeBlending,{culling:d.GLSettings.Material.CullSide.NONE})}};let Gc=Si;Gc.defaultProps={data:new he,key:"",scaleType:0},Gc.attributeNames={angle:"angle",angleOffset:"angleOffset",center:"center",colorEnd:"colorEnd",colorStart:"colorStart",depth:"depth",radius:"radius",thickness:"thickness"};var y0=Object.defineProperty,b0=Object.getOwnPropertyDescriptor,nn=(t,e,i,n)=>{for(var r=n>1?void 0:n?b0(e,i):e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(r=(n?a(e,i,r):a(r))||r);return n&&r&&y0(e,i,r),r};const df=class extends ze{constructor(t){super(t),this.angle=[0,Math.PI],this.colorEnd=[1,1,1,1],this.colorStart=[1,1,1,1],this.center=[0,0],this.depth=0,this.angleOffset=0,this.radius=1,this.thickness=[5,5],He(this,df),this.angle=t.angle||this.angle,this.colorEnd=t.colorEnd||this.colorEnd,this.colorStart=t.colorStart||this.colorStart,this.center=t.center||this.center,this.depth=t.depth||this.depth,this.radius=t.radius||this.radius,this.thickness=t.thickness||this.thickness}};let Mi=df;nn([M],Mi.prototype,"angle",2),nn([M],Mi.prototype,"colorEnd",2),nn([M],Mi.prototype,"colorStart",2),nn([M],Mi.prototype,"center",2),nn([M],Mi.prototype,"depth",2),nn([M],Mi.prototype,"angleOffset",2),nn([M],Mi.prototype,"radius",2),nn([M],Mi.prototype,"thickness",2);const E0=`precision highp float;
varying vec4 vertexColor;
varying float edgeSharpness;
varying float edgeSharpnessBase;
varying vec2 pointCoord;
float circle(vec2 coord, float radius){
vec2 dist = coord - vec2(0.5);
return 1.0 - smoothstep(
radius - (radius * edgeSharpness),
radius + (radius * edgeSharpnessBase),
dot(dist, dist) * 4.0
);
}
void main() {
float step_factor = circle(pointCoord, 1.0);
\${out: color} = mix(
vec4(0.0, 0.0, 0.0, 0.0),
vertexColor,
step_factor
);
if (color.a == 0.0) discard;
}`,_0=`precision highp float;
varying vec4 vertexColor;
varying float edgeSharpness;
varying float edgeSharpnessBase;
float circle(vec2 coord, float radius){
vec2 dist = coord - vec2(0.5);
return 1.0 - smoothstep(
radius - (radius * edgeSharpness),
radius + (radius * edgeSharpnessBase),
dot(dist, dist) * 4.0
);
}
void main() {
float step_factor = circle(gl_PointCoord, 1.0);
\${out: color} = mix(
vec4(0.0, 0.0, 0.0, 0.0),
vertexColor,
step_factor
);
if (color.a == 0.0) discard;
}`,R0=`precision highp float;
varying vec4 vertexColor;
varying float edgeSharpness;
varying float edgeSharpnessBase;
void main() {
vertexColor = color;
vertexColor.a *= layerOpacity;
float size = radius * cameraScale2D.x;
edgeSharpness = mix(0.8, 0.0, min((size * 6.0 * pixelRatio) / (45.0 * pixelRatio), 1.0));
edgeSharpnessBase = mix(0.1, 0.0, min((size * 6.0 * pixelRatio) / (45.0 * pixelRatio), 1.0));
gl_Position = clipSpace(vec3(center, depth));
gl_PointSize = size * 2.0 * pixelRatio;
}`,x0=`precision highp float;
varying vec4 vertexColor;
varying float edgeSharpness;
varying float edgeSharpnessBase;
varying vec2 pointCoord;
void main() {
vertexColor = color;
vertexColor.a *= layerOpacity;
float size = radius * cameraScale2D.x * pixelRatio;
edgeSharpness = mix(0.8, 0.0, min((size * 6.0 * pixelRatio) / (45.0 * pixelRatio), 1.0));
edgeSharpnessBase = mix(0.1, 0.0, min((size * 6.0 * pixelRatio) / (45.0 * pixelRatio), 1.0));
pointCoord = (normals.xy + vec2(1.0, 1.0)) / 2.0;
vec4 clipCenter = clipSpace(vec3(center, depth));
vec2 screenCenter = (clipCenter.xy + vec2(1.0, 1.0)) * vec2(0.5, 0.5) * viewSize;
vec2 vertex = (normals.xy * size) + screenCenter;
gl_Position = vec4((vertex / viewSize) * vec2(2.0, 2.0) - vec2(1.0, 1.0), clipCenter.zw);
}`,Yr=class extends Ne{initShader(){const{animate:t={},usePoints:e=!1,opacity:i=()=>1}=this.props,{center:n,radius:r,color:s}=t,a={0:1,1:1,2:-1,3:1,4:-1,5:-1},o={0:-1,1:-1,2:-1,3:1,4:1,5:1},c=[{name:"normals",size:Be.TWO,update:u=>[a[u],o[u]]}],l=6;return{drawMode:e?d.GLSettings.Model.DrawMode.POINTS:d.GLSettings.Model.DrawMode.TRIANGLE_STRIP,fs:e?[{outputType:$.COLOR,source:_0},{outputType:$.GLOW,source:`
              void main() {
                \${out: glow} = color;
              }
              `}]:[{outputType:$.COLOR,source:E0},{outputType:$.GLOW,source:`
              void main() {
                \${out: glow} = color;
              }
              `}],instanceAttributes:[{easing:n,name:Yr.attributeNames.center,size:C.TWO,update:u=>u.center},{easing:r,name:Yr.attributeNames.radius,size:C.ONE,update:u=>[u.radius]},{name:Yr.attributeNames.depth,size:C.ONE,update:u=>[u.depth]},{easing:s,name:Yr.attributeNames.color,size:C.FOUR,update:u=>u.color}],uniforms:[{name:"layerOpacity",size:E.ONE,update:u=>[i()]}],vertexAttributes:e?void 0:c,vertexCount:e?0:l,vs:e?R0:x0}}getMaterialOptions(){return tt.transparentShapeBlending}};let kc=Yr;kc.defaultProps={data:new he,key:""},kc.attributeNames={center:"center",color:"color",depth:"depth",radius:"radius"};var A0=Object.defineProperty,S0=Object.getOwnPropertyDescriptor,ha=(t,e,i,n)=>{for(var r=n>1?void 0:n?S0(e,i):e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(r=(n?a(e,i,r):a(r))||r);return n&&r&&A0(e,i,r),r};const ff=class extends ze{constructor(t){super(t),this.color=[1,1,1,1],this.depth=0,this.radius=0,this.center=[0,0],He(this,ff),this.color=t.color||this.color,this.radius=t.radius||this.radius,this.center=t.center||this.center,this.depth=t.depth||this.depth}get width(){return this.radius*2}get height(){return this.radius*2}};let qr=ff;ha([M],qr.prototype,"color",2),ha([M],qr.prototype,"depth",2),ha([M],qr.prototype,"radius",2),ha([M],qr.prototype,"center",2);var Kr=(t=>(t[t.NONE=0]="NONE",t[t.SCREEN_CURVE=1]="SCREEN_CURVE",t))(Kr||{}),ii=(t=>(t[t.LINE=0]="LINE",t[t.BEZIER=1]="BEZIER",t[t.BEZIER2=2]="BEZIER2",t))(ii||{}),zc=(t=>(t[t.ALL=0]="ALL",t[t.PASS_Y=1]="PASS_Y",t[t.PASS_X=2]="PASS_X",t))(zc||{});const M0=`precision highp float;
varying vec4 vertexColor;
\${interpolation}
void main() {
float normal = vertex.x;
float interpolationTime = vertex.y;
float interpolationIncrement = 1.0 / vertex.z;
vec2 currentPosition = interpolation(interpolationTime, start, end, control.xy, control.zw);
vec2 prePosition = interpolation(interpolationTime - interpolationIncrement, start, end, control.xy, control.zw);
vec2 nextPosition = interpolation(interpolationTime + interpolationIncrement, start, end, control.xy, control.zw);
vec2 preLine = prePosition - currentPosition;
vec2 nextLine = nextPosition - currentPosition;
vec2 currentNormal = mix(
normalize(vec2(preLine.y, -preLine.x)),
mix(
normalize(vec2(preLine.y, -preLine.x) + vec2(-nextLine.y, nextLine.x)),
normalize(vec2(-nextLine.y, nextLine.x)),
float(vertex.x >= 1.0)
),
float(vertex.x > 0.0)
);
float lineThickness = mix(thickness.x, thickness.y, interpolationTime) / 2.0;
vec2 vertexPos = currentPosition + currentNormal * (normal * lineThickness);
vertexColor = mix(startColor, endColor, interpolationTime);
gl_Position = clipSpace(vec3(vertexPos, depth));
gl_PointSize = 5.0;
}`,I0=`vec2 interpolation(float t, vec2 p1, vec2 p2, vec2 c1, vec2 c2) {
float t1 = 1.0 - t;
return pow(t1, 3.0) * p1 + 3.0 * t * pow(t1, 2.0) * c1 + 3.0 * pow(t, 2.0) * t1 * c2 + pow(t, 3.0) * p2;
}`,L0=`vec2 interpolation(float t, vec2 p1, vec2 p2, vec2 c1, vec2 c2) {
return (1.0 - t) * (1.0 - t) * p1 + 2.0 * t * (1.0 - t) * c1 + t * t * p2;
}`,C0=`precision highp float;
varying vec4 vertexColor;
void main() {
gl_FragColor = vertexColor;
}`,O0=`vec2 interpolation(float t, vec2 p1, vec2 p2, vec2 c1, vec2 c2) {
return p1 + (p2 - p1) * t;
}`,N0=`precision highp float;
varying vec4 vertexColor;
\${interpolation}
void main() {
float normal = vertex.x;
float interpolationTime = vertex.y;
float interpolationIncrement = 1.0 / vertex.z;
vec4 startClip = clipSpace(vec3(start, depth));
vec4 endClip = clipSpace(vec3(end, depth));
vec2 startScreen = (startClip.xy + vec2(1.0, 1.0)) * vec2(0.5, 0.5) * viewSize;
vec2 endScreen = (endClip.xy + vec2(1.0, 1.0)) * vec2(0.5, 0.5) * viewSize;
vec2 control1 = startScreen + vec2(control.x, -control.y) * scaleFactor;
vec2 control2 = endScreen + vec2(control.z, -control.w) * scaleFactor;
vec2 currentPosition = interpolation(interpolationTime, startScreen, endScreen, control1, control2);
vec2 prePosition = interpolation(interpolationTime - interpolationIncrement, startScreen, endScreen, control1, control2);
vec2 nextPosition = interpolation(interpolationTime + interpolationIncrement, startScreen, endScreen, control1, control2);
vec2 preLine = prePosition - currentPosition;
vec2 nextLine = nextPosition - currentPosition;
vec2 currentNormal = mix(
normalize(vec2(preLine.y, -preLine.x)),
mix(
normalize(vec2(preLine.y, -preLine.x) + vec2(-nextLine.y, nextLine.x)),
normalize(vec2(-nextLine.y, nextLine.x)),
float(vertex.x >= 1.0)
),
float(vertex.x > 0.0)
);
float lineThickness = mix(thickness.x, thickness.y, interpolationTime) / 2.0;
vec2 vertexPos = currentPosition + currentNormal * (-normal * lineThickness * scaleFactor);
vertexColor = mix(startColor, endColor, interpolationTime);
gl_Position = vec4((vertexPos / viewSize) * vec2(2.0, 2.0) - vec2(1.0, 1.0), startClip.zw);
gl_PointSize = 5.0;
}`;function P0(t){return[t[0][0],t[0][1],t[1][0],t[1][1]]}const D0={[ii.LINE]:O0,[ii.BEZIER]:L0,[ii.BEZIER2]:I0},ni=class extends Ne{initShader(){const{animate:t={},scaleFactor:e=()=>1,type:i,scaleType:n=Kr.NONE,smoothness:r=50}=this.props,{end:s,start:a,startColor:o,endColor:c,control:l,thickness:u}=t,h=i===ii.LINE?2:r,f={0:1,[h*2+2]:-1},p={0:0,[h*2+2]:1};let g=1;for(let w=0;w<h*2;++w)f[w+1]=g,p[w+1]=Math.floor(w/2)/(h-1),g*=-1;const m={interpolation:D0[i]},T=Ki({options:m,required:{name:"Edge Layer",values:["interpolation"]},shader:n===Kr.NONE?M0:N0,onToken:(w,y)=>w in m?y:`\${${w}}`});return{fs:C0,instanceAttributes:[{easing:o,name:ni.attributeNames.startColor,size:C.FOUR,update:w=>w.startColor},{easing:c,name:ni.attributeNames.endColor,size:C.FOUR,update:w=>w.endColor},{easing:a,name:ni.attributeNames.start,size:C.TWO,update:w=>w.start},{easing:s,name:ni.attributeNames.end,size:C.TWO,update:w=>w.end},{easing:u,name:ni.attributeNames.thickness,size:C.TWO,update:w=>w.thickness},{name:ni.attributeNames.depth,size:C.ONE,update:w=>[w.depth]},i===ii.LINE?{easing:l,name:ni.attributeNames.control,size:C.FOUR,update:w=>[0,0,0,0]}:null,i===ii.BEZIER?{easing:l,name:ni.attributeNames.control,size:C.FOUR,update:w=>[w.control[0][0],w.control[0][1],0,0]}:null,i===ii.BEZIER2?{easing:l,name:ni.attributeNames.control,size:C.FOUR,update:w=>P0(w.control)}:null],uniforms:[{name:"scaleFactor",size:E.ONE,update:w=>[e()]},{name:"layerOpacity",size:E.ONE,update:w=>[this.props.opacity===void 0?1:this.props.opacity]}],vertexAttributes:[{name:"vertex",size:Be.THREE,update:w=>[f[w],p[w],h*2]}],vertexCount:h*2+2,vs:T.shader}}getMaterialOptions(){return tt.transparentShapeBlending}};let Vc=ni;Vc.defaultProps={broadphase:zc.ALL,data:new he,key:"none",scaleType:Kr.NONE,type:ii.LINE},Vc.attributeNames={control:"control",depth:"depth",end:"end",endColor:"endColor",start:"start",startColor:"startColor",thickness:"thickness"};var F0=Object.defineProperty,B0=Object.getOwnPropertyDescriptor,Ln=(t,e,i,n)=>{for(var r=n>1?void 0:n?B0(e,i):e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(r=(n?a(e,i,r):a(r))||r);return n&&r&&F0(e,i,r),r};const pf=class extends ze{constructor(t){super(t),this.control=[[0,0],[0,0]],this.depth=0,this.end=[0,0],this.endColor=[1,1,1,1],this.start=[0,0],this.startColor=[1,1,1,1],this.thickness=[1,1],He(this,pf),this.startColor=t.startColor||this.startColor,this.endColor=t.endColor||this.endColor,this.control=t.control||this.control,this.depth=t.depth||this.depth,this.end=t.end||this.end,this.thickness=t.thickness||this.thickness,this.start=t.start||this.start}get length(){const t=[this.end[0]-this.start[0],this.end[1]-this.start[1]];return Math.sqrt(t[0]*t[0]+t[1]*t[1])}get midpoint(){return 0}get perpendicular(){const t=this.length;return[(this.end[1]-this.start[1])/t,-(this.end[0]-this.start[0])/t]}setEdgeThickness(t){this.thickness=[t,t]}setColor(t){this.startColor=At(t),this.endColor=At(t)}};let rn=pf;Ln([M],rn.prototype,"control",2),Ln([M],rn.prototype,"depth",2),Ln([M],rn.prototype,"end",2),Ln([M],rn.prototype,"endColor",2),Ln([M],rn.prototype,"start",2),Ln([M],rn.prototype,"startColor",2),Ln([M],rn.prototype,"thickness",2);const Te=xe("video");function U0(t){Te.enabled&&(t.addEventListener("abort",()=>Te("abort")),t.addEventListener("canplay",()=>Te("canplay")),t.addEventListener("canplaythrough",()=>Te("canplaythrough")),t.addEventListener("durationchange",()=>Te("durationchange")),t.addEventListener("emptied",()=>Te("emptied")),t.addEventListener("ended",()=>Te("ended")),t.addEventListener("error",()=>Te("error")),t.addEventListener("loadeddata",()=>Te("loadeddata")),t.addEventListener("loadedmetadata",()=>Te("loadedmetadata")),t.addEventListener("loadstart",()=>Te("loadstart")),t.addEventListener("pause",()=>Te("pause")),t.addEventListener("play",()=>Te("play")),t.addEventListener("playing",()=>Te("playing")),t.addEventListener("progress",()=>Te("progress")),t.addEventListener("ratechange",()=>Te("ratechange")),t.addEventListener("seeked",()=>Te("seeked")),t.addEventListener("seeking",()=>Te("seeking")),t.addEventListener("stalled",()=>Te("stalled")),t.addEventListener("suspend",()=>Te("suspend")),t.addEventListener("timeupdate",()=>Te("timeupdate")),t.addEventListener("volumechange",()=>Te("volumechange")),t.addEventListener("waiting",()=>Te("waiting")))}const G0=`precision highp float;
varying vec4 vertexColor;
varying vec2 texCoord;
void main() {
gl_FragColor = texture2D(imageAtlas, texCoord) * vertexColor;
gl_FragColor = gl_FragColor * gl_FragColor.a;
}`,k0=`precision highp float;
varying vec4 vertexColor;
varying vec2 texCoord;
void main() {
float normal = normals.x;
float side = normals.y;
vec2 vertex = vec2(side, float(normal == 1.0f)) * size - anchor;
float crotation = cos(rotation);
float srotation = sin(rotation);
vertex = vec2(crotation * vertex.x - srotation * vertex.y, srotation * vertex.x + crotation * vertex.y);
vertex += location;
gl_Position = clipSpace(vec3(vertex, depth));
texCoord = texture.xy + ((texture.zw - texture.xy) * vec2(side, float(normal == -1.0f)));
vertexColor = tint;
}`,z0=`precision highp float;
varying vec4 vertexColor;
varying vec2 texCoord;
void main() {
vec3 screenSize = cameraSpaceSize(vec3(size, 1.0));
bool largerOnScreen = screenSize.y > size.y;
float useScaleMode = float(
(
scaling == 3.0 ||
(largerOnScreen && scaling == 2.0)
) &&
scaling != 1.0
);
float unequalZooms = float(cameraScale2D.x != cameraScale2D.y);
float normal = normals.x;
float side = normals.y;
vec2 worldAnchor = location + anchor;
texCoord = texture.xy + ((texture.zw - texture.xy) * vec2(side, float(normal == -1.0)));
vertexColor = tint;
vec2 adjustedSize = mix(
size,
(size * cameraScale2D.yx),
unequalZooms
);
vec2 adjustedAnchor = mix(
anchor,
(anchor * cameraScale2D.yx),
unequalZooms
);
vec2 vertex = vec2(side, float(normal == 1.0)) * adjustedSize + location - adjustedAnchor;
float imageScreenScale = mix(
screenSize.y / adjustedSize.y,
screenSize.x / adjustedSize.x,
float((cameraScale2D.x < 1.0) || (cameraScale2D.x > 1.0))
);
vec2 anchorToVertex = vertex - location;
vertex = mix(
vertex,
(anchorToVertex / imageScreenScale) + location,
useScaleMode
);
gl_Position = clipSpace(vec3(vertex, depth));
}`,Ii=class extends Ne{constructor(t,e,i){super(t,e,i)}initShader(){const t=this.props.animate||{},{tint:e,location:i,size:n,rotation:r}=t,s={0:1,1:1,2:-1,3:1,4:-1,5:-1},a={0:0,1:0,2:0,3:1,4:1,5:1};return{fs:G0,instanceAttributes:[this.props.enableRotation?{easing:r,name:Ii.attributeNames.rotation,size:C.ONE,update:o=>[o.rotation]}:null,{easing:i,name:Ii.attributeNames.location,size:C.TWO,update:o=>o.origin},{name:Ii.attributeNames.anchor,size:C.TWO,update:o=>[o.anchor.x||0,o.anchor.y||0]},{easing:n,name:Ii.attributeNames.size,size:C.TWO,update:o=>[o.width,o.height]},{name:Ii.attributeNames.depth,size:C.ONE,update:o=>[o.depth]},{name:Ii.attributeNames.scaling,size:C.ONE,update:o=>[o.scaling]},{name:Ii.attributeNames.texture,resource:{key:()=>this.props.atlas||"",name:"imageAtlas"},update:o=>(o.source,o.request?this.resource.request(this,o,o.request):(console.warn("An image utilizing the image-render-layer does not have its request specified yet.","The image-render-layer does NOT manage requests and should be handled before this layer deals with the instance"),[0,0,0,0]))},{easing:e,name:Ii.attributeNames.tint,size:C.FOUR,update:o=>o.tint}],uniforms:[{name:"scaleFactor",size:E.ONE,update:o=>[1]}],vertexAttributes:[{name:"normals",size:Be.TWO,update:o=>[s[o],a[o]]}],vertexCount:6,vs:this.props.enableRotation?k0:z0}}getMaterialOptions(){return tt.transparentImageBlending}};let Wc=Ii;Wc.defaultProps={key:"",data:new he},Wc.attributeNames={location:"location",anchor:"anchor",size:"size",depth:"depth",scaling:"scaling",texture:"texture",tint:"tint",rotation:"rotation"};function Zr(t){return t&&t.videoSrc}const da=new Image;da.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";class gf extends Ne{constructor(){super(...arguments),this.childProvider=new he,this.imageToResource=new Map,this.sourceToRequest=new Map,this.sourceToVideo=new Map,this.usingVideo=new Map,this.waitingForVideo=new Map,this.waitForVideoSource=new Map,this.originalOnReadyCallbacks=new Map}childLayers(){return[_n(Wc,{...this.props,key:`${this.props.key}.image-render-layer`})]}destroy(){super.destroy(),this.sourceToVideo.forEach(e=>{e.pause(),this.sourceToVideo.clear(),this.waitingForVideo.clear(),this.waitForVideoSource.clear()})}draw(){const e=this.resolveChanges(!0);if(this.updateAnimationState(),e.length<=0)return;this.propertyIds||(this.propertyIds=this.getInstanceObservableIds(e[0][0],["source"]));const{source:i}=this.propertyIds;for(let r=0,s=e.length;r<s;++r){const[a,o,c]=e[r];switch(o){case Le.CHANGE:if(c[i]!==void 0){const l=this.imageToResource.get(a);let u=this.getAtlasSource(a);if(u===l)break;if(l instanceof HTMLVideoElement){const h=this.waitForVideoSource.get(a);if(h){this.waitForVideoSource.delete(a);const p=this.waitingForVideo.get(h);p&&p.delete(a)}let f=this.usingVideo.get(l.getAttribute("data-source")||"");f||(f=new Set),f.delete(a),f.size<=0&&this.sourceToVideo.delete(l.getAttribute("data-source")||""),a.onReady=this.originalOnReadyCallbacks.get(a)}if(Zr(a.source)&&(this.prepareVideo(a,a.source),u=this.getAtlasSource(a),qi(this.usingVideo,a.source.videoSrc,new Set).add(a)),this.imageToResource.set(a,u),this.resource.request(this,a,Yn({key:this.props.atlas||"",disposeResource:!0,source:l})),u){let h=this.sourceToRequest.get(u);(!h||h.texture&&!h.texture.isValid)&&(h=Yn({key:this.props.atlas||"",source:u,rasterizationScale:this.props.rasterizationScale}),this.sourceToRequest.set(u,h)),a.request=h,this.resource.request(this,a,h)}}break;case Le.INSERT:if(a.source){let l=this.getAtlasSource(a);Zr(a.source)&&(this.prepareVideo(a,a.source),l=this.getAtlasSource(a),qi(this.usingVideo,a.source.videoSrc,new Set).add(a));let u=this.sourceToRequest.get(l);(!u||u.texture&&!u.texture.isValid)&&(u=Yn({key:this.props.atlas||"",source:l,rasterizationScale:this.props.rasterizationScale}),this.sourceToRequest.set(l,u)),a.request=u}break;case Le.REMOVE:{const l=this.getAtlasSource(a);if(this.imageToResource.delete(a),Zr(a.source)){const u=this.waitForVideoSource.get(a);if(u){this.waitForVideoSource.delete(a);const f=this.waitingForVideo.get(u);f&&f.delete(a)}let h=this.usingVideo.get(a.source.videoSrc);h||(h=new Set),h.delete(a),h.size<=0&&this.sourceToVideo.delete(a.source.videoSrc),this.originalOnReadyCallbacks.delete(a)}this.resource.request(this,a,Yn({key:this.props.atlas||"",disposeResource:!0,source:l}));break}}}const n=[];this.usingVideo.forEach((r,s)=>{r.size<=0&&n.push(s)});for(let r=0,s=n.length;r<s;++r){const a=n[r];this.usingVideo.delete(a),this.sourceToVideo.delete(a)}}getAtlasSource(e){return Zr(e.source)?this.sourceToVideo.get(e.source.videoSrc)||da:e.source}prepareVideo(e,i){const n=this.sourceToVideo.get(i.videoSrc);if(this.originalOnReadyCallbacks.get(e)||this.originalOnReadyCallbacks.set(e,e.onReady),n){const p=this.waitingForVideo.get(i.videoSrc);if(p)p.add(e),this.waitForVideoSource.set(e,i.videoSrc),e.onReady=void 0,e.source=da,e.videoLoad=()=>{n.load(),i.autoPlay&&n.play()};else{const g=this.originalOnReadyCallbacks.get(e)||e.onReady;if(!g)return;e.onReady=m=>{g(m,n)}}return}const s=document.createElement("video");this.sourceToVideo.set(i.videoSrc,s),s.setAttribute("data-source",i.videoSrc),U0(s);const a=new ke,o=new ke,c=()=>{s.removeEventListener("loadedmetadata",u),s.removeEventListener("loadeddata",l),s.removeEventListener("error",h),this.waitingForVideo.delete(i.videoSrc),this.waitForVideoSource.delete(e)},l=()=>{o.resolve()},u=()=>{a.resolve()},h=p=>{let g;p.path&&p.path[0]&&(g=p.path[0].error),p.originalTarget&&(g=p.originalTarget.error),console.warn("There was an error loading the video resource to the atlas texture context"),console.warn(g),a.reject({}),o.reject({})};s.addEventListener("loadedmetadata",u),s.addEventListener("loadeddata",l),s.addEventListener("error",h),e.onReady=void 0,qi(this.waitingForVideo,i.videoSrc,new Set).add(e),this.waitForVideoSource.set(e,i.videoSrc),e.source=da,e.videoLoad=()=>{s.load(),i.autoPlay&&s.play()},s.muted=!0,s.src=i.videoSrc,Promise.all([a.promise,o.promise]).then(()=>{s.currentTime=0,i.autoPlay&&s.play();const p=this.waitingForVideo.get(i.videoSrc);p&&p.forEach(g=>{g.source=i,g.onReady=this.originalOnReadyCallbacks.get(g)}),c()}).catch(()=>{c()})}updateAnimationState(){let e=!1;this.sourceToVideo.forEach(i=>{i.paused||(e=!0)}),this.alwaysDraw=this.usingVideo.size>0&&e}initShader(){return null}}gf.defaultProps={atlas:"default",key:"",data:new he};var V0=Object.defineProperty,W0=Object.getOwnPropertyDescriptor,Li=(t,e,i,n)=>{for(var r=n>1?void 0:n?W0(e,i):e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(r=(n?a(e,i,r):a(r))||r);return n&&r&&V0(e,i,r),r};const{max:$0}=Math,j0={[P.TopLeft]:(t,e)=>{t.x=-t.padding,t.y=-t.padding},[P.TopMiddle]:(t,e)=>{t.x=e.width/2,t.y=-t.padding},[P.TopRight]:(t,e)=>{t.x=e.width+t.padding,t.y=-t.padding},[P.MiddleLeft]:(t,e)=>{t.x=-t.padding,t.y=e.height/2},[P.Middle]:(t,e)=>{t.x=e.width/2,t.y=e.height/2},[P.MiddleRight]:(t,e)=>{t.x=e.width+t.padding,t.y=e.height/2},[P.BottomLeft]:(t,e)=>{t.x=-t.padding,t.y=e.height+t.padding},[P.BottomMiddle]:(t,e)=>{t.x=e.width/2,t.y=e.height+t.padding},[P.BottomRight]:(t,e)=>{t.x=e.width+t.padding,t.y=e.height+t.padding},[P.Custom]:(t,e)=>{t.x=t.x||0,t.y=t.y||0}},mf=class extends ze{constructor(t){super(t),this.tint=[0,0,0,1],this.depth=0,this.height=1,this.origin=[0,0],this.scaling=ti.BOUND_MAX,this.width=1,this.rotation=0,this.sourceWidth=0,this.sourceHeight=0,this._anchor={padding:0,type:P.TopLeft,x:0,y:0},this.videoLoad=xs,He(this,mf),this.depth=t.depth||this.depth,this.tint=t.tint||this.tint,this.scaling=t.scaling||this.scaling,this.origin=t.origin||this.origin,this.width=t.width||1,this.height=t.height||1,this.source=t.source,this.rotation=t.rotation||0,this.onReady=t.onReady,t.anchor&&this.setAnchor(t.anchor)}get maxSize(){return $0(this.width,this.height)}set maxSize(t){const e=this.width/this.height;this.width=t*e,this.height=t}get anchor(){return this._anchor}resourceTrigger(){this.source=this.source,this.request&&this.request.texture&&(this.sourceWidth=this.request.texture.pixelWidth,this.sourceHeight=this.request.texture.pixelHeight),this.onReady&&this.onReady(this)}setAnchor(t){const e={padding:t.padding||0,type:t.type,x:t.x||0,y:t.y||0};j0[e.type](e,this),this._anchor=e}};let ri=mf;Li([M],ri.prototype,"tint",2),Li([M],ri.prototype,"depth",2),Li([M],ri.prototype,"height",2),Li([M],ri.prototype,"origin",2),Li([M],ri.prototype,"scaling",2),Li([M],ri.prototype,"source",2),Li([M],ri.prototype,"width",2),Li([M],ri.prototype,"rotation",2),Li([M],ri.prototype,"_anchor",2);var H0=Object.defineProperty,Q0=Object.getOwnPropertyDescriptor,Ci=(t,e,i,n)=>{for(var r=n>1?void 0:n?Q0(e,i):e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(r=(n?a(e,i,r):a(r))||r);return n&&r&&H0(e,i,r),r};const $c=class extends ze{constructor(t){super(t),this.anchor=[0,0],this.character="a",this.color=[1,1,1,1],this.depth=0,this.fontScale=1,this.maxScale=1,this.offset=[0,0],this.origin=[0,0],this.padding=[0,0],He(this,$c),this.origin=t.origin||this.origin,this.offset=t.offset||this.offset,this.character=t.character||this.character,this.color=t.color||this.color,this.maxScale=t.maxScale||this.maxScale,this.padding=t.padding||this.padding,this.anchor=t.anchor||this.anchor,this.onReady=t.onReady}clone(){const t=new $c(this);t.onReady=this.onReady,t.request=this.request}resourceTrigger(){this.offset=this.offset,this.origin=this.origin,this.character=this.character,this.color=this.color,this.onReady&&this.onReady(this)}};let wt=$c;Ci([M],wt.prototype,"anchor",2),Ci([M],wt.prototype,"character",2),Ci([M],wt.prototype,"color",2),Ci([M],wt.prototype,"depth",2),Ci([M],wt.prototype,"fontScale",2),Ci([M],wt.prototype,"maxScale",2),Ci([M],wt.prototype,"offset",2),Ci([M],wt.prototype,"origin",2),Ci([M],wt.prototype,"padding",2);const vf=`varying vec4 vertexColor;
varying vec2 texCoord;
void main() {
vec4 texColor = texture2D(fontMap, texCoord);
if (texColor.r <= 0.0) discard;
texColor.a = texColor.r;
gl_FragColor = texColor * vertexColor;
}`,wf=`varying vec4 vertexColor;
varying vec2 texCoord;
void main() {
vec2 pushOut = normals * glyphSize * fontScale;
vec3 position = vec3(origin + padding - anchor + offset + pushOut, depth);
gl_Position = clipSpace(position);
texCoord = texture.xy + (texture.zw - texture.xy) * normals;
vertexColor = color * color.a;
}`,X0=`varying vec4 vertexColor;
varying vec2 texCoord;
void main() {
vec4 texColor = texture2D(fontMap, texCoord);
if (texColor.r <= 0.0) discard;
texColor.a = texColor.r;
gl_FragColor = texColor * vertexColor;
}`,Y0=`varying vec4 vertexColor;
varying vec2 texCoord;
void main() {
vec2 scale = fontScale * cameraScale2D.xy;
float scaleBy = max(scale.x, scale.y) / maxScale;
vec2 pushOut = normals * glyphSize * fontScale;
float vx = mix(
(-anchor.x + offset.x + pushOut.x),
(-anchor.x + offset.x + pushOut.x) / scaleBy,
float(scale.x >= maxScale)
);
float vy = mix(
(-anchor.y + offset.y + pushOut.y),
(-anchor.y + offset.y + pushOut.y) / scaleBy,
float(scale.y >= maxScale)
);
vec3 position = vec3(origin + padding + vec2(vx, vy), depth);
gl_Position = clipSpace(position);
texCoord = texture.xy + (texture.zw - texture.xy) * normals;
vertexColor = color * color.a;
}`,q0=`varying vec4 vertexColor;
varying vec2 texCoord;
void main() {
vec4 texColor = texture2D(fontMap, texCoord);
if (texColor.r <= 0.0) discard;
texColor.a = texColor.r;
gl_FragColor = texColor * vertexColor;
}`,K0=`varying vec4 vertexColor;
varying vec2 texCoord;
void main() {
vec2 pushOut = normals * glyphSize * fontScale;
vec3 position = vec3(origin + padding + (-anchor + offset + pushOut) / cameraScale2D.xy, depth);
gl_Position = clipSpace(position);
texCoord = texture.xy + (texture.zw - texture.xy) * normals;
vertexColor = color * color.a;
}`,Z0=`varying vec4 vertexColor;
varying vec2 texCoord;
void main() {
vec4 texColor = texture2D(fontMap, texCoord);
if (texColor.r <= 0.0) discard;
texColor.a = texColor.r;
gl_FragColor = texColor * vertexColor;
}`,J0=`varying vec4 vertexColor;
varying vec2 texCoord;
void main() {
vec2 pushOut = normals * glyphSize * fontScale;
vec3 position = vec3(origin + padding + offset + pushOut, depth);
gl_Position = clipSpace(position);
texCoord = texture.xy + (texture.zw - texture.xy) * normals;
vertexColor = color * color.a;
}`,ev=`varying vec4 vertexColor;
varying vec2 texCoord;
void main() {
vec4 texColor = texture2D(fontMap, texCoord);
if (texColor.r <= 0.0) discard;
texColor.a = texColor.r;
gl_FragColor = texColor * vertexColor;
}`,tv=`varying vec4 vertexColor;
varying vec2 texCoord;
void main() {
vec2 scale = fontScale * cameraScale2D.xy;
float scaleBy = max(scale.x, scale.y) / maxScale;
vec2 pushOut = normals * glyphSize * fontScale;
float vx = mix(
(origin.x + padding.x + offset.x + pushOut.x),
origin.x + anchor.x + (padding.x - anchor.x + offset.x + pushOut.x) / scaleBy,
float(scale.x >= maxScale)
);
float vy = mix(
(origin.y + padding.y + offset.y + pushOut.y),
origin.y + anchor.y + (padding.y - anchor.y + offset.y + pushOut.y) / scaleBy,
float(scale.y >= maxScale)
);
vec3 position = vec3(vec2(vx, vy), depth);
gl_Position = clipSpace(position);
texCoord = texture.xy + (texture.zw - texture.xy) * normals;
vertexColor = color * color.a;
}`,iv=`varying vec4 vertexColor;
varying vec2 texCoord;
void main() {
vec4 texColor = texture2D(fontMap, texCoord);
if (texColor.r <= 0.0) discard;
texColor.a = texColor.r;
gl_FragColor = texColor * vertexColor;
}`,nv=`varying vec4 vertexColor;
varying vec2 texCoord;
void main() {
vec2 pushOut = normals * glyphSize * fontScale;
vec3 position = vec3(origin + anchor + (padding - anchor + offset + pushOut) / cameraScale2D.xy , depth);
gl_Position = clipSpace(position);
texCoord = texture.xy + (texture.zw - texture.xy) * normals;
vertexColor = color * color.a;
}`,er=class extends Ne{constructor(){super(...arguments),this.glyphRequests={}}initShader(){const t=this.props.animate||{},{anchor:e,color:i,offset:n,origin:r}=t,s={0:[0,0],1:[0,0],2:[1,0],3:[0,1],4:[1,1],5:[1,1]},a={name:"texture",resource:{key:()=>this.props.resourceKey||"",name:"fontMap"},update:h=>{const f=h.character;return(!h.request||h.character!==h.request.character)&&(this.glyphRequests[h.character]?h.request=this.glyphRequests[h.character]:(h.request=Sn({key:this.props.resourceKey||"",character:f}),this.glyphRequests[h.character]=h.request),h.request.fontMap&&h.onReady&&h.onReady(h)),h.request.fetch=An.TEXCOORDS,this.resource.request(this,h,h.request)}},o={name:"glyphSize",parentAttribute:a,resource:{key:()=>this.props.resourceKey||"",name:"fontMap"},size:C.TWO,update:h=>{const f=h.character;return(!h.request||h.character!==h.request.character)&&(this.glyphRequests[h.character]?h.request=this.glyphRequests[h.character]:(h.request=Sn({key:this.props.resourceKey||"",character:f}),this.glyphRequests[h.character]=h.request),h.request.fontMap&&h.onReady&&h.onReady(h)),h.request.fetch=An.IMAGE_SIZE,this.resource.request(this,h,h.request)}};a.childAttributes=[o];let c,l;switch(this.props.scaleMode||ti.ALWAYS){case ti.BOUND_MAX:{c=this.props.inTextArea?ev:X0,l=this.props.inTextArea?tv:Y0;break}case ti.NEVER:{c=this.props.inTextArea?q0:iv,l=this.props.inTextArea?nv:K0;break}case ti.ALWAYS:{c=this.props.inTextArea?Z0:vf,l=this.props.inTextArea?J0:wf;break}default:{c=vf,l=wf;break}}return{fs:c,instanceAttributes:[{easing:i,name:er.attributeNames.color,size:C.FOUR,update:h=>h.color},{name:er.attributeNames.depth,size:C.ONE,update:h=>[h.depth]},{name:"fontScale",size:C.ONE,update:h=>[h.fontScale]},{easing:e,name:er.attributeNames.anchor,size:C.TWO,update:h=>h.anchor},{easing:r,name:er.attributeNames.origin,size:C.TWO,update:h=>h.origin},{easing:n,name:er.attributeNames.offset,size:C.TWO,update:h=>h.offset},{name:"padding",size:C.TWO,update:h=>h.padding},{name:"maxScale",size:C.ONE,update:h=>[h.maxScale]},o,a],uniforms:[],vertexAttributes:[{name:"normals",size:Be.TWO,update:h=>s[h]}],vertexCount:6,vs:l}}draw(){super.draw()}getMaterialOptions(){return Object.assign({},tt.transparentImageBlending,{depthTest:!1})}willUpdateProps(t){t.resourceKey!==this.props.resourceKey&&(Object.values(this.glyphRequests).forEach(e=>{delete e.fontMap,e.key=t.resourceKey||""}),this.rebuildLayer())}};let fa=er;fa.defaultProps={key:"",data:new he,resourceKey:"No resource specified"},fa.attributeNames={color:"color",depth:"depth",anchor:"anchor",origin:"origin",offset:"offset"};const rv="...",Tf={[P.TopLeft]:(t,e)=>{t.x=0,t.y=0},[P.TopMiddle]:(t,e)=>{t.x=e.size[0]/2,t.y=0},[P.TopRight]:(t,e)=>{t.x=e.size[0],t.y=0},[P.MiddleLeft]:(t,e)=>{t.x=0,t.y=e.size[1]/2},[P.Middle]:(t,e)=>{t.x=e.size[0]/2,t.y=e.size[1]/2},[P.MiddleRight]:(t,e)=>{t.x=e.size[0],t.y=e.size[1]/2},[P.BottomLeft]:(t,e)=>{t.x=0,t.y=e.size[1]},[P.BottomMiddle]:(t,e)=>{t.x=e.size[0]/2,t.y=e.size[1]},[P.BottomRight]:(t,e)=>{t.x=e.size[0],t.y=e.size[1]},[P.Custom]:(t,e)=>{t.x=t.x||0,t.y=t.y||0}},sn=[[-1,-1],[0,-1],[1,-1],[-1,0],[0,0],[1,0],[-1,1],[0,1],[1,1]].map(t=>{const e=Math.sqrt(Dn(t,t));return Re(t,1/-e)}),yf={[P.TopLeft]:t=>{t.paddingDirection=Re(sn[0],t.padding)},[P.TopMiddle]:t=>{t.paddingDirection=Re(sn[1],t.padding)},[P.TopRight]:t=>{t.paddingDirection=Re(sn[2],t.padding)},[P.MiddleLeft]:t=>{t.paddingDirection=Re(sn[3],t.padding)},[P.Middle]:t=>{t.paddingDirection=[0,0]},[P.MiddleRight]:t=>{t.paddingDirection=Re(sn[5],t.padding)},[P.BottomLeft]:t=>{t.paddingDirection=Re(sn[6],t.padding)},[P.BottomMiddle]:t=>{t.paddingDirection=Re(sn[7],t.padding)},[P.BottomRight]:t=>{t.paddingDirection=Re(sn[8],t.padding)},[P.Custom]:t=>{t.paddingDirection=t.paddingDirection}};function Ve(t){if(t)return e=>{t({...e,instances:e.instances.map(i=>i.parentLabel).filter(me)})}}class jc extends Ne{constructor(){super(...arguments),this.fullUpdate=!1,this.glyphProvider=new he,this.labelToGlyphs=new Map,this.labelToKerningRequest=new Map,this.labelWaitingOnGlyph=new Map,this.truncationWidth=-1,this.handleGlyphReady=e=>{if(!e.parentLabel){delete e.onReady;return}const i=e.parentLabel,n=this.labelWaitingOnGlyph.get(e.parentLabel);if(n&&n.has(e)&&(n.delete(e),n.size<=0)){const r=i.onReady;r&&r(i)}}}childLayers(){return[_n(this.props.customGlyphLayer||fa,{animate:this.props.animate,data:this.glyphProvider,key:`${this.id}.glyphs`,resourceKey:this.props.resourceKey,scaleMode:this.props.scaleMode||ti.BOUND_MAX,inTextArea:this.props.inTextArea,picking:this.props.picking,onMouseClick:Ve(this.props.onMouseClick),onMouseUp:Ve(this.props.onMouseUp),onMouseDown:Ve(this.props.onMouseDown),onMouseOut:Ve(this.props.onMouseOut),onMouseOver:Ve(this.props.onMouseOver),onMouseMove:Ve(this.props.onMouseMove),onMouseUpOutside:Ve(this.props.onMouseUpOutside),onTap:Ve(this.props.onTap),onTouchDown:Ve(this.props.onTouchDown),onTouchUp:Ve(this.props.onTouchUp),onTouchUpOutside:Ve(this.props.onTouchUpOutside),onTouchMove:Ve(this.props.onTouchMove),onTouchOut:Ve(this.props.onTouchOut),onTouchOver:Ve(this.props.onTouchOver),onTouchAllEnd:Ve(this.props.onTouchAllEnd),onTouchAllOut:Ve(this.props.onTouchAllOut)})]}draw(){const e=this.resolveChanges();if(e.length<=0)return;if(!this.propertyIds){const h=e[0][0];this.propertyIds=this.getInstanceObservableIds(h,["text","active","anchor","color","origin","fontSize","maxWidth","maxScale","letterSpacing"])}const{text:i,active:n,anchor:r,color:s,origin:a,fontSize:o,maxWidth:c,maxScale:l,letterSpacing:u}=this.propertyIds;for(let h=0,f=e.length;h<f;++h){const[p,g,m]=e[h];switch(g){case Le.CHANGE:if(!this.labelToGlyphs.get(p)){this.insert(p);continue}m[i]!==void 0?(this.invalidateRequest(p),this.layoutGlyphs(p)):m[n]!==void 0&&(p.active?(this.layoutGlyphs(p),this.showGlyphs(p)):this.hideGlyphs(p)),m[r]&&this.updateAnchor(p),m[s]!==void 0&&this.updateGlyphColors(p),m[a]!==void 0&&this.updateGlyphOrigins(p),m[l]!==void 0&&this.updateGlyphMaxScales(p),m[o]!==void 0&&(this.invalidateRequest(p),this.layoutGlyphs(p)),m[c]!==void 0&&(this.invalidateRequest(p),this.layoutGlyphs(p)),m[u]!==void 0&&(this.invalidateRequest(p),this.layoutGlyphs(p));break;case Le.INSERT:this.insert(p);break;case Le.REMOVE:{const T=this.labelToGlyphs.get(p);if(T){for(let w=0,y=T.length;w<y;++w)this.glyphProvider.remove(T[w]);this.labelToGlyphs.delete(p),this.labelToKerningRequest.delete(p),this.labelWaitingOnGlyph.delete(p)}break}}}}insert(e){e.preload?this.props.data.remove(e):this.labelToGlyphs.get(e)||this.labelToGlyphs.set(e,[]),this.layoutGlyphs(e)}hideGlyphs(e){const i=this.labelToGlyphs.get(e);if(i)for(let n=0,r=i.length;n<r;++n)this.glyphProvider.remove(i[n])}initShader(){return null}invalidateRequest(e){this.labelToKerningRequest.delete(e)}layoutGlyphs(e){if(!this.updateKerning(e)||!e.active)return;const i=this.labelToKerningRequest.get(e);if(!i||!i.fontMap)return;const n=i.metrics;if(!n||!n.layout)return;const r=n.layout;this.updateGlyphs(e,r);const s=e.glyphs;e.size=r.size,Tf[e.anchor.type](e.anchor,e),yf[e.anchor.type](e.anchor);const a=e.anchor,o=e.anchor.paddingDirection;for(let c=0,l=Math.min(r.positions.length,s.length);c<l;++c){const u=r.positions[c],h=s[c];h.offset=u,h.fontScale=r.fontScale,h.anchor=[a.x||0,a.y||0],h.origin=os(e.origin),h.padding=o||[0,0],h.maxScale=e.maxScale}}managesInstance(e){return!!this.labelToGlyphs.get(e)}showGlyphs(e){const i=this.labelToGlyphs.get(e);if(i)for(let n=0,r=i.length;n<r;++n)this.glyphProvider.add(i[n])}updateAnchor(e){const i=e.glyphs;if(!i)return;Tf[e.anchor.type](e.anchor,e),yf[e.anchor.type](e.anchor);const n=e.anchor,r=e.anchor.paddingDirection;for(let s=0,a=i.length;s<a;++s)i[s].anchor=[n.x||0,n.y||0],i[s].padding=r||[0,0]}updateGlyphs(e,i){let n=this.labelToGlyphs.get(e);n||(n=[],this.labelToGlyphs.set(e,n));let r=this.labelWaitingOnGlyph.get(e);r||(r=new Set,this.labelWaitingOnGlyph.set(e,r));for(let s=0,a=Math.min(n.length,i.glyphs.length);s<a;++s){const o=n[s];o.character!==i.glyphs[s]&&(o.character=i.glyphs[s],(!o.request||!o.request.fontMap||!o.request.fontMap.glyphMap[o.character])&&r.add(o))}if(n.length<i.glyphs.length){let s=0;for(let a=n.length,o=i.glyphs.length;a<o;++a,++s){const c=i.glyphs[a],l=new wt({character:c,color:e.color,origin:e.origin,maxScale:e.maxScale,onReady:this.handleGlyphReady});l.parentLabel=e,n.push(l),e.active&&this.glyphProvider.add(l),r.add(l)}}else if(n.length>i.glyphs.length){for(let s=i.glyphs.length,a=n.length;s<a;++s){const o=n[s];this.glyphProvider.remove(o)}for(;n.length>i.glyphs.length;)n.pop()}e.glyphs=n}updateGlyphColors(e){const i=e.glyphs;if(i)for(let n=0,r=i.length;n<r;++n)i[n].color=At(e.color)}updateGlyphOrigins(e){const i=e.glyphs;if(!i)return;const n=e.origin;for(let r=0,s=i.length;r<s;++r)i[r].origin=[n[0],n[1]]}updateGlyphMaxScales(e){const i=e.glyphs;if(!i)return;const n=e.maxScale;for(let r=0,s=i.length;r<s;++r)i[r].maxScale=n}updateKerning(e){let i=this.labelToKerningRequest.get(e);const n=e.text;if(i){if(i.kerningPairs&&i.kerningPairs.indexOf(n)>-1)return!!i.fontMap;if(i.fontMap&&!i.fontMap.supportsKerning(n.replace(/\s/g,"")))this.labelToKerningRequest.delete(e),i=void 0;else return!0}if(!i){const r={fontSize:e.fontSize,text:e.text,letterSpacing:e.letterSpacing};return e.maxWidth>0&&(r.maxWidth=e.maxWidth,r.truncation=this.props.truncation||rv),i=Sn({key:this.props.resourceKey||"",character:"",kerningPairs:[n],metrics:r}),e.preload?(e.resourceTrigger=()=>{e.onReady&&e.onReady(e)},this.resource.request(this,e,i)):(this.resource.request(this,e,i,{resource:{type:le.FONT,key:this.props.resourceKey||""}}),this.labelToKerningRequest.set(e,i)),!1}return!0}willUpdateProps(e){e.data!==this.props.data&&delete this.propertyIds,e.scaleMode!==this.props.scaleMode&&this.rebuildLayer(),e.resourceKey!==this.props.resourceKey&&(this.fullUpdate=!0)}}jc.defaultProps={key:"",data:new he};var sv=Object.defineProperty,av=Object.getOwnPropertyDescriptor,si=(t,e,i,n)=>{for(var r=n>1?void 0:n?av(e,i):e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(r=(n?a(e,i,r):a(r))||r);return n&&r&&sv(e,i,r),r};const bf=class extends ze{constructor(t){super(t),this.color=[0,0,0,1],this.depth=0,this.fontSize=12,this.maxScale=1,this.maxWidth=0,this.origin=[0,0],this.scale=1,this.text="",this.letterSpacing=0,this.preload=!1,this.glyphs=[],this.size=[0,0],this.truncatedText="",this.anchor={padding:0,paddingDirection:[0,0],type:P.TopLeft,x:0,y:0},He(this,bf),this.anchor=t.anchor||this.anchor,this.color=t.color||this.color,this.depth=t.depth||this.depth,this.fontSize=t.fontSize||this.fontSize,this.maxScale=t.maxScale||this.maxScale,this.maxWidth=t.maxWidth||0,this.onReady=t.onReady,this.origin=t.origin,this.preload=t.preload||!1,this.scale=t.scale||this.scale,this.text=t.text||this.text,this.letterSpacing=t.letterSpacing||this.letterSpacing,t.anchor&&this.setAnchor(t.anchor)}getWidth(){return this.size[0]}setAnchor(t){const e={padding:t.padding||0,paddingDirection:t.paddingDirection,type:t.type,x:t.x||0,y:t.y||0};this.anchor=e}subTextGlyphs(t){const e=[],i=this.text.indexOf(t);if(i<0)return e;let n=0;for(let r=0,s=Math.min(this.text.length,i+t.length);r<s;++r)pn(this.text[r])||(n++,r>=i&&e.push(this.glyphs[n]));return e}resourceTrigger(){}};let ae=bf;si([M],ae.prototype,"color",2),si([M],ae.prototype,"depth",2),si([M],ae.prototype,"fontSize",2),si([M],ae.prototype,"maxScale",2),si([M],ae.prototype,"maxWidth",2),si([M],ae.prototype,"origin",2),si([M],ae.prototype,"scale",2),si([M],ae.prototype,"text",2),si([M],ae.prototype,"letterSpacing",2),si([M],ae.prototype,"anchor",2);var ov=Object.defineProperty,cv=Object.getOwnPropertyDescriptor,Cn=(t,e,i,n)=>{for(var r=n>1?void 0:n?cv(e,i):e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(r=(n?a(e,i,r):a(r))||r);return n&&r&&ov(e,i,r),r},pa=(t=>(t[t.LEFT=0]="LEFT",t[t.RIGHT=1]="RIGHT",t[t.CENTERED=2]="CENTERED",t))(pa||{}),ai=(t=>(t[t.NONE=0]="NONE",t[t.CHARACTER=1]="CHARACTER",t[t.WORD=2]="WORD",t))(ai||{}),tr=(t=>(t[t.NEWLINE=0]="NEWLINE",t))(tr||{});const Ef=class extends ae{constructor(t){super(t),this.maxHeight=0,this.lineHeight=0,this.wordWrap=0,this.alignment=0,this.labels=[],this.newLabels=[],this.borders=[],this.padding=[0,0,0,0],this.borderWidth=6,this.hasBorder=!0,this.spaceWidth=0,He(this,Ef),this.color=t.color,this.origin=t.origin,this.oldOrigin=t.origin,this.text=t.text,this.fontSize=t.fontSize||this.fontSize,this.maxWidth=t.maxWidth||this.maxWidth,this.maxHeight=t.maxHeight||this.maxHeight,this.lineHeight=t.lineHeight||this.lineHeight,this.wordWrap=t.wordWrap||this.wordWrap,this.alignment=t.alignment||this.alignment,this.padding=t.padding||this.padding,this.borderWidth=t.borderWidth||this.borderWidth,this.hasBorder=t.hasBorder!==void 0?t.hasBorder:this.hasBorder,this.letterSpacing=t.letterSpacing||this.letterSpacing}};let an=Ef;Cn([M],an.prototype,"maxHeight",2),Cn([M],an.prototype,"lineHeight",2),Cn([M],an.prototype,"wordWrap",2),Cn([M],an.prototype,"alignment",2),Cn([M],an.prototype,"padding",2),Cn([M],an.prototype,"borderWidth",2),Cn([M],an.prototype,"hasBorder",2);var lv=Object.defineProperty,uv=Object.getOwnPropertyDescriptor,on=(t,e,i,n)=>{for(var r=n>1?void 0:n?uv(e,i):e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(r=(n?a(e,i,r):a(r))||r);return n&&r&&lv(e,i,r),r};const hv={[P.TopLeft]:(t,e)=>{t.x=-t.padding,t.y=-t.padding},[P.TopMiddle]:(t,e)=>{t.x=e.size[0]/2,t.y=-t.padding},[P.TopRight]:(t,e)=>{t.x=e.size[0]+t.padding,t.y=-t.padding},[P.MiddleLeft]:(t,e)=>{t.x=-t.padding,t.y=e.size[1]/2},[P.Middle]:(t,e)=>{t.x=e.size[0]/2,t.y=e.size[1]/2},[P.MiddleRight]:(t,e)=>{t.x=e.size[0]+t.padding,t.y=e.size[1]/2},[P.BottomLeft]:(t,e)=>{t.x=-t.padding,t.y=e.size[1]+t.padding},[P.BottomMiddle]:(t,e)=>{t.x=e.size[0]/2,t.y=e.size[1]+t.padding},[P.BottomRight]:(t,e)=>{t.x=e.size[0]+t.padding,t.y=e.size[1]+t.padding},[P.Custom]:(t,e)=>{t.x=t.x||0,t.y=t.y||0}},_f=class extends ze{constructor(t){super(t),this.color=[0,0,0,1],this.depth=0,this.maxScale=1,this.scale=1,this.scaling=ti.BOUND_MAX,this.size=[1,1],this.position=[0,0],this._anchor={padding:0,type:P.TopLeft,x:0,y:0},He(this,_f),this.depth=t.depth||this.depth,this.color=t.color||this.color,this.scaling=t.scaling||this.scaling,this.position=t.position||this.position,this.size=t.size||this.size,t.anchor&&this.setAnchor(t.anchor)}get anchor(){return this._anchor}setAnchor(t){const e={padding:t.padding||0,type:t.type,x:t.x||0,y:t.y||0};hv[e.type](e,this),this._anchor=e}};let oi=_f;on([M],oi.prototype,"color",2),on([M],oi.prototype,"depth",2),on([M],oi.prototype,"maxScale",2),on([M],oi.prototype,"scale",2),on([M],oi.prototype,"scaling",2),on([M],oi.prototype,"size",2),on([M],oi.prototype,"position",2),on([M],oi.prototype,"_anchor",2);var dv=Object.defineProperty,fv=Object.getOwnPropertyDescriptor,Hc=(t,e,i,n)=>{for(var r=n>1?void 0:n?fv(e,i):e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(r=(n?a(e,i,r):a(r))||r);return n&&r&&dv(e,i,r),r};const Rf=class extends oi{constructor(t){super(t),this.fontScale=1,this.textAreaOrigin=[0,0],this.textAreaAnchor=[0,0],He(this,Rf),this.fontScale=t.fontScale||this.fontScale,this.textAreaOrigin=t.textAreaOrigin||this.textAreaOrigin,this.textAreaAnchor=t.textAreaAnchor||this.textAreaAnchor}};let On=Rf;Hc([M],On.prototype,"fontScale",2),Hc([M],On.prototype,"textAreaOrigin",2),Hc([M],On.prototype,"textAreaAnchor",2);const pv=`precision highp float;
varying vec4 vertexColor;
void main() {
gl_FragColor = vertexColor;
}`,gv=`precision highp float;
varying vec4 vertexColor;
void main() {
float borderScale = mix(fontScale, 1.0, float(scaling == 3.0));
vec3 screenSize = cameraSpaceSize(vec3(size * scale * borderScale / scaleFactor / maxScale, 1.0));
bool largerOnScreen = screenSize.y > size.y || screenSize.x > size.x;
float useScaleMode = float(
(
scaling == 3.0 ||
(largerOnScreen && scaling == 2.0)
) &&
scaling != 1.0
);
float unequalZooms = float(cameraScale2D.x != cameraScale2D.y);
vec2 adjustedSize = mix(
size,
(size * cameraScale2D.yx),
unequalZooms
);
float normal = normals.x;
float side = normals.y;
vec2 scaledAnchor = anchor * scale;
vec2 worldAnchor = location + scaledAnchor;
vec2 adjustedAnchor = mix(
scaledAnchor,
(scaledAnchor * cameraScale2D.yx),
unequalZooms
);
vec2 vertex = vec2(side, float(normal == 1.0)) * scale * adjustedSize + location - adjustedAnchor;
float labelScreenScale = mix(
screenSize.y / adjustedSize.y,
screenSize.x / adjustedSize.x,
float((cameraScale2D.x != 1.0))
);
float currentScale = labelScreenScale * scale;
vec2 anchorToVertex = vertex - location;
vertex = mix(
vertex + textAreaOrigin,
(anchorToVertex + location - textAreaAnchor) / labelScreenScale + textAreaOrigin + textAreaAnchor,
useScaleMode
);
vertexColor = color;
gl_Position = clipSpace(vec3(vertex, depth));
}`,ci=class extends Ne{initShader(){const t=this.props.animate||{},e={0:1,1:1,2:-1,3:1,4:-1,5:-1},i={0:0,1:0,2:0,3:1,4:1,5:1},{scaleFactor:n=()=>1}=this.props;return{fs:pv,instanceAttributes:[{easing:t.location,name:ci.attributeNames.location,size:C.TWO,update:r=>r.position},{name:ci.attributeNames.anchor,size:C.TWO,update:r=>[r.anchor.x||0,r.anchor.y||0]},{name:ci.attributeNames.size,size:C.TWO,update:r=>r.size},{name:ci.attributeNames.depth,size:C.ONE,update:r=>[r.depth]},{name:ci.attributeNames.scaling,size:C.ONE,update:r=>[r.scaling]},{easing:t.color,name:ci.attributeNames.color,size:C.FOUR,update:r=>r.color},{name:ci.attributeNames.scale,size:C.ONE,update:r=>[r.scale]},{name:ci.attributeNames.maxScale,size:C.ONE,update:r=>[r.maxScale]},{name:ci.attributeNames.fontScale,size:C.ONE,update:r=>[r.fontScale]},{name:"textAreaOrigin",size:C.TWO,update:r=>r.textAreaOrigin},{name:"textAreaAnchor",size:C.TWO,update:r=>r.textAreaAnchor}],uniforms:[{name:"scaleFactor",size:E.ONE,update:r=>[n()]}],vertexAttributes:[{name:"normals",size:Be.TWO,update:r=>[e[r],i[r]]}],vertexCount:6,vs:gv}}getMaterialOptions(){return tt.transparentShapeBlending}};let Qc=ci;Qc.defaultProps={key:"",data:new he},Qc.attributeNames={anchor:"anchor",color:"color",depth:"depth",fontScale:"fontScale",location:"location",maxScale:"maxScale",scale:"scale",scaling:"scaling",size:"size"};const cn={[P.TopLeft]:t=>[0,0],[P.TopMiddle]:t=>[t.maxWidth/2,0],[P.TopRight]:t=>[t.maxWidth,0],[P.MiddleLeft]:t=>[0,t.maxHeight/2],[P.Middle]:t=>[t.maxWidth/2,t.maxHeight/2],[P.MiddleRight]:t=>[t.maxWidth,t.maxHeight/2],[P.BottomLeft]:t=>[0,t.maxHeight],[P.BottomMiddle]:t=>[t.maxWidth/2,t.maxHeight],[P.BottomRight]:t=>[t.maxWidth,t.maxHeight],[P.Custom]:t=>[t.anchor.x||0,t.anchor.y||0]};function ga(t,e){let i=Number.MAX_SAFE_INTEGER;for(let n=0,r=t.length;n<r;n++){const s=t[n],a=e.get(s);a===0?i=0:a&&a<i&&(i=a)}return i===Number.MAX_SAFE_INTEGER?0:i}function mv(t){const e=[],i=t.split(jl);for(let s=0,a=i.length-1;s<a;s++)i[s].split(" ").forEach(l=>{l!==""&&e.push(l)}),e.push(`
`);return i[i.length-1].split(" ").forEach(s=>{s!==""&&e.push(s)}),e}function vv(t,e){const i=new Map;if(e.fontMap){const n=e.fontMap.fontSource.size,r=t.fontSize/n,s=e.fontMap,a=t.text.replace(/\s/g,"");let o=Number.MAX_SAFE_INTEGER,c=0,l,u="";for(let h=0,f=a.length;h<f;++h){const p=a[h];l=0,u&&(l=s.kerning[u][p][1]||0),c=c+l*r,i.set(p,c),o=Math.min(c,o),u=p}i.forEach((h,f)=>{i.set(f,h-o)})}return i}function wv(t,e,i){const n=[],r=i.fontMap?i.fontMap.fontSource.size:e.fontSize,s=e.fontSize/r;let a="",o=0,c=[0,0];for(let l=0,u=t.text.length;l<u;l++){const h=t.text[l];if(i.fontMap){let f=[0,0];a&&(f=i.fontMap.kerning[a][h]||[0,0]),c=fi(c,Re(f,s)),l!==0&&(c=fi(c,[e.letterSpacing,0]));const p=i.fontMap.glyphMap[h];o=c[0]+p.pixelWidth*s,n.push(o),a=h}}return n}class xf extends Ne{constructor(){super(...arguments),this.providers={labels:new he,borders:new he},this.fullUpdate=!1,this.areaToLabels=new Map,this.areaToLines=new Map,this.areaWaitingOnLabel=new Map,this.areaTokerningRequest=new Map,this.areaToWords=new Map,this.labelsInLine=[],this.handleLabelReady=e=>{if(!e.parentTextArea){delete e.onReady;return}const i=e.parentTextArea,n=this.areaWaitingOnLabel.get(i);if(n&&n.has(e)&&(n.delete(e),n.size<=0)){i.active=!0;const r=i.onReady;r&&r(i)}}}childLayers(){const e=this.props.animateLabel||{},i=this.props.animateBorder||{},n=this.props.scaling;return[_n(jc,{animate:e,customGlyphLayer:this.props.customGlyphLayer,data:this.providers.labels,key:`${this.id}.labels`,resourceKey:this.props.resourceKey,scaleMode:n,inTextArea:!0}),_n(Qc,{animate:{color:i.color,location:i.location},data:this.providers.borders,key:`${this.id}.border`})]}draw(){const e=this.resolveChanges();if(e.length<=0)return;if(!this.propertyIds){const T=e[0][0];this.propertyIds=this.getInstanceObservableIds(T,["active","alignment","borderWidth","color","fontSize","hasBorder","letterSpacing","lineHeight","maxHeight","maxWidth","origin","padding","text","wordWrap"])}const{active:i,alignment:n,borderWidth:r,color:s,fontSize:a,hasBorder:o,letterSpacing:c,lineHeight:l,maxHeight:u,maxWidth:h,origin:f,padding:p,text:g,wordWrap:m}=this.propertyIds;for(let T=0,w=e.length;T<w;++T){const[y,b,x]=e[T];switch(b){case Le.CHANGE:if(!this.areaToLabels.get(y)){this.insert(y);continue}x[g]!==void 0?(this.clear(y),this.updateLabels(y),this.layout(y)):x[i]!==void 0&&(y.active?(this.layout(y),this.showLabels(y)):this.hideLabels(y)),x[n]!==void 0&&(this.clear(y),this.updateLabels(y),this.layoutLabels(y)),x[s]!==void 0&&this.updateLabelColors(y),x[f]!==void 0&&this.updateLabelOrigins(y),x[a]!==void 0&&this.updateLabelFontSizes(y),x[m]!==void 0&&this.updateLabelLineWrap(y),x[l]!==void 0&&this.updateLabelLineHeight(y),x[h]!==void 0&&this.updateTextAreaSize(y),x[u]!==void 0&&this.updateTextAreaSize(y),x[p]!==void 0&&this.updateTextAreaSize(y),x[r]!==void 0&&this.updateBorderWidth(y),x[o]!==void 0&&this.updateBorder(y),x[c]!==void 0&&this.updateLetterSpacing(y);break;case Le.INSERT:this.insert(y);break;case Le.REMOVE:{const R=this.areaToLabels.get(y);if(R){for(let N=0,I=R.length;N<I;++N){const S=R[N];S instanceof ae&&this.providers.labels.remove(S)}this.areaToLabels.delete(y),this.areaWaitingOnLabel.delete(y)}break}}}}insert(e){this.layout(e),this.updateLabels(e)}hideLabels(e){const i=this.areaToLabels.get(e);if(i)for(let n=0,r=i.length;n<r;++n){const s=i[n];s instanceof ae&&this.providers.labels.remove(s)}}initShader(){return null}clear(e){const i=e.labels;for(let r=0,s=i.length;r<s;r++){const a=i[r];a instanceof ae&&this.providers.labels.remove(a)}e.labels=[];const n=e.newLabels;for(let r=0,s=n.length;r<s;r++){const a=n[r];a instanceof ae&&this.providers.labels.remove(a)}e.newLabels=[],this.areaToLabels.delete(e),this.areaWaitingOnLabel.delete(e),this.areaToWords.delete(e)}seperateLabel(e,i,n,r,s,a,o,c,l){const u=e.padding[0],h=e.padding[1]||0,f=e.padding[2]||0,p=e.padding[3]||0,g=e.maxWidth-p-h,m=e.maxHeight-u-f,T=e.origin[0],w=e.origin[1];i.active=!1;const y=r.substring(0,s+1),b=ga(y,n),x=cn[e.anchor.type](e),R=new ae({anchor:{padding:0,type:P.Custom,paddingDirection:[a+p,o+u+b],x:x[0],y:x[1]},color:e.color,fontSize:e.fontSize,letterSpacing:e.letterSpacing,origin:[T,w],text:y});if(R.size=[l[s],i.size[1]],this.providers.labels.add(R),e.newLabels.push(R),this.labelsInLine.push(R),a+=R.getWidth()+c,e.wordWrap===ai.CHARACTER||e.wordWrap===ai.WORD){if(this.setTextAlignment(a,o,c,g,e.alignment),a=0,o+=e.lineHeight,o+e.lineHeight<=m){let N=l[l.length-1]-l[s];for(;N>g&&o+e.lineHeight<=m;){let I=l.length-1;for(;l[I]-l[s]>g;)I--;const S=r.substring(s+1,I+1),j=ga(S,n),Q=new ae({anchor:{padding:0,type:P.Custom,paddingDirection:[a+p,o+u+j],x:x[0],y:x[1]},color:e.color,fontSize:e.fontSize,letterSpacing:e.letterSpacing,origin:[T,w],text:S});Q.size=[l[I]-l[s],i.size[1]],a+=Q.getWidth()+c,this.labelsInLine.push(Q),this.providers.labels.add(Q),e.newLabels.push(Q),this.setTextAlignment(a,o,c,g,e.alignment),a=0,o+=e.lineHeight,s=I,N=l[l.length-1]-l[s]}if(o+e.lineHeight<=m){const I=r.substring(s+1),S=ga(I,n),j=new ae({anchor:{padding:0,type:P.Custom,paddingDirection:[a+p,o+u+S],x:x[0],y:x[1]},color:e.color,fontSize:e.fontSize,letterSpacing:e.letterSpacing,origin:[T,w],text:I});j.size=[l[l.length-1]-l[s],i.size[1]],this.labelsInLine.push(j);const Q=[];for(let D=s+1;D<l.length;D++)Q.push(l[D]-l[s]);this.providers.labels.add(j),e.newLabels.push(j),a+=j.getWidth()+c}}}else e.wordWrap===ai.NONE&&(a+=R.getWidth()+c);return[a,o]}updateLabelLineWrap(e){const i=this.areaToLabels.get(e);if(i){for(let n=0,r=i.length;n<r;++n){const s=i[n];s instanceof ae&&(s.active=!0)}for(let n=0,r=e.newLabels.length;n<r;++n){const s=e.newLabels[n];this.providers.labels.remove(s)}e.newLabels=[],this.layoutLabels(e)}}updateLabelLineHeight(e){const i=this.areaToLabels.get(e);if(i){for(let n=0,r=i.length;n<r;++n){const s=i[n];s instanceof ae&&(s.active=!0)}for(let n=0,r=e.newLabels.length;n<r;++n){const s=e.newLabels[n];this.providers.labels.remove(s)}e.newLabels=[],this.layoutLabels(e)}}updateTextAreaSize(e){const i=this.areaToLabels.get(e);if(i){for(let n=0,r=i.length;n<r;++n){const s=i[n];s instanceof ae&&(s.active=!0)}for(let n=0,r=e.newLabels.length;n<r;++n){const s=e.newLabels[n];this.providers.labels.remove(s)}e.newLabels=[];for(let n=0,r=e.borders.length;n<r;++n){const s=e.borders[n];this.providers.borders.remove(s)}e.borders=[],this.layoutBorder(e),this.layoutLabels(e)}}updateBorderWidth(e){for(let i=0,n=e.borders.length;i<n;++i){const r=e.borders[i];this.providers.borders.remove(r)}e.borders=[],this.layoutBorder(e)}updateBorder(e){if(e.hasBorder)this.layoutBorder(e);else{for(let i=0,n=e.borders.length;i<n;++i){const r=e.borders[i];this.providers.borders.remove(r)}e.borders=[]}}updateLetterSpacing(e){this.clear(e),this.updateLabels(e),this.layout(e)}setTextAlignment(e,i,n,r,s){if(e-n<r&&s!==pa.LEFT){const a=r-e+n,o=s===pa.RIGHT?a:a/2;this.labelsInLine.forEach(c=>{const l=c.anchor;c.anchor={padding:l.padding,type:P.Custom,paddingDirection:[(l.paddingDirection?l.paddingDirection[0]:0)+o,l.paddingDirection?l.paddingDirection[1]:i],x:l.x,y:l.y}})}this.labelsInLine=[]}layoutBorder(e){if(e.hasBorder){const i=this.areaTokerningRequest.get(e);if(!i)return;const n=i.fontMap?i.fontMap.fontSource.size:e.fontSize,r=e.fontSize/n,s=this.props.scaling,a=e.borderWidth,o=new On({color:e.color,fontScale:r,scaling:s,size:[e.maxWidth+2*a,a],textAreaOrigin:e.origin,textAreaAnchor:cn[e.anchor.type](e),position:[-a,-a]}),c=new On({color:e.color,fontScale:r,scaling:s,size:[a,e.maxHeight+2*a],textAreaOrigin:e.origin,textAreaAnchor:cn[e.anchor.type](e),position:[-a,-a]}),l=new On({color:e.color,fontScale:r,scaling:s,size:[a,e.maxHeight+2*a],textAreaOrigin:e.origin,textAreaAnchor:cn[e.anchor.type](e),position:[e.maxWidth,-a]}),u=new On({color:e.color,fontScale:r,scaling:s,size:[e.maxWidth+2*a,a],textAreaOrigin:e.origin,textAreaAnchor:cn[e.anchor.type](e),position:[-a,e.maxHeight]});this.providers.borders.add(o),this.providers.borders.add(c),this.providers.borders.add(l),this.providers.borders.add(u),e.borders.push(o),e.borders.push(c),e.borders.push(l),e.borders.push(u)}}layoutLabels(e){const i=this.areaTokerningRequest.get(e);if(!i)return;const n=e.padding[0],r=e.padding[1]||0,s=e.padding[2]||0,a=e.padding[3]||0,o=e.maxWidth-a-r,c=e.maxHeight-n-s,l=e.origin[0],u=e.origin[1];let h=0;if(e.spaceWidth)h=e.spaceWidth;else{if(i.fontMap){const m=i.fontMap.fontSource.size,T=e.fontSize/m;h=i.fontMap.spaceWidth*T}else h=this.props.whiteSpaceKerning||e.fontSize/2;e.spaceWidth=h}const f=vv(e,i);let p=0,g=0;this.labelsInLine=[];for(let m=0,T=e.labels.length;m<T;++m){const w=e.labels[m];if(w instanceof ae){const y=w.getWidth(),b=ga(w.text,f),x=wv(w,e,i);if(g+e.lineHeight<=c&&x[0]<=o)if(p+y<=o){w.origin=[l,u];const R=cn[e.anchor.type](e);w.anchor={padding:0,paddingDirection:[p+a,g+n+b],type:P.Custom,x:R[0],y:R[1]},p+=y+h,this.labelsInLine.push(w),p>=o&&e.wordWrap===ai.CHARACTER&&m+1<T&&e.labels[m+1]!==tr.NEWLINE&&(this.setTextAlignment(p,g,h,o,e.alignment),p=0,g+=e.lineHeight)}else if(e.wordWrap===ai.WORD&&w.getWidth()<=e.maxWidth)if(this.setTextAlignment(p,g,h,o,e.alignment),p=0,g+=e.lineHeight,g+e.lineHeight<=c){w.origin=[l,u];const R=cn[e.anchor.type](e);w.anchor={padding:0,paddingDirection:[p+a,g+n+b],type:P.Custom,x:R[0],y:R[1]},this.labelsInLine.push(w),p+=w.getWidth()+h}else w.active=!1;else{const R=o-p;let N=x.length-1;const I=w.text;for(;x[N]>R;)N--;if(N>=0){const S=this.seperateLabel(e,w,f,I,N,p,g,h,x);p=S[0],g=S[1]}else if(e.wordWrap===ai.CHARACTER||e.wordWrap===ai.WORD)if(this.setTextAlignment(p,g,h,o,e.alignment),g+=e.lineHeight,p=0,g+e.lineHeight<c)if(p+w.getWidth()<=o){w.origin=[l,u];const S=cn[e.anchor.type](e);w.anchor={padding:0,paddingDirection:[p+a,g+n+b],type:P.Custom,x:S[0],y:S[1]},this.labelsInLine.push(w),p+=w.getWidth()+h,p>=o&&m+1<T&&e.labels[m+1]!==tr.NEWLINE&&(this.setTextAlignment(p,g,h,o,e.alignment),p=0,g+=e.lineHeight)}else{const S=o-p;let j=x.length-1;const Q=w.text;for(;x[j]>S;)j--;if(j>=0){const D=this.seperateLabel(e,w,f,Q,j,p,g,h,x);p=D[0],g=D[1]}}else w.active=!1;else e.wordWrap===ai.NONE&&(w.active=!1)}else w.active=!1}else w===tr.NEWLINE&&(this.setTextAlignment(p,g,h,o,e.alignment),p=0,g+=e.lineHeight)}this.setTextAlignment(p,g,h,o,e.alignment)}layout(e){this.updateKerning(e);const i=this.areaTokerningRequest.get(e);if(!i||!i.fontMap)return;const n=this.areaWaitingOnLabel.get(e);if(n&&n.size>0||!e.active)return;const r=this.areaToLabels.get(e);!r||r.length===0||(this.updateLabels(e),this.layoutBorder(e),this.layoutLabels(e))}updateKerning(e){let i=this.areaTokerningRequest.get(e);const n=e.text;if(i){if(i.kerningPairs&&i.kerningPairs.indexOf(n)>-1)return!!i.fontMap;if(i.fontMap&&!i.fontMap.supportsKerning(n))this.areaTokerningRequest.delete(e),i=void 0;else return!1}else{const r={fontSize:e.fontSize,text:e.text,letterSpacing:e.letterSpacing};return i=Sn({character:"",key:this.props.resourceKey||"",kerningPairs:[n],metrics:r}),e.preload?(e.resourceTrigger=()=>{e.onReady&&e.onReady(e)},this.resource.request(this,e,i)):(this.resource.request(this,e,i),this.areaTokerningRequest.set(e,i)),!1}return!0}managesInstance(e){return!!this.areaToLabels.get(e)}showLabels(e){const i=this.areaToLabels.get(e);if(i)for(let n=0,r=i.length;n<r;++n){const s=i[n];s instanceof ae&&this.providers.labels.add(s)}}updateLabels(e){let i=this.areaToLabels.get(e);const n=e.padding[0],r=e.padding[3]||0,s=e.origin[0]+r,a=e.origin[1]+n;i||(i=[],this.areaToLabels.set(e,i));let o=this.areaWaitingOnLabel.get(e);o||(o=new Set,this.areaWaitingOnLabel.set(e,o));let c=this.areaToWords.get(e);if(c||(c=mv(e.text)),i.length<c.length)for(let l=i.length,u=c.length;l<u;++l){const h=c[l];if(h===`
`)i.push(tr.NEWLINE);else{const f=new ae({active:!1,color:e.color,fontSize:e.fontSize,letterSpacing:e.letterSpacing,text:h,origin:[s,a],onReady:this.handleLabelReady});f.parentTextArea=e,i.push(f),this.providers.labels.add(f),o.add(f)}}e.labels=i}updateLabelColors(e){const i=this.areaToLabels.get(e);if(i){for(let n=0,r=i.length;n<r;++n){const s=i[n];s instanceof ae&&(s.color=At(e.color))}for(let n=0,r=e.newLabels.length;n<r;++n)e.newLabels[n].color=At(e.color);for(let n=0,r=e.borders.length;n<r;++n)e.borders[n].color=At(e.color)}}updateLabelFontSizes(e){this.clear(e),this.updateLabels(e),this.areaTokerningRequest.delete(e),this.layout(e)}updateLabelOrigins(e){const i=this.areaToLabels.get(e);if(!i)return;const n=e.origin,r=e.oldOrigin;for(let s=0,a=i.length;s<a;++s){const o=i[s];if(o instanceof ae){const c=o.origin;o.origin=[c[0]+n[0]-r[0],c[1]+n[1]-r[1]]}}for(let s=0,a=e.newLabels.length;s<a;++s){const o=e.newLabels[s];if(o instanceof ae){const c=o.origin;o.origin=[c[0]+n[0]-r[0],c[1]+n[1]-r[1]]}}for(let s=0,a=e.borders.length;s<a;++s){const o=e.borders[s];o.position=[o.position[0]+n[0]-r[0],o.position[1]+n[1]-r[1]]}e.oldOrigin=e.origin}willUpdateProps(e){e.data!==this.props.data&&delete this.propertyIds,e.resourceKey!==this.props.resourceKey&&(this.fullUpdate=!0)}}xf.defaultProps={key:"",data:new he,scaling:ti.ALWAYS};const Tv=`precision highp float;
varying vec4 vertexColor;
void main() {
gl_FragColor = vertexColor;
}`,yv=`precision highp float;
varying vec4 vertexColor;
void main() {
vec3 screenSize = cameraSpaceSize(vec3(size * scale / scaleFactor / maxScale, 1.0));
bool largerOnScreen = screenSize.y > size.y || screenSize.x > size.x;
float useScaleMode = float(
(
scaling == 3.0 ||
(largerOnScreen && scaling == 2.0)
) &&
scaling != 1.0
);
float unequalZooms = float(cameraScale2D.x != cameraScale2D.y);
vec2 adjustedSize = mix(
size,
(size * cameraScale2D.yx),
unequalZooms
);
float normal = normals.x;
float side = normals.y;
vec2 scaledAnchor = anchor * scale;
vec2 worldAnchor = location + scaledAnchor;
vec2 adjustedAnchor = mix(
scaledAnchor,
(scaledAnchor * cameraScale2D.yx),
unequalZooms
);
vec2 vertex = vec2(side, float(normal == 1.0)) * scale * adjustedSize + location - adjustedAnchor;
float labelScreenScale = mix(
screenSize.y / adjustedSize.y,
screenSize.x / adjustedSize.x,
float((cameraScale2D.x != 1.0))
);
float currentScale = labelScreenScale * scale;
vec2 anchorToVertex = vertex - location;
vertex = mix(
vertex,
(anchorToVertex / labelScreenScale) + location,
useScaleMode
);
vertexColor = color;
gl_Position = clipSpace(vec3(vertex, depth));
}`,Oi=class extends Ne{initShader(){const t=this.props.animate||{},e={0:1,1:1,2:-1,3:1,4:-1,5:-1},i={0:0,1:0,2:0,3:1,4:1,5:1},{scaleFactor:n=()=>1}=this.props;return{fs:Tv,instanceAttributes:[{easing:t.location,name:Oi.attributeNames.location,size:C.TWO,update:r=>r.position},{name:Oi.attributeNames.anchor,size:C.TWO,update:r=>[r.anchor.x||0,r.anchor.y||0]},{name:Oi.attributeNames.size,size:C.TWO,update:r=>r.size},{name:Oi.attributeNames.depth,size:C.ONE,update:r=>[r.depth]},{name:Oi.attributeNames.scaling,size:C.ONE,update:r=>[r.scaling]},{easing:t.color,name:Oi.attributeNames.color,size:C.FOUR,update:r=>r.color},{name:Oi.attributeNames.scale,size:C.ONE,update:r=>[r.scale]},{name:Oi.attributeNames.maxScale,size:C.ONE,update:r=>[r.maxScale]}],uniforms:[{name:"scaleFactor",size:E.ONE,update:r=>[n()]}],vertexAttributes:[{name:"normals",size:Be.TWO,update:r=>[e[r],i[r]]}],vertexCount:6,vs:yv}}getMaterialOptions(){return tt.transparentShapeBlending}};let Xc=Oi;Xc.defaultProps={key:"",data:new he},Xc.attributeNames={anchor:"anchor",color:"color",depth:"depth",location:"location",maxScale:"maxScale",scale:"scale",scaling:"scaling",size:"size"};var bv=Object.defineProperty,Ev=Object.getOwnPropertyDescriptor,Jr=(t,e,i,n)=>{for(var r=n>1?void 0:n?Ev(e,i):e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(r=(n?a(e,i,r):a(r))||r);return n&&r&&bv(e,i,r),r};const Af=class extends ze{constructor(t){super(t),this.color=[1,1,1,1],this.depth=0,this.radius=0,this.thickness=1,this.center=[0,0],He(this,Af),this.color=t.color||this.color,this.depth=t.depth||this.depth,this.radius=t.radius||this.radius,this.thickness=t.thickness||this.thickness,this.center=t.center||this.center}get width(){return this.radius*2}get height(){return this.radius*2}get innerRadius(){return this.radius-this.thickness}};let ir=Af;Jr([M],ir.prototype,"color",2),Jr([M],ir.prototype,"depth",2),Jr([M],ir.prototype,"radius",2),Jr([M],ir.prototype,"thickness",2),Jr([M],ir.prototype,"center",2);const _v=`precision highp float;
varying vec4 vertexColor;
varying float edgeSharpness;
varying float borderSize;
varying vec2 pointCoord;
varying float scale;
float circle(vec2 coord, float radius){
vec2 dist = coord - vec2(0.5);
return 1.0 - smoothstep(
radius - (radius * edgeSharpness),
radius,
dot(dist, dist) * 4.0
);
}
void main() {
float outer_step_factor = circle(pointCoord, 1.0);
float inner_step_factor = circle(pointCoord, 1.0 - borderSize * scale);
gl_FragColor = mix(
mix(
vec4(0.0, 0.0, 0.0, 0.0),
vertexColor,
outer_step_factor
),
vec4(0.0, 0.0, 0.0, 0.0),
inner_step_factor
);
}`,Rv=`precision highp float;
varying vec4 vertexColor;
varying float edgeSharpness;
varying float borderSize;
varying vec2 pointCoord;
varying float scale;
void main() {
scale = scaleFactor;
vertexColor = color;
float size = radius * scaleFactor * pixelRatio;
float ringWidth = mix(2.0 , thickness, float(thickness > 2.0));
borderSize = mix(
(ringWidth) / size,
((ringWidth * pixelRatio) / size),
float(pixelRatio > 1.0)
);
edgeSharpness = min(0.2 / (ringWidth * scale), 0.1);
pointCoord = (normals.xy + vec2(1.0, 1.0)) / 2.0;
vec4 clipCenter = clipSpace(vec3(center, depth));
vec2 screenCenter = (clipCenter.xy + vec2(1.0, 1.0)) * vec2(0.5, 0.5) * viewSize;
vec2 vertex = (normals.xy * size) + screenCenter;
gl_Position = vec4((vertex / viewSize) * vec2(2.0, 2.0) - vec2(1.0, 1.0), clipCenter.zw);
}`,nr=class extends Ne{initShader(){const t=this.props.scaleFactor||(()=>1),e=this.props.animate||{},{color:i,center:n,radius:r}=e,s={0:1,1:1,2:-1,3:1,4:-1,5:-1},a={0:-1,1:-1,2:-1,3:1,4:1,5:1};return{fs:_v,instanceAttributes:[{easing:n,name:nr.attributeNames.center,size:C.TWO,update:o=>o.center},{easing:r,name:nr.attributeNames.radius,size:C.ONE,update:o=>[o.radius]},{name:nr.attributeNames.depth,size:C.ONE,update:o=>[o.depth]},{easing:i,name:nr.attributeNames.color,size:C.FOUR,update:o=>o.color},{name:nr.attributeNames.thickness,size:C.ONE,update:o=>[o.thickness]}],uniforms:[{name:"scaleFactor",size:E.ONE,update:o=>[t()]}],vertexAttributes:[{name:"normals",size:Be.TWO,update:o=>[s[o],a[o]]}],vertexCount:6,vs:Rv}}getMaterialOptions(){return tt.transparentShapeBlending}};let Yc=nr;Yc.defaultProps={key:"",data:new he},Yc.attributeNames={center:"center",radius:"radius",depth:"depth",color:"color",thickness:"thickness"};const xv=`\${import: camera}
vec3 cameraSpace(vec3 world) {
return (view * vec4(world, 1.0)).xyz;
}
vec3 cameraSpace(vec4 world) {
return (view * world).xyz;
}
vec3 cameraSpaceDirection(vec3 world) {
return (view * vec4(world, 0.0)).xyz;
}
vec3 cameraSpaceDirection(vec4 world) {
return (view * world).xyz;
}
vec3 cameraSpaceSize(vec3 worldSize) {
return (view * vec4(worldSize, 0.0)).xyz;
}
vec4 clipSpace(vec3 world) {
return (viewProjection) * vec4(world, 1.0);
}
vec4 clipSpace(vec4 world) {
return (viewProjection) * world;
}
vec4 clipSpaceDirection(vec3 worldSize) {
return (viewProjection) * vec4(worldSize, 0.0);
}
vec4 clipSpaceDirection(vec4 worldSize) {
return (viewProjection) * worldSize;
}
vec4 clipSpaceSize(vec3 worldSize) {
return (viewProjection) * vec4(worldSize, 0.0);
}`,Av=`
These are properties injected from the
current camera applied to the view.

Constants:
mat4 projection;
mat4 view;
mat4 viewProjection;
vec3 cameraOffset;
vec3 cameraPosition;
vec3 cameraScale;
vec3 cameraRotation;
vec2 viewSize;
float pixelRatio;
`;Ee.register([{moduleId:"camera",description:Av,content:"",compatibility:A.ALL,uniforms:t=>[{name:"projection",size:E.MATRIX4,update:()=>t.view.props.camera.projection},{name:"viewProjection",size:E.MATRIX4,update:()=>t.view.props.camera.viewProjection},{name:"view",size:E.MATRIX4,update:()=>t.view.props.camera.view},{name:"cameraPosition",size:E.THREE,update:()=>t.view.props.camera.position},{name:"cameraScale",size:E.THREE,update:()=>t.view.props.camera.scale},{name:"cameraRotation",size:E.THREE,update:()=>t.view.props.camera.scale},{shaderInjection:A.ALL,name:"viewSize",size:E.TWO,update:()=>[t.view.viewBounds.width,t.view.viewBounds.height]},{shaderInjection:A.ALL,name:"pixelRatio",size:E.ONE,update:()=>[t.view.pixelRatio]}]},{moduleId:"projection",content:xv,compatibility:A.ALL}]);const Sf=`
This provides frame timing information
or how many frames have been rendered.

Constants:
float currentTime;
float currentFrame;
`;Ee.register({moduleId:"frame",description:Sf,content:"",compatibility:A.ALL,uniforms:t=>[{name:"currentTime",size:E.ONE,shaderInjection:A.ALL,update:()=>[t.surface.frameMetrics.currentTime]},{name:"currentFrame",size:E.ONE,shaderInjection:A.ALL,update:()=>[t.surface.frameMetrics.currentFrame]}]}),Ee.register({moduleId:"time",description:Sf,content:"",compatibility:A.ALL,uniforms:t=>[{name:"time",size:E.ONE,shaderInjection:A.ALL,update:()=>[t.surface.frameMetrics.currentTime]}]});const Sv=`vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}`,Mv=`
Provides methods that converts colors to
HSV values and back. This makes it
easier to deal with hue saturation and
lightness levels.

Methods:
vec3 rgb2hsv(vec3 c);
vec3 hsv2rgb(vec3 c);
`;Ee.register({moduleId:"hsv",description:Mv,content:Sv,compatibility:A.ALL});const Iv=`
This is an internal shader module that
helps establish the instancing system.
Not recommended for use unless you
really know how to utilize it properly.

Attributes:
float _active;
float instance;
`;Ee.register({moduleId:"instancing",description:Iv,content:"",compatibility:A.ALL,instanceAttributes:t=>{const e={name:"_active",size:C.ONE,update:i=>[i.active?1:0]};return t.shaderIOInfo.activeAttribute=e,[e]},vertexAttributes:t=>t.bufferType===Ae.UNIFORM?[{name:"instance",size:Be.ONE,update:()=>[0]}]:[]});const Lv=`\${import: PI, PI2, fsin, fcos, wrap}
vec2 arc(float t, vec2 center, float radius, float start, float end) {
float angle = wrap((end - start) * t + start, 0.0, PI2);
return center + vec2(fcos(angle), fsin(angle)) * radius;
}`,Cv=`vec2 bezier1(float t, vec2 p1, vec2 p2, vec2 c1) {
return (1.0 - t) * (1.0 - t) * p1 + 2.0 * t * (1.0 - t) * c1 + t * t * p2;
}`,Ov=`vec2 bezier2(float t, vec2 p1, vec2 p2, vec2 c1, vec2 c2) {
float t1 = 1.0 - t;
return pow(t1, 3.0) * p1 + 3.0 * t * pow(t1, 2.0) * c1 + 3.0 * pow(t, 2.0) * t1 * c2 + pow(t, 3.0) * p2;
}`,Nv=`\${import: PI, PI2, PI_2}
float fcos(float x) {
float sine;
x += PI_2;
x += mix(
mix(
0.0,
-PI2, float(x > PI)
),
PI2, float(x < -PI)
);
sine = 1.27323954 * x;
sine += mix(-1.0, 1.0, float(x < 0.0)) * 0.405284735 * x * x;
sine = 0.225 * (sine * (mix(1.0, -1.0, float(sine < 0.0)) * sine) - sine) + sine;
return sine;
}`,Pv=`float fmod(float x, float m, float m_inv) {
return x - m * floor(x * m_inv);
}`,Dv=`\${import: PI, PI2}
float fsin(float x) {
float sine;
x += mix(
mix(
0.0,
-PI2, float(x > PI)
),
PI2, float(x < -PI)
);
sine = 1.27323954 * x;
sine += mix(-1.0, 1.0, float(x < 0.0)) * 0.405284735 * x * x;
sine = 0.225 * (sine * (mix(1.0, -1.0, float(sine < 0.0)) * sine) - sine) + sine;
return sine;
}`,Fv="float PI = 3.14159265;",Bv="float PI2 = 6.2831853;",Uv="float PI2_INV = 0.1591549431;",Gv="float PI_2 = 1.5707963268;",kv="float PI_4 = 0.7853981634;",zv="float PI_INV = 0.3183098862;",Vv="float toDegrees = 57.2957795131;",Wv="float toRadians = 0.01745329252;",$v=`float wrap(float value, float start, float end) {
float width = end - start;
float offsetValue = value - start;
return (offsetValue - (floor(offsetValue / width) * width)) + start;
}`,qc=[{moduleId:"PI_INV",description:"Provides: float PI_INV = 1.0 / pi",content:zv,compatibility:A.ALL},{moduleId:"PI2_INV",description:`Provides:
float PI2_INV = 1.0 / (pi * 2.0)`,content:Uv,compatibility:A.ALL},{moduleId:"PI_2",description:"Provides: float PI_2 = pi / 2.0",content:Gv,compatibility:A.ALL},{moduleId:"PI_4",description:"Provides: float PI_4 = pi / 4.0",content:kv,compatibility:A.ALL},{moduleId:"PI",description:"Provides: float PI = pi",content:Fv,compatibility:A.ALL},{moduleId:"PI2",description:"Provides: float PI2 = pi * 2.0",content:Bv,compatibility:A.ALL},{moduleId:"toDegrees",description:`Provides: float toDegrees;
Can be used to convert radians to degrees:
radians * toDegrees`,content:Vv,compatibility:A.ALL},{moduleId:"toRadians",description:`Provides: float toRadians;
Can be used to convert degrees to radians:
degress * toRadians`,content:Wv,compatibility:A.ALL}],jv={moduleId:"constants",description:`
Provides all the math constants you may
need as convenience. It's probably
better to include them individually, but
convenience sometimes beats practicality

Constants:
${qc.map(t=>t.moduleId).join(`
`)}
`,content:`\${import: ${qc.map(t=>t.moduleId).join(", ")}}`,compatibility:A.ALL},Hv=[{moduleId:"bezier1",description:`Provides the 2D single control
point bezier method:
vec2 bezier1(float t, vec2 p1, vec2 p2, vec2 c1)`,content:Cv,compatibility:A.ALL},{moduleId:"bezier2",description:`Provides the 2D single control
point bezier method:
vec2 bezier2(float t, vec2 p1, vec2 p2, vec2 c1, vec2 c2)`,content:Ov,compatibility:A.ALL},{moduleId:"arc",description:`Provides the 2D
arc interpolation method:
vec2 arc(float t,
	vec2 center,
	float radius,
	float start,
	float end
)`,content:Lv,compatibility:A.ALL},{moduleId:"fmod",description:`Provides the floating point
modulus method:
float fmod(float x, float m, float m_inv)`,content:Pv,compatibility:A.ALL},{moduleId:"wrap",description:`Provides a method that wraps
value overflows:
float wrap(float value, float start, float end)`,content:$v,compatibility:A.ALL},{moduleId:"fcos",description:`Provides a fcos method that also
has a higher precision than
some hardware cos implementations:
float fcos(float x)`,content:Nv,compatibility:A.ALL},{moduleId:"fsin",description:`Provides a fsin method that also
has a higher precision than
some hardware sin implementations:
float fsin(float x)`,content:Dv,compatibility:A.ALL}];Ee.register([...Hv,...qc,jv]);const Qv=`mat4 rotationFromQuaternion(vec4 q) {
float x2 = q.y + q.y;
float y2 = q.z + q.z;
float z2 = q.w + q.w;
float xx = q.y * x2;
float xy = q.y * y2;
float xz = q.y * z2;
float yy = q.z * y2;
float yz = q.z * z2;
float zz = q.w * z2;
float wx = q.x * x2;
float wy = q.x * y2;
float wz = q.x * z2;
return mat4(
1.0 - (yy + zz), xy - wz, xz + wy, 0.0,
xy + wz, 1.0 - (xx + zz), yz - wx, 0.0,
xz - wy, yz + wx, 1.0 - (xx + yy), 0.0,
0, 0, 0, 1
);
}`,Xv=`mat4 scale(vec3 s) {
return mat4(
s.x, 0, 0, 0,
0, s.y, 0, 0,
0, 0, s.z, 0,
0, 0, 0, 1
);
}`,Yv=`\${import: translation, rotation, scale}
mat4 transform(vec3 s, vec4 r, vec3 t) {
return translation(t) * rotationFromQuaternion(r) * scale(s);
}`,qv=`mat4 translation(vec3 t) {
return mat4(
1, 0, 0, 0,
0, 1, 0, 0,
0, 0, 1, 0,
t.x, t.y, t.z, 1
);
}`;Ee.register([{moduleId:"translation",description:`Generates a translation matrix
from a vec3:
mat4 transform(vec3 s, vec4 r, vec3 t)`,compatibility:A.ALL,content:qv},{moduleId:"rotation",description:`Generates a rotation matrix
from a quaternion:
mat4 rotationFromQuaternion(vec4 q)`,compatibility:A.ALL,content:Qv},{moduleId:"scale",description:`Generates a scale matrix
from a vec3:
mat4 scale(vec3 s)`,compatibility:A.ALL,content:Xv},{moduleId:"transform",description:`Generates a full transform matrix
from a scale, quaternion, translation:
mat4 transform(vec3 s, vec4 r, vec3 t)`,compatibility:A.ALL,content:Yv}]);const Kv=`vec3 mod289(vec3 x) {
return x - floor(x * (1.0f / 289.0f)) * 289.0f;
}
vec2 mod289(vec2 x) {
return x - floor(x * (1.0f / 289.0f)) * 289.0f;
}
vec3 permute(vec3 x) {
return mod289(((x * 34.0f) + 10.0f) * x);
}
float simplexNoise2D(vec2 v) {
const vec4 C = vec4(0.211324865405187f,
0.366025403784439f,
-0.577350269189626f,
0.024390243902439f);
vec2 i = floor(v + dot(v, C.yy));
vec2 x0 = v - i + dot(i, C.xx);
vec2 i1;
i1 = (x0.x > x0.y) ? vec2(1.0f, 0.0f) : vec2(0.0f, 1.0f);
vec4 x12 = x0.xyxy + C.xxzz;
x12.xy -= i1;
i = mod289(i);
vec3 p = permute(permute(i.y + vec3(0.0f, i1.y, 1.0f)) + i.x + vec3(0.0f, i1.x, 1.0f));
vec3 m = max(0.5f - vec3(dot(x0, x0), dot(x12.xy, x12.xy), dot(x12.zw, x12.zw)), 0.0f);
m = m * m;
m = m * m;
vec3 x = 2.0f * fract(p * C.www) - 1.0f;
vec3 h = abs(x) - 0.5f;
vec3 ox = floor(x + 0.5f);
vec3 a0 = x - ox;
m *= 1.79284291400159f - 0.85373472095314f * (a0 * a0 + h * h);
vec3 g;
g.x = a0.x * x0.x + h.x * x0.y;
g.yz = a0.yz * x12.xz + h.yz * x12.yw;
return 130.0f * dot(m, g);
}`,Zv=`vec3 mod289(vec3 x) {
return x - floor(x * (1.0f / 289.0f)) * 289.0f;
}
vec4 mod289(vec4 x) {
return x - floor(x * (1.0f / 289.0f)) * 289.0f;
}
vec4 permute(vec4 x) {
return mod289(((x * 34.0f) + 10.0f) * x);
}
vec4 taylorInvSqrt(vec4 r) {
return 1.79284291400159f - 0.85373472095314f * r;
}
float simplexNoise3D(vec3 v) {
const vec2 C = vec2(1.0f / 6.0f, 1.0f / 3.0f);
const vec4 D = vec4(0.0f, 0.5f, 1.0f, 2.0f);
vec3 i = floor(v + dot(v, C.yyy));
vec3 x0 = v - i + dot(i, C.xxx);
vec3 g = step(x0.yzx, x0.xyz);
vec3 l = 1.0f - g;
vec3 i1 = min(g.xyz, l.zxy);
vec3 i2 = max(g.xyz, l.zxy);
vec3 x1 = x0 - i1 + C.xxx;
vec3 x2 = x0 - i2 + C.yyy;
vec3 x3 = x0 - D.yyy;
i = mod289(i);
vec4 p = permute(permute(permute(i.z + vec4(0.0f, i1.z, i2.z, 1.0f)) + i.y + vec4(0.0f, i1.y, i2.y, 1.0f)) + i.x + vec4(0.0f, i1.x, i2.x, 1.0f));
float n_ = 0.142857142857f;
vec3 ns = n_ * D.wyz - D.xzx;
vec4 j = p - 49.0f * floor(p * ns.z * ns.z);
vec4 x_ = floor(j * ns.z);
vec4 y_ = floor(j - 7.0f * x_);
vec4 x = x_ * ns.x + ns.yyyy;
vec4 y = y_ * ns.x + ns.yyyy;
vec4 h = 1.0f - abs(x) - abs(y);
vec4 b0 = vec4(x.xy, y.xy);
vec4 b1 = vec4(x.zw, y.zw);
vec4 s0 = floor(b0) * 2.0f + 1.0f;
vec4 s1 = floor(b1) * 2.0f + 1.0f;
vec4 sh = -step(h, vec4(0.0f));
vec4 a0 = b0.xzyw + s0.xzyw * sh.xxyy;
vec4 a1 = b1.xzyw + s1.xzyw * sh.zzww;
vec3 p0 = vec3(a0.xy, h.x);
vec3 p1 = vec3(a0.zw, h.y);
vec3 p2 = vec3(a1.xy, h.z);
vec3 p3 = vec3(a1.zw, h.w);
vec4 norm = taylorInvSqrt(vec4(dot(p0, p0), dot(p1, p1), dot(p2, p2), dot(p3, p3)));
p0 *= norm.x;
p1 *= norm.y;
p2 *= norm.z;
p3 *= norm.w;
vec4 m = max(0.5f - vec4(dot(x0, x0), dot(x1, x1), dot(x2, x2), dot(x3, x3)), 0.0f);
m = m * m;
return 105.0f * dot(m * m, vec4(dot(p0, x0), dot(p1, x1), dot(p2, x2), dot(p3, x3)));
}`;Ee.register({moduleId:"simplexNoise3D",content:Zv,compatibility:A.ALL,description:"Provides the simplex noise function for 3D coordinates."}),Ee.register({moduleId:"simplexNoise2D",content:Kv,compatibility:A.ALL,description:"Provides the simplex noise function for 2D coordinates."});const Jv=`vec4 bitSh = vec4(16777216., 65536., 256., 1.);
vec4 bitMsk = vec4(0., vec3(1. / 256.0));
vec4 bitShifts = vec4(1.) / vec4(16777216., 65536., 256., 1.);
vec4 packFloat(float value, float range) {
value = (value + range) / (range * 2.);
vec4 comp = fract(value * bitSh);
comp -= comp.xxyz * bitMsk;
return comp;
}
float unpackFloat(vec4 color, float range) {
return dot(color , bitShifts) * (range * 2.) - range;
}`,e1=`
This provides the ability to pack
a float value into a color RGBA
value. This is used to bypass the
lack of support for float textures.

Constants:
float currentTime;
float currentFrame;
`;Ee.register({moduleId:"packFloat",description:e1,content:Jv,compatibility:A.ALL});const t1="varying highp vec4 _picking_color_pass_;";Ee.register([{moduleId:"picking",description:`Internal use only. Provides methods
and constants to make the picking processes work.`,content:t1,compatibility:A.VERTEX,instanceAttributes:t=>[{name:"_pickingColor",size:C.FOUR,shaderInjection:A.VERTEX,update:e=>{const i=16777215-e.uid;return[((i&16711680)>>16)/255,((i&65280)>>8)/255,(i&255)/255,1]}}]}]);const i1=`void main() {
gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
}`,n1=`void main() {
gl_Position = vec4(0.0, 0.0, 0.0, 1.0);
}`,Mf=`
Makes a no-op shader where gl_Position
is [0, 0, 0, 0] and gl_FragColor is
[0, 0, 0, 0].

You can not import this if you specify
your own main() method.
`;Ee.register([{moduleId:"no-op",description:Mf,content:n1,compatibility:A.VERTEX},{moduleId:"no-op",description:Mf,content:i1,compatibility:A.FRAGMENT}]);const r1=`
This is a special helper module used by
the system to map View2D content into
a 3D world space. The system utilizes
this module automatically for you when
you utilize createLayer2Din3D.
`;Ee.register([{moduleId:"world2DXY",description:r1,content:ef,compatibility:A.ALL,uniforms:t=>t instanceof Ne?t.props.control2D?[{name:"projection",size:E.MATRIX4,update:()=>t.view.props.camera.projection},{name:"view",size:E.MATRIX4,update:()=>t.view.props.camera.view},{name:"cameraOffset",size:E.THREE,update:()=>t.props.control2D instanceof xi?t.props.control2D.offset:[0,0,0]},{name:"cameraPosition",size:E.THREE,update:()=>t.view.props.camera.position},{name:"cameraScale",size:E.THREE,update:()=>t.view.props.camera.scale},{name:"cameraScale2D",size:E.THREE,update:()=>t.props.control2D instanceof xi?t.props.control2D.scale:[1,1,1]},{name:"cameraRotation",size:E.FOUR,update:()=>t.view.props.camera.transform.rotation},{name:"viewSize",size:E.TWO,update:()=>[t.view.viewBounds.width,t.view.viewBounds.height]},{name:"pixelRatio",size:E.ONE,update:()=>[t.view.pixelRatio]}]:(console.warn("For a layer 2D to be compatible with a 3D View, the layer requires an additional prop of control2D"),[]):(console.warn("A shader requested the module world2DXZ; however, the layer the shader comes from is NOT a Layer2D which is","required for the module to work."),[])}]);const s1=`vec3 cameraSpace(vec3 world) {
return (world + cameraOffset) * cameraScale2D;
}
vec3 cameraSpaceSize(vec3 worldSize) {
return worldSize * cameraScale2D;
}
vec4 clipSpace(vec3 world) {
return ((projection * view) * vec4(cameraSpace(world.xzy), 1.0));
}
vec4 clipSpaceSize(vec3 worldSize) {
return ((projection * view) * vec4(cameraSpaceSize(worldSize.xzy), 0.0));
}`,a1=`
This is a special helper module used by
the system to map View2D content into
a 3D world space. The system utilizes
this module automatically for you when
you utilize createLayer2Din3D.
`;Ee.register([{moduleId:"world2DXZ",description:a1,content:s1,compatibility:A.ALL,uniforms:t=>t instanceof Ne?t.props.control2D?[{name:"projection",size:E.MATRIX4,update:()=>t.view.props.camera.projection},{name:"view",size:E.MATRIX4,update:()=>t.view.props.camera.view},{name:"cameraOffset",size:E.THREE,update:()=>t.props.control2D instanceof xi?t.props.control2D.offset:[0,0,0]},{name:"cameraPosition",size:E.THREE,update:()=>t.view.props.camera.position},{name:"cameraScale",size:E.THREE,update:()=>t.view.props.camera.scale},{name:"cameraScale2D",size:E.THREE,update:()=>t.props.control2D instanceof xi?t.props.control2D.scale:[1,1,1]},{name:"cameraRotation",size:E.THREE,update:()=>t.view.props.camera.scale},{name:"viewSize",size:E.TWO,update:()=>[t.view.viewBounds.width,t.view.viewBounds.height]},{name:"pixelRatio",size:E.ONE,update:()=>[t.view.pixelRatio]}]:(console.warn("For a layer 2D to be compatible with a 3D View, the layer requires an additional prop of control2D"),[]):(console.warn("A shader requesed the module world2DXZ; however, the layer the shader comes from is NOT a Layer2D which is","required for the module to work."),[])}]);const o1=`vec3 cameraSpace(vec3 world) {
return (world + cameraOffset) * cameraScale2D;
}
vec3 cameraSpaceSize(vec3 worldSize) {
return worldSize * cameraScale2D;
}
vec4 clipSpace(vec3 world) {
return ((projection * view) * vec4(cameraSpace(world.zyx), 1.0));
}
vec4 clipSpaceSize(vec3 worldSize) {
return ((projection * view) * vec4(cameraSpaceSize(worldSize.zyx), 0.0));
}`,c1=`
This is a special helper module used by
the system to map View2D content into
a 3D world space. The system utilizes
this module automatically for you when
you utilize createLayer2Din3D.
`;Ee.register([{moduleId:"world2DYZ",description:c1,content:o1,compatibility:A.ALL,uniforms:t=>t instanceof Ne?t.props.control2D?[{name:"projection",size:E.MATRIX4,update:()=>t.view.props.camera.projection},{name:"view",size:E.MATRIX4,update:()=>t.view.props.camera.view},{name:"cameraOffset",size:E.THREE,update:()=>t.props.control2D instanceof xi?t.props.control2D.offset:[0,0,0]},{name:"cameraPosition",size:E.THREE,update:()=>t.view.props.camera.position},{name:"cameraScale",size:E.THREE,update:()=>t.view.props.camera.scale},{name:"cameraScale2D",size:E.THREE,update:()=>t.props.control2D instanceof xi?t.props.control2D.scale:[1,1,1]},{name:"cameraRotation",size:E.THREE,update:()=>t.view.props.camera.scale},{name:"viewSize",size:E.TWO,update:()=>[t.view.viewBounds.width,t.view.viewBounds.height]},{name:"pixelRatio",size:E.ONE,update:()=>[t.view.pixelRatio]}]:(console.warn("For a layer 2D to be compatible with a 3D View, the layer requires an additional prop of control2D"),[]):(console.warn("A shader requesed the module world2DYZ; however, the layer the shader comes from is NOT a Layer2D which is","required for the module to work."),[])}]);class If extends Ns{screenToWorld(e,i){return i=i||[0,0,0],this.viewToWorld(this.screenToView(e),i),i}screenRay(e){if(this.camera.projectionType===yi.ORTHOGRAPHIC){const i=ki(this.screenToWorld(e));return dc(i,this.camera.transform.forward)}else{const i=ki(this.screenToWorld(e));return fc(ki(this.camera.transform.position),i)}}worldToScreen(e,i){i=i||[0,0];const n=rt(this.camera.projection,this.camera.view),r=Ds(n,e,this.viewBounds.width,this.viewBounds.height);return de(i,r[0]/this.pixelRatio,r[1]/this.pixelRatio)}viewToWorld(e,i){i=i||[0,0,0];const{width:n,height:r}=this.viewBounds,{projectionOptions:s}=this.camera,a=Re(e,this.pixelRatio),{tan:o}=Math;if(s.type===yi.PERSPECTIVE){const{fov:c,near:l}=s,u=r/n,h=o(c/2)*l,f=(2*((a[0]+.5)/n)-1)*h,p=(1-2*((a[1]+.5)/r))*h*u,g=[f,p,-1],m=Or(this.camera.transform.matrix,dr(g,1));pe(i,m[0],m[1],m[2])}else{const c=ye(a,[n/2,r/2]),l=Or(this.camera.transform.viewMatrix,dr(c,-s.near));pe(i,l[0],-l[1],l[2])}return i}worldToView(e,i){i=i||[0,0];const n=rt(this.camera.projection,this.camera.view),r=Ds(n,e,this.viewBounds.width,this.viewBounds.height);return de(i,r[0]/this.pixelRatio,r[1]/this.pixelRatio)}}function l1(t){return t.projectionType===yi.ORTHOGRAPHIC}class Lf extends Xr{constructor(e,i){super(e,i),this.projection=new If,this.projection.camera=i.camera,this.projection.pixelRatio=this.pixelRatio}fitViewtoViewport(e,i){if(wc(this.props.camera)){const n=i.width,r=i.height,s=this.props.camera,a={near:s.projectionOptions.near,far:s.projectionOptions.far,width:n,height:r};this.props.preventCameraAdjustment||(s.projectionOptions=Object.assign(s.projectionOptions,a),s.update()),this.projection.pixelRatio=this.pixelRatio,this.projection.viewBounds=i,this.projection.viewBounds.d=this,this.projection.screenBounds=new te({height:this.projection.viewBounds.height/this.pixelRatio,width:this.projection.viewBounds.width/this.pixelRatio,x:this.projection.viewBounds.x/this.pixelRatio,y:this.projection.viewBounds.y/this.pixelRatio}),this.projection.screenBounds.d=this}else if(l1(this.props.camera)){const n=i.width,r=i.height,s=this.props.camera,a={near:s.projectionOptions.near,far:s.projectionOptions.far,left:-n/2,right:n/2,top:r/2,bottom:-r/2};this.props.preventCameraAdjustment||(s.projectionOptions=Object.assign(s.projectionOptions,a),s.update()),this.projection.pixelRatio=this.pixelRatio,this.projection.viewBounds=i,this.projection.viewBounds.d=this,this.projection.screenBounds=new te({height:this.projection.viewBounds.height/this.pixelRatio,width:this.projection.viewBounds.width/this.pixelRatio,x:this.projection.viewBounds.x/this.pixelRatio,y:this.projection.viewBounds.y/this.pixelRatio}),this.projection.screenBounds.d=this}}willUpdateProps(e){this.projection.camera=e.camera}}Lf.defaultProps={key:"",camera:new bi({type:yi.PERSPECTIVE,width:100,height:100,fov:Math.PI/2,far:1e5,near:1}),viewport:{left:0,right:0,bottom:0,top:0}};var Cf=(t=>(t[t.XY=0]="XY",t[t.XZ=1]="XZ",t[t.YZ=2]="YZ",t))(Cf||{});function u1(t,e,i){if(!(e===Ne||e.prototype instanceof Ne))return console.warn("A Layer type was specified for createLayer2din3D that is NOT a Layer2D type, which is invalid.","The layer will be used without being modified."),En(e,i);let r;switch(t){case 0:r="world2DXY";break;case 1:r="world2DXZ";break;case 2:r="world2DYZ";break;default:return En(e,i)}const s=Object.assign({},i,{baseShaderModules:(a,o)=>{let c=o.vs.indexOf("world2D");return c>=0&&o.vs.splice(c,1,r),c=o.fs.indexOf("world2D"),c>=0&&o.fs.splice(c,1,r),o}});return En(e,s)}class Of extends ei{baseShaderModules(e){const i=super.baseShaderModules(e);return i.vs.push("parent-transform"),i}}const h1=`
When working with SceneGraphLayers, the
layer can have a transform applied to
the layer. This makes that transform
available in the parentTransform
constant.

mat4 parentTransform;
`;Ee.register({moduleId:"parent-transform",description:h1,compatibility:A.VERTEX,content:"",uniforms:t=>{const e=t;if(!(e instanceof Of))return console.warn("A shader requested the module parent-transform; however, the layer the","shader is generated from is NOT a SceneGraphLayer which is","required for the module to work."),[];const i=ue();return[{name:"parentTransform",size:E.MATRIX4,update:()=>{var n;return((n=e.props.parent)==null?void 0:n.matrix)||i}}]}});var d1=Object.defineProperty,f1=Object.getOwnPropertyDescriptor,ln=(t,e,i,n)=>{for(var r=n>1?void 0:n?f1(e,i):e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(r=(n?a(e,i,r):a(r))||r);return n&&r&&d1(e,i,r),r};const Kc=class extends ze{constructor(t){super(t),this.needsLocalUpdate=!1,this.needsWorldUpdate=!1,He(this,Kc);const e=t.transform||new Xs;this.transform=e,t.parent&&(t.parent instanceof Kc?this.parent=t.parent:this.transform.parent=t.parent)}get transform(){return this._transform}set transform(t){this._transform||(this._position=t.position,this._rotation=t.rotation,this._scale=t.scale,this._localPosition=t.localPosition,this._localRotation=t.localRotation,this._localScale=t.localScale,this._matrix=t.matrix,this._localMatrix=t.localMatrix),t.instance=this,this._transform=t}get matrix(){return this._transform.update(),this._matrix}get localMatrix(){return this._transform.update(),this._localMatrix}get localPosition(){return this.needsLocalUpdate=!0,this._localPosition}set localPosition(t){this.transform.localPosition=t}get localRotation(){return this.needsLocalUpdate=!0,this._localRotation}set localRotation(t){this.transform.localRotation=t}get localScale(){return this.needsLocalUpdate=!0,this._localScale}set localScale(t){this.transform.localScale=t}get position(){return this.needsWorldUpdate=!0,this.transform.update(),this._position}set position(t){this.transform.position=t}get rotation(){return this.needsWorldUpdate=!0,this.transform.update(),this._rotation}set rotation(t){this.transform.rotation=t}get scale(){return this.needsWorldUpdate=!0,this.transform.update(),this._scale}set scale(t){this.transform.scale=t}set parent(t){this.transform.parent=t.transform}optimize(){this.needsWorldUpdate=!1,this.needsLocalUpdate=!1,this.transform.optimize()}};let li=Kc;ln([M],li.prototype,"_matrix",2),ln([M],li.prototype,"_localMatrix",2),ln([M],li.prototype,"_localPosition",2),ln([M],li.prototype,"_localRotation",2),ln([M],li.prototype,"_localScale",2),ln([M],li.prototype,"_position",2),ln([M],li.prototype,"_rotation",2),ln([M],li.prototype,"_scale",2);class p1 extends vc{constructor(){super(...arguments),this.isQueuedForUpdate=!1,this.needsWorldOrientation=!1,this.needsWorldDecomposition=!1,this._instance=null,this._matrix={value:ue()},this._localMatrix={value:this._matrix.value},this._position={value:[0,0,0]},this._localPosition={value:this._position.value},this._rotation={value:Br()},this._localRotation={value:0},this.localRotationMatrix=Lr(),this._scale={value:[1,1,1]},this._localScale={value:this._scale.value}}set instance(e){this._instance!==e&&this._instance&&(this._instance.transform.instance=null,e&&(e.transform=this)),this._instance=e}get matrix(){return this.update(),this._matrix.value}get position(){return this.needsWorldOrientation=!0,this.update(),this._position.value}set position(e){this.parent?console.warn("NOT IMPLEMENTED: Setting world position is not supported yet. Use localPosition for now."):this.localPosition=e}get localPosition(){return this._localPosition.value}set localPosition(e){this._localPosition.value[0]=e[0],this._localPosition.value[1]=e[1],this._localPosition.didUpdate=!0,this.invalidate()}get rotation(){return this.needsWorldOrientation=!0,this.update(),this._rotation.value}set rotation(e){console.warn("NOT IMPLEMENTED: Setting world rotation for a 2D transform is not supported yet.")}get localRotation(){return this._localRotation.value}set localRotation(e){this._localRotation.value=e,this._localRotation.didUpdate=!0,this.invalidate()}get scale(){return this.needsWorldOrientation=!0,this.update(),this._scale.value}set scale(e){this.parent?console.warn("NOT IMPLEMENTED: Setting world scale is not supported yet. Use localScale for now."):this.localScale=e}get localScale(){return this._localScale.value}set localScale(e){de(this._localScale.value,e[0],e[1]),this._localScale.didUpdate=!0,this.invalidate()}decomposeWorldMatrix(){if(!this.parent||!this.needsWorldDecomposition||!this.needsWorldOrientation)return;this.needsWorldDecomposition=!1;const e=this._matrix.value,i=this._position.value,n=this._scale.value;this._position.didUpdate=i[0]!==e[12]||i[1]!==e[13]||i[2]!==e[14],this._position.didUpdate&&pe(i,e[12],e[13],e[14]);const r=pi(e[0],e[1],e[2],e[3]),s=pi(e[4],e[5],e[6],e[7]),a=pi(e[8],e[9],e[10],e[11]);this._scale.didUpdate=n[0]!==r||n[1]!==s||n[2]!==a,pe(n,r,s,a),this._scale.didUpdate=!0;const[o,c,l,u]=this._rotation.value;$s(this._matrix.value,r,s,a,this._rotation.value);const h=this._rotation.value;this._rotation.didUpdate=h[0]!==o||h[1]!==c||h[2]!==l||h[3]!==u}queueForUpdate(){!this.isQueuedForUpdate&&this._instance&&this._instance.active&&(this.isQueuedForUpdate=!0,gc(this))}update(e){let i=!1;if(this.isQueuedForUpdate&&(mc(this),this.isQueuedForUpdate=!1),this.needsUpdate){const n=this.localRotationMatrix;this._localRotation.didUpdate&&Yo(this._localRotation.value,n),nc(this._localScale.value,n,this._localPosition.value,this._localMatrix.value),this._localMatrix.didUpdate=!0,i=!0}this.parent&&(this.parent.needsUpdate?(e||this.processParentUpdates(n=>{n.update(!0)}),i=!0):this.parent.childUpdate.has(this)&&(i=!0),i&&(rt(this.parent._matrix.value,this._localMatrix.value,this._matrix.value),this._matrix.didUpdate=!0,this.needsWorldDecomposition=!0)),this.decomposeWorldMatrix(),this._instance&&this._instance.active&&(this._localRotation.didUpdate&&(this._instance._localRotation=this._localRotation.value),this._localPosition.didUpdate&&(this._instance._localPosition=this._localPosition.value),this._localScale.didUpdate&&(this._instance._localScale=this._localScale.value),this.parent?(this._rotation.didUpdate&&(this._instance._rotation=this._rotation.value),this._scale.didUpdate&&(this._instance._scale=this._scale.value),this._position.didUpdate&&(this._instance._position=this._position.value)):(this._localRotation.didUpdate&&(this._instance._rotation=this._localRotation.value),this._localPosition.didUpdate&&(this._instance._position=this._localPosition.value),this._localScale.didUpdate&&(this._instance._scale=this._localScale.value)),(this._matrix.didUpdate||this._localMatrix.didUpdate)&&(this._instance.transform=this)),this._localScale.didUpdate=!1,this._localRotation.didUpdate=!1,this._localPosition.didUpdate=!1,this._rotation.didUpdate=!1,this._scale.didUpdate=!1,this._position.didUpdate=!1,this._matrix.didUpdate=!1,this._localMatrix.didUpdate=!1,this.resolve()}}const g1=`varying vec2 _texCoord;
void main() {
gl_FragColor = mix(
vec4(1.0, 0.0, 0.0, 1.0),
vec4(0.0, 0.0, 0.0, 1.0),
float(_texCoord.x <= 0.01 || _texCoord.x > 0.99 || _texCoord.y < 0.01 || _texCoord.y > 0.99)
);
}`,m1=`\${import: projection}
varying vec2 _texCoord;
void main() {
vec4 pos = vec4(position * size, 1.0);
vec4 world = transform * pos;
_texCoord = texCoord;
gl_Position = clipSpace(world.xyz);
}`;class Nf extends ei{initShader(){const e=[1,1,1],i=[1,1,-1],n=[1,-1,-1],r=[1,-1,1],s=[-1,1,1],a=[-1,1,-1],o=[-1,-1,-1],c=[-1,-1,1],l=[e,i,n,e,n,r,s,e,r,s,r,c,s,o,a,s,c,o,a,n,i,a,o,n,s,i,e,s,a,i,c,r,n,c,n,o],u=[1,0,0],h=[0,0,1],f=[-1,0,0],p=[0,0,-1],g=[0,1,0],m=[0,-1,0],T=[u,u,u,u,u,u,h,h,h,h,h,h,f,f,f,f,f,f,p,p,p,p,p,p,g,g,g,g,g,g,m,m,m,m,m,m],w=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1],[0,0],[1,0],[1,1],[0,0],[1,1],[0,1],[0,0],[1,1],[1,0],[0,0],[0,1],[1,1],[0,0],[1,1],[1,0],[0,0],[0,1],[1,1],[0,0],[1,1],[1,0],[0,0],[0,1],[1,1],[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];return{drawMode:d.GLSettings.Model.DrawMode.TRIANGLES,fs:[{outputType:$.COLOR,source:g1}],instanceAttributes:[{name:"transform",size:C.MAT4X4,update:y=>(y.transform||kh).matrix},{name:"size",size:C.THREE,update:y=>y.size}],uniforms:[],vertexAttributes:[{name:"position",size:Be.THREE,update:y=>l[y]},{name:"normal",size:Be.THREE,update:y=>T[y]},{name:"texCoord",size:Be.TWO,update:y=>w[y]}],vertexCount:36,vs:m1}}getMaterialOptions(){return Object.assign({},tt.transparentShapeBlending,{cullSide:d.GLSettings.Material.CullSide.CCW})}}Nf.defaultProps={data:new he,key:"",materialOptions:tt.transparentShapeBlending};var v1=Object.defineProperty,w1=Object.getOwnPropertyDescriptor,Pf=(t,e,i,n)=>{for(var r=n>1?void 0:n?w1(e,i):e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(r=(n?a(e,i,r):a(r))||r);return n&&r&&v1(e,i,r),r};const Df=class extends li{constructor(t){super(t),this.size=[1,1,1],this.color=[1,1,1,1],He(this,Df),this.size=t.size||this.size,this.color=t.color||this.color}};let Zc=Df;Pf([M],Zc.prototype,"size",2),Pf([M],Zc.prototype,"color",2);var Jc={exports:{}},es={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Ff;function T1(){if(Ff)return es;Ff=1;var t=q,e=Symbol.for("react.element"),i=Symbol.for("react.fragment"),n=Object.prototype.hasOwnProperty,r=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,s={key:!0,ref:!0,__self:!0,__source:!0};function a(o,c,l){var u,h={},f=null,p=null;l!==void 0&&(f=""+l),c.key!==void 0&&(f=""+c.key),c.ref!==void 0&&(p=c.ref);for(u in c)n.call(c,u)&&!s.hasOwnProperty(u)&&(h[u]=c[u]);if(o&&o.defaultProps)for(u in c=o.defaultProps,c)h[u]===void 0&&(h[u]=c[u]);return{$$typeof:e,type:o,key:f,ref:p,props:h,_owner:r.current}}return es.Fragment=i,es.jsx=a,es.jsxs=a,es}var ts={};/**
 * @license React
 * react-jsx-runtime.development.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Bf;function y1(){return Bf||(Bf=1,process.env.NODE_ENV!=="production"&&function(){var t=q,e=Symbol.for("react.element"),i=Symbol.for("react.portal"),n=Symbol.for("react.fragment"),r=Symbol.for("react.strict_mode"),s=Symbol.for("react.profiler"),a=Symbol.for("react.provider"),o=Symbol.for("react.context"),c=Symbol.for("react.forward_ref"),l=Symbol.for("react.suspense"),u=Symbol.for("react.suspense_list"),h=Symbol.for("react.memo"),f=Symbol.for("react.lazy"),p=Symbol.for("react.offscreen"),g=Symbol.iterator,m="@@iterator";function T(v){if(v===null||typeof v!="object")return null;var _=g&&v[g]||v[m];return typeof _=="function"?_:null}var w=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;function y(v){{for(var _=arguments.length,O=new Array(_>1?_-1:0),k=1;k<_;k++)O[k-1]=arguments[k];b("error",v,O)}}function b(v,_,O){{var k=w.ReactDebugCurrentFrame,ie=k.getStackAddendum();ie!==""&&(_+="%s",O=O.concat([ie]));var ce=O.map(function(J){return String(J)});ce.unshift("Warning: "+_),Function.prototype.apply.call(console[v],console,ce)}}var x=!1,R=!1,N=!1,I=!1,S=!1,j;j=Symbol.for("react.module.reference");function Q(v){return!!(typeof v=="string"||typeof v=="function"||v===n||v===s||S||v===r||v===l||v===u||I||v===p||x||R||N||typeof v=="object"&&v!==null&&(v.$$typeof===f||v.$$typeof===h||v.$$typeof===a||v.$$typeof===o||v.$$typeof===c||v.$$typeof===j||v.getModuleId!==void 0))}function D(v,_,O){var k=v.displayName;if(k)return k;var ie=_.displayName||_.name||"";return ie!==""?O+"("+ie+")":O}function H(v){return v.displayName||"Context"}function z(v){if(v==null)return null;if(typeof v.tag=="number"&&y("Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue."),typeof v=="function")return v.displayName||v.name||null;if(typeof v=="string")return v;switch(v){case n:return"Fragment";case i:return"Portal";case s:return"Profiler";case r:return"StrictMode";case l:return"Suspense";case u:return"SuspenseList"}if(typeof v=="object")switch(v.$$typeof){case o:var _=v;return H(_)+".Consumer";case a:var O=v;return H(O._context)+".Provider";case c:return D(v,v.render,"ForwardRef");case h:var k=v.displayName||null;return k!==null?k:z(v.type)||"Memo";case f:{var ie=v,ce=ie._payload,J=ie._init;try{return z(J(ce))}catch{return null}}}return null}var V=Object.assign,ne=0,W,oe,Y,Ce,ee,Me,Pi;function Di(){}Di.__reactDisabledLog=!0;function Fi(){{if(ne===0){W=console.log,oe=console.info,Y=console.warn,Ce=console.error,ee=console.group,Me=console.groupCollapsed,Pi=console.groupEnd;var v={configurable:!0,enumerable:!0,value:Di,writable:!0};Object.defineProperties(console,{info:v,log:v,warn:v,error:v,group:v,groupCollapsed:v,groupEnd:v})}ne++}}function di(){{if(ne--,ne===0){var v={configurable:!0,enumerable:!0,writable:!0};Object.defineProperties(console,{log:V({},v,{value:W}),info:V({},v,{value:oe}),warn:V({},v,{value:Y}),error:V({},v,{value:Ce}),group:V({},v,{value:ee}),groupCollapsed:V({},v,{value:Me}),groupEnd:V({},v,{value:Pi})})}ne<0&&y("disabledDepth fell below zero. This is a bug in React. Please file an issue.")}}var Bi=w.ReactCurrentDispatcher,sr;function Nn(v,_,O){{if(sr===void 0)try{throw Error()}catch(ie){var k=ie.stack.trim().match(/\n( *(at )?)/);sr=k&&k[1]||""}return`
`+sr+v}}var rl=!1,ya;{var G1=typeof WeakMap=="function"?WeakMap:Map;ya=new G1}function Yf(v,_){if(!v||rl)return"";{var O=ya.get(v);if(O!==void 0)return O}var k;rl=!0;var ie=Error.prepareStackTrace;Error.prepareStackTrace=void 0;var ce;ce=Bi.current,Bi.current=null,Fi();try{if(_){var J=function(){throw Error()};if(Object.defineProperty(J.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(J,[])}catch(Ui){k=Ui}Reflect.construct(v,[],J)}else{try{J.call()}catch(Ui){k=Ui}v.call(J.prototype)}}else{try{throw Error()}catch(Ui){k=Ui}v()}}catch(Ui){if(Ui&&k&&typeof Ui.stack=="string"){for(var K=Ui.stack.split(`
`),Xe=k.stack.split(`
`),_e=K.length-1,Ie=Xe.length-1;_e>=1&&Ie>=0&&K[_e]!==Xe[Ie];)Ie--;for(;_e>=1&&Ie>=0;_e--,Ie--)if(K[_e]!==Xe[Ie]){if(_e!==1||Ie!==1)do if(_e--,Ie--,Ie<0||K[_e]!==Xe[Ie]){var pt=`
`+K[_e].replace(" at new "," at ");return v.displayName&&pt.includes("<anonymous>")&&(pt=pt.replace("<anonymous>",v.displayName)),typeof v=="function"&&ya.set(v,pt),pt}while(_e>=1&&Ie>=0);break}}}finally{rl=!1,Bi.current=ce,di(),Error.prepareStackTrace=ie}var or=v?v.displayName||v.name:"",cp=or?Nn(or):"";return typeof v=="function"&&ya.set(v,cp),cp}function k1(v,_,O){return Yf(v,!1)}function z1(v){var _=v.prototype;return!!(_&&_.isReactComponent)}function ba(v,_,O){if(v==null)return"";if(typeof v=="function")return Yf(v,z1(v));if(typeof v=="string")return Nn(v);switch(v){case l:return Nn("Suspense");case u:return Nn("SuspenseList")}if(typeof v=="object")switch(v.$$typeof){case c:return k1(v.render);case h:return ba(v.type,_,O);case f:{var k=v,ie=k._payload,ce=k._init;try{return ba(ce(ie),_,O)}catch{}}}return""}var Ea=Object.prototype.hasOwnProperty,qf={},Kf=w.ReactDebugCurrentFrame;function _a(v){if(v){var _=v._owner,O=ba(v.type,v._source,_?_.type:null);Kf.setExtraStackFrame(O)}else Kf.setExtraStackFrame(null)}function V1(v,_,O,k,ie){{var ce=Function.call.bind(Ea);for(var J in v)if(ce(v,J)){var K=void 0;try{if(typeof v[J]!="function"){var Xe=Error((k||"React class")+": "+O+" type `"+J+"` is invalid; it must be a function, usually from the `prop-types` package, but received `"+typeof v[J]+"`.This often happens because of typos such as `PropTypes.function` instead of `PropTypes.func`.");throw Xe.name="Invariant Violation",Xe}K=v[J](_,J,k,O,null,"SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED")}catch(_e){K=_e}K&&!(K instanceof Error)&&(_a(ie),y("%s: type specification of %s `%s` is invalid; the type checker function must return `null` or an `Error` but returned a %s. You may have forgotten to pass an argument to the type checker creator (arrayOf, instanceOf, objectOf, oneOf, oneOfType, and shape all require an argument).",k||"React class",O,J,typeof K),_a(null)),K instanceof Error&&!(K.message in qf)&&(qf[K.message]=!0,_a(ie),y("Failed %s type: %s",O,K.message),_a(null))}}}var W1=Array.isArray;function sl(v){return W1(v)}function $1(v){{var _=typeof Symbol=="function"&&Symbol.toStringTag,O=_&&v[Symbol.toStringTag]||v.constructor.name||"Object";return O}}function j1(v){try{return Zf(v),!1}catch{return!0}}function Zf(v){return""+v}function Jf(v){if(j1(v))return y("The provided key is an unsupported type %s. This value must be coerced to a string before before using it here.",$1(v)),Zf(v)}var is=w.ReactCurrentOwner,H1={key:!0,ref:!0,__self:!0,__source:!0},ep,tp,al;al={};function Q1(v){if(Ea.call(v,"ref")){var _=Object.getOwnPropertyDescriptor(v,"ref").get;if(_&&_.isReactWarning)return!1}return v.ref!==void 0}function X1(v){if(Ea.call(v,"key")){var _=Object.getOwnPropertyDescriptor(v,"key").get;if(_&&_.isReactWarning)return!1}return v.key!==void 0}function Y1(v,_){if(typeof v.ref=="string"&&is.current&&_&&is.current.stateNode!==_){var O=z(is.current.type);al[O]||(y('Component "%s" contains the string ref "%s". Support for string refs will be removed in a future major release. This case cannot be automatically converted to an arrow function. We ask you to manually fix this case by using useRef() or createRef() instead. Learn more about using refs safely here: https://reactjs.org/link/strict-mode-string-ref',z(is.current.type),v.ref),al[O]=!0)}}function q1(v,_){{var O=function(){ep||(ep=!0,y("%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",_))};O.isReactWarning=!0,Object.defineProperty(v,"key",{get:O,configurable:!0})}}function K1(v,_){{var O=function(){tp||(tp=!0,y("%s: `ref` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",_))};O.isReactWarning=!0,Object.defineProperty(v,"ref",{get:O,configurable:!0})}}var Z1=function(v,_,O,k,ie,ce,J){var K={$$typeof:e,type:v,key:_,ref:O,props:J,_owner:ce};return K._store={},Object.defineProperty(K._store,"validated",{configurable:!1,enumerable:!1,writable:!0,value:!1}),Object.defineProperty(K,"_self",{configurable:!1,enumerable:!1,writable:!1,value:k}),Object.defineProperty(K,"_source",{configurable:!1,enumerable:!1,writable:!1,value:ie}),Object.freeze&&(Object.freeze(K.props),Object.freeze(K)),K};function J1(v,_,O,k,ie){{var ce,J={},K=null,Xe=null;O!==void 0&&(Jf(O),K=""+O),X1(_)&&(Jf(_.key),K=""+_.key),Q1(_)&&(Xe=_.ref,Y1(_,ie));for(ce in _)Ea.call(_,ce)&&!H1.hasOwnProperty(ce)&&(J[ce]=_[ce]);if(v&&v.defaultProps){var _e=v.defaultProps;for(ce in _e)J[ce]===void 0&&(J[ce]=_e[ce])}if(K||Xe){var Ie=typeof v=="function"?v.displayName||v.name||"Unknown":v;K&&q1(J,Ie),Xe&&K1(J,Ie)}return Z1(v,K,Xe,ie,k,is.current,J)}}var ol=w.ReactCurrentOwner,ip=w.ReactDebugCurrentFrame;function ar(v){if(v){var _=v._owner,O=ba(v.type,v._source,_?_.type:null);ip.setExtraStackFrame(O)}else ip.setExtraStackFrame(null)}var cl;cl=!1;function ll(v){return typeof v=="object"&&v!==null&&v.$$typeof===e}function np(){{if(ol.current){var v=z(ol.current.type);if(v)return`

Check the render method of \``+v+"`."}return""}}function ew(v){{if(v!==void 0){var _=v.fileName.replace(/^.*[\\\/]/,""),O=v.lineNumber;return`

Check your code at `+_+":"+O+"."}return""}}var rp={};function tw(v){{var _=np();if(!_){var O=typeof v=="string"?v:v.displayName||v.name;O&&(_=`

Check the top-level render call using <`+O+">.")}return _}}function sp(v,_){{if(!v._store||v._store.validated||v.key!=null)return;v._store.validated=!0;var O=tw(_);if(rp[O])return;rp[O]=!0;var k="";v&&v._owner&&v._owner!==ol.current&&(k=" It was passed a child from "+z(v._owner.type)+"."),ar(v),y('Each child in a list should have a unique "key" prop.%s%s See https://reactjs.org/link/warning-keys for more information.',O,k),ar(null)}}function ap(v,_){{if(typeof v!="object")return;if(sl(v))for(var O=0;O<v.length;O++){var k=v[O];ll(k)&&sp(k,_)}else if(ll(v))v._store&&(v._store.validated=!0);else if(v){var ie=T(v);if(typeof ie=="function"&&ie!==v.entries)for(var ce=ie.call(v),J;!(J=ce.next()).done;)ll(J.value)&&sp(J.value,_)}}}function iw(v){{var _=v.type;if(_==null||typeof _=="string")return;var O;if(typeof _=="function")O=_.propTypes;else if(typeof _=="object"&&(_.$$typeof===c||_.$$typeof===h))O=_.propTypes;else return;if(O){var k=z(_);V1(O,v.props,"prop",k,v)}else if(_.PropTypes!==void 0&&!cl){cl=!0;var ie=z(_);y("Component %s declared `PropTypes` instead of `propTypes`. Did you misspell the property assignment?",ie||"Unknown")}typeof _.getDefaultProps=="function"&&!_.getDefaultProps.isReactClassApproved&&y("getDefaultProps is only used on classic React.createClass definitions. Use a static property named `defaultProps` instead.")}}function nw(v){{for(var _=Object.keys(v.props),O=0;O<_.length;O++){var k=_[O];if(k!=="children"&&k!=="key"){ar(v),y("Invalid prop `%s` supplied to `React.Fragment`. React.Fragment can only have `key` and `children` props.",k),ar(null);break}}v.ref!==null&&(ar(v),y("Invalid attribute `ref` supplied to `React.Fragment`."),ar(null))}}function op(v,_,O,k,ie,ce){{var J=Q(v);if(!J){var K="";(v===void 0||typeof v=="object"&&v!==null&&Object.keys(v).length===0)&&(K+=" You likely forgot to export your component from the file it's defined in, or you might have mixed up default and named imports.");var Xe=ew(ie);Xe?K+=Xe:K+=np();var _e;v===null?_e="null":sl(v)?_e="array":v!==void 0&&v.$$typeof===e?(_e="<"+(z(v.type)||"Unknown")+" />",K=" Did you accidentally export a JSX literal instead of a component?"):_e=typeof v,y("React.jsx: type is invalid -- expected a string (for built-in components) or a class/function (for composite components) but got: %s.%s",_e,K)}var Ie=J1(v,_,O,ie,ce);if(Ie==null)return Ie;if(J){var pt=_.children;if(pt!==void 0)if(k)if(sl(pt)){for(var or=0;or<pt.length;or++)ap(pt[or],v);Object.freeze&&Object.freeze(pt)}else y("React.jsx: Static children should always be an array. You are likely explicitly calling React.jsxs or React.jsxDEV. Use the Babel transform instead.");else ap(pt,v)}return v===n?nw(Ie):iw(Ie),Ie}}function rw(v,_,O){return op(v,_,O,!0)}function sw(v,_,O){return op(v,_,O,!1)}var aw=sw,ow=rw;ts.Fragment=n,ts.jsx=aw,ts.jsxs=ow}()),ts}process.env.NODE_ENV==="production"?Jc.exports=T1():Jc.exports=y1();var Pe=Jc.exports;function un(t,e,i,n={current:0},r=""){const s=e.get(i),a=new Set,o=q.useRef([]),c=new Set;o.current=[],r=r?`${r}.`:"";let l=[];return s&&(l=q.Children.map(s,u=>{if(q.isValidElement(u)){const h=u.key||n.current++,f=`${r}${u.props.name||`${h}`}`,p=t.get(f)||new ke;t.set(f,p),o.current.push(p),u.props.share&&(u.props.share.current=p);const g={key:h,name:f,resolver:p};return a.has(g.name)?c.add(g.name):a.add(g.name),q.cloneElement(u,g)}})),[l,Promise.all(o.current.map(u=>u==null?void 0:u.promise)),{resolvers:o,nameConflict:c}]}function el(...t){return t.filter(me).reduce((e,i)=>e.concat(i),[])}function b1(t){const{children:e,tagName:i,...n}=t,r=Object.keys(n).reduce((s,a)=>{try{vi(a)&&(s[a.toLowerCase()]=JSON.stringify(n[a]))}catch{}return s},{});return{tagName:i,attributes:r,children:e}}const ui=t=>{const{tagName:e="",attributes:i,children:n}=b1(t),{writeToDom:r}=q.useContext(rr)||{};return r?q.createElement(e,i,n):t.children};var We=(t=>(t[t.EVENT_MANAGER=1]="EVENT_MANAGER",t[t.LAYER=2]="LAYER",t[t.CAMERA=3]="CAMERA",t[t.PROVIDER=4]="PROVIDER",t[t.RESOURCE=5]="RESOURCE",t[t.VIEW=6]="VIEW",t[t.SCENE=7]="SCENE",t))(We||{});function Uf(t,e,i){var s,a;const n=new Map,r=[];for(e&&e.forEach(o=>{n.set(o,[])}),q.Children.forEach(t,(o,c)=>{r.push(o)}),r.reverse();r.length>0;){const o=r.pop();if(q.isValidElement(o)){if(o!==void 0&&((o==null?void 0:o.type)===q.Fragment||o.props.surfaceJSXType===void 0)){if(!((s=o==null?void 0:o.props)!=null&&s.children)){i&&i.push(o);continue}const c=[];q.Children.forEach(((a=o==null?void 0:o.props)==null?void 0:a.children)||[],l=>{c.push(l)});for(let l=c.length-1;l>=0;--l)r.push(c[l]);continue}else if(o!==void 0){if(o.props.surfaceJSXType===void 0){i&&i.push(o);continue}if(e){const c=n.get(o.props.surfaceJSXType);if(!c){i&&i.push(o);continue}c.push(o)}else{let c=n.get(o.props.surfaceJSXType);c||(c=[],n.set(o.props.surfaceJSXType,c)),c.push(o)}}}}return n}function E1(t){return t&&t.charCodeAt!==void 0}function _1(t){return t!=null}const Gf=()=>{};class R1{constructor(e){this.resolver=Gf,this.rejector=Gf,this.promise=new Promise((i,n)=>(this.resolver=i,this.rejector=n))}resolve(e){this.resolver(e)}reject(e){this.rejector(e)}hijack(e){this.children=this.children||[],this.children.push(e),this.childResolvers=this.childResolvers||new Map,this.childResolvers.set(e,e.resolver),e.resolver=async i=>{this.childResolutions=this.childResolutions||new Map,this.childResolutions.set(e,i)}}}function Ni(t,e){var o,c;const[i,n]=q.useState(!0),[r,s]=q.useState(!1),a={store:t,shouldMount:i};if(!r&&_1(t.willMount)&&(a.shouldMount=!!((o=t.willMount)!=null&&o.call(t))),r){const l=(c=t.willUpdate)==null?void 0:c.call(t);l&&(async()=>await l())()}return q.useEffect(()=>{const l=new R1;s(!0),n(a.shouldMount);let u;return(async()=>{var h;u=await((h=t.didMount)==null?void 0:h.call(t)),l.resolve(!0)})(),()=>{(async()=>(await l.promise,u==null||u()))()}},[]),q.useEffect(()=>{var l;r&&(a.shouldMount=!!((l=t.willMount)!=null&&l.call(t)))},e||[0]),a}const lw="",rr=q.createContext(void 0),x1=t=>{const e=q.useRef(null),i=q.useRef(null),n=q.useRef(0),r=q.useRef(null),s=q.useRef(null),a=q.useRef(-1),o=q.useRef(new Map),c=q.useRef(new Map),l=q.useRef(new Map),u=q.useRef(new Map),h=q.useRef(new Map),f=q.useRef(new ke),p={current:0},g=[],m=Uf(t.children,void 0,g);g.length&&console.warn("Surface found unsupported children",g);const[T,w]=un(o.current,m,We.EVENT_MANAGER,p),[y,b]=un(c.current,m,We.RESOURCE,p),[x,R,{nameConflict:N}]=un(h.current,m,We.SCENE,p),[I,S,{nameConflict:j}]=un(u.current,m,We.LAYER,p),[Q,D,{nameConflict:H}]=un(l.current,m,We.VIEW,p);if(N.size>0){console.warn("Root Scene name conflict:",N);return}if(j.size>0){console.warn("Root Scene Layer name conflict:",j);return}if(H.size>0){console.warn("Root Scene View name conflict:",H);return}const z=async W=>{r.current&&(n.current=W,r.current.draw(W))},V=W=>{var oe,Y,Ce,ee,Me,Pi;(oe=i.current)==null||oe.remove(),(ee=r.current)==null||ee.resize(((Y=e.current)==null?void 0:Y.offsetWidth)||0,((Ce=e.current)==null?void 0:Ce.offsetHeight)||0),i.current&&((Me=e.current)==null||Me.appendChild(i.current)),W||(Pi=r.current)==null||Pi.draw(n.current)},ne=()=>{window.clearTimeout(a.current),a.current=window.setTimeout(()=>{V(!0)})};return Ni({async didMount(){var sr;if(!i.current||!e.current)return;const[W,oe,Y,Ce,ee]=await Promise.all([w,b,R,S,D]),Me=Y.filter(me),Pi=W.filter(me),Di=oe.filter(me),Fi=Ce.filter(me),di=ee.filter(me);if(Y.length<=0&&(!(Fi!=null&&Fi.length)||!(di!=null&&di.length))){console.error("No scenes or root level Layers+Views provided to surface");return}di.length&&Fi.length&&Me.unshift({key:"root",layers:Fi,views:di});const Bi=await new of({context:i.current,handlesWheelEvents:t.handlesWheelEvents!==void 0?t.handlesWheelEvents:!0,pixelRatio:t.pixelRatio||window.devicePixelRatio,eventManagers:Pi,ioExpansion:t.ioExpansion,shaderTransforms:t.shaderTransforms,resourceManagers:t.resourceManagers,rendererOptions:Object.assign({alpha:!0,antialias:!1},t.options)}).ready;return s.current=pc(z),Bi.pipeline({resources:Di,scenes:Me}),r.current=Bi,await Ti(),V(!0),(sr=t.ready)==null||sr.resolve(r.current),window.addEventListener("resize",ne),()=>{var Nn;window.removeEventListener("resize",ne),Uh(s.current),(Nn=r.current)==null||Nn.destroy()}}}),Pe.jsx("div",{ref:e,className:`SurfaceJSX ${t.className||""}`,...t.containerProps,children:Pe.jsx("canvas",{ref:i,children:Pe.jsx(rr.Provider,{value:{writeToDom:t.writeToDom,eventResolvers:o.current,resourceResolvers:c.current,viewResolvers:l.current,layerResolvers:u.current,sceneResolvers:h.current,resolversReady:f.current},children:Pe.jsx(ui,{tagName:"Surface",...t,children:el(T,y,Q,I,x)})})})})},kf=t=>(Ni({didMount(){var e;(e=t.resolver)==null||e.resolve(new Fc(t.handlers,t.preserveEvents))}}),Pe.jsx(ui,{tagName:"QueuedEventHandler",...t}));kf.defaultProps={surfaceJSXType:We.EVENT_MANAGER};const zf=t=>(Ni({didMount(){var e;(e=t.resolver)==null||e.resolve(new ns(t.handlers))}}),Pe.jsx(ui,{tagName:"SimpleEventHandler",...t}));zf.defaultProps={surfaceJSXType:We.EVENT_MANAGER};const Vf=t=>(Ni({didMount(){var e;(e=t.resolver)==null||e.resolve(new lf(t.config))}}),Pe.jsx(ui,{tagName:"BasicCamera2DController",...t}));Vf.defaultProps={surfaceJSXType:We.EVENT_MANAGER};const Wf=t=>(Ni({didMount(){var e;(e=t.resolver)==null||e.resolve(bc({key:t.name,height:t.height,width:t.width,textureSettings:t.textureSettings}))}}),Pe.jsx(ui,{tagName:"Texture",...t}));Wf.defaultProps={surfaceJSXType:We.RESOURCE};const $f=t=>(Ni({didMount(){var e;(e=t.resolver)==null||e.resolve(Sc({key:t.name,fontSource:t.fontSource,characterFilter:t.characterFilter,dynamic:t.dynamic,fontMap:t.fontMap,fontMapSize:t.fontMapSize}))}}),Pe.jsx(ui,{tagName:"Font",...t}));$f.defaultProps={surfaceJSXType:We.RESOURCE};const ma=t=>{const e=q.useContext(rr);return Ni({async didMount(){var a;let i=t.config;const n=t.uses;if(n){await(e==null?void 0:e.resolversReady);const o={},c=n.names.map(async l=>{var f,p;const u=(f=e==null?void 0:e.resourceResolvers)==null?void 0:f.get(l);if(!u)return console.error(`A layer requested a resource: ${l} but the name identifier was not found in the available resources`),console.warn("Available resources:",Array.from(((p=e==null?void 0:e.resourceResolvers)==null?void 0:p.keys())||[])),null;const h=await u.promise;if(!h)return console.error(`The Layer requested a resource "${l}", but the resource did not resolve a value`),null;if(!bn(h))return console.error(`The Layer requested a resource "${l}", but the resource resolved to a value that is not a render texture resource`),null;o[l]=h}).filter(me);await Promise.all(c),i=n.apply(o,{...t.config})}const r=En(t.type,{key:t.name,...i});let s=r.init[1].data;s===r.init[0].defaultProps.data&&(s=new he,r.init[1].data=s),t.providerRef&&s instanceof he&&(t.providerRef.current=s),(a=t.resolver)==null||a.resolve(r)}}),Pe.jsx(ui,{tagName:"Layer",...t})};ma.defaultProps={surfaceJSXType:We.LAYER};function jf(t,e,i){var r,s;const n=(r=e==null?void 0:e.resourceResolvers)==null?void 0:r.get(i);return n||(console.error(`A View "${t}" requested a resource: ${i} but the name identifier was not found in the available resources`),console.warn("Available resources:",Array.from(((s=e==null?void 0:e.resourceResolvers)==null?void 0:s.keys())||[])),null)}const va=t=>{const e=q.useContext(rr);return Ni({async didMount(){var c,l,u;t.config.output&&!t.output&&console.warn("Do NOT use the output property in the config. Use the output property on the props of the JSX element"),await(e==null?void 0:e.resolversReady);const i=((c=t.output)==null?void 0:c.buffers)||{},n=Object.entries(i).map(([h,f])=>{const p=jf(t.name,e,f);return p?[Number.parseInt(h),p,f]:(console.warn("View props",t),null)}).filter(me),r={};await Promise.all(n.map(async h=>{const f=await h[1].promise;bn(f)||Ys(f)?r[h[0]]=f:(console.error(`A View "${t.name}" requested an output buffer for the resource with name: ${h[2]} but the resource indicated is not a valid output target type.`,"Ensure the resource is a RenderTextureResource or ColorBufferResource"),console.warn("View props",t))}));let s=!0;const a=(l=t.output)==null?void 0:l.depth;if(E1(a)){const h=jf(t.name,e,a);if(!h)console.warn("View props",t),s=!1;else{const f=await h.promise;bn(f)||Ys(f)?s=f:(console.error(`A View "${t.name}" requested a depth buffer for the resource with name: ${a} but the resource indicated is not a valid output target type.`,"Ensure the resource is a RenderTextureResource or ColorBufferResource"),console.warn("View props",t))}}else me(a)&&(s=a);const o=Pc(t.type,{key:t.name,...t.config,output:t.output?{buffers:r,depth:s}:void 0});(u=t.resolver)==null||u.resolve(o)}}),Pe.jsx(ui,{tagName:"View",...t})};va.defaultProps={surfaceJSXType:We.VIEW};const wa=t=>{var u,h,f,p;const e=q.useContext(rr),i={current:0},n=Uf(t.children),[r,s,{nameConflict:a}]=un((e==null?void 0:e.layerResolvers)||new Map,n,We.LAYER,i,t.name),[o,c,{nameConflict:l}]=un((e==null?void 0:e.viewResolvers)||new Map,n,We.VIEW,i,t.name);if(a.size>0){console.warn(`Scene ${t.name} Layer name conflict:`,a),(u=t.resolver)==null||u.resolve(null);return}if(l.size>0){console.warn(`Scene ${t.name} View name conflict:`,l),(h=t.resolver)==null||h.resolve(null);return}if(!r){console.warn("A Scene had no Layers:",t.name),(f=t.resolver)==null||f.resolve(null);return}if(!o){console.warn("A Scene had no Views:",t.name),(p=t.resolver)==null||p.resolve(null);return}return Ni({async didMount(){var T;const[g,m]=await Promise.all([s,c]);(T=t.resolver)==null||T.resolve({key:t.name,layers:g.filter(me),views:m.filter(me)})}}),Pe.jsx(ui,{tagName:"Scene",...t,children:el(o,r)})};wa.defaultProps={surfaceJSXType:We.SCENE};function A1(t){const e=[];for(let i=0,n=t.length;i<n;++i){const r=t[i];for(let s=0,a=r.length;s<a;++s)e.push(r[s])}return e}var S1=Object.defineProperty,M1=Object.getOwnPropertyDescriptor,I1=(t,e,i,n)=>{for(var r=n>1?void 0:n?M1(e,i):e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(r=(n?a(e,i,r):a(r))||r);return n&&r&&S1(e,i,r),r};const Hf=class extends ze{constructor(){super(),this.tint=[1,1,1,1],He(this,Hf)}};let tl=Hf;I1([M],tl.prototype,"tint",2);const Qf=new se({data:{width:2,height:2,buffer:new Uint8Array(16)}});class il extends ei{initShader(){const{buffers:e,fs:i,data:n}=this.props,r=new tl;n instanceof he&&n.add(r),this.alwaysDraw=!0;const s=[[-1,-1],[1,-1],[-1,1],[1,1]],a=s.map(l=>[l[0]===1?1:0,l[1]===1?1:0]),o=A1(Object.keys(e).map(l=>{const u=e[l];if(!u)return;const h=u.key,f=jr({key:h});return[{name:l,shaderInjection:A.FRAGMENT,size:E.TEXTURE,update:()=>(this.resource.request(this,r,f),f.texture||Qf)},{name:`${l}_size`,shaderInjection:A.FRAGMENT,size:E.TWO,update:()=>{this.props,this.resource.request(this,r,f);const p=(f.texture||Qf).data;return[(p==null?void 0:p.width)||1,(p==null?void 0:p.height)||1]}}]}).filter(me));let c=this.props.uniforms||[];return Array.isArray(c)||(c=c(this)),{drawMode:d.GLSettings.Model.DrawMode.TRIANGLE_STRIP,vs:`
        varying vec2 texCoord;

        void main() {
          gl_Position = vec4(vertex, 0.0, 1.0);
          texCoord = tex;
        }
      `,fs:i,instanceAttributes:[{name:"dummy",size:C.ONE,update:l=>[0]}],uniforms:o.concat(c),vertexAttributes:[{name:"vertex",size:Be.TWO,update:l=>s[l]},{name:"tex",size:Be.TWO,update:l=>a[l]}],vertexCount:4}}shouldDrawView(){return!0}getMaterialOptions(){return tt.transparentImageBlending.modify({depthTest:!1})}}il.defaultProps={key:"",data:new he,buffers:{},baseShaderModules:()=>({fs:[],vs:[]}),fs:"void main() { gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);"};const hi=t=>{var e;return Pe.jsxs(wa,{name:t.name,children:[Pe.jsx(va,{name:"fullscreen",type:ua,...t.view,config:{camera:new Ai,viewport:{left:0,top:0,width:"100%",height:"100%"},...(e=t.view)==null?void 0:e.config}}),Pe.jsx(ma,{name:"postprocess",type:il,uses:{names:Object.values(t.buffers),apply:(i,n)=>{var r;return n.buffers={},Object.keys(t.buffers).map(s=>{n.buffers[s]=i[t.buffers[s]]}),(r=t.onResources)==null||r.call(t,i),n}},config:{printShader:t.printShader,buffers:{},fs:t.shader,uniforms:t.uniforms,materialOptions:t.material}})]},t.name)},L1=t=>Pe.jsxs(wa,{name:t.name,children:[Pe.jsx(va,{type:ua,config:{camera:new Ai}}),Pe.jsx(ma,{type:Uc,config:{commands:t.callback}})]}),C1=`\${import: camera}
varying vec2 texCoord;
void main() {
vec2 texelSize = 1.0 / viewSize;
vec4 o = texelSize.xyxy * vec2(-delta, delta).xxyy;
vec4 s =
texture2D(color, texCoord + o.xy) + texture2D(color, texCoord + o.zy) +
texture2D(color, texCoord + o.xw) + texture2D(color, texCoord + o.zw);
gl_FragColor = s * 0.25;
}`;var Ta=(t=>(t[t.DOWN=0]="DOWN",t[t.UP=1]="UP",t))(Ta||{});function nl(t){const{output:e,input:i}=t;return hi({name:t.name,printShader:t.printShader,view:Object.assign(e?{output:{buffers:{[$.COLOR]:e},depth:!1}}:{},t.view),buffers:{color:i},shader:C1,material:t.material,uniforms:[{name:"delta",size:E.ONE,shaderInjection:A.FRAGMENT,update:()=>t.direction===0?1:.5}]})}function O1(t){const{compose:e,output:i,resources:n,view:r}=t,s={blending:{blendDst:d.GLSettings.Material.BlendingDstFactor.One,blendSrc:d.GLSettings.Material.BlendingSrcFactor.One,blendEquation:d.GLSettings.Material.BlendingEquations.Add}},a=[];for(let o=0,c=t.samples;o<c;++o){const l=nl({name:`${t.name}.box-down${o}`,printShader:t.printShader,input:n[o],output:n[o+1],direction:Ta.DOWN,material:{blending:void 0}});a.push(l)}for(let o=t.samples-1;o>0;--o){const c=nl({name:`${t.name}.box-up${o}`,printShader:t.printShader,input:n[o+1],output:n[o],direction:Ta.UP,material:s});a.push(c)}return e&&a.push(hi({name:`${t.name}.compose`,printShader:t.printShader,buffers:{color:e,glow:n[1]},material:s,view:{...i?{output:{buffers:{[$.COLOR]:i},depth:!1}}:void 0,...r},uniforms:[{name:"gamma",size:E.ONE,shaderInjection:A.ALL,update:()=>[t.gammaCorrection||1]}],shader:`
          varying vec2 texCoord;

          void main() {
            vec3 base = texture2D(color, texCoord).rgb;
            vec3 glow = texture2D(glow, texCoord).rgb;

            ${t.gammaCorrection!==void 0?`
              vec3 result = mix(
                base,
                glow + base,
                ((glow.r + glow.g + glow.b) * gamma)
              );
            `:`
              vec3 result = base + glow;
            `}

            gl_FragColor = vec4(result, 1.0);
          }
        `})),a}function N1(t){return Array.isArray(t[0])}const P1=t=>{const e=t.scale||us(1,1),n=(N1(e)?e:[t.scale]).map(s=>ls(s)),r=1/n.length;if(me(t.drift)){const s=t.drift;return hi({name:t.name,buffers:{},view:{output:{buffers:{[$.COLOR]:t.output},depth:!1}},uniforms:[{name:"drift",size:E.THREE,shaderInjection:A.FRAGMENT,update:()=>s}],shader:`
        \${import: time, simplexNoise3D}

        void main() {
          float value = 0.;
          ${n.map(a=>`value += simplexNoise3D(vec3(gl_FragCoord.xy * vec2(${a[0]}f, ${a[1]}f), 0.) + (drift * time));`).join(`
`)}
          value *= ${r.toFixed(1)}f;
          \${out: color} = vec4(value, value, value, 1.);
        }
      `})}else if(me(t.zOffset)){const s=t.zOffset;return hi({name:t.name,buffers:{},view:{output:{buffers:{[$.COLOR]:t.output},depth:!1}},uniforms:[{name:"zOffset",size:E.ONE,update:Hl(s)?()=>[s]:()=>[s()]}],shader:`
        \${import: simplexNoise3D}

        void main() {
          float value = 0.;
          ${n.map(a=>`
            value += simplexNoise3D(vec3(gl_FragCoord.xy * vec2(${a[0]}f, ${a[1]}f), zOffset));
          `).join(`
`)}
          value *= ${r.toFixed(1)}f;
          \${out: color} = vec4(value, value, value, 1.);
        }
      `})}else return hi({name:t.name,buffers:{},view:{output:{buffers:{[$.COLOR]:t.output},depth:!1}},shader:`
        \${import: simplexNoise2D}

        void main() {
          float value = 0.;
          ${n.map(s=>`
            value += simplexNoise2D(gl_FragCoord.xy * vec2(${s[0]}f, ${s[1]}f));
          `).join(`
`)}
          value *= ${r.toFixed(1)}f;
          \${out: color} = vec4(value, value, value, 1.);
        }
      `})},D1=xe("performance");function F1(t){const{output:e,input:i,channel:n,grayScale:r}=t;return hi({name:t.name,printShader:t.printShader,view:{output:e?{buffers:{[$.COLOR]:e||""},depth:!1}:void 0,...t.view},buffers:{color:i},shader:r&&n?`
      varying vec2 texCoord;

      void main() {
        gl_FragColor = vec4(texture2D(color, texCoord).${n}${n}${n}, 1.);
      }
    `:n?`
      varying vec2 texCoord;

      void main() {
        gl_FragColor = vec4(texture2D(color, texCoord).${n}, 0., 0., 1.);
      }
    `:`
      varying vec2 texCoord;

      void main() {
        gl_FragColor = texture2D(color, texCoord);
      }
    `,material:t.material,onResources:s=>{Object.values(s).forEach(a=>{(!a.textureSettings||a.textureSettings.generateMipMaps)&&D1("POSSIBLE ERROR: for the draw post effect,","it is a common mistale to leave mipmaps enabled on the input texture.","Often the mipmaps are not available in the target resource and thus","you will get a blank output when rendering in certain scenarios.")})}})}function B1(t){const{output:e,input:i,view:n}=t,r=[];return r.push(hi({name:`${t.name}_base`,printShader:t.printShader,buffers:{trailTex:i.trail,addTex:i.add},material:{blending:null},view:{config:{clearFlags:[Jn.COLOR]},output:{buffers:{[$.COLOR]:e},depth:!1},...n},shader:`
          varying vec2 texCoord;

          void main() {
            // Add the trailTex and addTex but fade out the trailTex slightly
            vec4 addT = texture2D(addTex, texCoord);
            vec4 trailT = texture2D(trailTex, texCoord);

            // Blend the textures
            float alpha = addT.a + trailT.a * (1.0 - addT.a); // Compute final alpha
            vec3 color;
            if (alpha > 0.0) { // Avoid division by zero
              color = (addT.rgb * addT.a + trailT.rgb * trailT.a * (1.0 - addT.a)) / alpha;
            } else {
              color = vec3(0.0); // Fallback to black (or any other fallback color)
            }

            gl_FragColor = vec4(color, alpha);
          }
        `})),t.drift?t.drift&&r.push(hi({name:t.name,printShader:t.printShader,buffers:{tex:e},material:{blending:null},view:{output:{buffers:{[$.COLOR]:i.trail},depth:!1},...n},uniforms:[{name:"drift",size:E.TWO,shaderInjection:A.FRAGMENT,update:()=>{var s;return((s=t.drift)==null?void 0:s.direction)||[0,0]}}],shader:`
          varying vec2 texCoord;

          void main() {
            vec4 fade = texture2D(tex, texCoord + (drift / tex_size));
            fade.rgba *= ${t.intensity||.7};
            \${out: color} = fade;
          }
        `})):r.push(hi({name:t.name,printShader:t.printShader,buffers:{tex:e},material:{blending:null},view:{output:{buffers:{[$.COLOR]:i.trail},depth:!1},...n},shader:`
          varying vec2 texCoord;

          void main() {
            vec4 fade = texture2D(tex, texCoord);
            fade.rgba *= ${t.intensity||.7};
            \${out: color} = fade;
          }
        `})),r}class Xf extends ei{constructor(e,i,n){super(e,i,n),console.warn("Please ensure all debugLayer calls are removed for production:",n.key)}childLayers(){return this.props.wrap?(this.props.wrap.init[1].key=`debug-wrapper.${this.props.key}`,[this.props.wrap]):[]}draw(){if(!this.props.wrap)return;const e=this.resolveChanges(!0);if(e.length===0)return;const{messageHeader:i=()=>""}=this.props;console.warn(`${i()}
`,{totalChanges:e.length,changes:e})}initShader(){if(!this.props.wrap)return null;const e=new this.props.wrap.init[0](this.surface,this.scene,this.props.wrap.init[1]),i=e.childLayers(),n={};for(;i.length>0;){const r=i.pop();if(!r)continue;const s=new r.init[0](this.surface,this.scene,r.init[1]);n[s.id]={shaderIO:s.initShader()},s.childLayers().forEach(a=>i.push(a))}return console.warn(`Shader IO: ${this.id}
`,{shaderIO:e.initShader(),childLayers:n}),null}}Xf.defaultProps={data:new he,key:"default",messageHeader:()=>"",wrap:En(ei,{data:new he})};function U1(t,e){const i=_n(Xf,{messageHeader:()=>`CHANGES FOR: ${i.init[1].key}`,wrap:_n(t,e),data:e.data});return i}d.ActiveIOExpansion=Ad,d.AnchorType=P,d.ArcInstance=Mi,d.ArcLayer=Gc,d.ArcScaleType=hf,d.Atlas=td,d.AtlasManager=nd,d.AtlasResourceManager=sd,d.Attribute=gi,d.AutoEasingLoopStyle=Qt,d.AutoEasingMethod=Bs,d.Axis2D=Cf,d.BaseIOExpansion=$r,d.BaseIOSorting=tf,d.BaseProjection=Ns,d.BaseResourceManager=Qn,d.BaseShaderIOInjection=rd,d.BasicCamera2DController=lf,d.BasicCamera2DControllerJSX=Vf,d.BasicIOExpansion=xd,d.BasicInstance=Vg,d.BloomJSX=O1,d.Bounds=te,d.BoxSampleJSX=nl,d.BoxSampleJSXDirection=Ta,d.BufferManagerBase=ra,d.Camera=bi,d.Camera2D=Ai,d.CameraBoundsAnchor=cf,d.CameraProjectionType=yi,d.CircleInstance=qr,d.CircleLayer=kc,d.ClearFlags=Jn,d.CommandLayer=Uc,d.CommandsJSX=L1,d.CommonMaterialOptions=tt,d.Control2D=xi,d.CubeInstance=Zc,d.CubeLayer=Nf,d.CustomTag=ui,d.DEFAULT_IO_EXPANSION=rf,d.DEFAULT_RESOURCE_MANAGEMENT=sf,d.DEFAULT_RESOURCE_ROUTER=wd,d.DEFAULT_SHADER_TRANSFORM=af,d.DrawJSX=F1,d.EasingIOExpansion=_d,d.EasingUtil=$g,d.EdgeBroadphase=zc,d.EdgeInstance=rn,d.EdgeLayer=Vc,d.EdgeScaleType=Kr,d.EdgeType=ii,d.EulerOrder=re,d.EventManager=Pn,d.FontGlyphRenderSize=gd,d.FontJSX=$f,d.FontManager=md,d.FontMap=ud,d.FontMapGlyphType=ea,d.FontRenderer=fd,d.FontResourceManager=vd,d.FontResourceRequestFetch=An,d.FragmentOutputType=$,d.GLProxy=Tr,d.GLState=ql,d.Geometry=zi,d.GlyphInstance=wt,d.GlyphLayer=fa,d.Hadamard2x2=Iu,d.Hadamard3x3=Lu,d.Hadamard4x4=Cu,d.INVALID_RESOURCE_MANAGER=$h,d.IdentityTransform=kh,d.ImageInstance=ri,d.ImageLayer=gf,d.ImageRasterizer=Rn,d.Instance=ze,d.Instance3D=li,d.InstanceAttributeBufferManager=Ld,d.InstanceAttributePackingBufferManager=Cd,d.InstanceAttributeSize=C,d.InstanceBlockIndex=No,d.InstanceDiffType=Le,d.InstanceProvider=he,d.InstanceProviderWithList=Gg,d.InvalidResourceManager=Wh,d.LabelInstance=ae,d.LabelLayer=jc,d.Layer=ei,d.Layer2D=Ne,d.LayerBufferType=Ae,d.LayerInteractionHandler=Xd,d.LayerJSX=ma,d.LayerMouseEvents=nf,d.LayerScene=la,d.M200=$i,d.M201=ji,d.M210=Hi,d.M211=Qi,d.M300=br,d.M301=Er,d.M302=_r,d.M310=Rr,d.M311=xr,d.M312=Ar,d.M320=Sr,d.M321=Mr,d.M322=Ir,d.M3R=vn,d.M400=Lt,d.M401=Ct,d.M402=Ot,d.M403=Nt,d.M410=Pt,d.M411=Dt,d.M412=Ft,d.M413=Bt,d.M420=Ut,d.M421=Gt,d.M422=kt,d.M423=zt,d.M430=Vt,d.M431=Wt,d.M432=$t,d.M433=jt,d.M4R=Ue,d.Material=yr,d.MaterialUniformType=be,d.MatrixMath=Ig,d.Model=Bo,d.MouseButton=ul,d.NOOP=xs,d.NewLineCharacterMode=tr,d.NoView=Zd,d.ObservableMonitoring=je,d.PackNode=Qe,d.PickType=X,d.PostProcessInstance=tl,d.PostProcessJSX=hi,d.PostProcessLayer=il,d.Projection3D=If,d.PromiseResolver=ke,d.QR1=rh,d.QR2=sh,d.QR3=ah,d.QR4=oh,d.QW=hh,d.QX=ch,d.QY=lh,d.QZ=uh,d.QuadTree=Kh,d.QuadTreeNode=Xn,d.QuadTreeQuadrants=qh,d.QuaternionMath=Lg,d.QueuedEventHandler=Fc,d.QueuedEventHandlerJSX=kf,d.REQUEST=xm,d.RESOURCE=Rm,d.RayMath=Cg,d.ReactiveDiff=Vr,d.RectangleInstance=oi,d.RectangleLayer=Xc,d.ReferenceCamera2D=p0,d.RenderTarget=Wi,d.RenderTexture=Ec,d.RenderTextureResourceManager=ad,d.ResourcePool=Kg,d.ResourceRouter=Mc,d.ResourceType=le,d.RingInstance=ir,d.RingLayer=Yc,d.SRT4x4=Fs,d.SRT4x4_2D=nc,d.ScaleMode=ti,d.Scene=Ms,d.SceneGraphLayer=Of,d.SceneJSX=wa,d.ShaderInjectionTarget=A,d.ShaderModule=Ee,d.ShaderModuleUnit=aa,d.SimpleEventHandler=ns,d.SimpleEventHandlerJSX=zf,d.SimpleProjection=hu,d.SimplexNoiseJSX=P1,d.StreamChangeStrategy=As,d.SubTexture=Ei,d.Surface=of,d.SurfaceContext=rr,d.SurfaceErrorType=Fo,d.SurfaceJSX=x1,d.TRS4x4=Nr,d.TRS4x4_2D=Ju,d.TextAlignment=pa,d.TextAreaInstance=an,d.TextAreaLayer=xf,d.Texture=se,d.TextureIOExpansion=Zs,d.TextureJSX=Wf,d.TextureSize=lt,d.TrailJSX=B1,d.Transform=Xs,d.Transform2D=p1,d.TreeNode=vc,d.UniformBufferManager=Nd,d.UniformSize=E,d.UseMaterialStatus=gt,d.UserInputEventManager=Jd,d.V3R=$e,d.V4R=hl,d.VecMath=B,d.VectorMath=Og,d.VertexAttributeSize=Be,d.View=Xr,d.View2D=ua,d.View3D=Lf,d.ViewJSX=va,d.WebGLRenderer=Zl,d.WebGLStat=L,d.WordWrap=ai,d.add1=rs,d.add2=fi,d.add2x2=_u,d.add3=Rt,d.add3x3=Ru,d.add4=ps,d.add4by3=Ml,d.add4x4=xu,d.addQuat=dh,d.affineInverse2x2=pu,d.affineInverse3x3=gu,d.affineInverse4x4=mu,d.angleQuat=xh,d.apply1=Fe,d.apply2=de,d.apply2x2=ft,d.apply3=pe,d.apply3x3=Ke,d.apply4=fe,d.apply4x4=ve,d.atlasRequest=Yn,d.axisQuat=Ah,d.ceil1=Sa,d.ceil2=ja,d.ceil3=no,d.ceil4=uo,d.clamp=et,d.color4FromHex3=Ol,d.color4FromHex4=Nl,d.colorBufferFormat=Gl,d.colorUID=Ip,d.compare1=Ma,d.compare2=cs,d.compare2x2=Yu,d.compare3=lr,d.compare3x3=qu,d.compare4=gs,d.compare4x4=ic,d.concat4x4=Eu,d.concatChildren=el,d.conjugateQuat=cc,d.convertToSDF=pm,d.copy1=Ia,d.copy2=os,d.copy2x2=Ku,d.copy3=it,d.copy3x3=Zu,d.copy4=At,d.copy4x4=Gn,d.create=qg,d.createAtlas=ed,d.createAttribute=Xh,d.createChildLayer=_n,d.createEasingAttribute=Pm,d.createFont=Sc,d.createLayer=En,d.createLayer2Din3D=u1,d.createMaterialOptions=xp,d.createTexture=bc,d.createUniform=Zh,d.createVertex=Jh,d.createView=Pc,d.cross1=Ca,d.cross2=Qa,d.cross3=Ye,d.cross4=fo,d.debugLayer=U1,d.decomposeRotation=$s,d.depthBufferFormat=kl,d.determinant2x2=ge,d.determinant3x3=wn,d.determinant4x4=Xo,d.diffUnitQuat=gh,d.divide1=Oa,d.divide2=cr,d.divide3=ur,d.divide4=po,d.divideQuat=fh,d.dot1=za,d.dot2=Dn,d.dot3=hr,d.dot4=Ts,d.dotQuat=yh,d.down3=Sl,d.drawMode=_s,d.empty1=Na,d.empty2=Xa,d.empty3=ro,d.empty4=go,d.eulerToQuat=Ih,d.eventElementPosition=Mt,d.exponentQuat=ph,d.filterQuery=Qg,d.flatten1=Pa,d.flatten2=Ya,d.flatten3=so,d.flatten4=ms,d.floor1=Da,d.floor2=qa,d.floor3=ao,d.floor4=mo,d.fontRequest=Sn,d.forward1=La,d.forward2=Ha,d.forward3=hn,d.forward4=ho,d.fromEulerAxisAngleToQuat=bh,d.fromOrderedEulerToQuat=uc,d.fuzzyCompare1=pl,d.fuzzyCompare2=vl,d.fuzzyCompare3=bl,d.fuzzyCompare4=Il,d.generateDefaultScene=Td,d.generateLayerGeometry=bd,d.generateLayerMaterial=yd,d.generateLayerModel=na,d.getAbsolutePositionBounds=Mo,d.getProgramInfo=hp,d.iQuat=Ph,d.identity2=Lr,d.identity3=Ht,d.identity4=ue,d.imaginaryQuat=Th,d.indexToColorAttachment=pr,d.indexToTextureUnit=Vl,d.injectShaderIO=zd,d.inputImageFormat=fr,d.instanceAttributeSizeFloatCount=$l,d.inverse1=Fa,d.inverse2=ls,d.inverse3=Fn,d.inverse4=vo,d.inverseQuat=mh,d.isAtlasResource=_c,d.isBoolean=Vi,d.isBufferLocation=Wm,d.isBufferLocationGroup=Sd,d.isDefined=me,d.isFontResource=Ac,d.isFunction=Ap,d.isInstanceAttributeBufferLocation=jm,d.isInstanceAttributeBufferLocationGroup=Id,d.isInstanceAttributeVector=bp,d.isNewline=Rp,d.isNumber=Hl,d.isOffscreenCanvas=gn,d.isOrthographic=zh,d.isPerspective=wc,d.isRenderTextureResource=bn,d.isResourceAttribute=Ep,d.isString=vi,d.isUniformBufferLocation=Od,d.isUniformFloat=Bp,d.isUniformMat3=Pp,d.isUniformMat4=Dp,d.isUniformTexture=Fp,d.isUniformVec2=Cp,d.isUniformVec3=Op,d.isUniformVec4=Np,d.isUniformVec4Array=Xl,d.isVec1=dl,d.isVec2=Aa,d.isVec3=fl,d.isVec4=U,d.isVideoResource=Zr,d.isWhiteSpace=pn,d.jQuat=Dh,d.kQuat=Fh,d.left3=Al,d.length1=Wa,d.length1Components=ml,d.length2=Gi,d.length2Components=io,d.length3=hs,d.length3Components=lo,d.length4=ys,d.length4Components=pi,d.lengthQuat=lc,d.linear1=Va,d.linear2=to,d.linear3=co,d.linear4=To,d.lookAtMatrix=Oh,d.lookAtQuat=hc,d.magFilter=fn,d.makeFontSDF=gm,d.makeObservable=He,d.mapGetWithDefault=Ks,d.mapInjectDefault=qi,d.matrix3x3FromUnitQuatModel=Vs,d.matrix3x3FromUnitQuatView=Mh,d.matrix3x3ToQuaternion=Lh,d.matrix4x4FromUnitQuatModel=Sh,d.matrix4x4FromUnitQuatView=Ws,d.matrix4x4ToQuaternion=Ch,d.max1=Ba,d.max2=Ka,d.max3=ds,d.max4=yo,d.min1=Ua,d.min2=Za,d.min3=fs,d.min4=bo,d.minFilter=mi,d.multiply1=Ga,d.multiply2=Ja,d.multiply2x2=yu,d.multiply3=oo,d.multiply3x3=bu,d.multiply4=wo,d.multiply4x4=rt,d.multiplyQuat=ac,d.multiplyScalar2x2=vu,d.multiplyScalar3x3=wu,d.multiplyScalar4x4=Tu,d.newLineCharRegEx=Do,d.newLineRegEx=jl,d.nextFrame=kr,d.normalize1=ka,d.normalize2=eo,d.normalize3=ct,d.normalize4=Eo,d.normalizeQuat=vh,d.normalizeWheel=Ho,d.observable=M,d.onAnimationLoop=pc,d.onFrame=Ti,d.oneQuat=Br,d.orthographic4x4=ec,d.packAttributes=Bd,d.perspective4x4=Jo,d.perspectiveFOVY4x4=Xu,d.perspectiveFrustum4x4=Ps,d.preloadNumber=ym,d.project3As4ToScreen=Ds,d.projectToScreen=tc,d.ray=dc,d.rayFromPoints=fc,d.rayToLocation=Bh,d.realQuat=wh,d.removeComments=Wr,d.renderGlyph=Rc,d.resolveUpdate=mc,d.reverse2=yl,d.reverse3=_l,d.reverse4=Cl,d.right3=xl,d.rotateVectorByUnitQuat=js,d.rotation2x2=Yo,d.rotation4x4=qo,d.rotation4x4by3=ju,d.scale1=ss,d.scale2=Re,d.scale3=nt,d.scale4=vs,d.scale4x4=Ko,d.scale4x4by3=Hu,d.scaleQuat=oc,d.scheduleUpdate=gc,d.shaderTemplate=Ki,d.shallowCompare=rc,d.shearX2x2=Pu,d.shearX4x4=Fu,d.shearY2x2=Du,d.shearY4x4=Bu,d.shearZ4x4=Uu,d.slerpQuat=_o,d.slerpUnitQuat=Nh,d.stencilBufferFormat=zl,d.stopAllFrameCommands=Ng,d.stopAnimationLoop=Uh,d.subTextureIOValue=Zi,d.subtract1=as,d.subtract2=ye,d.subtract2x2=Au,d.subtract3=xt,d.subtract3x3=Su,d.subtract4=ws,d.subtract4x4=Mu,d.texelFormat=dn,d.textureRequest=jr,d.textureUnitToIndex=Lo,d.toEulerFromQuat=_h,d.toEulerXYZfromOrderedEuler=Eh,d.toOrderedEulerFromQuat=zs,d.toOrderedEulerFromQuat2=Rh,d.toString1=Pl,d.toString2=Dl,d.toString2x2=Vu,d.toString3=Fl,d.toString3x3=Wu,d.toString4=Bl,d.toString4x4=$u,d.tod1=gl,d.tod2=wl,d.tod3=El,d.tod4=Ll,d.tod_flip2=Tl,d.touchesContainsStartView=uu,d.touchesHasStartView=lu,d.transform2=Gu,d.transform3=ku,d.transform3as4=zu,d.transform4=Or,d.translation4x4=Zo,d.translation4x4by3=Qu,d.transpose2x2=Ou,d.transpose3x3=Cr,d.transpose4x4=Nu,d.uid=G,d.up3=Rl,d.useChildResolvers=un,d.vec1=$a,d.vec1Methods=Ro,d.vec2=us,d.vec2Methods=xo,d.vec3=ki,d.vec3Methods=Ao,d.vec4=dr,d.vec4Methods=So,d.wait=Xg,d.waitForValidDimensions=Yg,d.whiteSpaceCharRegEx=Po,d.whiteSpaceRegEx=_p,d.wrapMode=Io,d.zeroQuat=we,Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=index.js.map
